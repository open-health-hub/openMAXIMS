//#############################################################################
//#                                                                           #
//#  Copyright (C) <2014>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Daniel Laffan using IMS Development Environment (version 1.20 build 40806.900)
// Copyright (C) 1995-2004 IMS MAXIMS plc. All rights reserved.

package ims.core.forms.vitalsignsall;

import ims.clinical.vo.PatientHeightEstimationULNAConfigVo;
import ims.clinical.vo.SECSConfigurationVo;
import ims.clinical.vo.SECSConfigurationVoCollection;
import ims.clinical.vo.SECSLookupConfigVo;
import ims.clinical.vo.SECSLookupScoreVo;
import ims.clinical.vo.SECSRangeScoreVo;
import ims.clinical.vo.SECSVo;
import ims.configuration.gen.ConfigFlag;
import ims.core.vo.AuthoringInformationVo;
import ims.core.vo.MemberOfStaffLiteVo;
import ims.core.vo.MemberOfStaffShortVo;
import ims.core.vo.PatientEWSVo;
import ims.core.vo.RecordingUserInformationVo;
import ims.core.vo.VSBloodPressure;
import ims.core.vo.VSBloodSugar;
import ims.core.vo.VSGlasgowComaScale;
import ims.core.vo.VSLungFunctionTestVo;
import ims.core.vo.VSMetrics;
import ims.core.vo.VSOxygenSaturation;
import ims.core.vo.VSPainLadderVo;
import ims.core.vo.VSPulse;
import ims.core.vo.VSPupils;
import ims.core.vo.VSRespirations;
import ims.core.vo.VSTemperature;
import ims.core.vo.VSVisualAcuity;
import ims.core.vo.VitalSignsVo;
import ims.core.vo.VitalSignsVoCollection;
import ims.core.vo.lookups.CBGType;
import ims.core.vo.lookups.ConsciousLevel;
import ims.core.vo.lookups.LookupHelper;
import ims.core.vo.lookups.PatientCausingConcern;
import ims.core.vo.lookups.SECSTypes;
import ims.core.vo.lookups.Sex;
import ims.core.vo.lookups.UrineOutput;
import ims.core.vo.lookups.VSSnellen;
import ims.core.vo.lookups.VSSnellenCollection;
import ims.core.vo.lookups.VSType;
import ims.core.vo.lookups.VSTypeCollection;
import ims.domain.exceptions.StaleObjectException;
import ims.framework.MessageButtons;
import ims.framework.MessageIcon;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.FormMode;
import ims.framework.exceptions.FormOpenException;
import ims.framework.exceptions.PresentationLogicException;
import ims.framework.utils.Date;
import ims.framework.utils.DateTime;
import ims.framework.utils.Time;
import ims.nursing.vo.lookups.PainSeverity;

import java.util.ArrayList;

public class Logic extends BaseLogic
{
	protected void onFormOpen() throws ims.framework.exceptions.FormOpenException
	{
		StringBuffer tooltip = new StringBuffer();
		tooltip.append("<b>Eyes open</b>");
		tooltip.append("<br>Spontaneously&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4");
		tooltip.append("<br>To speech&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3");
		tooltip.append("<br>To pain&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2");
		tooltip.append("<br>None&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1");
		tooltip.append("<br><br><b>Verbal response</b>");
		tooltip.append("<br>Orientated&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5");
		tooltip.append("<br>Confused&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4");
		tooltip.append("<br>Inappropriate words&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3");
		tooltip.append("<br>Incomprehensible sound&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2");
		tooltip.append("<br>None&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1");
		tooltip.append("<br><br><b>Motor response</b>");
		tooltip.append("<br>Obey commands;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6");
		tooltip.append("<br>Localises pain&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5");
		tooltip.append("<br>Normal flexion (Withdraws)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4");
		tooltip.append("<br>Abnormal flexion (Decorticate)&nbsp; 3");
		tooltip.append("<br>Extension Decerebrate&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2");
		tooltip.append("<br>None (Flaccid)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1");
		form.lnkGCS().setTooltip(tooltip.toString());

		clearScreen();
		
		enableBloodSugarControls(false);
		showBloodGlucoseControls(false, false);
		form.intBPStandingDiastolic().setEnabled(false);
		form.intBPStandingSystolic().setEnabled(false);

		loadPupilsCombos();

		if (ConfigFlag.UI.USE_EARLY_WARNING_SYSTEM.getValue())
			loadEWSCombos();
		else
		{
			hideEWSControls();
		}

		try
		{
			listVitalSigns();
		}
		catch (PresentationLogicException e1)
		{

			engine.showMessage(e1.getMessage());
			return;
		}
		form.setMode(FormMode.VIEW);
		// Don't allow to create new Vital Signs when "Logged in User is not a
		// Hcp"
		if (form.getMode().equals(FormMode.VIEW) && isLoggedInUser() == false)
		{
			engine.showMessage("Logged in User is not a Hcp");
			form.btnNew().setEnabled(false);
		}

		// default to original record selected if flicking back to this screen
		// from any other
		if (form.getGlobalContext().Core.getVitalSign() != null)
		{
			form.cmbAllRecords().setValue(form.getGlobalContext().Core.getVitalSign());
			try
			{
				onCmbAllRecordsValueChanged();
			}
			catch (PresentationLogicException e)
			{
				throw new FormOpenException("PresentationLogicException occurred " + e.getMessage(), e);
			}
		}

		setPupilstooltip();

		form.lnkVisualAcuity().setEnabled(false);
		form.lnkVisualAcuity().setVisible(false);

	}

	private void hideEWSControls()
	{
		form.lblConscious().setVisible(false);
		form.lblPatCausConc().setVisible(false);
		form.lblUrineOut().setVisible(false);
		form.cmbConscious().setVisible(false);
		form.cmbPatientConcern().setVisible(false);
		form.cmbUrine().setVisible(false);
		form.lblEWSScore().setVisible(false);
	}

	/**
	 * Patient Causing Concern,Conscious Level and Urine Output
	 */
	private void loadEWSCombos()
	{
		SECSVo voSecs = domain.getSecs();

		if (voSecs == null || voSecs.getConfiguration() == null)
			return;

		form.getLocalContext().setSecsRecord(voSecs);

		SECSConfigurationVoCollection voCollConfig = voSecs.getConfiguration();

		for (int i = 0; i < voCollConfig.size(); i++)
		{
			SECSConfigurationVo voConfig = voCollConfig.get(i);
			if (voConfig.getTypeIsNotNull())
			{
				if (voConfig.getType().equals(SECSTypes.PATIENT_CONCERN))
				{
					SECSLookupConfigVo voLookupConfig = voConfig.getLookupConfig();
					if (voLookupConfig != null && voLookupConfig.getLookupScores() != null)
					{
						for (int p = 0; p < voLookupConfig.getLookupScores().size(); p++)
							form.cmbPatientConcern().newRow(new PatientCausingConcern(voLookupConfig.getLookupScores().get(p).getLookupInstance().getId(), voLookupConfig.getLookupScores().get(p).getLookupInstance().getText(), voLookupConfig.getLookupScores().get(p).getLookupInstance().isActive(), null, null, null), voLookupConfig.getLookupScores().get(p).getLookupInstance().getText());
					}
				}
				else if (voConfig.getType().equals(SECSTypes.CONSCIOUS_LEVEL))
				{
					SECSLookupConfigVo voLookupConfig = voConfig.getLookupConfig();
					if (voLookupConfig != null && voLookupConfig.getLookupScores() != null)
					{
						for (int p = 0; p < voLookupConfig.getLookupScores().size(); p++)
							form.cmbConscious().newRow(new ConsciousLevel(voLookupConfig.getLookupScores().get(p).getLookupInstance().getId(), voLookupConfig.getLookupScores().get(p).getLookupInstance().getText(), voLookupConfig.getLookupScores().get(p).getLookupInstance().isActive(), null, null, null), voLookupConfig.getLookupScores().get(p).getLookupInstance().getText());
					}
				}
				else if (voConfig.getType().equals(SECSTypes.URINE_OUTPUT))
				{
					SECSLookupConfigVo voLookupConfig = voConfig.getLookupConfig();
					if (voLookupConfig != null && voLookupConfig.getLookupScores() != null)
					{
						for (int p = 0; p < voLookupConfig.getLookupScores().size(); p++)
							form.cmbUrine().newRow(new UrineOutput(voLookupConfig.getLookupScores().get(p).getLookupInstance().getId(), voLookupConfig.getLookupScores().get(p).getLookupInstance().getText(), voLookupConfig.getLookupScores().get(p).getLookupInstance().isActive(), null, null, null), voLookupConfig.getLookupScores().get(p).getLookupInstance().getText());
					}
				}
			}
		}
	}

	private void enableBloodSugarControls(boolean bEnable)
	{
		form.cmbTimePeriod().setEnabled(bEnable);
		form.decValue().setEnabled(bEnable);
		form.decPostValue().setEnabled(bEnable);
		form.intInterval().setEnabled(bEnable);
	}

	protected void onCmbAllRecordsValueChanged() throws PresentationLogicException
	{
		if (form.cmbAllRecords().getValue() != null)
		{

			form.getGlobalContext().Core.setVitalSign(form.cmbAllRecords().getValue());
			displayRecord();
		}
		else
			clearScreen(); // wdev-13022
	}

	protected void onBtnNewClick() throws PresentationLogicException
	{
		clearScreen();
		form.setMode(FormMode.EDIT);
		
		form.cmbAllRecords().setValue(null);

		form.customControlAuthoringInfo().initializeComponent();
		form.setcustomControlAuthoringInfoEnabled(true);

		Object mos = domain.getMosUser();
		if (mos != null)
		{
			form.cmbRecordingHCP().newRow((MemberOfStaffLiteVo) mos, mos.toString());
			form.cmbRecordingHCP().setValue((MemberOfStaffLiteVo) mos);
		}
		form.dtimRecordingDateTime().setValue(new DateTime());

		form.dteTaken().setValue(new Date());
		form.timTaken().setValue(new Time());

		form.dteTaken().setEnabled(true);
		form.timTaken().setEnabled(true);

		form.GroupBP().setValue(GenForm.GroupBPEnumeration.rdoBPSitting);
		onRadioButtonGroupBPValueChanged();

		showBloodGlucoseControls(false, false);
		
	}

	private void showBloodGlucoseControls(boolean bShow, boolean bCBGM)
	{
		form.lblValue().setVisible(bShow);
		form.decValue().setVisible(bShow);
		form.lblValueUnits().setVisible(bShow);

		if (bCBGM)
		{
			form.lblValue().setValue("Pre Value: ");

			form.lblValue().setVisible(bShow);
			form.lblPostValue().setVisible(bShow);
			form.lblPostValueUnits().setVisible(bShow);
			form.lblTimeInterval().setVisible(bShow);
			form.lblTimeIntervalUnits().setVisible(bShow);
			form.lblTimePeriod().setVisible(bShow);

			form.cmbTimePeriod().setVisible(bShow);
			form.decPostValue().setVisible(bShow);
			form.intInterval().setVisible(bShow);
		}
		else
		{
			form.lblValue().setValue("Value: ");

			form.lblPostValue().setVisible(false);
			form.lblPostValueUnits().setVisible(false);
			form.lblTimeInterval().setVisible(false);
			form.lblTimeIntervalUnits().setVisible(false);
			form.lblTimePeriod().setVisible(false);

			form.cmbTimePeriod().setVisible(false);
			form.decPostValue().setVisible(false);
			form.intInterval().setVisible(false);
		}
	}

	protected void onBtnSaveClick() throws PresentationLogicException
	{
		if (form.dteTaken().getValue() != null)
		{
			if (form.dteTaken().getValue().isGreaterThan(new Date()))
			{
				engine.showMessage("'Date/Time taken' can not be in the future.");
				return;
			}
		}
		ArrayList<String> screenErrors = new ArrayList<String>();

		VitalSignsVo voVitalSign = new VitalSignsVo();
		VSTypeCollection recordedSigns = new VSTypeCollection();

		populateEwsDataFromControls(voVitalSign);

		if ((form.intBPSittingLyingDiastolic().getValue() != null) || (form.intBPSittingLyingSystolic().getValue() != null) || (form.intBPStandingDiastolic().getValue() != null) || (form.intBPStandingSystolic().getValue() != null))
		{
			VSBloodPressure voBP = new VSBloodPressure();
			if ((form.intBPSittingLyingDiastolic().getValue() != null && form.intBPSittingLyingSystolic().getValue() == null) || (form.intBPSittingLyingDiastolic().getValue() == null && form.intBPSittingLyingSystolic().getValue() != null))
			{
				if (form.GroupBP().getValue().equals(GenForm.GroupBPEnumeration.rdoBPSitting))
					screenErrors.add("Please enter both Blood Pressure values for Sitting.");
				else
					screenErrors.add("Please enter both Blood Pressure values for Lying.");
			}
			else
			{

				if (form.GroupBP().getValue().equals(GenForm.GroupBPEnumeration.rdoBPSitting))
				{
					voBP.setBPSittingDias(new Float(form.intBPSittingLyingDiastolic().getValue().intValue()));
					voBP.setBPSittingSys(new Float(form.intBPSittingLyingSystolic().getValue().intValue()));
				}
				else
				{
					if (form.intBPSittingLyingDiastolic().getValue() != null)
						voBP.setBPLyingDias(new Float(form.intBPSittingLyingDiastolic().getValue().intValue()));
					if (form.intBPSittingLyingSystolic().getValue() != null)
						voBP.setBPLyingSys(new Float(form.intBPSittingLyingSystolic().getValue().intValue()));
				}
			}

			if ((form.intBPStandingDiastolic().getValue() != null && form.intBPStandingSystolic().getValue() == null) || (form.intBPStandingDiastolic().getValue() == null && form.intBPStandingSystolic().getValue() != null))
			{
				screenErrors.add("Please enter both Blood Pressure values for Standing.");
			}
			else
			{
				if (form.intBPStandingDiastolic().getValue() != null)
					voBP.setBPStandingDias(new Float(form.intBPStandingDiastolic().getValue().intValue()));
				if (form.intBPStandingSystolic().getValue() != null)
					voBP.setBPStandingSys(new Float(form.intBPStandingSystolic().getValue().intValue()));
			}

			// wdev-12900
			voBP.setComment(form.txtComment().getValue());
			// ------------
			voVitalSign.setBloodPressure(voBP);
			recordedSigns.add(VSType.BP);
		}
		else if ((form.intBPSittingLyingDiastolic().getValue() == null) && (form.intBPSittingLyingSystolic().getValue() == null) && (form.intBPStandingDiastolic().getValue() == null) && (form.intBPStandingSystolic().getValue() == null))
			voVitalSign.setBloodPressure(null);

		if ((form.intPulseRadial().getValue() != null) || (form.intPulseApex().getValue() != null))
		{
			VSPulse voPulse = new VSPulse();
			if (form.intPulseRadial().getValue() != null)
			{
				voPulse.setPulseRateRadial(form.intPulseRadial().getValue());
			}
			if (form.intPulseApex().getValue() != null)
			{
				voPulse.setPulseRateApex(form.intPulseApex().getValue());
			}
			voPulse.setIsIrregular(new Boolean(form.chkIrregular().getValue()));
			voVitalSign.setPulse(voPulse);
			recordedSigns.add(VSType.PULSE);
		}
		else if ((form.intPulseRadial().getValue() == null) && (form.intPulseApex().getValue() == null))
			voVitalSign.setPulse(null);

		if ((form.intPeakFlowPre().getValue() != null) || (form.intPeakFlowPost().getValue() != null) || (form.intTimeInterval().getValue() != null))
		{
			// VSPeakFlow vopeakFlow = new VSPeakFlow();
			VSLungFunctionTestVo voLungFunction = new VSLungFunctionTestVo();

			if (form.intPeakFlowPre().getValue() != null)
			{
				voLungFunction.setPeakFlowPre(form.intPeakFlowPre().getValue());
			}

			if (form.intPeakFlowPost().getValue() != null)
			{
				voLungFunction.setPeakFlowPost(form.intPeakFlowPost().getValue());
			}

			if (form.intTimeInterval().getValue() != null)
			{
				voLungFunction.setTimeInterval(form.intTimeInterval().getValue());
			}

			voVitalSign.setLungFunctionTest(voLungFunction);
			recordedSigns.add(VSType.PEAKFLOW);
		}
		else if ((form.intPeakFlowPre().getValue() == null) && (form.intPeakFlowPost().getValue() == null) && (form.intTimeInterval().getValue() == null))
			voVitalSign.setLungFunctionTest(null);

		if (form.getLocalContext().getSeverityIsNotNull())
		{
			VSPainLadderVo voPain = new VSPainLadderVo();
			PainSeverity severity = form.getLocalContext().getSeverity();
			voPain.setPain(severity);
			voVitalSign.setPain(voPain);
			recordedSigns.add(VSType.PAIN);
		}
		else if (form.getLocalContext().getSeverity() == null)
		{
			voVitalSign.setPain(null);
		}

		if (form.decTemp().getValue() != null)
		{
			VSTemperature voTemperature = new VSTemperature();
			voTemperature.setTemperature(form.decTemp().getValue());
			voVitalSign.setTemperature(voTemperature);
			recordedSigns.add(VSType.TEMP);
		}
		else if (form.decTemp().getValue() == null)
			voVitalSign.setTemperature(null);

		if (form.intRespirations().getValue() != null)
		{
			VSRespirations voResp = new VSRespirations();
			voResp.setRespRate(form.intRespirations().getValue());
			voVitalSign.setRespiratory(voResp);
			recordedSigns.add(VSType.RESPIRATION);
		}
		else if (form.intRespirations().getValue() == null)
			voVitalSign.setRespiratory(null);

		if (form.intO2Sat().getValue() != null || form.intFractionRate().getValue() != null)
		{
			if (form.chkonFiO2().getValue())
			{
				if (form.intFractionRate().getValue() == null)
					screenErrors.add("Please enter value for Oxygen Saturation % rate.");
			}

			VSOxygenSaturation voOxygen = new VSOxygenSaturation();
			voOxygen.setOxygenSaturationLevel(form.intO2Sat().getValue());
			voOxygen.setFractionRate(form.intFractionRate().getValue());
			voOxygen.setIsOnFiO2(form.chkonFiO2().getValue());
			voVitalSign.setOxygenSaturation(voOxygen);
			recordedSigns.add(VSType.OXYGEN);
		}
		else
			voVitalSign.setOxygenSaturation(null);

		if (!form.BloodGlucoseGroup1().getValue().equals(GenForm.BloodGlucoseGroup1Enumeration.None))
		{
			VSBloodSugar voBloodSugar = new VSBloodSugar();
			if (form.BloodGlucoseGroup1().getValue().equals(GenForm.BloodGlucoseGroup1Enumeration.rdoRandom))
				voBloodSugar.setType(CBGType.RANDOM);
			else
				voBloodSugar.setType(CBGType.CBGM);
			voBloodSugar.setBloodSugarValue(form.decValue().getValue());
			voBloodSugar.setTimePeriod(form.cmbTimePeriod().getValue());
			voBloodSugar.setPostBloodSugarValue(form.decPostValue().getValue());
			voBloodSugar.setTimeInterval(form.intInterval().getValue());
			voVitalSign.setBloodSugar(voBloodSugar);
			recordedSigns.add(VSType.BLOODSUGAR);
		}
		else
			voVitalSign.setBloodSugar(null);

		if (form.cmbLeftSizePupil().getValue() != null || form.cmbRightSizePupil().getValue() != null || form.cmbLeftReactionPupil().getValue() != null || form.cmbRightReactionPupil().getValue() != null)
		{
			if (form.cmbLeftSizePupil().getValue() == null || form.cmbRightSizePupil().getValue() == null || form.cmbLeftReactionPupil().getValue() == null || form.cmbRightReactionPupil().getValue() == null)
			{
				screenErrors.add("Please enter values for pupil size and reaction for both eyes.");
			}
			else
			{
				VSPupils voPupil = new VSPupils();
				voPupil.setPupilLeftReaction(form.cmbLeftReactionPupil().getValue());
				voPupil.setPupilRightReaction(form.cmbRightReactionPupil().getValue());
				voPupil.setPupilLeftSize(form.cmbLeftSizePupil().getValue());
				voPupil.setPupilRightSize(form.cmbRightSizePupil().getValue());
				voVitalSign.setPupils(voPupil);
				recordedSigns.add(VSType.PUPILS);
			}
		}
		else if ((form.cmbLeftSizePupil().getValue() == null) && (form.cmbRightSizePupil().getValue() == null) && (form.cmbLeftReactionPupil().getValue() == null) && (form.cmbRightReactionPupil().getValue() == null))
			voVitalSign.setPupils(null);

		if (form.cmbVisualLeft().getValue() != null || form.cmbVisualRight().getValue() != null)
		{
			VSVisualAcuity voVisual = new VSVisualAcuity();

			if (form.cmbVisualLeft().getValue() != null)
				voVisual.setLeftValue(String.valueOf(form.cmbVisualLeft().getValue().getID()));

			if (form.cmbVisualRight().getValue() != null)
				voVisual.setRightValue(String.valueOf(form.cmbVisualRight().getValue().getID()));

			voVitalSign.setVisualAcuity(voVisual);
			recordedSigns.add(VSType.VISUALACUITY);
		}
		else if (form.cmbVisualLeft().getValue() == null && form.cmbVisualRight().getValue() == null)
			voVitalSign.setVisualAcuity(null);

		if (form.intGCS().getValue() != null || form.cmbVResponse().getValue() != null || form.cmbMResponse().getValue() != null || form.cmbEyeOpening().getValue() != null)
		{
			if (form.cmbVResponse().getValue() == null || form.cmbMResponse().getValue() == null || form.cmbEyeOpening().getValue() == null)
			{
				screenErrors.add("Please enter all values for Glasgow Coma Scale.");
			}
			else
			{
				VSGlasgowComaScale voGcs = new VSGlasgowComaScale();
				voGcs.setMotorResponse(form.cmbMResponse().getValue());
				voGcs.setVerbalResponse(form.cmbVResponse().getValue());
				voGcs.setEyeOpening(form.cmbEyeOpening().getValue());
				voGcs.setTotalGlasgowComaScale(form.intGCS().getValue());

				voVitalSign.setGlasgowComaScale(voGcs);

				recordedSigns.add(VSType.GLASGOWCOMASCALE);
			}
		}
		else if ((form.intGCS().getValue() == null) && (form.cmbVResponse().getValue() == null) && (form.cmbMResponse().getValue() == null) && (form.cmbEyeOpening().getValue() == null))
			voVitalSign.setGlasgowComaScale(null);

		if ((form.decHeight().getValue() == null) && (form.decWeight().getValue() == null))
		{
			voVitalSign.setMetrics(null);
		}
		else
		{
			if ((form.decHeight().getValue() != null && form.decHeight().getValue() < 1) || (form.decWeight().getValue() != null && form.decWeight().getValue() < 1))
			{
				screenErrors.add("Height and Weight values can not be less than 1.");
			}
			else
			{
				VSMetrics voMetrics = new VSMetrics();
				voMetrics.setHeightValue(form.decHeight().getValue());
				voMetrics.setWeightValue(form.decWeight().getValue());
				voMetrics.setBMI(bodyMassIndex(form.decHeight().getValue(), form.decWeight().getValue()));
				voMetrics.setSurfaceArea(bodySurfaceArea(form.decHeight().getValue(), form.decWeight().getValue()));
				voMetrics.setHeightEstimatedMeasured(Boolean.TRUE); // default
				// to
				// measured
				voMetrics.setWeightEstimatedMeasured(Boolean.TRUE); // default
				// to
				// measured
				voMetrics.setPatient(form.getGlobalContext().Core.getPatientShort());

				voMetrics.setAuthoringInformation(getAuthoringInfo());// wdev-13657

				voVitalSign.setMetrics(voMetrics);
				recordedSigns.add(VSType.METRICS);
			}
		}

		if (recordedSigns.size() == 0)
			screenErrors.add("No Vital Signs values entered");
		else
			voVitalSign.setRecordedSigns(recordedSigns);

		voVitalSign.setAuthoringInformation(getAuthoringInfo());
		// WDEV-12901 set Recording Information
		if (voVitalSign.getRecordingInformation() == null)
		{
			RecordingUserInformationVo voRecordingUserInformation = new RecordingUserInformationVo();
			voRecordingUserInformation.setRecordingUser(form.cmbRecordingHCP().getValue());
			voRecordingUserInformation.setRecordingDateTime(new DateTime());
			voVitalSign.setRecordingInformation(voRecordingUserInformation);
		}

		Date date1 = form.dteTaken().getValue();
		Time time1 = form.timTaken().getValue();

		DateTime dt1 = null;
		if (date1 != null && time1 != null)
			dt1 = new DateTime(date1, time1);

		voVitalSign.setVitalsTakenDateTime(dt1);

		voVitalSign.setClinicalContact(form.getGlobalContext().Core.getCurrentClinicalContact());
		voVitalSign.setCareContext(form.getGlobalContext().Core.getCurrentCareContext());

		String[] arrErrors = voVitalSign.validate();
		String[] arrScreenAndVoErrors = addScreenErrorsToVOErrors(screenErrors, arrErrors);
		if (arrScreenAndVoErrors.length == 0)
		{
			try
			{
				domain.saveVitalSign(voVitalSign);
			}
			catch (StaleObjectException e)
			{
				engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
				refresh();
				return;
			}
		}
		else
		{
			engine.showErrors("Error", arrScreenAndVoErrors);
			return;
		}

		form.setMode(FormMode.VIEW);
		enableBloodSugarControls(false);

		clearScreen();
		form.btnNew().setEnabled(true);
		listVitalSigns();
		// wdev-12905
		enableDisableLinkControls(true);
		updateControlState();
		// ----------

		if (ConfigFlag.UI.USE_EARLY_WARNING_SYSTEM.getValue())
		{
			if (requiresEscalation(voVitalSign))
			{
				if (form.getLocalContext().getSecsRecordIsNotNull() && form.getLocalContext().getSecsRecord().getEWSProtocolIsNotNull())
				{
					engine.showMessage("EWS score is : " + form.getGlobalContext().Core.getVitalSignsEscalationScore(), "Score", MessageButtons.OK, MessageIcon.INFORMATION);
				}
				else
					engine.open(form.getForms().Nursing.SECS);
			}
		}

	}

	private void populateEwsDataFromControls(VitalSignsVo voVitalSign)
	{
		if (!ConfigFlag.UI.USE_EARLY_WARNING_SYSTEM.getValue())
			return;

		// constructing lookup instances from LookupInstVo
		PatientCausingConcern pccLkup = null;
		if (form.cmbPatientConcern().getValue() != null)
			pccLkup = new PatientCausingConcern(form.cmbPatientConcern().getValue().getId(), form.cmbPatientConcern().getValue().getText(), form.cmbPatientConcern().getValue().isActive(), null, null, null);

		voVitalSign.setPatientCausingConcern(pccLkup);

		ConsciousLevel clLkup = null;
		if (form.cmbConscious().getValue() != null)
			clLkup = new ConsciousLevel(form.cmbConscious().getValue().getId(), form.cmbConscious().getValue().getText(), form.cmbConscious().getValue().isActive(), null, null, null);

		voVitalSign.setPatientConscious(clLkup);

		UrineOutput uLkup = null;
		if (form.cmbUrine().getValue() != null)
			uLkup = new UrineOutput(form.cmbUrine().getValue().getId(), form.cmbUrine().getValue().getText(), form.cmbUrine().getValue().isActive(), null, null, null);

		voVitalSign.setUrine2mlkgkhr(uLkup);
	}

	private AuthoringInformationVo getAuthoringInfo()
	{
		AuthoringInformationVo voAuthInfo = form.customControlAuthoringInfo().getValue();
		if (voAuthInfo == null)
			return null;

		if (voAuthInfo.countFieldsWithValue() == 0)
			return null;

		return voAuthInfo;
	}

	private boolean requiresEscalation(VitalSignsVo voVitalSign)
	{
		SECSVo voSecs = form.getLocalContext().getSecsRecord();
		// Boolean bOXYTriggered = false; WDEV-12769

		form.getGlobalContext().Core.setVitalSignsEscalationScore("0");

		if (voSecs == null || voSecs.getConfiguration() == null)
			return false;

		SECSConfigurationVoCollection voCollConfig = voSecs.getConfiguration();
		StringBuffer originsOfScore = new StringBuffer();

		if (voVitalSign.getTemperatureIsNotNull() && voVitalSign.getTemperature().getTemperatureIsNotNull())
		{
			String scoreText = null;
			scoreText = getEscalationScoreText(-1, SECSTypes.TEMPERATURE, voCollConfig, -1, voVitalSign.getTemperature().getTemperature().floatValue());
			if (!scoreText.equals(""))
			{
				originsOfScore.append("Temperature  ");
				originsOfScore.append(scoreText);
			}
		}

		if (voVitalSign.getBloodPressureIsNotNull() && voVitalSign.getBloodPressure().getBPSittingSysIsNotNull())
		{
			String scoreText = null;
			scoreText = getEscalationScoreText(voVitalSign.getBloodPressure().getBPSittingSys().intValue(), SECSTypes.SYSTOLICBP, voCollConfig, -1, -1);
			if (!scoreText.equals(""))
			{
				if (!originsOfScore.equals(""))
					originsOfScore.append("\n");
				originsOfScore.append("Systolic Blood Pressure  ");
				originsOfScore.append(scoreText);
			}
		}

		if (voVitalSign.getBloodPressureIsNotNull() && voVitalSign.getBloodPressure().getBPLyingSysIsNotNull())
		{
			String scoreText = null;
			scoreText = getEscalationScoreText(voVitalSign.getBloodPressure().getBPLyingSys().intValue(), SECSTypes.SYSTOLICBP, voCollConfig, -1, -1);
			if (!scoreText.equals(""))
			{
				if (!originsOfScore.equals(""))
					originsOfScore.append("\n");
				originsOfScore.append("Systolic Blood Pressure  ");
				originsOfScore.append(scoreText);
			}
		}

		if (voVitalSign.getRespiratoryIsNotNull() && voVitalSign.getRespiratory().getRespRateIsNotNull())
		{
			String scoreText = null;
			scoreText = getEscalationScoreText(voVitalSign.getRespiratory().getRespRate().intValue(), SECSTypes.RESPIRATORYRATE, voCollConfig, -1, -1);
			if (!scoreText.equals(""))
			{
				if (!originsOfScore.equals(""))
					originsOfScore.append("\n");
				originsOfScore.append("Respiratory Rate        ");
				originsOfScore.append(scoreText);
			}
		}

		if (voVitalSign.getPulseIsNotNull() && voVitalSign.getPulse().getPulseRateRadialIsNotNull())
		{
			String scoreText = null;
			scoreText = getEscalationScoreText(voVitalSign.getPulse().getPulseRateRadial().intValue(), SECSTypes.PULSE, voCollConfig, -1, -1);
			if (!scoreText.equals(""))
			{
				if (!originsOfScore.equals(""))
					originsOfScore.append("\n");
				originsOfScore.append("Heart Rate                         ");
				originsOfScore.append(scoreText);
			}
		}

		if (voVitalSign.getOxygenSaturationIsNotNull() && voVitalSign.getOxygenSaturation().getOxygenSaturationLevelIsNotNull())// WDEV-12769
		{
			String scoreText = null;
			scoreText = getEscalationScoreText(voVitalSign.getOxygenSaturation().getOxygenSaturationLevel(), SECSTypes.OXYGENSATS, voCollConfig, -1, -1);// WDEV-12769
			if (!scoreText.equals(""))
			{
				if (!originsOfScore.equals(""))
					originsOfScore.append("\n");
				originsOfScore.append("Oxygen Saturation             ");// WDEV-12769
				originsOfScore.append(scoreText);

				// bOXYTriggered = true; WDEV-12769
			}
		}

		if (voVitalSign.getPatientCausingConcernIsNotNull())
		{
			String scoreText = null;
			scoreText = getEscalationScoreText(voVitalSign.getPatientCausingConcern().getID(), SECSTypes.PATIENT_CONCERN, voCollConfig, -1, -1);
			if (!scoreText.equals(""))
			{
				if (!originsOfScore.equals(""))
					originsOfScore.append("\n");
				originsOfScore.append("Patient Causing Concern            ");
				originsOfScore.append(scoreText);
			}
		}

		if (voVitalSign.getPatientConsciousIsNotNull())
		{
			String scoreText = null;
			scoreText = getEscalationScoreText(voVitalSign.getPatientConscious().getID(), SECSTypes.CONSCIOUS_LEVEL, voCollConfig, -1, -1);
			if (!scoreText.equals(""))
			{
				if (!originsOfScore.equals(""))
					originsOfScore.append("\n");
				originsOfScore.append("Conscious Level            ");
				originsOfScore.append(scoreText);
			}
		}

		if (voVitalSign.getUrine2mlkgkhrIsNotNull())
		{
			String scoreText = null;
			scoreText = getEscalationScoreText(voVitalSign.getUrine2mlkgkhr().getID(), SECSTypes.URINE_OUTPUT, voCollConfig, -1, -1);
			if (!scoreText.equals(""))
			{
				if (!originsOfScore.equals(""))
					originsOfScore.append("\n");
				originsOfScore.append("Urine output            ");
				originsOfScore.append(scoreText);
			}
		}

		form.getGlobalContext().Core.setVitalSignsEscalationText(originsOfScore.toString());
		if (form.getGlobalContext().Core.getVitalSignsEscalationScoreIsNotNull())
		{
			if (form.getLocalContext().getSecsRecordIsNotNull() && form.getLocalContext().getSecsRecord().getEWSTriggerScoreIsNotNull())
			{
				if (Integer.valueOf(form.getGlobalContext().Core.getVitalSignsEscalationScore()) >= form.getLocalContext().getSecsRecord().getEWSTriggerScore())
				{
					return true;
				}
			}
		}

		/*
		 * WDEV-12769if (bOXYTriggered) return true;
		 */

		return false;
	}

	/**
	 * takes a value and checks the type against the configuration and
	 * increments score if the value is outside configured values
	 * 
	 * @param value
	 *            (doubles also as id of lookup selected for the lookup config
	 *            items)
	 * @param type
	 * @param voCollConfig
	 * @param fractionRate
	 * @return scoreText
	 */
	private String getEscalationScoreText(int value, SECSTypes type, SECSConfigurationVoCollection voCollConfig, int fractionRate, float tempValue)
	{
		StringBuffer scoreText = new StringBuffer();

		int iScore = 0;

		String score = form.getGlobalContext().Core.getVitalSignsEscalationScore();

		if (score != null)
			iScore = Integer.valueOf(score);

		for (int i = 0; i < voCollConfig.size(); i++)
		{
			if (voCollConfig.get(i).getType().equals(type))
			{
				if (isRange(type))
				{
					if (voCollConfig.get(i).getRangeConfigIsNotNull() && voCollConfig.get(i).getRangeConfig().getRangeScoresIsNotNull())
					{
						for (int p = 0; p < voCollConfig.get(i).getRangeConfig().getRangeScores().size(); p++)
						{
							SECSRangeScoreVo voRangeScore = voCollConfig.get(i).getRangeConfig().getRangeScores().get(p);

							if (type.equals(SECSTypes.TEMPERATURE))
							{
								// temperature
								if (voRangeScore.getGreaterThanDecValueIsNotNull())
								{
									if (voRangeScore.getLessThanDecValueIsNotNull())
									{
										if (tempValue > voRangeScore.getGreaterThanDecValue().floatValue() && tempValue < voRangeScore.getLessThanDecValue().floatValue())
										{
											iScore += voRangeScore.getScore();
											scoreText.append(" > " + voRangeScore.getGreaterThanDecValue() + " < " + voRangeScore.getLessThanDecValue());
										}
									}
									else if (tempValue > voRangeScore.getGreaterThanDecValue().floatValue())
									{
										iScore += voRangeScore.getScore();
										scoreText.append(" > " + voRangeScore.getGreaterThanDecValue());
									}
								}
								else if (voRangeScore.getLessThanDecValueIsNotNull())
								{
									if (voRangeScore.getGreaterThanDecValueIsNotNull())
									{
										if (tempValue < voRangeScore.getLessThanDecValue().floatValue() && tempValue > voRangeScore.getGreaterThanDecValue().floatValue())
										{
											iScore += voRangeScore.getScore();
											scoreText.append(" < " + voRangeScore.getLessThanDecValue() + " > " + voRangeScore.getGreaterThanDecValue());
										}
									}
									else if (tempValue < voRangeScore.getLessThanDecValue().floatValue())
									{
										iScore += voRangeScore.getScore();
										scoreText.append(" < " + voRangeScore.getLessThanDecValue());
									}
								}
							}
							else if (voRangeScore.getGreaterThanIntValueIsNotNull())
							{
								if (voRangeScore.getLessThanIntValueIsNotNull())
								{
									if (value > voRangeScore.getGreaterThanIntValue().intValue() && value < voRangeScore.getLessThanIntValue().intValue())
									{
										iScore += voRangeScore.getScore();
										scoreText.append(" > " + voRangeScore.getGreaterThanIntValue() + " < " + voRangeScore.getLessThanIntValue());
									}
								}
								else if (value > voRangeScore.getGreaterThanIntValue().intValue())
								{
									iScore += voRangeScore.getScore();
									scoreText.append(" > " + voRangeScore.getGreaterThanIntValue());
								}
							}

							else if (voRangeScore.getLessThanIntValueIsNotNull())
							{
								if (voRangeScore.getGreaterThanIntValueIsNotNull())
								{
									if (value < voRangeScore.getLessThanIntValue().intValue() && value > voRangeScore.getGreaterThanIntValue().intValue())
									{
										iScore += voRangeScore.getScore();
										scoreText.append(" < " + voRangeScore.getLessThanIntValue() + " > " + voRangeScore.getGreaterThanIntValue());
									}
								}
								else if (value < voRangeScore.getLessThanIntValue().intValue())
								{
									iScore += voRangeScore.getScore();
									scoreText.append(" < " + voRangeScore.getLessThanIntValue());
								}
							}
						}
					}
				}
				else if (isScore(type))
				{
					if (voCollConfig.get(i).getLookupConfigIsNotNull() && voCollConfig.get(i).getLookupConfig().getLookupScoresIsNotNull())
					{
						for (int p = 0; p < voCollConfig.get(i).getLookupConfig().getLookupScores().size(); p++)
						{
							SECSLookupScoreVo voLookupScore = voCollConfig.get(i).getLookupConfig().getLookupScores().get(p);
							if (value == voLookupScore.getLookupInstance().getID())
							{
								iScore += voLookupScore.getScore();
								scoreText.append(" " + voLookupScore.toString());
							}
						}
					}
				}
				/*
				 * WDEV-12769else // Oxygen { if
				 * (voCollConfig.get(i).getOxygenSatsConfigIsNotNull()) {
				 * SECSOxygenSatsVo voOxygenConfig =
				 * voCollConfig.get(i).getOxygenSatsConfig();
				 * 
				 * if(fractionRate != -1) {
				 * if(voOxygenConfig.getStartNormalRangeOnOxygenIsNotNull() &&
				 * voOxygenConfig.getFractionRateIsNotNull()) { if (value <
				 * voOxygenConfig.getStartNormalRangeOnOxygen() && fractionRate
				 * >= voOxygenConfig.getFractionRate().intValue()) { iScore +=
				 * 3; scoreText.append(" < " +
				 * voOxygenConfig.getStartNormalRangeOnOxygen() + " >= " +
				 * voOxygenConfig.getFractionRate() + " FiO2"); } } } else if
				 * (voOxygenConfig.getStartNormalRangeIsNotNull()) { if (value <
				 * voOxygenConfig.getStartNormalRange()) { iScore += 3;
				 * scoreText.append(" < " + voOxygenConfig.getStartNormalRange()
				 * + " on air"); } } } }
				 */
			}
		}

		form.getGlobalContext().Core.setVitalSignsEscalationScore(String.valueOf(iScore));

		return scoreText.toString();
	}

	private boolean isRange(SECSTypes value)
	{
		return value != null && (value.equals(SECSTypes.PULSE) || value.equals(SECSTypes.RESPIRATORYRATE) || value.equals(SECSTypes.SYSTOLICBP) || value.equals(SECSTypes.TEMPERATURE) || value.equals(SECSTypes.OXYGENSATS));// WDEV-12769
	}

	private boolean isScore(SECSTypes value)
	{
		return value != null && (value.equals(SECSTypes.PATIENT_CONCERN) || value.equals(SECSTypes.URINE_OUTPUT) || value.equals(SECSTypes.CONSCIOUS_LEVEL));
	}

	protected void onBtnCancelClick() throws PresentationLogicException
	{
		clearScreen();
		form.setMode(FormMode.VIEW);
		enableBloodSugarControls(false);
		form.cmbAllRecords().setValue(null);
		form.btnNew().setEnabled(true);
		listVitalSigns();
		// wdev-12905
		enableDisableLinkControls(true);
		updateControlState();
		// ----------
	}

	private void listVitalSigns() throws PresentationLogicException
	{
		form.cmbAllRecords().clear();
		form.getLocalContext().setSelectedVitalSignsVo(null);
		VitalSignsVoCollection voColl = domain.listVitalSigns(form.getGlobalContext().Core.getCurrentCareContext());
		if (voColl != null)
		{
			for (int i = 0; i < voColl.size(); i++)
				form.cmbAllRecords().newRow(voColl.get(i), (voColl.get(i).getAuthoringInformationIsNotNull() && voColl.get(i).getAuthoringInformation().getAuthoringDateTime() != null ? voColl.get(i).getAuthoringInformation().getAuthoringDateTime().toString() : "") + " - " + (voColl.get(i).getAuthoringInformationIsNotNull() && voColl.get(i).getAuthoringInformation().getAuthoringHcp() != null ? voColl.get(i).getAuthoringInformation().getAuthoringHcp().toString() : ""));
		}
		// the latest record must be populated into the combo. Dont want blank
		// row
		if (form.cmbAllRecords().getValue() == null && form.cmbAllRecords().getValues() != null && voColl.size() > 0)
		{
			form.cmbAllRecords().setValue((VitalSignsVo) form.cmbAllRecords().getValues().get(0));
		}

		form.intBPStandingDiastolic().setEnabled(false);
		form.intBPStandingSystolic().setEnabled(false);

		onCmbAllRecordsValueChanged();
	}

	private void displayRecord()
	{
		ArrayList<VSType> vsTypesList = new ArrayList<VSType>();

		clearScreen();
		form.setMode(FormMode.VIEW);

		VitalSignsVo voVitalSign = form.getGlobalContext().Core.getVitalSign();
		form.getLocalContext().setSelectedVitalSignsVo(voVitalSign);

		if (voVitalSign.getAuthoringInformationIsNotNull())
			form.customControlAuthoringInfo().setValue(voVitalSign.getAuthoringInformation());

		if (voVitalSign.getRecordingInformationIsNotNull())
		{
			MemberOfStaffLiteVo mos = voVitalSign.getRecordingInformation().getRecordingUser();
			if (mos != null)
			{
				form.cmbRecordingHCP().newRow(mos, mos.toString());
				form.cmbRecordingHCP().setValue(mos);
			}
			form.dtimRecordingDateTime().setValue(voVitalSign.getRecordingInformation().getRecordingDateTime());
		}

		form.dteTaken().setValue(voVitalSign.getVitalsTakenDateTime() != null ? voVitalSign.getVitalsTakenDateTime().getDate() : null);
		form.timTaken().setValue(voVitalSign.getVitalsTakenDateTime() != null ? voVitalSign.getVitalsTakenDateTime().getTime() : null);

		form.lblEWSScore().setVisible(false);
		if (ConfigFlag.UI.USE_EARLY_WARNING_SYSTEM.getValue())
		{
			form.cmbConscious().setValue(voVitalSign.getPatientConscious());
			form.cmbUrine().setValue(voVitalSign.getUrine2mlkgkhr());
			form.cmbPatientConcern().setValue(voVitalSign.getPatientCausingConcern());

			requiresEscalation(voVitalSign);

			form.lblEWSScore().setVisible(true);
			if (form.getGlobalContext().Core.getVitalSignsEscalationScoreIsNotNull())
				form.lblEWSScore().setValue("EWS Score is : " + form.getGlobalContext().Core.getVitalSignsEscalationScore());
		}

		if (voVitalSign.getTemperature() != null)
		{
			form.decTemp().setValue(voVitalSign.getTemperature().getTemperature());
			vsTypesList.add(VSType.TEMP);
		}

		if (voVitalSign.getPain() != null && voVitalSign.getPain().getPain() != null)
		{
			form.lblScore().setValue("Score = " + voVitalSign.getPain().getPain().getText());
			vsTypesList.add(VSType.PAIN);
		}

		if (voVitalSign.getPulse() != null)
		{
			if (voVitalSign.getPulse().getPulseRateRadial() != null)
				form.intPulseRadial().setValue(voVitalSign.getPulse().getPulseRateRadial());
			if (voVitalSign.getPulse().getPulseRateApex() != null)
				form.intPulseApex().setValue(voVitalSign.getPulse().getPulseRateApex()); // cm
			if (voVitalSign.getPulse().getIsIrregular() != null)
				form.chkIrregular().setValue(voVitalSign.getPulse().getIsIrregular().booleanValue());
			vsTypesList.add(VSType.PULSE);
		}

		if (voVitalSign.getBloodPressure() != null)
		{
			// Siting
			if (voVitalSign.getBloodPressure().getBPSittingSysIsNotNull())
			{
				form.GroupBP().setValue(GenForm.GroupBPEnumeration.rdoBPSitting);
				try
				{
					onRadioButtonGroupBPValueChanged();
				}
				catch (PresentationLogicException e)
				{
					e.printStackTrace();
				}

				form.intBPSittingLyingDiastolic().setValue(new Integer(voVitalSign.getBloodPressure().getBPSittingDias().intValue()));
				form.intBPSittingLyingSystolic().setValue(new Integer(voVitalSign.getBloodPressure().getBPSittingSys().intValue()));
			}
			else
			{

				form.GroupBP().setValue(GenForm.GroupBPEnumeration.rdoBPLyingStanding);
				try
				{
					onRadioButtonGroupBPValueChanged();
				}
				catch (PresentationLogicException e)
				{
					e.printStackTrace();
				}

				// Standing
				if (voVitalSign.getBloodPressure().getBPStandingDias() != null)
					form.intBPStandingDiastolic().setValue(new Integer(voVitalSign.getBloodPressure().getBPStandingDias().intValue()));
				if (voVitalSign.getBloodPressure().getBPStandingSys() != null)
					form.intBPStandingSystolic().setValue(new Integer(voVitalSign.getBloodPressure().getBPStandingSys().intValue()));

				// Lying
				if (voVitalSign.getBloodPressure().getBPLyingDias() != null)
					form.intBPSittingLyingDiastolic().setValue(new Integer(voVitalSign.getBloodPressure().getBPLyingDias().intValue()));
				if (voVitalSign.getBloodPressure().getBPLyingSys() != null)
					form.intBPSittingLyingSystolic().setValue(new Integer(voVitalSign.getBloodPressure().getBPLyingSys().intValue()));
			}

			form.txtComment().setValue(voVitalSign.getBloodPressureIsNotNull() ? voVitalSign.getBloodPressure().getComment() : null); // wdev-12900
			vsTypesList.add(VSType.BP);
		}

		if (voVitalSign.getRespiratory() != null)
		{
			form.intRespirations().setValue(voVitalSign.getRespiratory().getRespRate());
			vsTypesList.add(VSType.RESPIRATION);
		}

		if (voVitalSign.getPupils() != null)
		{
			form.cmbLeftSizePupil().setValue(voVitalSign.getPupils().getPupilLeftSize());
			form.cmbRightSizePupil().setValue(voVitalSign.getPupils().getPupilRightSize());
			form.cmbLeftReactionPupil().setValue(voVitalSign.getPupils().getPupilLeftReaction());
			form.cmbRightReactionPupil().setValue(voVitalSign.getPupils().getPupilRightReaction());

			vsTypesList.add(VSType.PUPILS);
		}

		if (voVitalSign.getLungFunctionTest() != null)
		{
			form.intPeakFlowPre().setValue(voVitalSign.getLungFunctionTest().getPeakFlowPre());
			form.intPeakFlowPost().setValue(voVitalSign.getLungFunctionTest().getPeakFlowPost());
			form.intTimeInterval().setValue(voVitalSign.getLungFunctionTest().getTimeInterval());
			vsTypesList.add(VSType.PEAKFLOW);
		}

		if (voVitalSign.getGlasgowComaScale() != null)
		{
			form.cmbEyeOpening().setValue(voVitalSign.getGlasgowComaScale().getEyeOpening());
			form.cmbMResponse().setValue(voVitalSign.getGlasgowComaScale().getMotorResponse());
			form.cmbVResponse().setValue(voVitalSign.getGlasgowComaScale().getVerbalResponse());
			form.intGCS().setValue(voVitalSign.getGlasgowComaScale().getTotalGlasgowComaScale());

			vsTypesList.add(VSType.GLASGOWCOMASCALE);
		}

		if (voVitalSign.getMetrics() != null)
		{
			form.decHeight().setValue(voVitalSign.getMetrics().getHeightValue());
			form.decWeight().setValue(voVitalSign.getMetrics().getWeightValue());
			vsTypesList.add(VSType.METRICS);
		}

		if (voVitalSign.getBloodSugar() != null)
		{
			if (voVitalSign.getBloodSugar().getType().equals(CBGType.RANDOM))
				form.BloodGlucoseGroup1().setValue(GenForm.BloodGlucoseGroup1Enumeration.rdoRandom);
			else
				form.BloodGlucoseGroup1().setValue(GenForm.BloodGlucoseGroup1Enumeration.rdoCBGM);
			if (voVitalSign.getBloodSugar().getBloodSugarValueIsNotNull())
				form.decValue().setValue(voVitalSign.getBloodSugar().getBloodSugarValue());
			if (voVitalSign.getBloodSugar().getTimePeriodIsNotNull())
				form.cmbTimePeriod().setValue(voVitalSign.getBloodSugar().getTimePeriod());
			if (voVitalSign.getBloodSugar().getPostBloodSugarValueIsNotNull())
				form.decPostValue().setValue(voVitalSign.getBloodSugar().getPostBloodSugarValue());
			if (voVitalSign.getBloodSugar().getTimeIntervalIsNotNull())
				form.intInterval().setValue(voVitalSign.getBloodSugar().getTimeInterval());

			vsTypesList.add(VSType.BLOODSUGAR);

			showBloodGlucoseControls(true, voVitalSign.getBloodSugar().getType().equals(CBGType.CBGM));
		}
		else
			showBloodGlucoseControls(false, false);

		if (voVitalSign.getOxygenSaturation() != null)
		{
			form.intO2Sat().setValue(voVitalSign.getOxygenSaturation().getOxygenSaturationLevel());
			form.chkonFiO2().setValue(voVitalSign.getOxygenSaturation().getIsOnFiO2());
			form.intFractionRate().setValue(voVitalSign.getOxygenSaturation().getFractionRate());
			vsTypesList.add(VSType.OXYGEN);
		}

		if (voVitalSign.getVisualAcuity() != null)
		{
			form.cmbVisualLeft().setValue(retrieveCodeFromID(voVitalSign.getVisualAcuity().getLeftValue()));
			form.cmbVisualRight().setValue(retrieveCodeFromID(voVitalSign.getVisualAcuity().getRightValue()));

			vsTypesList.add(VSType.VISUALACUITY);
		}

		// Code for enabling/disabling relevant links

		VSType[] typeArray = null;
		if (vsTypesList.size() > 0)
		{
			typeArray = new VSType[vsTypesList.size()];
			if (vsTypesList != null)
			{
				for (int i = 0; i < vsTypesList.size(); i++)
				{
					typeArray[i] = (VSType) vsTypesList.get(i);
				}
			}
		}
	}

	private void clearScreen()
	{
		form.cmbConscious().setValue(null);
		form.cmbPatientConcern().setValue(null);
		form.cmbUrine().setValue(null);
		form.lblEWSScore().setValue("");
		form.decTemp().setValue(null);
		form.getLocalContext().setSeverity(null);
		form.intPulseRadial().setValue(null);
		form.intPulseApex().setValue(null);
		form.chkIrregular().setValue(false);
		form.intBPStandingDiastolic().setValue(null);
		form.intBPStandingSystolic().setValue(null);
		form.intBPSittingLyingDiastolic().setValue(null);
		form.intBPSittingLyingSystolic().setValue(null);
		form.intRespirations().setValue(null);
		form.cmbLeftSizePupil().setValue(null);
		form.cmbRightSizePupil().setValue(null);
		form.cmbLeftReactionPupil().setValue(null);
		form.cmbRightReactionPupil().setValue(null);
		form.intPeakFlowPre().setValue(null);
		form.intPeakFlowPost().setValue(null);
		form.intTimeInterval().setValue(null);
		form.cmbEyeOpening().setValue(null);
		form.cmbMResponse().setValue(null);
		form.cmbVResponse().setValue(null);
		form.intGCS().setValue(null);
		form.decHeight().setValue(null);
		form.decWeight().setValue(null);
		form.intO2Sat().setValue(null);
		form.intFractionRate().setValue(null);
		form.chkonFiO2().setValue(false);
		form.cmbVisualLeft().setValue(null);
		form.cmbVisualRight().setValue(null);
		form.customControlAuthoringInfo().setValue(null);
		form.dteTaken().setValue(null);
		form.timTaken().setValue(null);
		form.BloodGlucoseGroup1().setValue(null);
		form.decValue().setValue(null);
		form.cmbTimePeriod().setValue(null);
		form.decPostValue().setValue(null);
		form.intInterval().setValue(null);
		form.lblScore().setValue("Score = ");
		form.txtComment().setValue(null); // wdev-12900
		form.dtimRecordingDateTime().setValue(null);// WDEV-12901
		form.cmbRecordingHCP().setValue(null);// WDEV-12901

		form.decUlna().setValue(new Float(0));// WDEV-14920 //workaround to clear the Decimal Control
		form.decUlna().setValue(null);// WDEV-14920

	}

	VSSnellen retrieveCodeFromText(String text)
	{
		VSSnellenCollection coll = LookupHelper.getVSSnellen(domain.getLookupService());
		VSSnellen type = null;

		for (int i = 0; i < coll.size(); i++)
		{
			type = coll.get(i);
			if (type.getText().equals(text))
				break;
		}

		return type;
	}

	void loadPupilsCombos()
	{
		for (int i = 1; i < 9; i++)
		{
			form.cmbLeftSizePupil().newRow(new Integer(i), String.valueOf(i));
			form.cmbRightSizePupil().newRow(new Integer(i), String.valueOf(i));
		}
		for (int i = 1; i < 6; i++)
			form.cmbVResponse().newRow(new Integer(i), String.valueOf(i));

		for (int i = 1; i < 5; i++)
			form.cmbEyeOpening().newRow(new Integer(i), String.valueOf(i));

		for (int i = 1; i < 7; i++)
			form.cmbMResponse().newRow(new Integer(i), String.valueOf(i));
	}

	private void refresh() throws PresentationLogicException
	{
		clearScreen();
		listVitalSigns();
	}

	protected void onLnkTemperatureClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Core.VitalSignsTemperature);
	}

	protected void onLnkPulseClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Core.VitalSignsPulse);
	}

	protected void onLnkMetricsClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Core.VitalSignsMetrics);
	}

	protected void onLnkPeakFlowClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Core.VitalSignsPeakFlow);
	}

	protected void onLnkOxygenSaturationClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Core.VitalSignsOxygenSaturation);
	}

	protected void onLnkRespirationsClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Core.VitalSignsRespiration);
	}

	protected void onLnkBloodPresureClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Core.VitalSignsBP);
	}

	protected void onLnkGCSClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Core.VitalSignsGCS);
	}

	protected void onLnkPupilsClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Core.VitalSignsPupils);
	}

	protected void onLnkVisualAcuityClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Core.VitalSignsVisualAcuity);
	}

	protected void onLnkBMIClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Core.VitalSignsBMI);
	}

	protected void onCmbEyeOpeningValueChanged() throws PresentationLogicException
	{
		if (form.cmbEyeOpening().getValue() == null)
			return;

		if (form.cmbMResponse().getValue() == null)
			return;

		if (form.cmbVResponse().getValue() == null)
			return;

		form.intGCS().setValue(new Integer(form.cmbEyeOpening().getValue().intValue() + form.cmbMResponse().getValue().intValue() + form.cmbVResponse().getValue().intValue()));
	}

	private Float bodySurfaceArea(Float height/* cm */, Float weight/* kg */)
	{
		if (height == null || weight == null)
			return null;

		// we have to convert the HEIGHT from cm to m as the formula requires m
		return new Float((float) (0.20247 * Math.pow(height.floatValue() / 100.0, 0.725) * Math.pow(weight.floatValue(), 0.425)));
	}

	private Float bodyMassIndex(Float height/* cm */, Float weight/* kg */)
	{
		if (height == null || weight == null)
			return null;

		// we have to convert the HEIGHT from cm to m as the formula requires m
		return new Float((float) (weight.floatValue() / (height.floatValue() / 100.0 * height.floatValue() / 100.0)));
	}

	protected void onCmbMResponseValueChanged() throws PresentationLogicException
	{
		onCmbEyeOpeningValueChanged();
	}

	protected void onCmbVResponseValueChanged() throws PresentationLogicException
	{
		onCmbEyeOpeningValueChanged();
	}

	private VSSnellen retrieveCodeFromID(String id)
	{
		VSSnellenCollection coll = LookupHelper.getVSSnellen(domain.getLookupService());
		VSSnellen type = null;
		Integer val = null;

		try
		{
			val = Integer.valueOf(id);
		}
		catch (NumberFormatException e)
		{
			return null;
		}

		for (int i = 0; i < coll.size(); i++)
		{
			type = coll.get(i);
			if (type.getID() == val.intValue())
				break;
		}

		return type;
	}

	private String[] addScreenErrorsToVOErrors(ArrayList screenErrors, String[] arrErrors)
	{
		String[] arrAllErrors = null;

		if (arrErrors != null)
		{
			arrAllErrors = new String[screenErrors.size() + arrErrors.length];
			for (int i = 0; i < screenErrors.size(); i++)
				arrAllErrors[i] = (String) screenErrors.get(i);

			int i = 0;
			for (int p = screenErrors.size(); p < arrAllErrors.length; p++)
			{
				arrAllErrors[p] = arrErrors[i];
				i++;
			}
		}
		else
		{
			arrAllErrors = new String[screenErrors.size()];

			for (int i = 0; i < screenErrors.size(); i++)
				arrAllErrors[i] = (String) screenErrors.get(i);
		}

		return arrAllErrors;
	}

	private boolean isLoggedInUser()
	{
		MemberOfStaffShortVo memStaffShortVo = (MemberOfStaffShortVo) domain.getMosUser();
		if (memStaffShortVo != null && memStaffShortVo.getHcp() != null)
			return true;

		return false;
	}

	protected void onRadioButtonBloodGlucoseGroup1ValueChanged() throws PresentationLogicException
	{

		form.cmbTimePeriod().setValue(null);
		form.decValue().setValue(Float.valueOf("0.0"));
		form.decValue().setValue(null);
		form.decPostValue().setValue(Float.valueOf("0.0"));
		form.decPostValue().setValue(null);
		form.intInterval().setValue(Integer.valueOf("0"));
		form.intInterval().setValue(null);

		if (form.BloodGlucoseGroup1().getValue().equals(GenForm.BloodGlucoseGroup1Enumeration.rdoRandom))
		{
			showBloodGlucoseControls(true, false);

			form.cmbTimePeriod().setEnabled(false);
			form.decValue().setEnabled(true);
			form.decPostValue().setEnabled(false);
			form.intInterval().setEnabled(false);

		}
		else
		{
			showBloodGlucoseControls(true, true);

			form.cmbTimePeriod().setEnabled(true);
			form.decValue().setEnabled(true);
			form.decPostValue().setEnabled(true);
			form.intInterval().setEnabled(true);
		}
	}

	protected void onLnkCBGMClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Core.VitalSignsBloodSugar);

	}

	protected void onLnkPainLadderClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Core.VitalSignsPainLadder);

	}

	protected void onRadioButtonGroupBPValueChanged() throws PresentationLogicException
	{

		if (form.GroupBP().getValue().equals(GenForm.GroupBPEnumeration.rdoBPSitting))
		{
			form.intBPStandingDiastolic().setVisible(false);
			form.intBPStandingSystolic().setVisible(false);
			form.lblBPErectSlash().setVisible(false);
			form.lblBPSupine().setValue("Sitting");
			form.lblBPErect().setVisible(false);

		}
		else
		{
			form.intBPStandingDiastolic().setVisible(true);
			form.intBPStandingSystolic().setVisible(true);
			if (form.getMode().equals(FormMode.EDIT))
			{
				form.intBPStandingDiastolic().setEnabled(true);
				form.intBPStandingSystolic().setEnabled(true);
			}
			else
			{
				form.intBPStandingDiastolic().setEnabled(false);
				form.intBPStandingSystolic().setEnabled(false);
			}
			form.lblBPErectSlash().setVisible(true);
			form.lblBPSupine().setValue("Lying");
			form.lblBPErect().setVisible(true);
		}

		form.intBPSittingLyingDiastolic().setValue(new Integer(0));
		form.intBPSittingLyingDiastolic().setValue(null);
		form.intBPSittingLyingSystolic().setValue(new Integer(0));
		form.intBPSittingLyingSystolic().setValue(null);
		form.intBPStandingDiastolic().setValue(new Integer(0));
		form.intBPStandingDiastolic().setValue(null);
		form.intBPStandingSystolic().setValue(new Integer(0));
		form.intBPStandingSystolic().setValue(null);
	}

	protected void onImb1Click() throws PresentationLogicException
	{
		setSeverity(PainSeverity.NO_PAIN_AT_ALL);
	}

	protected void onImb2Click() throws PresentationLogicException
	{
		setSeverity(PainSeverity.NORMAL_ACTIVITIES);
	}

	protected void onImb3Click() throws PresentationLogicException
	{
		setSeverity(PainSeverity.MILD_STINGING);
	}

	protected void onImb4Click() throws PresentationLogicException
	{
		setSeverity(PainSeverity.FEW_PROBLEMS);
	}

	protected void onImb5Click() throws PresentationLogicException
	{
		setSeverity(PainSeverity.NOT_BAD);
	}

	protected void onImb6Click() throws PresentationLogicException
	{
		setSeverity(PainSeverity.QUITE_BAD);
	}

	protected void onImb7Click() throws PresentationLogicException
	{
		setSeverity(PainSeverity.CAUSES_DIFICULTIES);
	}

	protected void onImb8Click() throws PresentationLogicException
	{
		setSeverity(PainSeverity.VERY_BAD);
	}

	protected void onImb9Click() throws PresentationLogicException
	{
		setSeverity(PainSeverity.DISABLING);
	}

	protected void onImb10Click() throws PresentationLogicException
	{
		setSeverity(PainSeverity.EXCRUITIATING);

	}

	protected void onImb11Click() throws PresentationLogicException
	{
		setSeverity(PainSeverity.NO_CONTROL);
	}

	private void setSeverity(PainSeverity severity)
	{
		form.lblScore().setValue("Score = " + severity.toString());
		form.getLocalContext().setSeverity(severity);
	}

	private void setPupilstooltip()
	{
		StringBuffer tooltip = new StringBuffer();
		tooltip.append("<table border='0' width='4%' id='table1' bgcolor='#F5FAFF' cellspacing='6'>");
		tooltip.append("<tr>");
		tooltip.append("<td align='center'>");
		tooltip.append("<img border='0' src='" + form.getImages().Core.Pupil_1.getImagePath() + "' width='9' height='11'></td>");
		tooltip.append("<td align='center' width='11'><font face='Arial'>1</font></td>");
		tooltip.append("</tr>");
		tooltip.append("<tr>");
		tooltip.append("<td align='center'>");
		tooltip.append("<img border='0' src='" + form.getImages().Core.Pupil_2.getImagePath() + "' width='12' height='13'></td>");
		tooltip.append("<td align='center' width='11'><font face='Arial'>2</font></td>");
		tooltip.append("</tr>");
		tooltip.append("<tr>");
		tooltip.append("<td align='center'>");
		tooltip.append("<img border='0' src='" + form.getImages().Core.Pupil_3.getImagePath() + "' width='16' height='18'></td>");
		tooltip.append("<td align='center' width='11'><font face='Arial'>3</font></td>");
		tooltip.append("</tr>");
		tooltip.append("<tr>");
		tooltip.append("<td align='center'>");
		tooltip.append("<img border='0' src='" + form.getImages().Core.Pupil_4.getImagePath() + "' width='19' height='20'></td>");
		tooltip.append("<td align='center' width='11'><font face='Arial'>4</font></td>");
		tooltip.append("</tr>");
		tooltip.append("<tr>");
		tooltip.append("<td align='center'>");
		tooltip.append("<img border='0' src='" + form.getImages().Core.Pupil_5.getImagePath() + "' width='21' height='23'></td>");
		tooltip.append("<td align='center' width='11'><font face='Arial'>5</font></td>");
		tooltip.append("</tr>");
		tooltip.append("<tr>");
		tooltip.append("<td align='center'>");
		tooltip.append("<img border='0' src='" + form.getImages().Core.Pupil_6.getImagePath() + "' width='30' height='28'></td>");
		tooltip.append("<td align='center' width='11'><font face='Arial'>6</font></td>");
		tooltip.append("</tr>");
		tooltip.append("<tr>");
		tooltip.append("<td align='center'>");
		tooltip.append("<img border='0' src='" + form.getImages().Core.Pupil_7.getImagePath() + "' width='31' height='33'></td>");
		tooltip.append("<td align='center' width='11'><font face='Arial'>7</font></td>");
		tooltip.append("</tr>");
		tooltip.append("<tr>");
		tooltip.append("<td align='center'>");
		tooltip.append("<img border='0' src='" + form.getImages().Core.Pupil_8.getImagePath() + "' width='30' height='33'></td>");
		tooltip.append("<td align='center' width='11'><font face='Arial'>8</font></td>");
		tooltip.append("</tr>");
		tooltip.append("</table>");

		form.lnkPupils().setTooltip(tooltip.toString());
	}

	protected void onFormModeChanged()
	{
		updateControlState();
	}

	private void updateControlState()
	{
		if (form.getMode().equals(FormMode.EDIT))
		{
			form.intFractionRate().setEnabled(form.chkonFiO2().getValue());
			if (form.chkonFiO2().getValue() == false)
				form.intFractionRate().setValue(null);
		}

		if (ConfigFlag.UI.USE_EARLY_WARNING_SYSTEM.getValue())
		{
			form.cmbConscious().setEnabled(form.getMode().equals(FormMode.EDIT));
			form.cmbPatientConcern().setEnabled(form.getMode().equals(FormMode.EDIT));
			form.cmbUrine().setEnabled(form.getMode().equals(FormMode.EDIT));
		}

		// WDEV-12830 - starts here
		boolean showVitalSigns = ConfigFlag.UI.SHOW_VITAL_SIGNS_METRIC_CONTROLS.getValue();
		form.decHeight().setVisible(showVitalSigns);
		form.decHeight().setEnabled(FormMode.EDIT.equals(form.getMode()));
		form.decWeight().setVisible(showVitalSigns);
		form.decWeight().setEnabled(FormMode.EDIT.equals(form.getMode()));
		form.lblHeight().setVisible(showVitalSigns);
		form.lblWeight().setVisible(showVitalSigns);
		form.lblCms().setVisible(showVitalSigns);
		form.lblKg().setVisible(showVitalSigns);
		form.lnkMetrics().setVisible(showVitalSigns);
		form.lnkBMI().setVisible(showVitalSigns);
		form.lnkMetrics().setEnabled(!FormMode.EDIT.equals(form.getMode()));
		form.lnkBMI().setEnabled(!FormMode.EDIT.equals(form.getMode()));
		// WDEV-12830 - ends here

		// WDEV-14920
		form.lblUlnaUnit().setVisible(FormMode.EDIT.equals(form.getMode()) && ims.configuration.gen.ConfigFlag.DOM.USE_ULNA_TO_ESTIMATE_PATIENT_HEIGHT.getValue());
		form.lblUlna().setVisible(FormMode.EDIT.equals(form.getMode()) && ims.configuration.gen.ConfigFlag.DOM.USE_ULNA_TO_ESTIMATE_PATIENT_HEIGHT.getValue());
		form.decUlna().setVisible(FormMode.EDIT.equals(form.getMode()) && ims.configuration.gen.ConfigFlag.DOM.USE_ULNA_TO_ESTIMATE_PATIENT_HEIGHT.getValue());
		form.btnCalculateHeight().setVisible(FormMode.EDIT.equals(form.getMode()) && ims.configuration.gen.ConfigFlag.DOM.USE_ULNA_TO_ESTIMATE_PATIENT_HEIGHT.getValue());
		
		Integer patAge = form.getGlobalContext().Core.getPatientShort().getAge();
		Sex patSex = form.getGlobalContext().Core.getPatientShort().getSex();
	
		form.decUlna().setEnabled(patAge != null && patSex != null && (patSex.equals(ims.core.vo.lookups.Sex.MALE) || patSex.equals(ims.core.vo.lookups.Sex.FEMALE)));
		form.btnCalculateHeight().setEnabled(patAge != null && patSex != null && (patSex.equals(ims.core.vo.lookups.Sex.MALE) || patSex.equals(ims.core.vo.lookups.Sex.FEMALE)));
		
		form.customControlAuthoringInfo().setIsRequiredPropertyToControls(FormMode.EDIT.equals(form.getMode()));//WDEV-17261
	}

	protected void onChkonFiO2ValueChanged() throws PresentationLogicException
	{
		updateControlState();
	}

	protected void onFormDialogClosed(ims.framework.FormName formName, DialogResult result) throws PresentationLogicException
	{
		form.getGlobalContext().Assessment.setForceCompletion(false);

		if (formName != null)
		{
			if (formName.equals(form.getForms().Assessment.DynamicAssessmentsDialog))
			{
				if (result != null && result.equals(DialogResult.OK))
					saveEWS();
			}
		}
	}

	private void saveEWS()
	{
		PatientEWSVo voPatEws = new PatientEWSVo();

		// WDEV-12215
		if (form.getGlobalContext().Core.getPatient_AssessmentFull() != null)
			voPatEws.setPatientAssessment(domain.getPatientAssessmentFull(form.getGlobalContext().Core.getPatient_AssessmentFull()));

		voPatEws.setVitalSign(form.getGlobalContext().Core.getVitalSign());
		voPatEws.setSECSScore(form.getGlobalContext().Core.getVitalSignsEscalationScoreIsNotNull() ? new Integer(form.getGlobalContext().Core.getVitalSignsEscalationScore()) : null);
		voPatEws.setScoreDetails(form.getGlobalContext().Core.getVitalSignsEscalationText());
		voPatEws.setCareContext(form.getGlobalContext().Core.getCurrentCareContext());

		domain.savePatientEws(voPatEws);
	}

	@Override
	protected void onMessageBoxClosed(int messageBoxId, DialogResult result) throws PresentationLogicException
	{
		form.getGlobalContext().Assessment.setIsDynamicAssessmentOpenedForPreview(false);
		form.getGlobalContext().Assessment.setForceCompletion(true);

		engine.open(form.getForms().Assessment.DynamicAssessmentsDialog, new Object[] { form.getLocalContext().getSecsRecord().getEWSProtocol() }, "EWS Assessment", false);
	}

	// wdev-12905
	private void enableDisableLinkControls(Boolean enabledisable)
	{
		form.lnkBloodPresure().setEnabled(enabledisable);
		form.lnkBMI().setEnabled(enabledisable);
		form.lnkCBGM().setEnabled(enabledisable);
		form.lnkGCS().setEnabled(enabledisable);
		form.lnkMetrics().setEnabled(enabledisable);
		form.lnkOxygenSaturation().setEnabled(enabledisable);
		form.lnkPainLadder().setEnabled(enabledisable);
		form.lnkPeakFlow().setEnabled(enabledisable);
		form.lnkPulse().setEnabled(enabledisable);
		form.lnkPupils().setEnabled(enabledisable);
		form.lnkRespirations().setEnabled(enabledisable);
		form.lnkTemperature().setEnabled(enabledisable);
		// form.lnkVisualAcuity().setVisible(false);
		// form.lnkVisualAcuity().setEnabled(enabledisable);
	}

	// ------------

	// WDEV-14920
	@Override
	protected void onBtnCalculateHeightClick() throws PresentationLogicException
	{
		if (form.decHeight().getValue()!=null)
		{
			engine.showMessage("A value for Height already exist.\nHeight field should be empty to be able to calculate it using ULNA radius.");
			form.decUlna().setValue(null);
			return;
		}
		
		if (form.decUlna().getValue() == null)
		{
			engine.showMessage("Please enter the value for ULNA to calculate the Height");
			return;
		}

		Integer patAge = form.getGlobalContext().Core.getPatientShort().getAge();
		Sex patSex = form.getGlobalContext().Core.getPatientShort().getSex();

		if (patAge != null && patSex != null && (patSex.equals(ims.core.vo.lookups.Sex.MALE) || patSex.equals(ims.core.vo.lookups.Sex.FEMALE)))
		{
			Float heights = domain.getHeight(form.decUlna().getValue().toString(), patAge, patSex);

			if (heights == null)
			{
				engine.showMessage("Please enter a valid value for ULNA");
				return;
			}

			form.decHeight().setValue(heights);

		}
		else
		{
			engine.showMessage("When calculating the Height using ULNA radius the patient age and sex are mandatory!");
		}

	}
}
