//#############################################################################
//#                                                                           #
//#  Copyright (C) <2014>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Calin Perebiceanu using IMS Development Environment (version 1.71 build 3832.22959)
// Copyright (C) 1995-2010 IMS MAXIMS. All rights reserved.

package ims.core.forms.custompatientlist;

import ims.configuration.gen.ConfigFlag;
import ims.core.forms.custompatientlist.GenForm.grdDetailsRow;
import ims.core.resource.people.vo.MemberOfStaffRefVo;
import ims.core.vo.CustomListSearchCriteriaVo;
import ims.core.vo.CustomListVo;
import ims.core.vo.CustomListVoCollection;
import ims.core.vo.MemberOfStaffLiteVo;
import ims.core.vo.PatientCustomItemVo;
import ims.core.vo.PatientCustomItemVoCollection;
import ims.core.vo.PatientCustomListVo;
import ims.core.vo.PatientShort;
import ims.core.vo.lookups.CustomListType;
import ims.core.vo.lookups.PatIdType;
import ims.domain.exceptions.ForeignKeyViolationException;
import ims.domain.exceptions.StaleObjectException;
import ims.framework.FormName;
import ims.framework.MessageButtons;
import ims.framework.MessageIcon;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.SortOrder;
import ims.framework.exceptions.PresentationLogicException;
import ims.framework.utils.Date;

import java.util.ArrayList;
import java.util.List;

public class Logic extends BaseLogic
{
	private static final long serialVersionUID = 1L;

	@Override
	protected void onFormOpen(Object[] args) throws ims.framework.exceptions.PresentationLogicException
	{
		initialise();
		listCustomLists();
		refreshSearchCriteria();
	}
	
	private void refreshSearchCriteria() 
	{
		if (form.getGlobalContext().Core.getCustomListSearchCriteriaVoIsNotNull())
		{
			if ( ! form.cmbCustomLists().getValues().isEmpty())
			{
				for(int i = 0 ; i < form.cmbCustomLists().getValues().size() ; i++)
				{
					if (form.cmbCustomLists().getValues() != null
						&& form.getGlobalContext().Core.getCustomListSearchCriteriaVo().getCustomListRefIsNotNull()
						&& form.cmbCustomLists().getValues().get(i) != null
						&& ((CustomListVo)form.cmbCustomLists().getValues().get(i)).getID_CustomList().equals(form.getGlobalContext().Core.getCustomListSearchCriteriaVo().getCustomListRef().getID_CustomList()))
					{
						form.cmbCustomLists().setValue(((CustomListVo)form.cmbCustomLists().getValues().get(i)));
						
						//if(domain.getHcpLiteUser()!=null)//WDEV-9696 
						//{
						    form.imbRemoveList().setEnabled(true);
						//}
						
						search();
						
						break;
					}
				}
			}
		}
	}

	private void listCustomLists()
	{
		form.cmbCustomLists().clear();
		form.grdDetails().getRows().clear();

		updateMenuState();
		updateButtonState();

		CustomListVoCollection voColl = domain.listCustomLists((MemberOfStaffRefVo) domain.getMosUser());
		if (voColl != null && voColl.size() > 0 )
		{
			for (int i = 0 ; i < voColl.size() ; i++)
				form.cmbCustomLists().newRow(voColl.get(i), voColl.get(i).getListName());
		}
	}

	private void initialise() 
	{
		updateMenuState();
		updateButtonState();
		
		// WDEV-16083 Use display patid type, otherwise if not set, use NHS Number as was previous
		String patidColHeader="NHS Number";
		PatIdType dispIdType = PatIdType.getNegativeInstance(ConfigFlag.UI.DISPLAY_PATID_TYPE.getValue());
		if(dispIdType != null)
			patidColHeader=dispIdType.getText();
		form.grdDetails().setColPatIdCaption(patidColHeader);

	}

	private void updateMenuState()
	{
		form.getContextMenus().Core.hideAllRCHTCustomListMenuMenuItems();
		form.getContextMenus().Core.getRCHTCustomListMenuSELECTItem().setVisible(form.grdDetails().getValue() != null);
		form.getContextMenus().Core.getRCHTCustomListMenuSELECTItem().setEnabled(form.grdDetails().getValue() != null);
		form.getContextMenus().Core.getRCHTCustomListMenuREMOVEItem().setVisible(form.grdDetails().getValue() != null && form.cmbCustomLists().getValue() != null && form.cmbCustomLists().getValue().getListOwnerIsNotNull() && form.cmbCustomLists().getValue().getListOwner().equals((MemberOfStaffLiteVo)domain.getMosUser()));
		form.getContextMenus().Core.getRCHTCustomListMenuREMOVEItem().setEnabled(form.grdDetails().getValue() != null && form.cmbCustomLists().getValue() != null && form.cmbCustomLists().getValue().getListOwnerIsNotNull() && form.cmbCustomLists().getValue().getListOwner().equals((MemberOfStaffLiteVo)domain.getMosUser()));
	}

	private void updateButtonState()
	{		
		//WDEV-14238 
		if(!ConfigFlag.UI.CUSTOM_PATIENT_LIST_ACCESS_TYPE.getValue().equals("HCP")) 
			form.imbNewCustomList().setEnabled(true);
		
		form.imbRemoveList().setEnabled(form.cmbCustomLists().getValue() != null );	
	}

	private void search() 
	{
		form.grdDetails().getRows().clear();
		if (form.cmbCustomLists().getValue() != null)
		{
			PatientCustomListVo voPCL = domain.getPatientCustomList(form.cmbCustomLists().getValue());
			
			if (voPCL != null)
			{
				voPCL.getListEntry().sort();
				populateGrid(voPCL.getListEntry());
			}
		}
	}

	private void populateGrid(PatientCustomItemVoCollection listEntry) 
	{
	
		for ( int i = 0 ; listEntry != null && i < listEntry.size() ; i++)
		{
			addGridRow(listEntry.get(i));
		}
	}

	private void addGridRow(PatientCustomItemVo voItem)
	{
		grdDetailsRow row = form.grdDetails().getRows().newRow();
		
		PatientShort ps = voItem.getPatient();
		
		if ( (ps.getIsActiveIsNotNull() && ps.getIsActive()) 
				|| ps.getAssociatedPatientIsNotNull())
		{
			row.setColSurname(ps.getNameIsNotNull() ? ps.getName().getSurname() : ""); 		
			row.setColForename(ps.getNameIsNotNull() ? ps.getName().getForename() : ""); 		
			
			// WDEV-16083 - display PatientIdType for the DISPLAY_PATID_TYPE flag rather than hardcoding to NHS Number
			PatIdType dispIdType = PatIdType.getNegativeInstance(ConfigFlag.UI.DISPLAY_PATID_TYPE.getValue());
			row.setColPatId(ps.getPatId(dispIdType) != null ? (ps.getPatId(dispIdType).getValueIsNotNull() ? ps.getPatId(dispIdType).getValue().toString() : "") : ""); 		
			row.setColSex(ps.getSexIsNotNull() ? ps.getSex().toString() : ""); 		
			row.setColAge(ps.getDobIsNotNull() ? ps.calculateAge().toString() : ""); 		
			row.setColDOB(ps.getDobIsNotNull() ? ps.getDob().toString() : ""); 		
			row.setColAddedBy(voItem.getAddedByIsNotNull() ? voItem.getAddedBy().getName().toString() : ""); 		
			row.setColDateTime(voItem.getAddedDateTimeIsNotNull() ? voItem.getAddedDateTime().toString() : "");
			
			tickCol(row, voItem);
		
			if(voItem.getPatient().getAssociatedPatientIsNotNull())
				row.setBackColor(ConfigFlag.UI.MERGED_COLOUR.getValue());
				
			if (voItem.getPatient().getIsDead().booleanValue())
				row.setBackColor(ConfigFlag.UI.RIP_COLOUR.getValue());			

			row.setValue(voItem);
		}
	}

	private void tickCol(grdDetailsRow row, PatientCustomItemVo voItem) 
	{
		if (form.getGlobalContext().Core.getCustomListSearchCriteriaVoIsNotNull())
		{
			CustomListSearchCriteriaVo voCurrent = form.getGlobalContext().Core.getCustomListSearchCriteriaVo();
			for (int i = 0; voCurrent != null && i < voCurrent.getViewedItems().length; i++)
			{
				if (voCurrent.getViewedItems()[i] != null && voCurrent.getViewedItems()[i].equals(voItem.getPatient().getID_Patient()))
				{
					row.setColViewed(form.getImages().Core.Tick);
					row.setTooltipForColViewed("Patient viewed");//WDEV-14694
				}
			}
		}
	}

	@Override
	protected void onGrdDetailsSelectionChanged()
	{
		updateMenuState();
	}
	
	@Override
	protected void onContextMenuItemClick(int menuItemID, ims.framework.Control sender) throws ims.framework.exceptions.PresentationLogicException
	{
		switch (menuItemID)
		{
		case GenForm.ContextMenus.CoreNamespace.RCHTCustomListMenu.REMOVE:
			engine.showMessage("Are you sure you want to remove this patient from the list?", "Remove Patient", MessageButtons.YESNO, MessageIcon.QUESTION);
			form.getLocalContext().setLastMessageBox(1);
			break;
		case GenForm.ContextMenus.CoreNamespace.RCHTCustomListMenu.SELECT:
			selectPatient();
			break;
		}	
	}
	
	private void selectPatient() 
	{
		if(form.grdDetails().getSelectedRow() == null)
			return;
		
		if ( form.grdDetails().getSelectedRow().getValue() instanceof PatientCustomItemVo) 
		{
			form.getGlobalContext().Core.clearPatientShort();
		
			PatientShort ps = ((PatientCustomItemVo)form.grdDetails().getSelectedRow().getValue()).getPatient();
			form.getGlobalContext().Core.setPatientToBeDisplayed(ps);
			
			updateSearchCriteriaGC(ps.getID_Patient(), true);

			engine.open(ConfigFlag.UI.DEMOGRAPHICS_FORM.getValue());
		}
	}

	private void updateSearchCriteriaGC(Integer patient, boolean bAdd) 
	{
		if (form.getGlobalContext().Core.getCustomListSearchCriteriaVo() == null)
		{
			CustomListSearchCriteriaVo voNew = new CustomListSearchCriteriaVo();
			voNew.setCustomListRef(form.cmbCustomLists().getValue());
			
			Integer[] intValues = new Integer[1];
			intValues[0] = patient;
			voNew.setViewedItems(intValues);

			form.getGlobalContext().Core.setCustomListSearchCriteriaVo(voNew);
			return;
		}
		
		CustomListSearchCriteriaVo voCurrent = form.getGlobalContext().Core.getCustomListSearchCriteriaVo();
		
		List<Integer> ids = new ArrayList<Integer>();
		boolean bAlreadyInlist = false;
		for (int i = 0; voCurrent != null && i < voCurrent.getViewedItems().length; i++)
		{
			if (voCurrent.getViewedItems().equals(patient)
				&& !bAdd)
				continue;
			else if ( ! voCurrent.getViewedItems().equals(patient))
				ids.add(voCurrent.getViewedItems()[i]);
			else if ( voCurrent.getViewedItems().equals(patient)
					&& bAdd)
				bAlreadyInlist = true;
		}
		if ( ! bAlreadyInlist && bAdd)
			ids.add(patient);
		
		if (ids.size() > 0)
		{
			Integer[] intValues = new Integer[ids.size()];
			ids.toArray(intValues);
			form.getGlobalContext().Core.getCustomListSearchCriteriaVo().setViewedItems(intValues);
		}
	}

	private void removePatient()
	{
		if (form.cmbCustomLists().getValue() != null
			&& form.grdDetails().getSelectedRow() != null)
		{
			PatientCustomListVo voWorkList = domain.getPatientCustomList(form.cmbCustomLists().getValue());
			voWorkList.getListEntry().remove(form.grdDetails().getSelectedRow().getValue());

			if (voWorkList.getListEntry().size() == 0)
			{
				voWorkList.setListEntry(null);
				try 
				{
					domain.deleteCustomList(voWorkList);
				} 
				catch (StaleObjectException e) 
				{
					engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
					return;
				} 
				catch (ForeignKeyViolationException e) 
				{
					engine.showMessage(e.toString());
					return;
				}
				search();
				return;
			}

			updateSearchCriteriaGC(form.grdDetails().getSelectedRow().getValue().getPatient().getID_Patient(), false);

			String[] errors = voWorkList.validate();
			if (errors != null)
			{
				engine.showErrors(errors);
				return;
			}
				
			try 
			{
				domain.savePatientCustomList(voWorkList);
			} 
			catch (StaleObjectException e) 
			{
				engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
				return;
			} 
		}
		search();
	}

	@Override
	protected void onFormDialogClosed(FormName formName, DialogResult result) throws PresentationLogicException 
	{
		if (formName.equals(form.getForms().Core.NewCustomListDialog)
			&& result.equals(DialogResult.OK))
			saveNewCustomList();
		else if (formName.equals(form.getForms().Core.AddToCustomListDialog)
			&& result.equals(DialogResult.OK))
			onCmbCustomListsValueChanged();
	}

	private void saveNewCustomList() 
	{
		CustomListVo voCL = new CustomListVo();
		
		voCL.setListType(CustomListType.CUSTOM_PATIENT_LIST);
		voCL.setListName(form.getGlobalContext().Core.getCustomListName());
		voCL.setDate(new Date());
		voCL.setIsActive(true);
		voCL.setListOwner((MemberOfStaffLiteVo) domain.getMosUser());
		
		String[] errors = voCL.validate();
		if (errors != null)
		{
			engine.showErrors(errors);
			return;
		}
		
		try 
		{
			domain.saveCustomList(voCL);
		} 
		catch (StaleObjectException e) 
		{
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			return;
		} 
		listCustomLists();
	}
	@Override
	protected void onMessageBoxClosed(int messageBoxId, DialogResult result) throws PresentationLogicException 
	{
		if(form.getLocalContext().getErrorMessageIsNotNull() && form.getLocalContext().getErrorMessage() == messageBoxId)
		{
			if(DialogResult.OK.equals(result))
				engine.close(DialogResult.ABORT);
		}
		
		if (result.equals(DialogResult.YES) 
			&& form.getLocalContext().getLastMessageBoxIsNotNull() 
			&& form.getLocalContext().getLastMessageBox().equals(2))
			removeCustomList();

		if (result.equals(DialogResult.YES) 
			&& form.getLocalContext().getLastMessageBoxIsNotNull() 
			&& form.getLocalContext().getLastMessageBox().equals(1))
			removePatient();

		updateMenuState();
		updateButtonState();
	}
	
	private void removeCustomList() 
	{
		CustomListVo voCL = form.cmbCustomLists().getValue();
			
		voCL.setIsActive(false);
			
		String[] errors = voCL.validate();
		if (errors != null)
		{
			engine.showErrors(errors);
			return;
		}
			
		try 
		{
			domain.saveCustomList(voCL);
		} 
		catch (StaleObjectException e) 
		{
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			return;
		}
		listCustomLists();
		
		updateButtonState();
	}

	@Override
	protected void onImbRemoveListClick() throws PresentationLogicException 
	{
		if(ConfigFlag.UI.CUSTOM_PATIENT_LIST_ACCESS_TYPE.getValue().equals("HCP"))//WDEV-14238 
		{
			if(domain.getHcpLiteUser()==null)//WDEV-9696 
			{			
				form.getLocalContext().setErrorMessage(engine.showMessage("Operation not allowed. User is not HCP.", "", MessageButtons.OK, MessageIcon.INFORMATION));
				return;
			}
		}
		engine.showMessage("Are you sure you want to inactivate the '" + form.cmbCustomLists().getValue().getListName() + "' Custom list ?", "Are you sure?", MessageButtons.YESNO, MessageIcon.QUESTION);;
		form.getLocalContext().setLastMessageBox(2);
		
		
	}

	@Override
	protected void onImbNewCustomListClick() throws PresentationLogicException 
	{
		if(ConfigFlag.UI.CUSTOM_PATIENT_LIST_ACCESS_TYPE.getValue().equals("HCP"))//WDEV-14238 
		{
			if(domain.getHcpLiteUser()==null) //WDEV-9696 
			{
				form.getLocalContext().setErrorMessage(engine.showMessage("Operation not allowed. User is not HCP.", "", MessageButtons.OK, MessageIcon.INFORMATION));
				return;
			}
		}
			engine.open(form.getForms().Core.NewCustomListDialog);
		}

	@Override
	protected void onCmbCustomListsValueChanged() throws PresentationLogicException 
	{
		form.getGlobalContext().Core.setCustomListSearchCriteriaVo(null);
		search();
		updateSearchCriteriaGC(-1, true);
		updateMenuState();
		updateButtonState();
	}

	@Override
	protected void onGrdDetailsGridHeaderClicked(int column) throws PresentationLogicException 
	{
		if (column == 8)
		{
			if (form.getLocalContext().getSortOrder() == null)
			{
				form.getLocalContext().setSortOrder(SortOrder.ASCENDING);
			}

			PatientCustomItemVoCollection voColl = form.grdDetails().getValues();
			voColl.sort(PatientCustomItemVo.getDateTimeComparator(form.getLocalContext().getSortOrder()));

			if (form.getLocalContext().getSortOrder().equals(SortOrder.ASCENDING))
				form.getLocalContext().setSortOrder(SortOrder.DESCENDING);
			else if (form.getLocalContext().getSortOrder().equals(SortOrder.DESCENDING))
				form.getLocalContext().setSortOrder(SortOrder.ASCENDING);

			form.grdDetails().getRows().clear();
			populateGrid(voColl);
		}
	}
}
