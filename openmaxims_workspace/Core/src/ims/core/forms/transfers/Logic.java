//#############################################################################
//#                                                                           #
//#  Copyright (C) <2014>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Peter Martin using IMS Development Environment (version 1.66 build 3261.22124)
// Copyright (C) 1995-2008 IMS MAXIMS plc. All rights reserved.

package ims.core.forms.transfers;

import ims.configuration.gen.ConfigFlag;
import ims.core.resource.place.vo.LocationRefVo;
import ims.core.vo.HcpFilter;
import ims.core.vo.HcpLiteVo;
import ims.core.vo.HcpLiteVoCollection;
import ims.core.vo.InpatientEpisodeVo;
import ims.core.vo.InpatientEpisodeVoCollection;
import ims.core.vo.LocMostVo;
import ims.core.vo.LocationLiteVo;
import ims.core.vo.LocationLiteVoCollection;
import ims.core.vo.PatientAlertLiteVo;
import ims.core.vo.PatientShort;
import ims.core.vo.PendingTransfersFilterVo;
import ims.core.vo.PendingTransfersVo;
import ims.core.vo.PendingTransfersVoCollection;
import ims.core.vo.PersonName;
import ims.core.vo.WardStayVo;
import ims.core.vo.lookups.AlertType;
import ims.core.vo.lookups.HcpDisType;
import ims.core.vo.lookups.LocationType;
import ims.core.vo.lookups.LookupHelper;
import ims.core.vo.lookups.PatIdType;
import ims.domain.exceptions.DomainInterfaceException;
import ims.domain.exceptions.StaleObjectException;
import ims.framework.Control;
import ims.framework.FormName;
import ims.framework.MessageButtons;
import ims.framework.MessageIcon;
import ims.framework.cn.data.TreeNode;
import ims.framework.controls.DynamicGridCell;
import ims.framework.controls.DynamicGridColumn;
import ims.framework.controls.DynamicGridRow;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.DynamicCellType;
import ims.framework.enumerations.SortMode;
import ims.framework.enumerations.SortOrder;
import ims.framework.exceptions.PresentationLogicException;
import ims.vo.LookupInstVo;

import java.util.ArrayList;
import java.util.Comparator;

public class Logic extends BaseLogic
{
	/**
	 * WDEV-13135
	 * @author George Josan
	 *	Comparator for manual sorting after request date time (InpatientEpisode records)
	 */
	private static class InpatientEpisodeRequestDateTimeCompartor implements Comparator<InpatientEpisodeVo>
	{
		private int direction;

		public InpatientEpisodeRequestDateTimeCompartor(SortOrder sortOrder)
		{
			if (SortOrder.ASCENDING.equals(sortOrder))
				direction = 1;
			else
				direction = -1;
		}

		public int compare(InpatientEpisodeVo o1, InpatientEpisodeVo o2)
		{
			if (o1.getWardStaysIsNotNull() && o1.getWardStays().size() > 1 && o2.getWardStaysIsNotNull() && o2.getWardStays().size() > 1)
			{
				// Sort ward stays
				o1.getWardStays().sort(WardStayVo.getWardStayVoIdComparator());
				o2.getWardStays().sort(WardStayVo.getWardStayVoIdComparator());
				
				WardStayVo previousStay1 = o1.getWardStays().get(1);
				WardStayVo previousStay2 = o2.getWardStays().get(1);
				
				return previousStay1.getTransferDateTime().compareTo(previousStay2.getTransferDateTime()) * direction;
			}
			
			if (o1.getWardStaysIsNotNull() && o1.getWardStays().size() > 1 && (!o2.getWardStaysIsNotNull() || o2.getWardStays().size() <= 1))
			{
				return direction;
			}
			
			if ((!o1.getWardStaysIsNotNull() || o1.getWardStays().size() <= 1) && o2.getWardStaysIsNotNull() && o2.getWardStays().size() > 1)
			{
				return -1 * direction;
			}

			return 0;
		}

	}

	/**
	 * WDEV-13136
	 * @author George Josan
	 *	Comparator for manual sorting after request date time (PendingTransfer records)
	 */
	private static class PendingTransferRequestDateTimeCompartor implements Comparator<PendingTransfersVo>
	{
		private int direction;
		
		public PendingTransferRequestDateTimeCompartor(SortOrder sortOrder)
		{
			if (SortOrder.ASCENDING.equals(sortOrder))
				direction = 1;
			else
				direction = -1;
		}

		public int compare(PendingTransfersVo o1, PendingTransfersVo o2)
		{
			if (o1.getTransferRequestDateTimeIsNotNull() && o2.getTransferRequestDateTimeIsNotNull())
			{
				return o1.getTransferRequestDateTime().compareTo(o2.getTransferRequestDateTime()) * direction;
			}
			
			if (o1.getTransferRequestDateTimeIsNotNull() && !o2.getTransferRequestDateTimeIsNotNull())
			{
				return direction;
			}
			
			if (!o1.getTransferRequestDateTimeIsNotNull() && o2.getTransferRequestDateTimeIsNotNull())
			{
				return -1 * direction;
			}

			return 0;
		}

	}
	
	
	/**
	 * WDEV-13136
	 * @author George Josan
	 *	Comparator for manual sorting after request date time (PendingTransfer records)
	 */
	private static class AlertCompartor implements Comparator<PendingTransfersVo>
	{
		private int direction;
		
		public AlertCompartor(SortOrder sortOrder)
		{
			if (SortOrder.ASCENDING.equals(sortOrder))
				direction = 1;
			else
				direction = -1;
		}

		public int compare(PendingTransfersVo o1, PendingTransfersVo o2)
		{
			if (o1.getInpatientEpisode()!= null && o1.getInpatientEpisode().getPasEvent()!= null && 
				o1.getInpatientEpisode().getPasEvent().getPatient() != null && 
				o2.getInpatientEpisode()!= null && o2.getInpatientEpisode().getPasEvent()!= null && 
				o2.getInpatientEpisode().getPasEvent().getPatient() != null)
			{
				Integer val1 = Boolean.TRUE.equals(o1.getActiveAlerts()) ? 1 : 0;
				Integer val2 = Boolean.TRUE.equals(o2.getActiveAlerts()) ? 1 : 0;
				
				if (val1 != 0 && val2 != 0)
				{
					return val1.compareTo(val2) * direction;
				}

				if (val1 != 0 && val2 == 0)
				{
					return direction;
				}

				if (val2 != 0 && val1 == 0)
				{
					return -1 * direction;
				}	
			}

		return 0;
		}
	}

	public static final Integer	COLSURNAME			= new Integer(0);
	public static final Integer	COLFORENAME			= new Integer(1);
	public static final Integer	COLHOSPNUM			= new Integer(-1);
	public static final Integer	COLSEX				= new Integer(-3);
	public static final Integer	COLALERT			= new Integer(-4);
	public static final Integer	COLCONSULTANT		= new Integer(-5);
	public static final Integer	COLCURRENTWARD		= new Integer(-6);
	public static final Integer	COLOTHERWARD		= new Integer(-7);
	public static final Integer	COLREQUESTDATE		= new Integer(-8);
	public static final Integer	COLCOMMENTS			= new Integer(-9);
	public static final Integer	COLDATETIME			= new Integer(-10);

	private static final long	serialVersionUID	= 1L;

	@Override
	protected void onFormOpen(Object[] args) throws ims.framework.exceptions.PresentationLogicException
	{
		initialise();
	}
	
	
	@Override
	/**
	 * WDEV-13136
	 * Event handler for column header clicked
	 */
	protected void onDyngrdPatientsColumnHeaderClicked(DynamicGridColumn column)
	{
		if (form.Tranfers().getValue().equals(GenForm.TranfersEnumeration.rdoPendingTransfers))
		{
			sortPendingTansferRecords(column.getIdentifier());
		}
		else
		{
			// Sort records after values on column which header was clicked
			sortInpatientEpisodeRecords(column.getIdentifier());
		}

		// Update controls & context menu options
		updateContextMenusState();
	}

	
	/**
	 * WDEV-13136
	 * Function used to sort records (PendingTransfers) after values on column which header was clicked 
	 */
	private void sortPendingTansferRecords(Object columnIdentifier)
	{
		// Get records from grid
		PendingTransfersVoCollection records = populatePendingTransferRecordsFromGrid();
		
		// Toggle sort order for column
		sortOrderToggle(columnIdentifier);
		
		// Sort records by column
		if (COLDATETIME.equals(columnIdentifier))
		{
			records.sort(new PendingTransferRequestDateTimeCompartor(form.getLocalContext().getSortOrderRequestDate()));
		}
		
		else if (COLALERT.equals(columnIdentifier))
		{
			records.sort(new AlertCompartor(form.getLocalContext().getSortOrderAlerts()));
		}
		
		// Get current selection
		Object selectedRecord = form.dyngrdPatients().getValue();
		// Populate records to grid
		populatePendingTransferRecordsToGrid(records);
		// Reselect record
		form.dyngrdPatients().setValue(selectedRecord);
		// Call code for new selection
		updateGlobalContextPatientSelection(form.dyngrdPatients().getValue());
	}


	/**
	 * WDEV-13136
	 * Function used to retrieve records (PatientTransfers) from grid
	 */
	private PendingTransfersVoCollection populatePendingTransferRecordsFromGrid()
	{
		// Create collection to return
		PendingTransfersVoCollection records = new PendingTransfersVoCollection();
		
		// Add each record from grid to collection
		for (int i = 0; i < form.dyngrdPatients().getRows().size(); i++)
		{
			DynamicGridRow row = form.dyngrdPatients().getRows().get(i);
			
			if (row.getValue() instanceof PendingTransfersVo)
				records.add((PendingTransfersVo) row.getValue());
		}
		
		// Return populated records
		return records;
	}


	/**
	 * WDEV-13136
	 * Function used to populate pending transfers to grid
	 */
	private void populatePendingTransferRecordsToGrid(PendingTransfersVoCollection records)
	{
		// Clear grid
		form.dyngrdPatients().getRows().clear();
		
		// Check records collection
		if (records == null)
			return;
		
		// Populate records to grid
		for (int i = 0; i < records.size(); i++)
		{
			addNewPendingTransfersDynamicGridRow(records.get(i));
		}
	}


	/**
	 * WDEV-13136
	 * Function used to sort records (InpatientEpisode) after values on column which header was clicked
	 */
	private void sortInpatientEpisodeRecords(Object columnIdentifier)
	{
		// Get records from grid
		InpatientEpisodeVoCollection records = populateInpatientRecordsFromGrid();
		
		// Toggle sort order for column
		sortOrderToggle(columnIdentifier);
		
		// Sort records by column
		if (COLDATETIME.equals(columnIdentifier))
		{
			records.sort(new InpatientEpisodeRequestDateTimeCompartor(form.getLocalContext().getSortOrderRequestDate()));
		}
		
		// Get current selection
		Object selectedRecord = form.dyngrdPatients().getValue();
		// Populate records to grid
		populateInpatientEpisodesToGrid(records);
		// Reselect record
		form.dyngrdPatients().setValue(selectedRecord);
		// Call code for new selection
		updateGlobalContextPatientSelection(form.dyngrdPatients().getValue());
	}

	/**
	 * WDEV-13136
	 * Function used to populate inpatient episodes to grid
	 */
	private void populateInpatientEpisodesToGrid(InpatientEpisodeVoCollection records)
	{
		// Clear grid records
		form.dyngrdPatients().getRows().clear();

		// Test collection
		if (records == null)
			return;
		
		// Populate records to grid
		for (int i = 0; i < records.size(); i++)
		{
			addNewInpatientEpisodeDynamicGridRow(records.get(i));
		}
	}


	/**
	 * WDEV-13136
	 * Function used to toggle sort order for columns
	 */
	private void sortOrderToggle(Object columnIdentifer)
	{
		// Column 'Request Date'
		if (COLDATETIME.equals(columnIdentifer))
		{
			if (SortOrder.ASCENDING.equals(form.getLocalContext().getSortOrderRequestDate()))
				form.getLocalContext().setSortOrderRequestDate(SortOrder.DESCENDING);
			else
				form.getLocalContext().setSortOrderRequestDate(SortOrder.ASCENDING);
		}
		else
		{
			form.getLocalContext().setSortOrderRequestDate(null);
		}
		
		// Column 'Alert'
		// WDEV-18011 
		if (COLALERT.equals(columnIdentifer))
		{
			if (SortOrder.ASCENDING.equals(form.getLocalContext().getSortOrderAlerts()))
				form.getLocalContext().setSortOrderAlerts(SortOrder.DESCENDING);
			else
				form.getLocalContext().setSortOrderAlerts(SortOrder.ASCENDING);
		}
		else
		{
			form.getLocalContext().setSortOrderAlerts(null);
		}
	}


	/**
	 * WDEV-13136
	 * Function used to retrieve records (InpatientEpisodes) from grid
	 */
	private InpatientEpisodeVoCollection populateInpatientRecordsFromGrid()
	{
		// Create collection to return
		InpatientEpisodeVoCollection records = new InpatientEpisodeVoCollection();
		
		// Add each record from grid to collection
		for (int i = 0; i < form.dyngrdPatients().getRows().size(); i++)
		{
			DynamicGridRow row = form.dyngrdPatients().getRows().get(i);
			
			if (row.getValue() instanceof InpatientEpisodeVo)
				records.add((InpatientEpisodeVo) row.getValue());
		}
		
		// Return populated records
		return records;
	}


	private void refreshSearchCriteria()
	{
		initialise();

		PendingTransfersFilterVo voFilter = form.getGlobalContext().STHK.getTransfersListFilter();

		if (voFilter != null)
		{
			form.txtIDNum().setValue(voFilter.getPatientHospNumber());
			form.cmbIDType().setValue(voFilter.getIDType());
			form.txtPatientSurname().setValue(voFilter.getPatientSurname());
			form.txtPatientForename().setValue(voFilter.getPatientForename());

			for (int i = 0; voFilter.getConsultantIsNotNull() && i < form.qmbConsultant().getValues().size(); i++)
			{
				HcpLiteVo voHCP = (HcpLiteVo) form.qmbConsultant().getValues().get(i);
				if (voHCP.getID_Hcp().equals(voFilter.getConsultant().getID_Hcp()))
					form.qmbConsultant().setValue((HcpLiteVo) form.qmbConsultant().getValues().get(i));
			}
			if (form.qmbConsultant().getValue() == null && voFilter.getConsultantIsNotNull())
			{
				HcpLiteVo voHCP = domain.getHCP(voFilter.getConsultant().getID_Hcp());
				form.qmbConsultant().newRow(voHCP, voHCP.getMos().getName().toString());
				form.qmbConsultant().setValue(voHCP);
			}

			form.cmbCurrentHosp().setValue(null);
			for (int i = 0; voFilter.getCurrentHospitalIsNotNull() && i < form.cmbCurrentHosp().getValues().size(); i++)
			{
				LocationLiteVo voHosp = (LocationLiteVo) form.cmbCurrentHosp().getValues().get(i);
				if (voHosp.getID_Location().equals(voFilter.getCurrentHospital().getID_Location()))
					form.cmbCurrentHosp().setValue((LocationLiteVo) form.cmbCurrentHosp().getValues().get(i));
			}
			if (form.cmbCurrentHosp().getValue() == null && voFilter.getCurrentHospitalIsNotNull())
			{
				LocationLiteVo voHosp = domain.getHospital(voFilter.getCurrentHospital());
				form.cmbCurrentHosp().newRow(voHosp, voHosp.getName().toString());
				form.cmbCurrentHosp().setValue(voHosp);
			}

			form.qmbCurrentWard().setValue(null);
			for (int i = 0; voFilter.getCurrentWardIsNotNull() && i < form.qmbCurrentWard().getValues().size(); i++)
			{
				LocationLiteVo voWard = (LocationLiteVo) form.qmbCurrentWard().getValues().get(i);
				if (voWard.getID_Location().equals(voFilter.getCurrentWard().getID_Location()))
					form.qmbCurrentWard().setValue((LocationLiteVo) form.qmbCurrentWard().getValues().get(i));
			}
			if (form.qmbCurrentWard().getValue() == null && voFilter.getCurrentWardIsNotNull())
			{
				LocationLiteVo voWard = domain.getWard(voFilter.getCurrentWard());
				form.qmbCurrentWard().newRow(voWard, voWard.getName());
				form.qmbCurrentWard().setValue(voWard);
			}

			form.cmbDestHosp().setValue(null);
			for (int i = 0; voFilter.getDestHospitalIsNotNull() && i < form.cmbDestHosp().getValues().size(); i++)
			{
				LocationLiteVo voHosp = (LocationLiteVo) form.cmbDestHosp().getValues().get(i);
				if (voHosp.getID_Location().equals(voFilter.getDestHospital().getID_Location()))
					form.cmbDestHosp().setValue((LocationLiteVo) form.cmbDestHosp().getValues().get(i));
			}
			if (form.cmbDestHosp().getValue() == null && voFilter.getDestHospitalIsNotNull())
			{
				LocationLiteVo voHosp = domain.getHospital(voFilter.getDestHospital());
				form.cmbDestHosp().newRow(voHosp, voHosp.getName().toString());
				form.cmbDestHosp().setValue(voHosp);
			}

			for (int i = 0; voFilter.getDestinationWardIsNotNull() && i < form.qmbOtherWard().getValues().size(); i++)
			{
				LocationLiteVo voWard = (LocationLiteVo) form.qmbOtherWard().getValues().get(i);
				if (voWard.getID_Location().equals(voFilter.getDestinationWard().getID_Location()))
					form.qmbOtherWard().setValue((LocationLiteVo) form.qmbOtherWard().getValues().get(i));
			}
			if (form.qmbOtherWard().getValue() == null && voFilter.getDestinationWardIsNotNull())
			{
				LocationLiteVo voWard = domain.getWard(voFilter.getDestinationWard());
				form.qmbOtherWard().newRow(voWard, voWard.getName());
				form.qmbOtherWard().setValue(voWard);
			}

			form.cmbAlert().setValue(voFilter.getAlert());
			form.Tranfers().setValue(voFilter.getPendingTransfer() ? GenForm.TranfersEnumeration.rdoPendingTransfers : GenForm.TranfersEnumeration.rdoRecentTransfers);

			radioChanged(); // initializeDynamicGrid(voFilter.getPendingTransfer());

			search(false);
		}
	}

	private void search(boolean fromSearchButton)
	{
		PendingTransfersVo pendingTransferSelectedRecord = null;
		InpatientEpisodeVo inpatientEpisodeSelectedRecord = null;
		
		if (!fromSearchButton  && form.dyngrdPatients().getValue() instanceof PendingTransfersVo)
			pendingTransferSelectedRecord = (PendingTransfersVo) form.dyngrdPatients().getValue();
		
		if (!fromSearchButton  && form.dyngrdPatients().getValue() instanceof InpatientEpisodeVo)
			inpatientEpisodeSelectedRecord = (InpatientEpisodeVo) form.dyngrdPatients().getValue();
		
		form.dyngrdPatients().getRows().clear(); // WDEV-18099 
		form.lblTotal().setValue("Total : 0"); // WDEV-18099 
		form.getContextMenus().hideAllGenericGridMenuItems();

		PendingTransfersFilterVo voPendingTransfersFilter = populateDataFromScreen();
		form.getGlobalContext().STHK.setTransfersListFilter(voPendingTransfersFilter);

		if (form.txtIDNum().getValue() != null && form.cmbIDType().getValue() == null)
		{
			engine.showErrors(new String[]{"Please enter both an Identifier type as well as its value."});
			return;
		}

		if (voPendingTransfersFilter.countFieldsWithValue() == 2 && voPendingTransfersFilter.getIDTypeIsNotNull() && voPendingTransfersFilter.getPendingTransferIsNotNull())
		{
			engine.showMessage("Please enter some valid search criteria.", "Invalid search cirteria", MessageButtons.OK, MessageIcon.ERROR);
			return;
		}

		form.dyngrdPatients().getRows().clear();
		if (form.Tranfers().getValue().equals(GenForm.TranfersEnumeration.rdoPendingTransfers))
		{

			PendingTransfersVoCollection pendingTransfers = domain.listPendingTransfers(voPendingTransfersFilter);

			if (pendingTransfers == null || pendingTransfers.size() == 0)
			{
				engine.showMessage("No matching records found");
				return;
			}
			if (pendingTransfers != null)
				form.lblTotal().setValue("Total : " + String.valueOf(pendingTransfers.size()));

			for (int i = 0; pendingTransfers != null && i < pendingTransfers.size(); i++)
				addNewPendingTransfersDynamicGridRow(pendingTransfers.get(i));
			
			form.dyngrdPatients().setValue(pendingTransferSelectedRecord);
		}
		else
		{
			InpatientEpisodeVoCollection inpatientEpisodes = domain.listRecentTransfers(voPendingTransfersFilter);

			if (inpatientEpisodes == null || inpatientEpisodes.size() == 0)
			{
				engine.showMessage("No records match your search criteria.", "No data found", MessageButtons.OK, MessageIcon.WARNING);
				return;
			}
			if (inpatientEpisodes != null)
				form.lblTotal().setValue("Total : " + String.valueOf(inpatientEpisodes.size()));

			for (int i = 0; inpatientEpisodes != null && i < inpatientEpisodes.size(); i++)
				addNewInpatientEpisodeDynamicGridRow(inpatientEpisodes.get(i));
			
			form.dyngrdPatients().setValue(inpatientEpisodeSelectedRecord);
		}
		updateContextMenusState();
	}

	private void addNewInpatientEpisodeDynamicGridRow(InpatientEpisodeVo voInpatientEpisode)
	{
		DynamicGridRow newRow = form.dyngrdPatients().getRows().newRow();

		if (voInpatientEpisode.getPasEventIsNotNull() && voInpatientEpisode.getPasEvent().getPatientIsNotNull())
			voInpatientEpisode.getPasEvent().getPatient().calculateAge();

		if (voInpatientEpisode.getPasEventIsNotNull() && voInpatientEpisode.getPasEvent().getPatientIsNotNull() && voInpatientEpisode.getPasEvent().getPatient().getNameIsNotNull())
		{
			DynamicGridCell snameCell = newRow.getCells().newCell(getColumn(COLSURNAME), DynamicCellType.LABEL);
			snameCell.setValue(voInpatientEpisode.getPasEvent().getPatient().getName().getSurname());
			snameCell.setReadOnly(true);

			DynamicGridCell fnameCell = newRow.getCells().newCell(getColumn(COLFORENAME), DynamicCellType.LABEL);
			fnameCell.setValue(voInpatientEpisode.getPasEvent().getPatient().getName().getForename());
			fnameCell.setReadOnly(true);
		}

		//wdev-8431
		if (voInpatientEpisode.getPasEventIsNotNull() 
			&& voInpatientEpisode.getPasEvent().getPatientIsNotNull() 
			&& voInpatientEpisode.getPasEvent().getPatient().getIdentifiersIsNotNull()
			&& voInpatientEpisode.getPasEvent().getPatient().getIdentifiers().size() > 0
			&& voInpatientEpisode.getPasEvent().getPatient().getPatId(PatIdType.HOSPNUM) != null
			&& voInpatientEpisode.getPasEvent().getPatient().getPatId(PatIdType.HOSPNUM).getValueIsNotNull())
		{
			DynamicGridCell hospnumCell = newRow.getCells().newCell(getColumn(COLHOSPNUM), DynamicCellType.LABEL);
			hospnumCell.setValue(voInpatientEpisode.getPasEvent().getPatient().getHospnum().getValue().toString());
			hospnumCell.setReadOnly(true);
		}

		if (voInpatientEpisode.getPasEventIsNotNull() && voInpatientEpisode.getPasEvent().getPatientIsNotNull())
		{
			DynamicGridCell patientCell = newRow.getCells().newCell(getColumn(COLSEX), DynamicCellType.LABEL);
			patientCell.setValue(voInpatientEpisode.getPasEvent().getPatient().getSexIsNotNull() ? voInpatientEpisode.getPasEvent().getPatient().getSex().toString() : "");
			patientCell.setReadOnly(true);
		}

		if (voInpatientEpisode.getPasEventIsNotNull() && voInpatientEpisode.getPasEvent().getConsultantIsNotNull())
		{
			DynamicGridCell patientCell = newRow.getCells().newCell(getColumn(COLCONSULTANT), DynamicCellType.LABEL);
			patientCell.setValue(voInpatientEpisode.getPasEvent().getConsultantIsNotNull() ? voInpatientEpisode.getPasEvent().getConsultant().toString() : "");
			patientCell.setReadOnly(true);
		}

		if (voInpatientEpisode.getPasEventIsNotNull() && voInpatientEpisode.getPasEvent().getLocationIsNotNull())
		{
			DynamicGridCell patientCell = newRow.getCells().newCell(getColumn(COLCURRENTWARD), DynamicCellType.LABEL);
			patientCell.setValue(voInpatientEpisode.getPasEvent().getLocationIsNotNull() ? voInpatientEpisode.getPasEvent().getLocation().toString() : "");
			patientCell.setReadOnly(true);
		}

		if (voInpatientEpisode.getWardStaysIsNotNull() && voInpatientEpisode.getWardStays().size() > 1)
		{
			//WDEV-8798
			voInpatientEpisode.getWardStays().sort(WardStayVo.getWardStayVoIdComparator());
			
			WardStayVo voPreviousWardStay = voInpatientEpisode.getWardStays().get(1);

			DynamicGridCell prevWardCell = newRow.getCells().newCell(getColumn(COLOTHERWARD), DynamicCellType.LABEL);
			prevWardCell.setValue(voPreviousWardStay.getWardIsNotNull() ? voPreviousWardStay.getWard().getName() : "");
			prevWardCell.setReadOnly(true);

			DynamicGridCell tdtCell = newRow.getCells().newCell(getColumn(COLDATETIME), DynamicCellType.LABEL);
			tdtCell.setValue(voPreviousWardStay.getTransferDateTimeIsNotNull() ? voPreviousWardStay.getTransferDateTime().toString() : "");
			tdtCell.setReadOnly(true);
		}
		
		if (voInpatientEpisode != null && voInpatientEpisode.getCommentsIsNotNull() && voInpatientEpisode.getPasEvent().getPatientIsNotNull())
		{
			DynamicGridCell patientCell = newRow.getCells().newCell(getColumn(COLCOMMENTS), DynamicCellType.IMAGEBUTTON);
			patientCell.setReadOnly(false);
			patientCell.setAutoPostBack(true);
			patientCell.setValue(form.getImages().Core.Memo);
			patientCell.setTooltip(voInpatientEpisode.getComments());
		}

		newRow.setValue(voInpatientEpisode);
	}

	private void initialise()
	{

		form.Tranfers().setValue(GenForm.TranfersEnumeration.rdoPendingTransfers);
		initializeDynamicGrid(true);
		loadHospitals();

		form.cmbIDType().setValue(PatIdType.getNegativeInstance(ConfigFlag.UI.DISPLAY_PATID_TYPE.getValue()));

		if (form.cmbCurrentHosp().getValue() == null && engine.getCurrentLocation() != null)
		{
			// Try and load the logged in location as a ward
			LocMostVo voLoc = domain.getLocation((LocationRefVo) engine.getCurrentLocation());
			if (voLoc != null && voLoc.getTypeIsNotNull() && voLoc.getType().equals(LocationType.WARD))
			{
				form.cmbCurrentHosp().setValue(voLoc.getParentLocation());

				form.qmbCurrentWard().newRow(voLoc, voLoc.getName());
				form.qmbCurrentWard().setValue(voLoc);
			}
		}

		loadAlerts();
	}

	private void loadAlerts()
	{
		form.cmbAlert().clear();

		TreeNode[] coll = LookupHelper.getAlertType(domain.getLookupService()).getRootNodes();

		if (coll != null)
		{
			for (int i = 0; i < coll.length; i++)
			{
				AlertType item = (AlertType) coll[i];
				ArrayList<LookupInstVo> coll1 = item.getChildInstances();

				AlertType type = null;
				for (int j = 0; j < coll1.size(); j++)
				{
					type = (AlertType) coll1.get(j);
					if (type.isActive())
						form.cmbAlert().newRow((AlertType) coll1.get(j), coll1.get(j).toString());
				}
			}
		}
	}

	private void loadHospitals()
	{
		LocationLiteVoCollection voColl = domain.listActiveHospitalsLite();
		form.cmbCurrentHosp().clear();
		form.cmbDestHosp().clear();

		for (int i = 0; voColl != null && i < voColl.size(); i++)
		{
			form.cmbCurrentHosp().newRow(voColl.get(i), voColl.get(i).getName());
			form.cmbDestHosp().newRow(voColl.get(i), voColl.get(i).getName());

			if (engine.getCurrentLocation() != null && voColl.get(i).getID_Location().equals(engine.getCurrentLocation().getID()))
			{
				form.cmbCurrentHosp().setValue(voColl.get(i));
				form.cmbDestHosp().setValue(voColl.get(i));
			}

		}
	}

	private void initializeDynamicGrid(boolean bPendingTransfers)
	{

		form.dyngrdPatients().clear();
		form.dyngrdPatients().setSelectable(true);
		form.getContextMenus().hideAllGenericGridMenuItems();

		if (bPendingTransfers)
		{
			DynamicGridColumn surnameColumn = form.dyngrdPatients().getColumns().newColumn("Surname", COLSURNAME);
			surnameColumn.setSortMode(SortMode.AUTOMATIC);
			surnameColumn.setWidth(72);

			DynamicGridColumn forenameColumn = form.dyngrdPatients().getColumns().newColumn("Forename", COLFORENAME);
			forenameColumn.setSortMode(SortMode.AUTOMATIC);
			forenameColumn.setWidth(72);

			DynamicGridColumn hospnumColumn = form.dyngrdPatients().getColumns().newColumn("Hosp. No.", COLHOSPNUM);
			hospnumColumn.setSortMode(SortMode.AUTOMATIC);
			hospnumColumn.setWidth(68);

			DynamicGridColumn sexColumn = form.dyngrdPatients().getColumns().newColumn("Sex", COLSEX);
			sexColumn.setSortMode(SortMode.AUTOMATIC);
			sexColumn.setWidth(40);

			DynamicGridColumn alertColumn = form.dyngrdPatients().getColumns().newColumn("Alert", COLALERT);
			alertColumn.setSortMode(SortMode.MANUAL);
			alertColumn.setWidth(47);

			DynamicGridColumn consultantColumn = form.dyngrdPatients().getColumns().newColumn("Consultant", COLCONSULTANT);
			consultantColumn.setSortMode(SortMode.AUTOMATIC);
			consultantColumn.setWidth(81);

			DynamicGridColumn currentWardColumn = form.dyngrdPatients().getColumns().newColumn("Current Ward", COLCURRENTWARD);
			currentWardColumn.setSortMode(SortMode.AUTOMATIC);
			currentWardColumn.setWidth(90);

			DynamicGridColumn otherWardColumn = form.dyngrdPatients().getColumns().newColumn("Destination Ward", COLOTHERWARD);
			otherWardColumn.setSortMode(SortMode.AUTOMATIC);
			otherWardColumn.setWidth(110);

			DynamicGridColumn requestDateColumn = form.dyngrdPatients().getColumns().newColumn("Request Date", COLREQUESTDATE);
			requestDateColumn.setSortMode(SortMode.AUTOMATIC);
			requestDateColumn.setWidth(88);

			DynamicGridColumn commentsColumn = form.dyngrdPatients().getColumns().newColumn("Comments", COLCOMMENTS);
			commentsColumn.setWidth(-1);
		}
		else
		{
			DynamicGridColumn surnameColumn = form.dyngrdPatients().getColumns().newColumn("Surname", COLSURNAME);
			surnameColumn.setSortMode(SortMode.AUTOMATIC);
			surnameColumn.setWidth(80);

			DynamicGridColumn forenameColumn = form.dyngrdPatients().getColumns().newColumn("Forename", COLFORENAME);
			forenameColumn.setSortMode(SortMode.AUTOMATIC);
			forenameColumn.setWidth(80);

			DynamicGridColumn hospnumColumn = form.dyngrdPatients().getColumns().newColumn("Hosp. No.", COLHOSPNUM);
			hospnumColumn.setSortMode(SortMode.AUTOMATIC);
			hospnumColumn.setWidth(90);

			DynamicGridColumn sexColumn = form.dyngrdPatients().getColumns().newColumn("Sex", COLSEX);
			sexColumn.setSortMode(SortMode.AUTOMATIC);
			sexColumn.setWidth(45);

			DynamicGridColumn consultantColumn = form.dyngrdPatients().getColumns().newColumn("Consultant", COLCONSULTANT);
			consultantColumn.setSortMode(SortMode.AUTOMATIC);
			consultantColumn.setWidth(90);

			DynamicGridColumn currentWardColumn = form.dyngrdPatients().getColumns().newColumn("Current Ward", COLCURRENTWARD);
			currentWardColumn.setSortMode(SortMode.AUTOMATIC);
			currentWardColumn.setWidth(110);

			DynamicGridColumn otherWardColumn = form.dyngrdPatients().getColumns().newColumn("Previous Ward", COLOTHERWARD);
			otherWardColumn.setSortMode(SortMode.AUTOMATIC);
			otherWardColumn.setWidth(110);

			DynamicGridColumn transferDateTimeColumn = form.dyngrdPatients().getColumns().newColumn("Transfer Date/time", COLDATETIME);
			transferDateTimeColumn.setSortMode(SortMode.AUTOMATIC);
			transferDateTimeColumn.setWidth(120);
			
			DynamicGridColumn commentsColumn = form.dyngrdPatients().getColumns().newColumn("Comments", COLCOMMENTS);
			commentsColumn.setWidth(-1);
		}

		form.lblTotal().setValue("Total : 0");
	}

	@Override
	protected void onRadioButtonTranfersValueChanged() throws ims.framework.exceptions.PresentationLogicException
	{
		radioChanged();
	}

	private void radioChanged()
	{
		if (form.Tranfers().getValue().equals(GenForm.TranfersEnumeration.rdoPendingTransfers))
		{
			form.lblOtherWard().setValue("Destination Ward:");
			form.cmbAlert().setVisible(true);
			form.lblAlert().setVisible(true);

			initializeDynamicGrid(true);
		}
		else if (form.Tranfers().getValue().equals(GenForm.TranfersEnumeration.rdoRecentTransfers))
		{
			form.lblOtherWard().setValue("Previous Ward:");
			form.cmbAlert().setVisible(false);
			form.lblAlert().setVisible(false);

			initializeDynamicGrid(false);
		}
	}

	@Override
	protected void onImbClearClick() throws ims.framework.exceptions.PresentationLogicException
	{
		clearControls();
		form.getContextMenus().hideAllGenericGridMenuItems();

		form.lblTotal().setValue("Total : 0");

		form.dyngrdPatients().getRows().clear();

		// Clear the selected patient information in the Engine
		form.getGlobalContext().Core.setSelectingPatientForm(null);
		form.getGlobalContext().Core.setPatientShort(null);
		form.getGlobalContext().Core.setPatientToBeDisplayed(null);
		engine.setPatientInfo("Please enter Patient ID or Surname and/or Forename");

		form.getGlobalContext().STHK.setTransfersListFilter(null);
	}

	private void clearControls()
	{
		form.txtPatientForename().setValue(null);
		form.txtPatientSurname().setValue(null);
		form.txtIDNum().setValue(null);
		form.qmbCurrentWard().setValue(null);
		form.qmbOtherWard().setValue(null);
		form.cmbAlert().setValue(null);
		form.qmbConsultant().setValue(null);
		form.cmbCurrentHosp().setValue(null);
		form.cmbDestHosp().setValue(null);
	}

	@Override
	protected void onImbSearchClick() throws ims.framework.exceptions.PresentationLogicException
	{
		search(true);
	}

	private void addNewPendingTransfersDynamicGridRow(PendingTransfersVo voPendingTransfers)
	{
		voPendingTransfers.setActiveAlerts(false);	// WDEV-18011
		DynamicGridRow newRow = form.dyngrdPatients().getRows().newRow();

		if (voPendingTransfers.getInpatientEpisodeIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEventIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEvent().getPatientIsNotNull())
			voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().calculateAge();

		if (voPendingTransfers.getInpatientEpisodeIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEventIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEvent().getPatientIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().getNameIsNotNull())
		{
			DynamicGridCell snameCell = newRow.getCells().newCell(getColumn(COLSURNAME), DynamicCellType.LABEL);
			snameCell.setValue(voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().getName().getSurname());
			snameCell.setReadOnly(true);

			DynamicGridCell fnameCell = newRow.getCells().newCell(getColumn(COLFORENAME), DynamicCellType.LABEL);
			fnameCell.setValue(voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().getName().getForename());
			fnameCell.setReadOnly(true);
		}

		//wdev-8431
		if (voPendingTransfers.getInpatientEpisodeIsNotNull() 
			&& voPendingTransfers.getInpatientEpisode().getPasEventIsNotNull() 
			&& voPendingTransfers.getInpatientEpisode().getPasEvent().getPatientIsNotNull() 
			&& voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().getIdentifiersIsNotNull()
			&& voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().getPatId(PatIdType.HOSPNUM) != null)
		{
			DynamicGridCell hospnumCell = newRow.getCells().newCell(getColumn(COLHOSPNUM), DynamicCellType.LABEL);
			hospnumCell.setValue(voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().getPatId(PatIdType.HOSPNUM).getValueIsNotNull() ? voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().getPatId(PatIdType.HOSPNUM).getValue().toString() : "");
			hospnumCell.setReadOnly(true);
		}

		if (voPendingTransfers.getInpatientEpisodeIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEventIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEvent().getPatientIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().getSexIsNotNull())
		{
			DynamicGridCell patientCell = newRow.getCells().newCell(getColumn(COLSEX), DynamicCellType.LABEL);
			patientCell.setValue(voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().getSex().toString());
			patientCell.setReadOnly(true);
		}

		if (voPendingTransfers.getInpatientEpisodeIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEventIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEvent().getPatientIsNotNull())
		{
			DynamicGridCell patientCell = newRow.getCells().newCell(getColumn(COLALERT), DynamicCellType.IMAGE);
			
			//wdev-11146
			if(voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().getPatientAlertsIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().getPatientAlerts().size() > 0 )
			{
				boolean tempBool = false; 	
				for(int i = 0; i < voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().getPatientAlerts().size();i++)
				{
					PatientAlertLiteVo patAlertLiteVo = voPendingTransfers.getInpatientEpisode().getPasEvent().getPatient().getPatientAlerts().get(i);
					if(patAlertLiteVo != null && patAlertLiteVo.getIsCurrentlyActiveAlert().equals(Boolean.TRUE))
					{
						tempBool = true;
						break;
					}
				}
				if (tempBool)
				{
					patientCell.setValue(form.getImages().Core.Alert16); // WDEV-18011 	
					voPendingTransfers.setActiveAlerts(true);	// WDEV-18011 				
				}
			}
			patientCell.setReadOnly(true);
		}

		if (voPendingTransfers.getInpatientEpisodeIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEventIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEvent().getConsultantIsNotNull())
		{
			DynamicGridCell patientCell = newRow.getCells().newCell(getColumn(COLCONSULTANT), DynamicCellType.LABEL);
			patientCell.setValue(voPendingTransfers.getInpatientEpisode().getPasEvent().getConsultant().toString());
			patientCell.setReadOnly(true);
		}

		if (voPendingTransfers.getInpatientEpisodeIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEventIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEvent().getLocationIsNotNull())
		{
			DynamicGridCell patientCell = newRow.getCells().newCell(getColumn(COLCURRENTWARD), DynamicCellType.LABEL);
			patientCell.setValue(voPendingTransfers.getInpatientEpisode().getPasEvent().getLocation().toString());
			patientCell.setReadOnly(true);
		}

		if (voPendingTransfers.getDestinationWardIsNotNull())
		{
			DynamicGridCell patientCell = newRow.getCells().newCell(getColumn(COLOTHERWARD), DynamicCellType.LABEL);
			patientCell.setValue(voPendingTransfers.getDestinationWard().toString());
			patientCell.setReadOnly(true);
		}

		if (voPendingTransfers.getTransferRequestDateTimeIsNotNull())
		{
			DynamicGridCell patientCell = newRow.getCells().newCell(getColumn(COLREQUESTDATE), DynamicCellType.LABEL);
			patientCell.setValue(voPendingTransfers.getTransferRequestDateTime().toString());
			patientCell.setReadOnly(true);
		}

		if (voPendingTransfers.getInpatientEpisodeIsNotNull() && voPendingTransfers.getInpatientEpisode().getCommentsIsNotNull() && voPendingTransfers.getInpatientEpisode().getPasEvent().getPatientIsNotNull())
		{
			DynamicGridCell patientCell = newRow.getCells().newCell(getColumn(COLCOMMENTS), DynamicCellType.IMAGEBUTTON);
			patientCell.setReadOnly(false);
			patientCell.setAutoPostBack(true);
			patientCell.setValue(form.getImages().Core.Memo);
			patientCell.setTooltip(voPendingTransfers.getInpatientEpisode().getComments());
		}

		newRow.setValue(voPendingTransfers);
	}

	private PendingTransfersFilterVo populateDataFromScreen()
	{
		PendingTransfersFilterVo filter = new PendingTransfersFilterVo();

		filter.setPatientHospNumber(form.txtIDNum().getValue());
		filter.setIDType(form.cmbIDType().getValue());
		filter.setPendingTransfer(form.Tranfers().getValue().equals(GenForm.TranfersEnumeration.rdoPendingTransfers) ? Boolean.TRUE : Boolean.FALSE);

		//WDEV-13065 -- if (form.txtIDNum().getValue() == null)
		
		filter.setPatientForename(form.txtPatientForename().getValue());
		filter.setPatientSurname(form.txtPatientSurname().getValue());
		filter.setConsultant(form.qmbConsultant().getValue());
		filter.setCurrentHospital(form.cmbCurrentHosp().getValue());
		filter.setDestHospital(form.cmbDestHosp().getValue());
		filter.setCurrentWard(form.qmbCurrentWard().getValue());
		filter.setDestinationWard(form.qmbOtherWard().getValue());
		filter.setAlert(form.cmbAlert().getValue());
		
		return filter;
	}

	@Override
	protected void onQmbConsultantTextSubmited(String value) throws PresentationLogicException
	{
		if (value != null)
		{
			HcpFilter voHCPFilter = new HcpFilter();
			PersonName name = new PersonName();
			name.setSurname(value);
			voHCPFilter.setQueryName(name);
			voHCPFilter.setHcpType(HcpDisType.MEDICAL);

			HcpLiteVoCollection voColl = domain.listHCPs(voHCPFilter);

			voColl.sort();
			form.qmbConsultant().clear();
			for (int i = 0; i < voColl.size(); i++)
			{
				form.qmbConsultant().newRow(voColl.get(i), voColl.get(i).getIHcpName());
			}
			if (voColl.size() == 1)
				form.qmbConsultant().setValue(voColl.get(0));
			else if (voColl.size() > 1)
				form.qmbConsultant().showOpened();
		}
	}

	@Override
	protected void onQmbDestinationWardTextSubmited(String value) throws PresentationLogicException
	{
		if (form.cmbDestHosp().getValue() == null)
		{
			engine.showMessage("Please select a Destination Hospital to find a Ward for.");
			return;
		}

		LocationLiteVoCollection wards = domain.listWards(form.cmbDestHosp().getValue().getID_Location(), value);
		if (wards != null)
		{
			form.qmbOtherWard().clear();//wdev-8431
			for (LocationLiteVo item : wards)
				form.qmbOtherWard().newRow(item, item.getName());
		}
		if (wards.size() == 1)
			form.qmbOtherWard().setValue(wards.get(0));
		else if (wards.size() > 1)
			form.qmbOtherWard().showOpened();

	}

	@Override
	protected void onQmbWardTextSubmited(String value) throws PresentationLogicException
	{
		if (form.cmbCurrentHosp().getValue() == null)
		{
			engine.showMessage("Please select a Current Hospital to find a Ward for.");
			return;
		}

		LocationLiteVoCollection wards = domain.listWards(form.cmbCurrentHosp().getValue().getID_Location(), value);
		if (wards != null)
		{
			form.qmbCurrentWard().clear();//wdev-8431
			for (LocationLiteVo item : wards)
				form.qmbCurrentWard().newRow(item, item.getName());
		}
		if (wards.size() == 1)
			form.qmbCurrentWard().setValue(wards.get(0));
		else if (wards.size() > 1)
			form.qmbCurrentWard().showOpened();

	}

	@Override
	protected void onCmbDestHospValueChanged() throws PresentationLogicException
	{
		form.qmbOtherWard().clear();
	}

	@Override
	protected void onCmbCurrentHospValueChanged() throws PresentationLogicException
	{
		form.qmbCurrentWard().clear();
	}

	@Override
	protected void onDyngrdPatientsRowSelectionChanged(DynamicGridRow row)
	{
		if (row == null)
			updateGlobalContextPatientSelection(null);
		else
			updateGlobalContextPatientSelection(row.getValue());

		updateContextMenusState();
	}


	/**
	 * WDEV-13136
	 * Function used to update global context patient
	 */
	private void updateGlobalContextPatientSelection(Object value)
	{
		setPatientGlobalContext(null);
		
		if (value == null)
			return;

		if (value instanceof InpatientEpisodeVo)
		{
			InpatientEpisodeVo vo = (InpatientEpisodeVo) value;
			if (vo != null && vo.getPasEventIsNotNull() && vo.getPasEvent().getPatientIsNotNull())
			{
				setPatientGlobalContext(vo.getPasEvent().getPatient());
			}
		}
		else if (value instanceof PendingTransfersVo)
		{
			PendingTransfersVo vo = (PendingTransfersVo) value;
			if (vo != null && vo.getInpatientEpisodeIsNotNull() && vo.getInpatientEpisode().getPasEventIsNotNull() && vo.getInpatientEpisode().getPasEvent().getPatientIsNotNull())
			{
				setPatientGlobalContext(domain.getPatientShort(vo.getInpatientEpisode().getPasEvent().getPatient()));
			}
		}
	}


	/**
	 * @param ps
	 */
	private void setPatientGlobalContext(PatientShort patient)
	{
		form.getGlobalContext().Core.setSelectingPatientForm(engine.getFormName());
		form.getGlobalContext().Core.setPatientToBeDisplayed(patient);
		form.getGlobalContext().Core.setPatientShort(patient);
	}

	public void refresh()
	{
		if (form.getGlobalContext().STHK.getTransfersListFilterIsNotNull())
			refreshSearchCriteria();
	}

	@Override
	protected void onContextMenuItemClick(int menuItemID, Control sender) throws PresentationLogicException
	{
		switch (menuItemID)
		{
			case GenForm.ContextMenus.GenericGrid.Add :
				addEditComment(null);
			break;
		}
	}

	private void addEditComment(DynamicGridCell cell)
	{
		if (cell != null)
			form.dyngrdPatients().setSelectedRow(cell.getRow());

		if (form.dyngrdPatients().getSelectedRow() != null && form.dyngrdPatients().getSelectedRow().getValue() != null)
		{
			if (form.dyngrdPatients().getSelectedRow().getValue() instanceof PendingTransfersVo)
			{
				PendingTransfersVo voTrans = domain.getCurrentTransferRecord((PendingTransfersVo) form.dyngrdPatients().getSelectedRow().getValue());

				form.getGlobalContext().Core.setCommentDialogString(voTrans.getInpatientEpisodeIsNotNull() ? voTrans.getInpatientEpisode().getComments() : "");
				form.dyngrdPatients().getSelectedRow().setValue(voTrans);
				updateGlobalContextPatientSelection(voTrans);//WDEV-18065 
				engine.open(form.getForms().Core.CommentDialog);
			}
			else if (form.dyngrdPatients().getSelectedRow().getValue() instanceof InpatientEpisodeVo)
			{
				InpatientEpisodeVo voEpis = (InpatientEpisodeVo) form.dyngrdPatients().getSelectedRow().getValue();

				form.getGlobalContext().Core.setCommentDialogString(voEpis.getComments());
				updateGlobalContextPatientSelection(voEpis);//WDEV-18065 
				engine.open(form.getForms().Core.CommentDialog);
			}	
		}
	}

	@Override
	protected void onFormDialogClosed(FormName formName, DialogResult result) throws PresentationLogicException
	{
		if (formName.equals(form.getForms().Core.CommentDialog) && result.equals(DialogResult.OK))
		{
			if (form.dyngrdPatients().getSelectedRow().getValue() instanceof PendingTransfersVo)
			{
				PendingTransfersVo voTrans = ((PendingTransfersVo) form.dyngrdPatients().getSelectedRow().getValue());
				voTrans.getInpatientEpisode().setComments(form.getGlobalContext().Core.getCommentDialogString());
				
				String[] errors = voTrans.validate();
				if (errors != null)
				{
					engine.showErrors(errors);
					return;
				}

				try
				{
					domain.saveTransfer(voTrans);
				}
				catch (DomainInterfaceException e)
				{
					engine.showMessage(e.getMessage());
					return;
				}
				catch (StaleObjectException e)
				{
					engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
					search(false);
					return;
				}
			}
			else if (form.dyngrdPatients().getSelectedRow().getValue() instanceof InpatientEpisodeVo)
			{
				InpatientEpisodeVo voEpis = (InpatientEpisodeVo) form.dyngrdPatients().getSelectedRow().getValue();
				voEpis.setComments(form.getGlobalContext().Core.getCommentDialogString());
				
				String[] errors = voEpis.validate();
				if (errors != null)
				{
					engine.showErrors(errors);
					return;
				}

				try
				{
					domain.saveInpatientEpisode(voEpis);
				}
				catch (StaleObjectException e)
				{
					engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
					search(false);
					return;
				}
			}	
			search(false);
		}
		updateContextMenusState();
	}

	@Override
	protected void onDyngrdPatientsCellButtonClicked(DynamicGridCell cell)
	{
		addEditComment(cell);
	}

	private void updateContextMenusState()
	{
		form.getContextMenus().hideAllGenericGridMenuItems();
		form.getContextMenus().getGenericGridAddItem().setText("Add/Edit Comment");
		form.getContextMenus().getGenericGridAddItem().setVisible(form.dyngrdPatients().getValue() != null); //WDEV-18011 
	}

	private DynamicGridColumn getColumn(Integer identifier)
	{
		return form.dyngrdPatients().getColumns().getByIdentifier(identifier);
	}
}
