//#############################################################################
//#                                                                           #
//#  Copyright (C) <2014>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Rory Fitzpatrick using IMS Development Environment (version 1.51 build 2477.26137)
// Copyright (C) 1995-2006 IMS MAXIMS plc. All rights reserved.

package ims.clinical.domain.impl;

import ims.admin.domain.MosAdmin;
import ims.admin.domain.impl.MosAdminImpl;
import ims.clinical.domain.ClinicalNoteDrawing;
import ims.clinical.domain.base.impl.BaseClinicalNotesImpl;
import ims.core.admin.domain.objects.ClinicalContact;
import ims.core.admin.vo.ClinicalContactRefVo;
import ims.core.clinical.domain.objects.ClinicalNotes;
import ims.core.clinical.vo.ClinicalNotesRefVo;
import ims.core.vo.ClinicalContactShortVo;
import ims.core.vo.ClinicalContactVo;
import ims.core.vo.ClinicalNotesVo;
import ims.core.vo.ClinicalNotesVoCollection;
import ims.core.vo.MemberOfStaffShortVo;
import ims.core.vo.MemberOfStaffVo;
import ims.core.vo.domain.ClinicalContactShortVoAssembler;
import ims.core.vo.domain.ClinicalNotesVoAssembler;
import ims.core.vo.lookups.ClinicalNoteType;
import ims.core.vo.lookups.SourceOfNote;
import ims.domain.DomainFactory;
import ims.domain.exceptions.DomainInterfaceException;
import ims.domain.exceptions.DomainRuntimeException;
import ims.domain.exceptions.StaleObjectException;
import ims.domain.exceptions.UniqueKeyViolationException;
import ims.framework.exceptions.CodingRuntimeException;

import java.util.ArrayList;
import java.util.List;

public class ClinicalNotesImpl extends BaseClinicalNotesImpl
{

	private static final long serialVersionUID = 1L;

	/**
	* saveClinicalNotes
	*/
	public ims.core.vo.ClinicalNotesVo saveClinicalNotes(ims.core.vo.ClinicalNotesVo clinicalNotesVo) throws ims.domain.exceptions.StaleObjectException
	{
		// Ensure the value object has been validated
		if (!clinicalNotesVo.isValidated())
			throw new DomainRuntimeException("Clinical Notes has not been validated");
		
		DomainFactory factory = getDomainFactory();
		
		StringBuffer hql = new StringBuffer("select p from ClinicalNotes p left join p.noteType as l1_1");
		
		if (clinicalNotesVo.getClinicalContact() == null)
		{
			ClinicalNotes doClinNotes = ClinicalNotesVoAssembler.extractClinicalNotes(factory, clinicalNotesVo);
			factory.save(doClinNotes);
			return ClinicalNotesVoAssembler.create(doClinNotes);
		}		
		
		/*if(ConfigFlag.UI.ALLOW_ONLY_ONE_CLINICAL_NOTE.getValue()){
			if(clinicalNotesVo.getID_ClinicalNotes()== null)
			{
				hql.append(" where (p.clinicalContact.id = " + clinicalNotesVo.getClinicalContact().getID_ClinicalContact() + 
								"and l1_1.id <> -882 and l1_1 <> -883)"); 
								// clinicalNote.noteType != ( SUMARIONADMISION(-882) and DISCHARGENOTE(-883)) 
			}
			else
			{
				hql.append(" where (p.clinicalContact.id = " + clinicalNotesVo.getClinicalContact().getID_ClinicalContact() + 
								"and l1_1.id <> -882 and l1_1 <> -883 and p.id <> " +  clinicalNotesVo.getID_ClinicalNotes() +")");
								//clinicalNote.noteType != ( SUMARIONADMISION(-882) and DISCHARGENOTE(-883))
			}
			
			List list = (factory.find(hql.toString()));
			
			if(list.size() > 0)
			{
				ClinicalNotesVoCollection doClinNotes = ClinicalNotesVoAssembler.createClinicalNotesVoCollectionFromClinicalNotes(list);
				if (doClinNotes.get(0).getSourceOfNote() != null &&
						!(doClinNotes.get(0).getSourceOfNote().getId() == (getDomLookup(SourceOfNote.CLINICALCLINICALNOTE).getId())))
				{
					return null;
				}
				else
				{
					throw new DomainRuntimeException("A record exists for this clinical contact, the screen will be refreshed");	
				}
			}
		}*/
		//wdev-9693
		if(clinicalNotesVo.getID_ClinicalNotes()== null && clinicalNotesVo.getClinicalContact().getID_ClinicalContactIsNotNull())
		{
			hql.append(" where (p.clinicalContact.id = " + clinicalNotesVo.getClinicalContact().getID_ClinicalContact() + 
							"and l1_1.id <> -882 and l1_1 <> -883)"); 
							// clinicalNote.noteType != ( SUMARIONADMISION(-882) and DISCHARGENOTE(-883)) 
			List<?> list = (factory.find(hql.toString()));
			
			if(list.size() > 0)
			{
				ClinicalNotesVoCollection doClinNotes = ClinicalNotesVoAssembler.createClinicalNotesVoCollectionFromClinicalNotes(list);
				if (doClinNotes.get(0).getSourceOfNote() != null &&
						!(doClinNotes.get(0).getSourceOfNote().getId() == (getDomLookup(SourceOfNote.CLINICALCLINICALNOTE).getId())))
				{
					return null;
				}
				else
				{
					throw new DomainRuntimeException("A record exists for this clinical contact, the screen will be refreshed");	
				}
			}
		}
		
		
	
		
		ClinicalNotes doClinNotes = ClinicalNotesVoAssembler.extractClinicalNotes(factory, clinicalNotesVo);
		ClinicalContact doClinicalContact = getCurrentClinicalContact(clinicalNotesVo.getClinicalContact());
		doClinNotes.setClinicalContact(doClinicalContact);
		
		factory.save(doClinNotes);

		return ClinicalNotesVoAssembler.create(doClinNotes);
	}

	private ClinicalContact getCurrentClinicalContact(ClinicalContactRefVo refVo) 
	{
		if (refVo == null)
			return null;
		
		DomainFactory factory = getDomainFactory();
		ClinicalContact domClinicalContact = (ClinicalContact)factory.getDomainObject(ClinicalContact.class, refVo.getID_ClinicalContact()); 
		
		return domClinicalContact;
	}
	
	/**
	* getClinicalNotes
	*/
	public ClinicalNotesVoCollection getClinicalNotes(ims.core.admin.vo.ClinicalContactRefVo contactVo) 
	{
		DomainFactory factory = getDomainFactory();
		StringBuffer hql = new StringBuffer(" from ClinicalNotes clinnote where "); 
		String andStr = " ";
	
		ArrayList<String> markers = new ArrayList<String>();
		ArrayList<Integer> values = new ArrayList<Integer>();
	
		hql.append(andStr + " clinnote.clinicalContact.id = :ccId");
			markers.add("ccId");
		values.add(contactVo.getID_ClinicalContact());
		
		hql.append(" ORDER BY recordingDateTime desc"); //WDEV-15382
		
		andStr = " and ";	

		
		
		List<?> listNotes = factory.find(hql.toString(), markers,values);
		if(listNotes != null && listNotes.size() > 0)
		{ 
			return ClinicalNotesVoAssembler.createClinicalNotesVoCollectionFromClinicalNotes(listNotes); //WDEV-15382
		}
		return null;
	}

	public MemberOfStaffVo getMemberOfStaff(MemberOfStaffShortVo mos)
	{
		MosAdmin mosAdmin = (MosAdmin)getDomainImpl(MosAdminImpl.class);
		return mosAdmin.getMemberOfStaff(mos);
	}

	public ClinicalContactVo getClinicalContact(Integer nId) 
	{
		ClinicalNoteDrawing clinImpl = (ClinicalNoteDrawing)getDomainImpl(ClinicalNoteDrawingImpl.class);
		return clinImpl.getClinicalContact(nId);
	}

	public ClinicalContactShortVo saveClinicalContact(ClinicalContactShortVo clinicalContactVo) throws StaleObjectException 
	{
		ClinicalNoteDrawing clinImpl = (ClinicalNoteDrawing)getDomainImpl(ClinicalNoteDrawingImpl.class);
		return clinImpl.saveClinicalContact(clinicalContactVo);
	}
	
	public ClinicalNotesVo getClinicalNotesForContact(ClinicalContactRefVo clinicalContactRefId) 
	{
		ClinicalNoteDrawing impl = (ClinicalNoteDrawing)getDomainImpl(ClinicalNoteDrawingImpl.class);
		return impl.getClinicalNotesForContact(clinicalContactRefId);
	}

	public ims.core.vo.ClinicalNotesVo getClinicalNote(ClinicalNotesRefVo clinicalNoteRefVo)
	{
		ClinicalNoteDrawing impl = (ClinicalNoteDrawing)getDomainImpl(ClinicalNoteDrawingImpl.class);
		return impl.getClinicalNotes(clinicalNoteRefVo.getID_ClinicalNotes());

	}

	public ClinicalNotesVo saveClinicalNotesAndClinicalContact(ClinicalNotesVo clinicalNote, ClinicalContactShortVo clinicalContact) throws DomainInterfaceException, StaleObjectException, UniqueKeyViolationException
	{
		if (clinicalNote == null)
			throw new DomainRuntimeException("Clinical Notes is null");
		// Ensure the value object has been validated
		if (!clinicalNote.isValidated())
			throw new DomainRuntimeException("Clinical Notes has not been validated");
		
		DomainFactory factory = getDomainFactory();
		
		
		//is new clinical note and is created for a clinical contact
		if (!clinicalNote.getID_ClinicalNotesIsNotNull() && clinicalNote.getClinicalContactIsNotNull())
		{
			if (!clinicalNote.getClinicalContact().getID_ClinicalContactIsNotNull())
				throw new DomainRuntimeException("The clinical contact from the clinical notes has no valid id");
			if (clinicalContact == null)
				throw new DomainRuntimeException("The clinical contact you provided should not be null ");
			if (!clinicalNote.getClinicalContact().getID_ClinicalContact().equals(clinicalContact.getID_ClinicalContact()))
				throw new DomainRuntimeException("The clinical contact you provided should be the same with the clinical contact from the clinical note ");
			
			String query = "select distinct cn.sourceOfNote.id from ClinicalNotes as cn where " +
							"(cn.clinicalContact.id = :ClinicalContact_id and " +
							"cn.noteType.id not in ("+
							ClinicalNoteType.SUMMARYATADMISSION.getID()+","+ClinicalNoteType.DISCHARGENOTE.getID()+") and cn.isRIE is null )";
			
			List<?> nodeTypes = factory.find(query, "ClinicalContact_id", clinicalNote.getClinicalContact().getID_ClinicalContact());
			
			if (nodeTypes != null && nodeTypes.size() > 0)
			{
				if (SourceOfNote.CLINICALCLINICALNOTE.getID() == ((Integer)nodeTypes.get(0)).intValue())
				{
					throw new CodingRuntimeException("A clinical note has been created by another user, the screen will be refreshed");
				}
				throw new CodingRuntimeException("ANOTHER_NOTE_FOR_CLINICAL_CONTACT");
			}
			
			//save clinicalcontact
			
			
			ClinicalContact extractClinicalContact = ClinicalContactShortVoAssembler.extractClinicalContact(factory,clinicalContact);
			// It is possible that somebody changed the clinical contact . So,  as  this is a background operation
			//we should get latest version to avoid stale.
			factory.refresh(extractClinicalContact);
			extractClinicalContact.setIsClinicalNoteCreated(Boolean.TRUE);
			factory.save(extractClinicalContact);
			
			
			
			clinicalContact = ClinicalContactShortVoAssembler.create(extractClinicalContact);
			clinicalNote.setClinicalContact(clinicalContact);
			
			
			
		}
		ClinicalNotes doClinNotes = ClinicalNotesVoAssembler.extractClinicalNotes(factory, clinicalNote);
		factory.save(doClinNotes);
		return ClinicalNotesVoAssembler.create(doClinNotes);
		
	}

}
