//#############################################################################
//#                                                                           #
//#  Copyright (C) <2014>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Daniel Laffan using IMS Development Environment (version 1.62 build 3040.26452)
// Copyright (C) 1995-2008 IMS MAXIMS plc. All rights reserved.

package ims.scheduling.forms.patientappointmentmanagement;

import ims.RefMan.vo.CatsReferralListVo;
import ims.configuration.gen.ConfigFlag;
import ims.core.resource.people.vo.MemberOfStaffRefVo;
import ims.core.vo.HcpLiteVo;
import ims.core.vo.PatientFilter;
import ims.core.vo.PatientId;
import ims.core.vo.PatientShort;
import ims.core.vo.PatientShortCollection;
import ims.core.vo.lookups.PatIdType;
import ims.domain.exceptions.DomainInterfaceException;
import ims.domain.exceptions.StaleObjectException;
import ims.framework.Control;
import ims.framework.FormName;
import ims.framework.MessageButtons;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.FormMode;
import ims.framework.exceptions.CodingRuntimeException;
import ims.framework.exceptions.PresentationLogicException;
import ims.framework.utils.Date;
import ims.framework.utils.DateFormat;
import ims.framework.utils.DateTime;
import ims.framework.utils.Time;
import ims.scheduling.forms.patientappointmentmanagement.GenForm.grdApptsRow;
import ims.scheduling.forms.patientappointmentmanagement.GenForm.grdPatientsRow;
import ims.scheduling.vo.Appointment_StatusVo;
import ims.scheduling.vo.Appointment_StatusVoCollection;
import ims.scheduling.vo.Appt_Tracking_Status_HistoryVo;
import ims.scheduling.vo.Appt_Tracking_Status_HistoryVoCollection;
import ims.scheduling.vo.Booking_AppointmentShortVo;
import ims.scheduling.vo.Booking_AppointmentShortVoCollection;
import ims.scheduling.vo.Booking_AppointmentVo;
import ims.scheduling.vo.SessionServiceAndSlotActivityVo;
import ims.scheduling.vo.lookups.AppointmentTrackingStatus;
import ims.scheduling.vo.lookups.Status_Reason;

public class Logic extends BaseLogic
{
	private static final long	serialVersionUID	= 1L;
	private static final int UNDO_ARRIVAL_IND = 1;	//wdev-12090
	private static final int UNDO_DNA_IND = 2;		//wdev-12090

	protected void onFormOpen(Object[] args) throws ims.framework.exceptions.PresentationLogicException
	{
		initialize();
	}

	private void initialize()
	{
		form.dteAppt().setValue(new Date());
		form.getLocalContext().setselectedPatient(null);
		form.lblDisplayPatId().setValue((PatIdType.getNegativeInstance(ConfigFlag.UI.DISPLAY_PATID_TYPE.getValue()).getText()) + ":");
		form.grdPatients().setHospitalNumberCaption((PatIdType.getNegativeInstance(ConfigFlag.UI.DISPLAY_PATID_TYPE.getValue()).getText()));
				
		clearContexts();
	}

	protected void onGrdApptsSelectionChanged() throws ims.framework.exceptions.PresentationLogicException
	{
		updateContextMenuState();
	}

	private void updateContextMenuState()
	{
		form.getContextMenus().Scheduling.hideAllPatientAppointmentManagementMenuItems();
		
		if(form.grdPatients().getValue() == null)
			return;
		
		Booking_AppointmentShortVo voAppt = form.grdAppts().getValue();
		
		//WDEV8891
		form.getContextMenus().Scheduling.getPatientAppointmentManagementCANCELLEDItem().setVisible(form.getMode().equals(FormMode.VIEW) && voAppt != null  && voAppt.getApptStatusIsNotNull()  && voAppt.getApptStatus().equals(Status_Reason.BOOKED));
		
		boolean isApptSelected = voAppt != null;	
		Status_Reason currentApptStatus = voAppt != null ? voAppt.getApptStatus() : null;		
		//WDEV10883
		form.getContextMenus().Scheduling.getPatientAppointmentManagementUNDO_ARRIVALItem().setVisible(form.getMode().equals(FormMode.VIEW) 
				&& voAppt != null  && voAppt.getApptStatusIsNotNull()  && voAppt.getApptStatus().equals(Status_Reason.ARRIVAL));
		
		//wdev-12090
		form.getContextMenus().Scheduling.getPatientAppointmentManagementUNDO_DNAItem().setVisible(form.getMode().equals(FormMode.VIEW) 
				&& voAppt != null  && voAppt.getApptStatusIsNotNull()  && voAppt.getApptStatus().equals(Status_Reason.DNA) && (voAppt.getIsCABBooking().equals(Boolean.FALSE) || !voAppt.getIsCABBookingIsNotNull()) );
		//----------

		if(currentApptStatus != null 
			&& voAppt.getAppointmentDateIsNotNull() //wdev-6529
			&& voAppt.getAppointmentDate().isLessOrEqualThan(new Date())) //wdev-6529
		{
			form.getContextMenus().Scheduling.getPatientAppointmentManagementATTENDEDItem().setVisible(form.getMode().equals(FormMode.VIEW) && isApptSelected && currentApptStatus.equals(Status_Reason.BOOKED));
			form.getContextMenus().Scheduling.getPatientAppointmentManagementSEENItem().setVisible(form.getMode().equals(FormMode.VIEW) && isApptSelected && currentApptStatus.equals(Status_Reason.ARRIVAL));			
			form.getContextMenus().Scheduling.getPatientAppointmentManagementOUTCOMEItem().setVisible(form.getMode().equals(FormMode.VIEW) && isApptSelected  &&(!currentApptStatus.equals(Status_Reason.DNA)) && ((currentApptStatus.equals(Status_Reason.SEEN) ||  currentApptStatus.equals(Status_Reason.ARRIVAL)) || (voAppt.getApptStatusHistoryIsNotNull() && voAppt.getApptStatusHistory().containsAny(new Status_Reason[]{Status_Reason.ARRIVAL, Status_Reason.SEEN}) && !Status_Reason.BOOKED.equals(currentApptStatus) && !Status_Reason.CANCELLED.equals(currentApptStatus))));///WDEV-12940		//WDEV-14642
			
			Boolean showDna = false;
			if(currentApptStatus.equals(Status_Reason.BOOKED))
			{
				if(voAppt.getAppointmentDateIsNotNull() && voAppt.getAppointmentDate().isLessThan(new Date()))
					showDna = false;
				//if day is the same include the time in the check
				else if(voAppt.getAppointmentDateIsNotNull() && voAppt.getAppointmentDate().equals(new Date()))
				{
					if(voAppt.getApptStartTimeIsNotNull() && voAppt.getApptStartTime().isLessThan(new Time()))
						showDna = false;
				}
			}
//			form.getContextMenus().Scheduling.getPatientAppointmentManagementDNAItem().setVisible(form.getMode().equals(FormMode.VIEW) && isApptSelected && showDna);
			form.getContextMenus().Scheduling.getPatientAppointmentManagementDNAItem().setVisible(false);
		}
	}

	protected void onGrdPatientsSelectionChanged() throws ims.framework.exceptions.PresentationLogicException
	{
		form.getLocalContext().setselectedPatient(form.grdPatients().getSelectedRow().getValue());
		form.getGlobalContext().Core.setPatientShort(form.grdPatients().getSelectedRow().getValue());
		listAppointmentsForPatientAndDate();
		clearInstanceControls();
		updateContextMenuState();
	}

	private void listAppointmentsForPatientAndDate()
	{
		Date dteAppt = null;
		if(form.getLocalContext().getDateApptIsNotNull())
			dteAppt = form.getLocalContext().getDateAppt();
		else
			dteAppt = form.dteAppt().getValue();
		Booking_AppointmentShortVoCollection voCollBookingAppointment = domain.listBookingAppointmentByPatientAndDate(form.getLocalContext().getselectedPatient(), dteAppt);
		populateApptsGrid(voCollBookingAppointment);
	}

	private void populateApptsGrid(Booking_AppointmentShortVoCollection voCollBookingAppointment)
	{
		form.grdAppts().getRows().clear();
		if(voCollBookingAppointment != null)
		{
			for(int i=0;i<voCollBookingAppointment.size();i++)
			{
				Booking_AppointmentShortVo voBooking = voCollBookingAppointment.get(i);
				grdApptsRow row = form.grdAppts().getRows().newRow();
				
				if(voBooking.getSessionIsNotNull())
					row.setClinicName(voBooking.getSession().getName());
				
				if(voBooking.getSeenByIsNotNull())
					row.setConsultant(voBooking.getSeenBy().toString());
				
				if(voBooking.getSessionIsNotNull())
					row.setClinicName(voBooking.getSession().getName());
				
				if(voBooking.getApptStartTimeIsNotNull())
					row.setAppointmentTime(voBooking.getApptStartTime().toString());
				
				if(voBooking.getApptStatusIsNotNull())
				{
					row.setStatus(voBooking.getApptStatus().toString());
					row.setBooking(voBooking.getApptStatus().getImage());
				}
				
				if(voBooking.getOutcomeIsNotNull())
					row.setTooltip("Outcome : " + voBooking.getOutcome().getText());
				
				row.setValue(voBooking);
			}
		}
		
	}

	protected void onImbClearClick() throws ims.framework.exceptions.PresentationLogicException
	{
		form.txtDisplayId().setValue(null);
		clearSearchCriteriaFields();
		clearGridsAndInstanceControls();
		form.dteAppt().setValue(new Date());
		form.getLocalContext().setselectedPatient(null);
		form.getGlobalContext().Core.setPatientShort(null); // WDEV-18127 
	}

	private void clearGridsAndInstanceControls()
	{
		form.grdPatients().getRows().clear();
		form.lblTotal().setValue("Total : 0");//WDEV-12990
		form.grdAppts().getRows().clear();
		clearInstanceControls();
	}

	private void clearInstanceControls()
	{
		updateContextMenuState();
		form.timTime().setValue(null);
	}

	protected void onImbSearchClick() throws ims.framework.exceptions.PresentationLogicException
	{
		if (validateSearchCriteria())
			populateGridWithPatients(search());
		
		updateContextMenuState();
	}

	private PatientShortCollection search()
	{
		form.grdAppts().getRows().clear();
		form.getLocalContext().setselectedPatient(null);
		
		
		form.grdPatients().getRows().clear();
		form.lblTotal().setValue("Total : " + form.grdPatients().getRows().size());//WDEV-12990
		PatientFilter voFilter = getPatientFilterDetails();
		PatientShortCollection voCollPatientShort = null;

		try
		{
			voCollPatientShort = domain.searchPatients(voFilter);
		}
		catch (DomainInterfaceException e)
		{
			engine.showMessage(e.getMessage());
			return null;
		}

		if (voCollPatientShort.size() == 0)
		{
			engine.showMessage("No patients found");
			return null;
		}

		return voCollPatientShort;
	}

	private boolean validateSearchCriteria()
	{
		if (form.txtDisplayId().getValue() != null && form.txtDisplayId().getValue().length() > 0)
			clearSearchCriteriaFields();
		else
		{

			// If it is a local search strip out the non-alpha except % chars
			// before validation
			if ((ConfigFlag.DOM.PATIENT_SEARCH_TYPE.getValue().equals("LOCAL")) && (form.txtSurname().getValue() == null || form.txtSurname().getValue().replaceAll("[^a-zA-Z%]", "").length() == 0))
			{
				engine.showMessage("Please enter a valid Surname search string");
				return false;
			}
			else if (form.txtSurname().getValue() == null || form.txtSurname().getValue().length() == 0)
			{
				engine.showMessage("Please enter a Surname search string");
				return false;
			}

			// Mandatory Search on forname
			if ((ConfigFlag.DOM.PATIENT_SEARCH_TYPE.getValue().equals("LOCAL")) && (ConfigFlag.UI.SEARCH_REQ_FORENAME.getValue()) && (form.txtName().getValue() == null || form.txtName().getValue().replaceAll("[^a-zA-Z%]", "").length() == 0))
			{
				engine.showMessage("Please enter a valid Forename search string");
				return false;
			}

			else if ((ConfigFlag.UI.SEARCH_REQ_FORENAME.getValue()) && (form.txtName().getValue() == null || form.txtName().getValue().length() == 0))
			{
				engine.showMessage("Please enter a valid Forename search string");
				return false;
			}
		}

		return true;
	}

	private void populateGridWithPatients(PatientShortCollection voCollPatientShort)
	{
		if (voCollPatientShort == null)
			return;

		for (int i = 0; i < voCollPatientShort.size(); i++)
		{
			PatientShort voPatShort = voCollPatientShort.get(i);
			grdPatientsRow row = form.grdPatients().getRows().newRow();

			if (voPatShort.getName() != null)
			{
				if (voPatShort.getName().getSurnameIsNotNull())
				{
					row.setSurname(voPatShort.getName().getSurname());
					row.setTooltipForSurname(voPatShort.getName().getSurname());
				}
				if (voPatShort.getName().getForenameIsNotNull())
				{
					row.setName(voPatShort.getName().getForename());
					row.setTooltipForName(voPatShort.getName().getForename());
				}
			}

			if (voPatShort.getDisplayId() != null)
			{
				row.setHospitalNumber(voPatShort.getDisplayId().getValue());
				row.setTooltipForHospitalNumber(voPatShort.getDisplayId().getValue());
			}
			
			if (voPatShort.getDob() != null)
				row.setDOB(voPatShort.getDob().toString(DateFormat.STANDARD));

			row.setValue(voPatShort);

			if (voPatShort.getAssociatedPatientIsNotNull())
				row.setBackColor(ConfigFlag.UI.MERGED_COLOUR.getValue());

			if (voPatShort.getIsDead().booleanValue())
				row.setBackColor(ConfigFlag.UI.RIP_COLOUR.getValue());
		}
		form.lblTotal().setValue("Total : " + form.grdPatients().getRows().size());
	}

	private PatientFilter getPatientFilterDetails()
	{
		PatientFilter voPatFilter = new PatientFilter();

		if (form.txtDisplayId().getValue() != null && form.txtDisplayId().getValue().length() > 0)
		{
			PatientId pid = new PatientId();
			pid.setType(PatIdType.getNegativeInstance(ConfigFlag.UI.DISPLAY_PATID_TYPE.getValue()));
			pid.setValue(form.txtDisplayId().getValue());
			voPatFilter.setPersId(pid);
		}
		else
		{
			voPatFilter.setForename(form.txtName().getValue());
			voPatFilter.setSurname(form.txtSurname().getValue());
			voPatFilter.setDob(form.pdtDate().getValue());
		}

		return voPatFilter;
	}

	private void clearSearchCriteriaFields()
	{
		form.txtSurname().setValue(null);
		form.txtName().setValue(null);
		form.pdtDate().setValue(null);
	}

	protected void onImbNextDateClick() throws PresentationLogicException
	{
		Date date = form.dteAppt().getValue().copy();
		date.addDay(1);
		form.dteAppt().setValue(date);	
		form.getLocalContext().setDateAppt(null);
		if(form.grdPatients().getValue() != null)
		{
			listAppointmentsForPatientAndDate();
			clearInstanceControls();
		}
	}

	protected void onImbPrevDateClick() throws PresentationLogicException
	{
		Date date = form.dteAppt().getValue().copy();
		date.addDay(-1);
		form.dteAppt().setValue(date);
		form.getLocalContext().setDateAppt(null);
		if(form.grdPatients().getValue() != null)
		{
			listAppointmentsForPatientAndDate();
			clearInstanceControls();
		}	
	}

	protected void onContextMenuItemClick(int menuItemID, Control sender) throws PresentationLogicException
	{
		switch (menuItemID)
		{
			case GenForm.ContextMenus.SchedulingNamespace.PatientAppointmentManagement.ATTENDED:
				form.getLocalContext().setNewStatus(Status_Reason.ARRIVAL);
				
				//WDEV-11770
				form.getLocalContext().setTrackingStatus(AppointmentTrackingStatus.PATIENT_ARRIVED);
				
				form.setMode(FormMode.EDIT);
				form.timTime().setValue(new Time());
				break;
			case GenForm.ContextMenus.SchedulingNamespace.PatientAppointmentManagement.SEEN:
				form.getLocalContext().setNewStatus(Status_Reason.SEEN);
				
				//WDEV-11770
				form.getLocalContext().setTrackingStatus(AppointmentTrackingStatus.PATIENT_SEEN_BY_CONSULTANT);
				
				form.setMode(FormMode.EDIT);
				form.timTime().setValue(new Time());
				break;
			case GenForm.ContextMenus.SchedulingNamespace.PatientAppointmentManagement.CANCELLED:
				Booking_AppointmentShortVo voAppt = form.grdAppts().getValue();
				if(voAppt != null)
				{
					SessionServiceAndSlotActivityVo voServiceAndActivity = null;
					//flexible appointment cancel WDEV-7766
					boolean flexible = false;
					if(voAppt.getSessionIsNotNull() && voAppt.getSession().getIsFixedIsNotNull() && !voAppt.getSession().getIsFixed())
						flexible = true;
					//wdev-11902
					CatsReferralListVo voReferral = domain.getCatsReferralForAppointment(form.grdAppts().getValue());
					form.getGlobalContext().RefMan.setCatsReferralStatus(voReferral != null ? voReferral.getCurrentStatus() : null);	//wdev-12335
					form.getGlobalContext().Scheduling.setBookingAppointmentRef(voAppt);
					voServiceAndActivity = domain.getServiceAndActivityByAppt(voAppt, flexible);
					//WDEV-12284 start
					//SOE
					if (voServiceAndActivity== null)
					{
						engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
						open();
						return;
					}
					//WDEV-12284 stop
					form.getGlobalContext().Scheduling.setBookingActivity(voServiceAndActivity.getSlotActivity());
					form.getGlobalContext().Scheduling.setBookingService(voServiceAndActivity.getSessionService());
					form.getGlobalContext().Scheduling.setBookingSession(voAppt.getSession());
					form.getGlobalContext().ChooseAndBook.setisCABAppt(voAppt.getIsCABBooking());
					engine.open(form.getForms().Scheduling.CancelAppointmentDialog);

				}
				break;
			case GenForm.ContextMenus.SchedulingNamespace.PatientAppointmentManagement.DNA:
//				form.getLocalContext().setNewStatus(Status_Reason.DNA);
//				if(save())
//					open();
				break;
			case GenForm.ContextMenus.SchedulingNamespace.PatientAppointmentManagement.OUTCOME:
				voAppt = form.grdAppts().getValue();
				if(voAppt != null)
				{
					form.getGlobalContext().Scheduling.setBookingAppointmentRef(voAppt);
					engine.open(form.getForms().Scheduling.AppointmentOutcomeDialog);
				}
				break;
			case GenForm.ContextMenus.SchedulingNamespace.PatientAppointmentManagement.UNDO_ARRIVAL:
				undoArrival();
				break;
			
			case GenForm.ContextMenus.SchedulingNamespace.PatientAppointmentManagement.UNDO_DNA:        //wdev-12090
				undoDNA(); 																				//wdev-12090
			default:
		}
		
	}	
	//wdev-12090
	private void undoDNA()
	{
		form.getLocalContext().setMessageBoxId(UNDO_DNA_IND);
		engine.showMessage("Are you sure you want to Undo this DNA?", "Undo DNA", MessageButtons.YESNO);
	}
	//-------
	private void undoArrival() 
	{
		form.getLocalContext().setMessageBoxId(UNDO_ARRIVAL_IND);	//wdev-12090
		engine.showMessage("Are you sure you want to Undo this Arrival?", "Undo Arrival", MessageButtons.YESNO); //wdev-12090
		//form.getLocalContext().setMessageBoxId(engine.showMessage("Are you sure you want to Undo this Arrival?", "Undo Arrival", MessageButtons.YESNO));
		
	}

	private boolean save()
	{
		if(form.grdAppts().getValue() == null)
			throw new CodingRuntimeException("No Appointment selected to manage");
		
		if(form.getLocalContext().getNewStatus() == null)
			throw new CodingRuntimeException("NewStatus not set in method saveBookingAppointmentWithNewStatus");
	
		Booking_AppointmentShortVo voAppt = form.grdAppts().getValue();
		
		Status_Reason status = form.getLocalContext().getNewStatus();
		if(status.equals(Status_Reason.SEEN))
		{	
			//WDEV-18480
			voAppt.setSeenBy((HcpLiteVo) domain.getHcpLiteUser());
			voAppt.setSeenTime(form.timTime().getValue());
		}	
		else if(status.equals(Status_Reason.ARRIVAL))
			voAppt.setArrivalTime(form.timTime().getValue());

		voAppt.setApptStatus(status);
		Appointment_StatusVo voStatus = new Appointment_StatusVo();
		voStatus.setApptDate(voAppt.getAppointmentDate());
		voStatus.setApptTime(voAppt.getApptStartTime());
		voStatus.setStatusChangeDateTime(new DateTime());
		voStatus.setStatus(form.getLocalContext().getNewStatus());
		
		Appointment_StatusVoCollection voCollStatusHistory = voAppt.getApptStatusHistory();
		if(voCollStatusHistory == null)
			voCollStatusHistory =  new Appointment_StatusVoCollection();
		
		voCollStatusHistory.add(voStatus);
		voAppt.setCurrentStatusRecord(voStatus); // wdev-6034
		voAppt.setApptStatusHistory(voCollStatusHistory);
		
		//WDEV-11770
		populateAppointmentWithTrackingStatus(voAppt, form.getLocalContext().getTrackingStatus());
		
		String[] arrErrors = voAppt.validate();
		if(arrErrors != null)
		{
			engine.showErrors(arrErrors);
			return false;
		}	
		
		try
		{
			domain.saveBookingAppt(voAppt, false,false);
		}
		catch (StaleObjectException e)
		{
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			open();	//WDEV-11780
			//clearGridsAndInstanceControls();	//WDEV-11780
			return false;
		}
		
		form.getLocalContext().setDateAppt(form.dteAppt().getValue());
		
		return true;
	}

	//WDEV-11770 - starts here
	private void populateAppointmentWithTrackingStatus(Booking_AppointmentShortVo voAppt, AppointmentTrackingStatus trackingStatus) 
	{
		if(voAppt == null || trackingStatus == null)
			return;
		
		Appt_Tracking_Status_HistoryVoCollection trackingCollection = voAppt.getApptTrackingStatusHistory();
		
		if(trackingCollection == null)
			trackingCollection = new Appt_Tracking_Status_HistoryVoCollection();
		
		Appt_Tracking_Status_HistoryVo newTrackingStatus = new Appt_Tracking_Status_HistoryVo();
		newTrackingStatus.setTrackingStatus(trackingStatus);
		newTrackingStatus.setApptDate(voAppt.getAppointmentDate());
		newTrackingStatus.setApptTime(voAppt.getApptStartTime());
		newTrackingStatus.setStatusChangeDateTime(new DateTime());
		
		Object mosUser = domain.getMosUser();
		newTrackingStatus.setChangedBy(mosUser instanceof MemberOfStaffRefVo ? (MemberOfStaffRefVo) mosUser : null);
		
		trackingCollection.add(newTrackingStatus);
		voAppt.setApptTrackingStatusHistory(trackingCollection);
	}
	//WDEV-11770 - ends here

	protected void onBtnCancelClick() throws PresentationLogicException
	{
		form.getLocalContext().setDateAppt(form.dteAppt().getValue());
		open();
		
	}

	protected void onBtnSaveClick() throws PresentationLogicException
	{
		if(save())
			open();
	}

	private void open()
	{
		clearContexts();
		form.setMode(FormMode.VIEW);
		form.grdAppts().setValue(null);
		form.getLocalContext().setNewStatus(null);
		updateContextMenuState();
		clearInstanceControls();
		if(form.getLocalContext().getDateAppt()==null)
			form.dteAppt().setValue(new Date());
		listAppointmentsForPatientAndDate();
	}

	protected void onFormDialogClosed(FormName formName, DialogResult result) throws PresentationLogicException
	{
		if(formName.equals(form.getForms().Scheduling.CancelAppointmentDialog))
		{
			if(result.equals(DialogResult.OK))
			{
				if(!cancelAppt())
					return;
				
				CatsReferralListVo voReferral = domain.getCatsReferralForAppointment(form.grdAppts().getValue());
				try
				{
					domain.updateCatsReferralAdditionalInvStatus(voReferral);
					
					domain.updateCatsReferralCancelStatus(voReferral);
				}
				catch (StaleObjectException e)
				{
					engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
					return;
				}
				
				//open book appointment
				if(form.getGlobalContext().Scheduling.getApptCancelStatusIsNotNull() && form.getGlobalContext().Scheduling.getApptCancelStatus().getRebookSelectedIsNotNull() && form.getGlobalContext().Scheduling.getApptCancelStatus().getRebookSelected())
				{
					form.getGlobalContext().Core.setPatientShort(form.grdPatients().getValue());
					
					if(ConfigFlag.UI.BOOKAPPT_UI_TYPE.getValue().equals("CARE_UK"))
					{
						form.getGlobalContext().RefMan.setCatsReferral(voReferral);
						form.getGlobalContext().RefMan.setReferralContractTypeForPatient(voReferral.getContractIsNotNull() ? voReferral.getContract().getContractType() : null );//wdev-12682

						engine.open(form.getForms().RefMan.BookAppointment);
					}
					else
						engine.open(form.getForms().Scheduling.BookAppointment);
				}
				else
					open();
			}
			if(result.equals(DialogResult.CANCEL))
			{
				onBtnCancelClick();
			}
		}
		else if(formName.equals(form.getForms().Scheduling.AppointmentOutcomeDialog))
		{
			if(result.equals(DialogResult.OK))
				open();
		}
	}
	
	private void clearContexts()
	{
		form.getGlobalContext().Scheduling.setBookingActivity(null);
		form.getGlobalContext().Scheduling.setBookingAppointment(null);
		form.getGlobalContext().Scheduling.setBookingAppointmentRef(null);
		form.getGlobalContext().Scheduling.setBookingService(null);
		form.getGlobalContext().Scheduling.setBookingSession(null);
		
		//WDEV-11770
		form.getLocalContext().setTrackingStatus(null);
	}

	private boolean cancelAppt() 
	{
		Booking_AppointmentShortVo voAppt = form.grdAppts().getValue();
		if(form.getGlobalContext().Scheduling.getApptCancelStatusIsNotNull())
		{
			//appt status and status history
			voAppt.setApptStatus(Status_Reason.CANCELLED);
			voAppt.setApptStatusReas(form.getGlobalContext().Scheduling.getApptCancelStatus().getStatusReason());
			
			Appointment_StatusVo voStatus = new Appointment_StatusVo();
			voStatus.setApptDate(voAppt.getAppointmentDate());
			voStatus.setApptTime(voAppt.getApptStartTime());
			voStatus.setStatusChangeDateTime(new DateTime());
			voStatus.setStatus(Status_Reason.CANCELLED);
			if(form.getGlobalContext().Scheduling.getApptCancelStatusIsNotNull())
			{
				voStatus.setCancellationReason(form.getGlobalContext().Scheduling.getApptCancelStatus().getCancellationReason());
				voStatus.setComment(form.getGlobalContext().Scheduling.getApptCancelStatus().getComment()); //WDEV-15458
				if(form.getGlobalContext().Scheduling.getApptCancelStatus().getRebookSelectedIsNotNull())
					voAppt.setRequiresRebook(form.getGlobalContext().Scheduling.getApptCancelStatus().getRebookSelected());
			}
			Appointment_StatusVoCollection voCollStatusHistory = voAppt.getApptStatusHistory();
			if(voCollStatusHistory == null)
				voCollStatusHistory =  new Appointment_StatusVoCollection();
			
			voCollStatusHistory.add(voStatus);
			voAppt.setCurrentStatusRecord(voStatus); // wdev-6034
			voAppt.setApptStatusHistory(voCollStatusHistory);	
		}

		String[] arrErrors = voAppt.validate();
		if(arrErrors != null)
		{
			engine.showErrors(arrErrors);
			return false;
		}	
		
		Booking_AppointmentVo voApptFull = null;
		try
		{
			voApptFull = domain.saveBookingAppt(voAppt, false,false);
		}
		catch (StaleObjectException e)
		{
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			//clearGridsAndInstanceControls();	//WDEV-11780
			open();	//WDEV-11780
			return false;
		}
		
		form.getGlobalContext().Scheduling.setBookingAppointment(voApptFull);
		form.getLocalContext().setDateAppt(form.dteAppt().getValue());
		return true;
	}

	protected void onDteApptValueChanged() throws PresentationLogicException
	{
		form.getLocalContext().setDateAppt(null);
		if(form.getLocalContext().getselectedPatient() != null)
		{
			listAppointmentsForPatientAndDate();
			clearInstanceControls();
		}
	}

	@Override
	protected void onFormModeChanged()
	{
		updateContextMenuState();
	}

	@Override
	protected void onMessageBoxClosed(int messageBoxId, DialogResult result) throws PresentationLogicException 
	{
		if (form.getLocalContext().getMessageBoxIdIsNotNull()
			&& form.getLocalContext().getMessageBoxId().equals(UNDO_ARRIVAL_IND)	//wdev-12090
			&& result.equals(DialogResult.YES))
		{
			undoAppointmentArrival();
		}
		//wdev-12090
		else if(form.getLocalContext().getMessageBoxIdIsNotNull()
				&& form.getLocalContext().getMessageBoxId().equals(UNDO_DNA_IND)
				&& result.equals(DialogResult.YES))
		{
			undoAppointmentDNA();
		}
		form.getLocalContext().setMessageBoxId(null);
		//---------------------------------------
			
		
	}

	private void undoAppointmentArrival() 
	{
		Booking_AppointmentShortVo voAppt = form.grdAppts().getValue();

		//appt status and status history
		voAppt.setApptStatus(Status_Reason.BOOKED);
		voAppt.setApptStatusReas(Status_Reason.DATA_CORRECTED);	//WDEV-12341
		voAppt.setArrivalTime(null);
		
		//WDEV-12341 - starts here
		Appointment_StatusVo voCorrectedStatus = new Appointment_StatusVo();
		voCorrectedStatus.setApptDate(voAppt.getAppointmentDate());
		voCorrectedStatus.setApptTime(voAppt.getApptStartTime());
		voCorrectedStatus.setStatusChangeDateTime(new DateTime());
		voCorrectedStatus.setStatus(Status_Reason.BOOKED);
		voCorrectedStatus.setStatusReason(Status_Reason.DATA_CORRECTED);
		//WDEV-12341 - ends here
				
		Appointment_StatusVoCollection voCollStatusHistory = voAppt.getApptStatusHistory();
		if(voCollStatusHistory == null)
			voCollStatusHistory =  new Appointment_StatusVoCollection();
			
		voCollStatusHistory.add(voCorrectedStatus);		//WDEV-12341
		voAppt.setCurrentStatusRecord(voCorrectedStatus);
		voAppt.setApptStatusHistory(voCollStatusHistory);	
		
		voAppt.setOutcome(null);//WDEV-12940
		voAppt.setOutcomeComments(null);//WDEV-12940
		
		
		//WDEV-12942if(!voAppt.getApptTrackingStatusHistoryIsNotNull())											//wdev-12364
		//	voAppt.setApptTrackingStatusHistory(new Appt_Tracking_Status_HistoryVoCollection());	//WDEV-11770
		
		//WDEV-17987
		populateAppointmentWithTrackingStatus(voAppt, AppointmentTrackingStatus.UNDO_ARRIVAL);

		String[] arrErrors = voAppt.validate();
		if(arrErrors != null)
		{
			engine.showErrors(arrErrors);
			return;
		}	
		
		Booking_AppointmentVo voApptFull = null;
		try
		{
			voApptFull = domain.saveBookingAppt(voAppt, true,false);
		}
		catch (StaleObjectException e)
		{
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			open();
			return;
		}
		
		form.getGlobalContext().Scheduling.setBookingAppointment(voApptFull);
		form.getLocalContext().setDateAppt(form.dteAppt().getValue());
		open();
	}
	//wdev-12090
	private void undoAppointmentDNA() 
	{
		Booking_AppointmentShortVo voAppt = form.grdAppts().getValue();
		Booking_AppointmentVo  voApptFull = domain.getBookingAppointmet(voAppt);
		if(voApptFull == null)
		{
			engine.showErrors(new String[]{"Appointment Invalid."});
			return;
		}
		//wdev-12340
		if(voAppt != null && voAppt.getVersion_Booking_Appointment() !=  voApptFull.getVersion_Booking_Appointment())
		{
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			form.getGlobalContext().Scheduling.setBookingAppointment(voApptFull);
			form.getLocalContext().setDateAppt(form.dteAppt().getValue());
			open();
			return;
		}
		//------------------
		//appt status and history
		voApptFull.setApptStatus(Status_Reason.BOOKED);
		voApptFull.setApptStatusReas(Status_Reason.DATA_CORRECTED);
		voApptFull.setRequiresRebook(Boolean.FALSE);
		voApptFull.setArrivalTime(null);
		
		Appointment_StatusVo voStatus = new Appointment_StatusVo();
		voStatus.setApptDate(voAppt.getAppointmentDate());
		voStatus.setApptTime(voAppt.getApptStartTime());
		voStatus.setStatusChangeDateTime(new DateTime());
		voStatus.setStatus(Status_Reason.BOOKED);
		voStatus.setStatusReason(Status_Reason.DATA_CORRECTED);
	
		Appointment_StatusVoCollection voCollStatusHistory = voAppt.getApptStatusHistory();
		if(voCollStatusHistory == null)
			voCollStatusHistory =  new Appointment_StatusVoCollection();
		
		voCollStatusHistory.add(voStatus);
		voApptFull.setCurrentStatusRecord(voStatus); 
		voApptFull.setApptStatusHistory(voCollStatusHistory);	
		
		if(voApptFull.getSessionSlotIsNotNull())
			voApptFull.getSessionSlot().setStatus(Status_Reason.APPOINTMENT_BOOKED);

		//WDEV-11770
		voApptFull.setApptTrackingStatusHistory(new Appt_Tracking_Status_HistoryVoCollection());
		//WDEV-18401
		boolean isDNARecProcessableforRTT = form.getLocalContext().getMessageBoxIdIsNotNull() && form.getLocalContext().getMessageBoxId().equals(UNDO_DNA_IND) && ConfigFlag.DOM.RTT_STATUS_POINT_FUNCTIONALITY.getValue() && voApptFull.getActivityIsNotNull() && voApptFull.getActivity().getFirstAppointment();
		String[] arrErrors = voApptFull.validate();
		if(arrErrors != null)
		{
			engine.showErrors(arrErrors);
			return;
		}	
		
		try
		{
			voApptFull = domain.saveBookingApptFull(voApptFull,isDNARecProcessableforRTT); //WDEV-18401  new argument passed to domain
		}
		catch (StaleObjectException e)
		{
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			open();
			return;
		}
		
		form.getGlobalContext().Scheduling.setBookingAppointment(voApptFull);
		form.getLocalContext().setDateAppt(form.dteAppt().getValue());
		open();
	}
}
