//#############################################################################
//#                                                                           #
//#  Copyright (C) <2014>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Rory Fitzpatrick using IMS Development Environment (version 1.71 build 3763.19232)
// Copyright (C) 1995-2010 IMS MAXIMS. All rights reserved.

package ims.ocrr.forms.centricitywebpacsviewer;

import ims.configuration.gen.ConfigFlag;
import ims.core.resource.people.vo.MemberOfStaffRefVo;
import ims.core.vo.PacsConfigurationVo;
import ims.core.vo.lookups.PACSClientType;
import ims.domain.exceptions.StaleObjectException;
import ims.framework.utils.DateTime;
import ims.ocrr.vo.PACSLaunchAuditVo;

public class Logic extends BaseLogic
{
	private static final long serialVersionUID = 1L;

	@Override
	protected void onFormOpen(Object[] args) throws ims.framework.exceptions.PresentationLogicException
	{
		PacsConfigurationVo tempVo = domain.getPACSConfigVo();
		if(tempVo == null)
		{
			engine.showMessage("No PACS Configuration found.");
			return;
		}
			
		StringBuffer sbURL = new StringBuffer();
		sbURL.append(tempVo.getURLWithoutTestAccessionNumber());

		if (form.getGlobalContext().OCRR.CentricityWebPACS.getAccessionNumberIsNotNull())
			sbURL.append(form.getGlobalContext().OCRR.CentricityWebPACS.getAccessionNumber());
		else
		{
			engine.showMessage("Accession Number is null.");
			return;
		}
		
		if (form.getGlobalContext().Core.getPatientShort() != null)
		{
			PACSLaunchAuditVo voPacs = new PACSLaunchAuditVo();
			voPacs.setPatient(form.getGlobalContext().Core.getPatientShort());
			voPacs.setAccessionNo(form.getGlobalContext().OCRR.CentricityWebPACS.getAccessionNumber());
			voPacs.setLaunchDateTime(new DateTime());
			if (engine.getLoggedInUser() != null
				&& engine.getLoggedInUser().getMosId() != null	)
				voPacs.setLaunchingUser(new MemberOfStaffRefVo(engine.getLoggedInUser().getMosId(), 0));
			voPacs.setPACSClientType(tempVo.getPACSClientType());
			
			voPacs.validate();

			String[] arrErrors = voPacs.validate();
			if (arrErrors != null)
			{
				engine.showErrors(arrErrors);
				return;
			}

			try 
			{
				domain.savePACSAuditRecord(voPacs);
			} 
			catch (StaleObjectException e) 
			{
				engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
				return;
			}
		}
				
		if (tempVo.getPACSClientTypeIsNotNull())
		{
			if (tempVo.getPACSClientType().equals(PACSClientType.CENTRICITY))
			{
				form.htmView().setIFrameValue(sbURL.toString());
			}
			else if (tempVo.getPACSClientType().equals(PACSClientType.CARESTREAM))
			{
				StringBuffer html = new StringBuffer();				
				html.append("<OBJECT ID=\"ChromeFrame\" width=\"100%\" height =\"100%\" CODEBASE=\"http://www.google.com\"");
				html.append("CLASSID=\"CLSID:E0A900DF-9611-4446-86BD-4B1D47E7DB2A\">");
				html.append("<PARAM NAME=\"src\" VALUE=\"" + sbURL.toString() +"\">");
				html.append("</OBJECT>");
				form.htmView().setHTML(html.toString(), true);								
			}
		}
		else
		{
			form.htmView().setIFrameValue(sbURL.toString());
		}
	}

}
