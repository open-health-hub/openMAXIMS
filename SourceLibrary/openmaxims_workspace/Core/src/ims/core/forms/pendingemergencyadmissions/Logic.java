//#############################################################################
//#                                                                           #
//#  Copyright (C) <2014>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Ander Telleria using IMS Development Environment (version 1.66 build 3261.22124)
// Copyright (C) 1995-2008 IMS MAXIMS plc. All rights reserved.

package ims.core.forms.pendingemergencyadmissions;

import ims.configuration.AppRight;
import ims.configuration.gen.ConfigFlag;
import ims.core.forms.pendingemergencyadmissions.GenForm.grdAdmissionsRow;
import ims.core.resource.place.vo.LocationRefVo;
import ims.core.vo.HcpFilter;
import ims.core.vo.HcpLiteVo;
import ims.core.vo.HcpLiteVoCollection;
import ims.core.vo.LocMostVo;
import ims.core.vo.LocationLiteVo;
import ims.core.vo.LocationLiteVoCollection;
import ims.core.vo.PatientAlertLiteVo;
import ims.core.vo.PatientShort;
import ims.core.vo.PendingEmergencyAdmissionLiteVo;
import ims.core.vo.PendingEmergencyAdmissionLiteVoCollection;
import ims.core.vo.PendingEmergencyAdmissionsDataVo;
import ims.core.vo.PersonName;
import ims.core.vo.enums.PendingEmergencyEventFired;
import ims.core.vo.lookups.AlertType;
import ims.core.vo.lookups.EmergencyAdmissionStatus;
import ims.core.vo.lookups.HcpDisType;
import ims.core.vo.lookups.LocationType;
import ims.core.vo.lookups.LookupHelper;
import ims.core.vo.lookups.PatIdType;
import ims.domain.exceptions.StaleObjectException;
import ims.framework.Control;
import ims.framework.FormName;
import ims.framework.MessageButtons;
import ims.framework.MessageIcon;
import ims.framework.cn.data.TreeNode;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.SortOrder;
import ims.framework.exceptions.PresentationLogicException;
import ims.framework.utils.Color;
import ims.framework.utils.DateTime;
import ims.vo.LookupInstVo;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Comparator;
import java.util.GregorianCalendar;

public class Logic extends BaseLogic
{
	/**
	 * WDEV-13136
	 * @author George Josan
	 *	Comparator for manual sorting after age
	 */
	private static class AgeComparator implements Comparator<PendingEmergencyAdmissionLiteVo>
	{
		private int direction;

		public AgeComparator(SortOrder sortOrderAge)
		{
			if (SortOrder.ASCENDING.equals(sortOrderAge))
				direction = 1;
			else
				direction = -1;
		}

		/**
		 * Function used to compare two records after age
		 */
		public int compare(PendingEmergencyAdmissionLiteVo o1, PendingEmergencyAdmissionLiteVo o2)
		{
			if (o1.getPasEventIsNotNull() && o1.getPasEvent().getPatientIsNotNull() && o1.getPasEvent().getPatient().getAgeIsNotNull()
					&& o2.getPasEventIsNotNull() && o2.getPasEvent().getPatientIsNotNull() && o2.getPasEvent().getPatient().getAgeIsNotNull())
			{
				return o1.getPasEvent().getPatient().getAge().compareTo(o2.getPasEvent().getPatient().getAge()) * direction;
			}
			
			if (o1.getPasEventIsNotNull() && o1.getPasEvent().getPatientIsNotNull() && o1.getPasEvent().getPatient().getAgeIsNotNull()
					&& (!o2.getPasEventIsNotNull() || !o2.getPasEvent().getPatientIsNotNull() || !o2.getPasEvent().getPatient().getAgeIsNotNull()) )
			{
				return direction;
			}
			
			if (o1.getPasEventIsNotNull() && o1.getPasEvent().getPatientIsNotNull() && o1.getPasEvent().getPatient().getAgeIsNotNull()
					&& (!o2.getPasEventIsNotNull() || !o2.getPasEvent().getPatientIsNotNull() || !o2.getPasEvent().getPatient().getAgeIsNotNull()) )
			{
				return -1 * direction;
			}

			return 0;
		}
	}

	/**
	 *  WDEV-18011 
	 *	Comparator for manual sorting after alert image
	 */
	private static class AlertComparator implements Comparator<PendingEmergencyAdmissionLiteVo>
	{
		private int direction;

		public AlertComparator(SortOrder sortOrderAlert)
		{
			if (SortOrder.ASCENDING.equals(sortOrderAlert))
				direction = 1;
			else
				direction = -1;
		}

		/**
		 * Function used to compare two records after alert image
		 */
		public int compare(PendingEmergencyAdmissionLiteVo o1, PendingEmergencyAdmissionLiteVo o2)
		{
			if (o1.getPasEvent()!= null && o1.getPasEvent().getPatient() != null && o2.getPasEvent() != null && o2.getPasEvent().getPatient() != null)
			{
				Integer val1 = Boolean.TRUE.equals(o1.getActiveAlerts()) ? 1 : 0;
				Integer val2 = Boolean.TRUE.equals(o2.getActiveAlerts()) ? 1 : 0;
				
				if (val1 != 0 && val2 != 0)
				{
					return val1.compareTo(val2) * direction;
				}

				if (val1 != 0 && val2 == 0)
				{
					return direction;
				}

				if (val2 != 0 && val1 == 0)
				{
					return -1 * direction;
				}	
			}

		return 0;
		}
	}
	
	private static final long	serialVersionUID	= 1L;
	
	private static final int COL_DATE_DECISION_TO_ADMIT = 10;
	private static final int COL_AGE = 3;
	private static final int COL_ALERT = 5;

	@Override
	protected void onFormOpen(Object[] args) throws ims.framework.exceptions.PresentationLogicException
	{
		initialize();
		refreshSearchCriteria(false);
		enableAutoRefeshStart(true);	//wdev-11804
	}

	private void initialize()
	{
		form.getLocalContext().setbTimerOn(false);
		
		clearControls();
		loadHospitals();

		form.cmbIDType().setValue(PatIdType.getNegativeInstance(ConfigFlag.UI.DISPLAY_PATID_TYPE.getValue()));

		if (form.cmbHospital().getValue() == null && engine.getCurrentLocation() != null)
		{
			// Try and load the logged in location as a ward
			LocMostVo voLoc = domain.getLocation((LocationRefVo) engine.getCurrentLocation());
			if (voLoc != null && voLoc.getTypeIsNotNull() && voLoc.getType().equals(LocationType.WARD))
			{
				form.cmbHospital().setValue(voLoc.getParentLocation());

				form.qmbWard().newRow(voLoc, voLoc.getName());
				form.qmbWard().setValue(voLoc);
			}
		}

		loadAlerts();
		
		setWatchDefaultButtonState();
	}

	private void setWatchDefaultButtonState()
	{
		if(form.getLocalContext().getbTimerOn() == null)
			return;
		
		if (form.getLocalContext().getbTimerOn())
		{
			enableAutoRefeshStart(true);
		}
		else
		{
			enableAutoRefeshStart(false);
		}
	}
	
	private void refreshSearchCriteria(Boolean timerCalled)
	{
		PendingEmergencyAdmissionsDataVo voFilter = form.getGlobalContext().STHK.getPendingEmergencyAdmissionsFilter();

		if (voFilter != null)
		{
			form.txtIDNum().setValue(voFilter.getIDNumber());
			form.cmbIDType().setValue(voFilter.getIDType());
			form.txtSurname().setValue(voFilter.getPatientSurname());
			form.txtForeName().setValue(voFilter.getPatientForename());

			form.cmbHospital().setValue(null);
			for (int i = 0; voFilter.getHospitalIsNotNull() && i < form.cmbHospital().getValues().size(); i++)
			{
				LocationLiteVo voHosp = (LocationLiteVo) form.cmbHospital().getValues().get(i);
				if (voHosp.getID_Location().equals(voFilter.getHospital().getID_Location()))
					form.cmbHospital().setValue((LocationLiteVo) form.cmbHospital().getValues().get(i));
			}
			if (form.cmbHospital().getValue() == null && voFilter.getHospitalIsNotNull())
			{
				LocationLiteVo voHosp = domain.getHospital(voFilter.getHospital());
				form.cmbHospital().newRow(voHosp, voHosp.getName().toString());
				form.cmbHospital().setValue(voHosp);
			}

			for (int i = 0; voFilter.getHcpIsNotNull() && i < form.qmbHCP().getValues().size(); i++)
			{
				HcpLiteVo voHCP = (HcpLiteVo) form.qmbHCP().getValues().get(i);
				if (voHCP.getID_Hcp().equals(voFilter.getHcp().getID_Hcp()))
					form.qmbHCP().setValue((HcpLiteVo) form.qmbHCP().getValues().get(i));
			}
			if (form.qmbHCP().getValue() == null && voFilter.getHcpIsNotNull())
			{
				HcpLiteVo voHCP = domain.getHCP(voFilter.getHcp().getID_Hcp());
				form.qmbHCP().newRow(voHCP, voHCP.getMos().getName().toString());
				form.qmbHCP().setValue(voHCP);
			}

			form.qmbWard().setValue(null);
			for (int i = 0; voFilter.getAllocatedWardIsNotNull() && i < form.qmbWard().getValues().size(); i++)
			{
				LocationLiteVo voWard = (LocationLiteVo) form.qmbWard().getValues().get(i);
				if (voWard.getID_Location().equals(voFilter.getAllocatedWard().getID_Location()))
					form.qmbWard().setValue((LocationLiteVo) form.qmbWard().getValues().get(i));
			}
			if (form.qmbWard().getValue() == null && voFilter.getAllocatedWardIsNotNull())
			{
				LocationLiteVo voWard = domain.getWard(voFilter.getAllocatedWard());
				form.qmbWard().newRow(voWard, voWard.getName());
				form.qmbWard().setValue(voWard);
			}
			form.cmbAlert().setValue(voFilter.getAlert());

			//enableAutoRefeshStart(true);
		}
	}

	private void loadAlerts()
	{
		form.cmbAlert().clear();

		TreeNode[] coll = LookupHelper.getAlertType(domain.getLookupService()).getRootNodes();
	
		if (coll != null)
		{
			for (int i = 0; i < coll.length; i++)
			{
				AlertType item = (AlertType) coll[i];
				ArrayList<LookupInstVo> coll1 = item.getChildInstances();

				AlertType type = null;
				for (int j = 0; j < coll1.size(); j++)
				{
					type = (AlertType) coll1.get(j);
					if (type.isActive())
						form.cmbAlert().newRow((AlertType) coll1.get(j), coll1.get(j).toString());
				}
			}
		}
	}

	private void loadHospitals()
	{
		LocationLiteVoCollection voColl = domain.listActiveHospitalsLite();
		for (int i = 0; voColl != null && i < voColl.size(); i++)
		{
			form.cmbHospital().newRow(voColl.get(i), voColl.get(i).getName());

			if (engine.getCurrentLocation() != null && voColl.get(i).getID_Location().equals(engine.getCurrentLocation().getID()))
				form.cmbHospital().setValue(voColl.get(i));
		}
	}

	@Override
	protected void onQmbWardTextSubmited(String value) throws ims.framework.exceptions.PresentationLogicException
	{
		form.getLocalContext().setEventFired(null);
		
		if (form.cmbHospital().getValue() == null)
		{
			engine.showMessage("Please select a Hospital to find a Ward for.");
			return;
		}

		LocationLiteVoCollection wards = domain.listWards(form.cmbHospital().getValue().getID_Location(), value);
		if (wards != null)
		{
			for (LocationLiteVo item : wards)
				form.qmbWard().newRow(item, item.getName());
		}
		if (wards.size() == 1)
			form.qmbWard().setValue(wards.get(0));
		else if (wards.size() > 1)
			form.qmbWard().showOpened();
	}

	@Override
	protected void onImbClearClick() throws ims.framework.exceptions.PresentationLogicException
	{
		form.getLocalContext().setEventFired(null);
		
		clearControls();
		form.cmbStatus().setValue(null);

		form.lblTotal().setValue("Total : 0");

		// Clear the selected patient information in the Engine
		form.getGlobalContext().Core.setSelectingPatientForm(null);
		form.getGlobalContext().Core.setPatientShort(null);
		form.getGlobalContext().Core.setPatientToBeDisplayed(null);
		engine.setPatientInfo("Please enter Patient ID or Surname and/or Forename");

		form.getGlobalContext().STHK.setPendingEmergencyAdmissionsFilter(null);
		
		//refresh
		form.getLocalContext().setbTimerOn(false);
		form.imbAutoRefresh().setEnabled(false);
		form.imbAutoRefresh().setTooltip("This button will be enabled once a search of New Results is executed");
//		form.getTimers().gettimerSearch().setEnabled(false);
	}

	private void clearControls()
	{
		form.cmbHospital().setValue(null);
		form.txtForeName().setValue(null);
		form.txtSurname().setValue(null);
		form.txtIDNum().setValue(null);
		form.qmbHCP().setValue(null);
		form.qmbWard().setValue(null);
		form.cmbAlert().setValue(null);
		form.grdAdmissions().getRows().clear();

		updateMenuOptions();
	}

	@Override
	protected void onImbSearchClick() throws ims.framework.exceptions.PresentationLogicException
	{
		form.getLocalContext().setEventFired(null);
		
		if (!validateSeachCriteria())
		{
			enableAutoRefeshStart(false);
			return;
		}

		enableAutoRefeshStart(true);

		search(false);
		updateMenuOptions(); //WDEV-18114 
	}

	private void enableAutoRefeshStart(boolean bEnabled)
	{
		form.imbAutoRefresh().setEnabled(bEnabled);

		form.imbAutoRefresh().setEnabledImage(form.getImages().Core.TimerStartEnabled24);
		form.imbAutoRefresh().setDisabledImage(form.getImages().Core.TimerStartDisabled24);

		if (bEnabled)
			form.imbAutoRefresh().setTooltip("Click button to start the automatic refresh of Pending Emergencies");
		else
			form.imbAutoRefresh().setTooltip("This button will be enabled once a search of Pending Emergencies is executed");

	}

	private void enableAutoRefeshStop(boolean bEnable)
	{
		form.imbAutoRefresh().setEnabled(bEnable);

		form.imbAutoRefresh().setEnabledImage(form.getImages().Core.TimerStopEnabled24);
		form.imbAutoRefresh().setDisabledImage(form.getImages().Core.TimerStopEnabled24);

		form.imbAutoRefresh().setTooltip("Click button to stop the automatic refresh of Pending Emergencies");

		form.getLocalContext().setbTimerOn(bEnable);

	}
	
	private boolean validateSeachCriteria()
	{
		if (form.txtIDNum().getValue() != null && form.cmbIDType().getValue() == null)
		{
			engine.showErrors(new String[]{"Please enter both an Identifier type as well as its value."});
			return false;
		}

		return true;
	}

	private void search(Boolean timerCalled)
	{
		PendingEmergencyAdmissionLiteVoCollection voColl = null;

		PendingEmergencyAdmissionsDataVo voFilter = populateDataFromScreen();
		form.grdAdmissions().getRows().clear();
		form.lblTotal().setValue("Total : 0"); //WDEV-18099 
		form.getGlobalContext().STHK.setPendingEmergencyAdmissionsFilter(voFilter);

		if (voFilter.countFieldsWithValue() == 1 && voFilter.getIDTypeIsNotNull())
		{
			engine.showMessage("Please enter some valid search criteria.", "Invalid search cirteria", MessageButtons.OK, MessageIcon.ERROR);
			enableAutoRefeshStart(false);
			return;
		}
 
		if ((voFilter.countFieldsWithValue() == 1 && voFilter.getIDType() == null) || voFilter.countFieldsWithValue() > 1)
		{
			voColl = domain.listPendingEmergencyAdmissions(voFilter);
		}
		else
		{
			engine.showErrors(new String[]{"Please enter some search criteria."});
			return;
		}

		if (voColl == null || voColl.size() == 0)
		{
			if(!timerCalled)
				engine.showMessage("No matching records found");
			return;
		}
		if (voColl != null)
			form.lblTotal().setValue("Total : " + String.valueOf(voColl.size()));

		if (voColl != null)
			populateGrid(voColl);
	}

	private void populateGrid(PendingEmergencyAdmissionLiteVoCollection emerAdmissions)
	{
		form.grdAdmissions().getRows().clear(); //WDEV-18011 
		for (PendingEmergencyAdmissionLiteVo item : emerAdmissions)
		{
			item.setActiveAlerts(false); //WDEV-18011 
			grdAdmissionsRow row = form.grdAdmissions().getRows().newRow();
			if (item.getPasEventIsNotNull())
			{
				if (item.getPasEvent().getPatientIsNotNull())
				{
					item.getPasEvent().getPatient().calculateAge();

					if (item.getPasEvent().getPatient().getNameIsNotNull())
						if (item.getPasEvent().getPatient().getName().getSurnameIsNotNull())
							row.setColSurname(item.getPasEvent().getPatient().getName().getSurname());
					if (item.getPasEvent().getPatient().getName().getForenameIsNotNull())
						row.setColForename(item.getPasEvent().getPatient().getName().getForename());

					if (item.getPasEvent().getPatient().getIdentifiersIsNotNull())
						if (item.getPasEvent().getPatient().getIdentifiersIsNotNull())
							for (int j = 0; j < item.getPasEvent().getPatient().getIdentifiers().size(); j++)
								if (item.getPasEvent().getPatient().getIdentifiers().get(j).getType().equals(PatIdType.HOSPNUM))
									row.setColHOSNUM(item.getPasEvent().getPatient().getIdentifiers().get(j).getValue());

					if (item.getPasEvent().getPatient().getAgeIsNotNull())
						row.setcolAge(item.getPasEvent().getPatient().getAge().toString());

					if (item.getPasEvent().getPatient().getSexIsNotNull())
						row.setColPatSex(item.getPasEvent().getPatient().getSex().getText());

					if (item.getPasEvent().getPatient().getPatientAlertsIsNotNull() && item.getPasEvent().getPatient().getPatientAlerts().size() > 0)
					{
						//wdev-11146				
						for(int i = 0; i < item.getPasEvent().getPatient().getPatientAlerts().size();i++)
						{
							PatientAlertLiteVo patAlertLiteVo = item.getPasEvent().getPatient().getPatientAlerts().get(i);
							if(patAlertLiteVo != null && patAlertLiteVo.getIsCurrentlyActiveAlert().equals(Boolean.TRUE))
							{
								row.setColAlerts(form.getImages().Core.Alert16); //WDEV-18011 
								item.setActiveAlerts(true); //WDEV-18011 
								break;
							}
						}						
					}
				}

				if (item.getPasEvent().getSpecialtyIsNotNull())
					row.setColSpecialty(item.getPasEvent().getSpecialty().getText());
			}

			if (item.getAllocatedWardIsNotNull())
				row.setColWard(item.getAllocatedWard().getName());
			if (item.getAdmissionStatusIsNotNull())
			{
				row.setColStatus(item.getAdmissionStatus().getText());
				row.setTooltipForColStatus(item.getAdmissionStatus().getText());
			}
			if (item.getDTADateTimeIsNotNull())
				row.setColDateTime(item.getDTADateTime().toString());

			// WDEV-8041
			if (item.getBedTypeRequestedIsNotNull())
				row.setColBedType(item.getBedTypeRequested());

			if (item.getDTADateTimeIsNotNull() && item.getAdmissionStatusIsNotNull() && item.getDTADateTime().isLessOrEqualThan(new DateTime()) && (item.getAdmissionStatus().equals(EmergencyAdmissionStatus.DTA) || item.getAdmissionStatus().equals(EmergencyAdmissionStatus.DISCHARGED)))
			{
				int intDiff = minsDiff(new DateTime(), item.getDTADateTime());

				// i. Green - 0-2 hrs
				// ii. Amber - 2-3 hrs
				// iii. Red - >3 hrs
				if (intDiff >= 0 && intDiff <= 119)
					row.setBackColor(Color.LightGreen);
				else if (intDiff >= 120 && intDiff <= 179)
					row.setBackColor(Color.Orange);
				else if (intDiff >= 180)
					row.setBackColor(Color.Red);
			}

			row.setValue(item);
		}
	}

	public static int minsDiff(DateTime startDate, DateTime endDate)
	{
		if (startDate == null)
			throw new IllegalArgumentException("No start date specified");
		if (endDate == null)
			throw new IllegalArgumentException("No end date specified");

		Calendar start = new GregorianCalendar((startDate.getDate()).getYear(), (startDate.getDate()).getMonth(), (startDate.getDate()).getDay(), startDate.getTime().getHour(), startDate.getTime().getMinute(), startDate.getTime().getSecond());
		Calendar end = new GregorianCalendar(endDate.getDate().getYear(), endDate.getDate().getMonth(), endDate.getDate().getDay(), endDate.getTime().getHour(), endDate.getTime().getMinute(), endDate.getTime().getSecond());

		long endInMillis = end.getTimeInMillis() + end.getTimeZone().getOffset(end.getTimeInMillis());
		long startInMillis = start.getTimeInMillis() + start.getTimeZone().getOffset(start.getTimeInMillis());

		return (int) ((((endInMillis < startInMillis ? startInMillis - endInMillis : endInMillis - startInMillis) / 1000) / 60));
	}

	private PendingEmergencyAdmissionsDataVo populateDataFromScreen()
	{
		PendingEmergencyAdmissionsDataVo admission = new PendingEmergencyAdmissionsDataVo();
		admission.setIDNumber(form.txtIDNum().getValue());
		admission.setIDType(form.cmbIDType().getValue());

		//WDEV-13065 -- if (form.txtIDNum().getValue() == null)
		
		admission.setHospital(form.cmbHospital().getValue());
		admission.setAlert(form.cmbAlert().getValue());
		admission.setAllocatedWard(form.qmbWard().getValue());
		admission.setHcp(form.qmbHCP().getValue());
		admission.setPatientForename(form.txtForeName().getValue());
		admission.setPatientSurname(form.txtSurname().getValue());
		admission.setAdmissionStatus(form.cmbStatus().getValue());
		
		return admission;
	}

	@Override
	protected void onQmbHCPTextSubmited(String value) throws ims.framework.exceptions.PresentationLogicException
	{
		form.getLocalContext().setEventFired(null);
		
		if (value != null)
		{
			HcpFilter voHCPFilter = new HcpFilter();
			PersonName name = new PersonName();
			name.setSurname(value);
			voHCPFilter.setQueryName(name);
			voHCPFilter.setHcpType(HcpDisType.MEDICAL);

			HcpLiteVoCollection voColl = domain.listHCPs(voHCPFilter);

			voColl.sort();
			form.qmbHCP().clear();
			for (int i = 0; i < voColl.size(); i++)
			{
				form.qmbHCP().newRow(voColl.get(i), voColl.get(i).getIHcpName());
			}
			if (voColl.size() == 1)
				form.qmbHCP().setValue(voColl.get(0));
			else if (voColl.size() > 1)
				form.qmbHCP().showOpened();
		}
	}

	@Override
	protected void onCmbHospitalValueChanged() throws PresentationLogicException
	{
		form.getLocalContext().setEventFired(null);
		form.qmbWard().clear();
	}

	@Override
	/**
	 * WDEV-13136
	 * Event handler for GridRowSelectionChanged event
	 */
	protected void onGrdAdmissionsSelectionChanged() throws PresentationLogicException
	{
		updateGlobalContextOnSelection(form.grdAdmissions().getValue());

		updateMenuOptions();

		form.getLocalContext().setEventFired(null);
	}

	/**
	 * WDEV-13136
	 * Function used to update the global contexts PatientToBeDisplayed and PatientShort
	 */
	private void updateGlobalContextOnSelection(PendingEmergencyAdmissionLiteVo selectedValue)
	{
		form.getGlobalContext().Core.setSelectingPatientForm(null);
		form.getGlobalContext().Core.setPatientToBeDisplayed(null);
		form.getGlobalContext().Core.setPatientShort(null);

		if (selectedValue == null)
			return;

		if (selectedValue.getPasEventIsNotNull() && selectedValue.getPasEvent().getPatientIsNotNull())
		{
			PatientShort ps = domain.getPatientShort(selectedValue.getPasEvent().getPatient());

			form.getGlobalContext().Core.setSelectingPatientForm(engine.getFormName());
			form.getGlobalContext().Core.setPatientToBeDisplayed(ps);
			form.getGlobalContext().Core.setPatientShort(ps);
		}
	}

	private void updateMenuOptions()
	{
		form.getContextMenus().Core.hideAllPendingEmergencyMenuItems();
		boolean isCancelled = form.grdAdmissions().getValue() != null && form.grdAdmissions().getValue().getAdmissionStatusIsNotNull() && form.grdAdmissions().getValue().getAdmissionStatus().equals(EmergencyAdmissionStatus.CANCELLED); //wdev-17355
		form.getContextMenus().Core.getPendingEmergencyASSIGNItem().setVisible(form.grdAdmissions().getValue() != null && !isCancelled);	//wdev-17355
		
		if(engine.hasRight(AppRight.ALLOW_ADT_PENDINGEMERGENCY_REMOVAL))
			form.getContextMenus().Core.getPendingEmergencyREMOVEPATIENTFROMPENDINGEMERGENCYItem().setVisible(form.grdAdmissions().getValue() != null);
	}

	public void refresh(Boolean timerCalled)
	{
		if (form.getGlobalContext().STHK.getPendingEmergencyAdmissionsFilterIsNotNull())
			refreshSearchCriteria(timerCalled);
		
		search(timerCalled); //WDEV-16192
		updateMenuOptions();
	}

	@Override
	/**
	 * WDEV-13136
	 * Event handler for GridColumnHeaderClick event
	 * Will sort records by values on column which header was clicked, then update the context menu options state
	 */
	protected void onGrdAdmissionsGridHeaderClicked(int column) throws PresentationLogicException
	{
		// Sort records by column
		sortAdmissions(column);
		// Update context menu options
		updateMenuOptions();
	}

	/**
	 * WDEV-13136
	 * Function used to sort admissions by column
	 */
	private void sortAdmissions(int column)
	{
		// Get records from grid
		PendingEmergencyAdmissionLiteVoCollection records = form.grdAdmissions().getValues();

		// Toggle sort mode for column
		sortOrderToggle(column);
		
		// Determine the column - sort records after it
		if (column == COL_AGE)
		{
			records.sort(new AgeComparator(form.getLocalContext().getSortOrderAge()));
		}
		else if (column == COL_DATE_DECISION_TO_ADMIT)
		{
			records.sort(PendingEmergencyAdmissionLiteVo.getDateTimeComparator(form.getLocalContext().getSortOrder()));
		}
		
		//WDEV-18011 
		else if (column == COL_ALERT)
		{
			records.sort(new AlertComparator(form.getLocalContext().getSortOrderAlert()));
		}

		// Get selection
		PendingEmergencyAdmissionLiteVo selectedValue = form.grdAdmissions().getValue();
		// Re-populate grid
		populateGrid(records);
		// Update selection
		form.grdAdmissions().setValue(selectedValue);
		// Call code for new selection
		updateGlobalContextOnSelection(form.grdAdmissions().getValue());
	}

	/**
	 *	WDEV-13136 
	 * 	Function used to toggle sort order for column
	 * 	Will reset the rest of the columns manual sort order
	 */
	private void sortOrderToggle(int column)
	{
		if (column == COL_AGE)
		{
			if (SortOrder.ASCENDING.equals(form.getLocalContext().getSortOrderAge()))
				form.getLocalContext().setSortOrderAge(SortOrder.DESCENDING);
			else
				form.getLocalContext().setSortOrderAge(SortOrder.ASCENDING);
		}
		else
		{
			form.getLocalContext().setSortOrderAge(null);
		}
		
		if (column == COL_DATE_DECISION_TO_ADMIT)
		{
			if (SortOrder.ASCENDING.equals(form.getLocalContext().getSortOrder()))
				form.getLocalContext().setSortOrder(SortOrder.DESCENDING);
			else
				form.getLocalContext().setSortOrder(SortOrder.ASCENDING);
		}
		else
		{
			form.getLocalContext().setSortOrder(null);
		}
		
		// WDEV-18011 
		if (column == COL_ALERT)
		{
			if (SortOrder.ASCENDING.equals(form.getLocalContext().getSortOrderAlert()))
				form.getLocalContext().setSortOrderAlert(SortOrder.DESCENDING);
			else
				form.getLocalContext().setSortOrderAlert(SortOrder.ASCENDING);
		}
		else
		{
			form.getLocalContext().setSortOrderAlert(null);
		}
	}

	@Override
	protected void onContextMenuItemClick(int menuItemID, Control sender) throws PresentationLogicException
	{
		switch (menuItemID)
		{
			case GenForm.ContextMenus.CoreNamespace.PendingEmergency.ASSIGN :
				form.getGlobalContext().Core.setADTPendingEmergencyAdmission(form.grdAdmissions().getValue());
				engine.open(form.getForms().Core.AssignADTWardAndSpecialtyDialog);
			break;
			case GenForm.ContextMenus.CoreNamespace.PendingEmergency.REMOVEPATIENTFROMPENDINGEMERGENCY :
				try
				{
					domain.removeFromPendingEmergency(form.grdAdmissions().getValue());
				}
				catch (StaleObjectException e)
				{
					engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
				}
				
				refresh(true);
			break;
			default :
		}
	}

	@Override
	protected void onFormDialogClosed(FormName formName, DialogResult result) throws PresentationLogicException
	{
		if (formName.equals(form.getForms().Core.AssignADTWardAndSpecialtyDialog) && result.equals(DialogResult.OK))
			search(false);
		
		updateMenuOptions();
	}

	@Override
	protected void onImbAutoRefreshClick() throws PresentationLogicException
	{
		if (form.getLocalContext().getbTimerOn().booleanValue())
		{
			form.getLocalContext().setEventFired(PendingEmergencyEventFired.STOP_TIMER);
			form.getLocalContext().setbTimerOn(false);			
			enableAutoRefeshStart(false);
			enableSearchCriteria(true);
		}
		else
		{
			form.getLocalContext().setEventFired(PendingEmergencyEventFired.START_TIMER);
			form.getLocalContext().setbTimerOn(true);
			enableAutoRefeshStop(true);
			enableSearchCriteria(false);
		}
	}

	private void enableSearchCriteria(boolean bEnable)
	{
		form.imbSearch().setEnabled(bEnable);
		form.imbClear().setEnabled(bEnable);
		form.cmbIDType().setEnabled(bEnable);
		form.txtSurname().setEnabled(bEnable);
		form.txtForeName().setEnabled(bEnable);
		form.txtIDNum().setEnabled(bEnable);
		form.qmbHCP().setEnabled(bEnable);
		form.cmbHospital().setEnabled(bEnable);
		form.cmbAlert().setEnabled(bEnable);
		form.qmbWard().setEnabled(bEnable);
		form.cmbStatus().setEnabled(bEnable);
	}

	public PendingEmergencyEventFired getEventFired()
	{
		return form.getLocalContext().getEventFired();
	}

//	@Override
//	protected void onTimer(Timer timer) throws PresentationLogicException
//	{
//		if (timer.equals(form.getTimers().gettimerSearch()))
//			search();
//	}
}
