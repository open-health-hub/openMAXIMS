//#############################################################################
//#                                                                           #
//#  Copyright (C) <2014>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Rory Fitzpatrick using IMS Development Environment (version 1.65 build 3210.27143)
// Copyright (C) 1995-2008 IMS MAXIMS plc. All rights reserved.

package ims.clinical.forms.therapiesnote;

import ims.configuration.gen.ConfigFlag;
import ims.core.clinical.vo.ClinicalNotesRefVo;
import ims.core.forms.authoringinfo.IComponent;
import ims.core.vo.AuthoringInformationVo;
import ims.core.vo.CareContextVo;
import ims.core.vo.ClinicalNoteStatusVo;
import ims.core.vo.ClinicalNoteStatusVoCollection;
import ims.core.vo.ClinicalNotesVo;
import ims.core.vo.ClinicalNotesVoCollection;
import ims.core.vo.HcpLiteVo;
import ims.core.vo.MedicVo;
import ims.core.vo.MemberOfStaffShortVo;
import ims.core.vo.MemberOfStaffVo;
import ims.core.vo.SOAPVo;
import ims.core.vo.enums.AuthoringLabelType;
import ims.core.vo.lookups.ClinicalNoteType;
import ims.core.vo.lookups.ClinicalNotesStatus;
import ims.core.vo.lookups.ClinicalNotingMode;
import ims.core.vo.lookups.SourceOfNote;
import ims.domain.exceptions.DomainInterfaceException;
import ims.domain.exceptions.DomainRuntimeException;
import ims.domain.exceptions.StaleObjectException;
import ims.domain.exceptions.UniqueKeyViolationException;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.FormMode;
import ims.framework.exceptions.FormOpenException;
import ims.framework.exceptions.PresentationLogicException;
import ims.framework.utils.DateTime;
import java.util.ArrayList;

public class Logic extends BaseLogic
{
	private static final long serialVersionUID = 1L;

	@Override
	protected void onFormOpen(Object[] args) throws ims.framework.exceptions.PresentationLogicException
	{
		if (domain.getMosUser() == null)
			throw new FormOpenException("The User Account is not linked to a HCP or Member of Staff, this form will not be active. Please contact the System Administrator.");
		
		form.btnClose().setVisible(engine.isDialog() && form.getMode().equals(FormMode.VIEW));
		initialiseScreenControls();

		openTherapiesSOAP();
		checkForDiscipline();
	}
	
	private boolean isDialog()
	{
		return engine.isDialog();
	}
	
	private void initialiseScreenControls() 
	{
		form.customControlReviewed().ignoreComponentReadonlyFlag(Boolean.TRUE);
		form.chkForReview().setVisible(true);
		form.cmbDiscipline().setVisible(true);
		form.lblDiscipline().setVisible(true);
		form.setcustomControlReviewedVisible(false);
		form.chkMarkAsReviewed().setVisible(false);
	}

	@Override
	protected void onFormModeChanged()
	{
		form.chkForReview().setEnabled(form.getMode().equals(FormMode.EDIT) ? true : false);
		form.cmbDiscipline().setEnabled(form.getMode().equals(FormMode.EDIT) ? true : false);
		form.setcustomControlReviewedEnabled(form.getMode().equals(FormMode.EDIT) ? true : false);
		form.chkMarkAsReviewed().setEnabled(form.getMode().equals(FormMode.EDIT) ? true : false);
		
		if(form.getGlobalContext().Core.getClinicalNotingModeIsNotNull()
			&& form.getGlobalContext().Core.getClinicalNotingMode().equals(ClinicalNotingMode.REVIEW))
		{
			form.cmbStatus().setEnabled(true);
			
			if (form.getMode().equals(FormMode.EDIT))
			{
				form.txtSubjective().setEnabled(false);
				form.txtObjective().setEnabled(false);
				form.txtAnalysis().setEnabled(false);
				form.txtPlan().setEnabled(false);
				form.cmbStatus().setEnabled(false);
				//form.customControlReviewed().setEnabledAuthoringHCP(Boolean.FALSE);
				//form.customControlReviewed().setEnabledDateTime(Boolean.FALSE);
			}
			
		}
		else
		{
			if (form.getMode().equals(FormMode.EDIT))
			{
				form.txtSubjective().setEnabled(true);
				form.txtObjective().setEnabled(true);
				form.txtAnalysis().setEnabled(true);
				form.txtPlan().setEnabled(true);
				form.cmbStatus().setEnabled(true);
				enabledCustomReviewed(Boolean.TRUE);
				
				//In Correct mode
				if (form.getGlobalContext().Clinical.getCurrentClinicalNoteIsNotNull() &&
						form.getGlobalContext().Clinical.getCurrentClinicalNote().getCurrentStatusIsNotNull() &&
							correctModeIP(form.getGlobalContext().Clinical.getCurrentClinicalNote().getCurrentStatus()))
				{
					form.chkForReview().setEnabled(false);
					form.cmbDiscipline().setEnabled(false);
					form.cmbStatus().setEnabled(false);
				}
				else
				{
					form.chkForReview().setEnabled(true);
					
					if (form.chkForReview().getValue() == false)
					{
						form.cmbDiscipline().setEnabled(false);
						form.cmbStatus().setEnabled(false);
					}
					else
					{
						form.cmbDiscipline().setEnabled(true);
						form.cmbStatus().setEnabled(true);
					}
					

					if (form.getGlobalContext().Clinical.getCurrentClinicalNoteIsNotNull() &&
							form.getGlobalContext().Clinical.getCurrentClinicalNote().getCurrentStatusIsNotNull() 
							&&  form.getGlobalContext().Clinical.getCurrentClinicalNote().getCurrentStatus().getStatus().equals(ClinicalNotesStatus.PREVALIDATION) )
					{
						form.cmbStatus().setEnabled(false);
					}
					else
						form.cmbStatus().setEnabled(true);
				}
			}
			else
			{
				form.cmbStatus().setEnabled(false);
			}
		}
		
		if (form.getGlobalContext().Clinical.getCurrentClinicalNoteIsNotNull())
		{
			form.setcustomControlReviewedEnabled(form.getMode().equals(FormMode.EDIT) ? true : false);
			form.chkMarkAsReviewed().setEnabled(form.getMode().equals(FormMode.EDIT) ? true : false);
			
			enableCustomReviewed(false);
		}
	}
	@Override
	protected void onBtnNewClick() throws ims.framework.exceptions.PresentationLogicException
	{
		newInstance();
	}
	@Override
	protected void onBtnSaveClick() throws ims.framework.exceptions.PresentationLogicException
	{
		if (saveTherapiesSOAP())
			openTherapiesSOAP();
		
		form.btnClose().setEnabled(true);
	}

	@Override
	protected void onBtnCancelClick() throws ims.framework.exceptions.PresentationLogicException
	{
		form.setMode(FormMode.VIEW);

		if (isDialog())
			onBtnCloseClick();
		else
			openTherapiesSOAP();
		
		form.btnClose().setEnabled(true);

	}
		
	private boolean testDiscipline()
	{
		MemberOfStaffVo fullVo = null;
		MemberOfStaffShortVo mos = (MemberOfStaffShortVo)domain.getMosUser();
		if (mos != null)
			fullVo = domain.getMemberOfStaff(mos);
		
		if (fullVo != null)
		{
			if (fullVo.getHcpIsNotNull())
			{
				if (fullVo.getHcp().getHcpTypeIsNotNull())
				{
					if (form.customControlAuthoring().getValue() != null &&
							form.customControlAuthoring().getValue().getAuthoringHcpIsNotNull() &&
								form.customControlAuthoring().getValue().getAuthoringHcp().getHcpTypeIsNotNull())
					{
						if (form.customControlAuthoring().getValue().getAuthoringHcp().getHcpType().equals(fullVo.getHcp().getHcpType()))
							return true;
					}					
				}				
			}
		}
		return false;
	}

	private String[] getUiErrors() 
	{
		ArrayList<String> errors = new ArrayList<String>();
		//wdev-2163
		if (form.txtSubjective().getValue() == null	&&
				form.txtObjective().getValue() == null &&
					form.txtAnalysis().getValue() == null &&
						form.txtPlan().getValue() == null)
		{
			errors.add("SOAP details are mandatory");
		}
		
		if(form.cmbStatus().getValue() == null)
		{
			errors.add("Status is mandatory");
		}
		
		if (form.chkForReview().getValue() == true)
		{
			if (form.cmbDiscipline().getValue() == null)
			{
				//form.chkForReview().setValue(false);
				errors.add("If 'For Review' is checked 'Discipline' is mandatory");
			}
		}
	
		if (errors.size() > 0) 
		{
			String[] searchErrors = new String[errors.size()];
			errors.toArray(searchErrors);
			engine.showErrors("Invalid SOAP record", searchErrors);
			return searchErrors;
		}
		return null;
	}
	
	private boolean saveTherapiesSOAP() throws PresentationLogicException 
	{
		ClinicalNotesVo clinNoteVo = populateDataFromScreen(form.getLocalContext().getclinicalNotesVo());
		if (clinNoteVo == null)
			return false;
		 
		String[] uiErrors = getUiErrors();
		String[] errors = clinNoteVo.validate(uiErrors);
		if(errors != null && errors.length > 0)
		{
			engine.showErrors(errors);
			
			if (form.chkForReview().getValue() == false)
				form.cmbDiscipline().setEnabled(false);
			else
				form.cmbDiscipline().setEnabled(true);
			
			return false;
		}

		try
		{
			clinNoteVo = domain.saveClinicalNotes(clinNoteVo);
		}
		catch(StaleObjectException e)
		{
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			form.getLocalContext().setclinicalNotesVo(clinNoteVo);
			openTherapiesSOAP();
			return false;
		}
		catch(DomainRuntimeException e)
		{
			engine.showMessage(e.getMessage());
			form.getLocalContext().setclinicalNotesVo(clinNoteVo);
			openTherapiesSOAP();
			return false;
		}
		catch(DomainInterfaceException e)
		{
			engine.showMessage(e.getMessage());
			form.getLocalContext().setclinicalNotesVo(clinNoteVo);
			openTherapiesSOAP();
			return false;
		}
		
		if (clinNoteVo == null)
			throw new FormOpenException("There is a clinical note of a different type already recorded on the system for this care context");		
		
		form.getLocalContext().setclinicalNotesVo(clinNoteVo);
		form.getGlobalContext().Clinical.setCurrentClinicalNote(clinNoteVo);
		
		//Now Save SOAP
		SOAPVo voSOAP = form.getLocalContext().getSOAPVo();
		if (voSOAP == null)
			voSOAP = new SOAPVo();

		if (clinNoteVo != null)
		{
			ClinicalNotesRefVo voRef = new ClinicalNotesRefVo();
			voRef.setID_ClinicalNotes(clinNoteVo.getID_ClinicalNotes());
			voSOAP.setClinicalNote(voRef);
		}

		if (!voSOAP.getCareContextIsNotNull())
			voSOAP.setCareContext(form.getGlobalContext().Core.getCurrentCareContext());
		
		errors = voSOAP.validate();
		if (errors != null)
		{
			engine.showErrors(errors);
			return false;
		}

		try
		{
			domain.saveSOAPsVo(voSOAP);
		}
		catch (StaleObjectException sox)
		{
			engine.showMessage(ims.configuration.gen.ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			openTherapiesSOAP();
			return false;
		}
		catch (UniqueKeyViolationException ue)
		{
			engine.showMessage(ue.getMessage());
			return false;
		}
		catch (DomainInterfaceException e)
		{
			engine.showMessage(e.getMessage());
			return false;
		}

		if (isDialog())
		{
			onBtnCancelClick();
			onBtnCloseClick();
		}

		return true;
	}
	
	private void fillIPStatusCombo(ClinicalNotesVo voClinicalNote) 
	{
		if (voClinicalNote != null)
		{
			//In Correct mode, HCP ok and either Active or Correct
			if (correctModeIP(voClinicalNote.getCurrentStatus())) 
			{	
				fillIPStatusCorrect();
			}
			//Requires Validation
			else if (voClinicalNote.getCurrentStatus().getStatusIsNotNull() &&
				voClinicalNote.getCurrentStatus().getStatus().equals(ClinicalNotesStatus.PREVALIDATION))
			{
				//fillIPStatusValidation();
				if (domain.getHcpLiteUser() != null)			
					fillIPStatusPreValidation();
			}
			//Draft, HCP OK
			else if (voClinicalNote.getCurrentStatus().getStatusIsNotNull() &&
				voClinicalNote.getCurrentStatus().getStatus().equals(ClinicalNotesStatus.DRAFT)	&&
					domain.getHcpLiteUser() != null	&&
						//domain.getHcpLiteUser().equals(form.customControlAuthoring().getValue().getAuthoringHcp()))
						testDiscipline())
			{
				fillIPStatusNew();
			}
			//Draft, HCP not OK
			else if (voClinicalNote.getCurrentStatus().getStatusIsNotNull()	&&
				voClinicalNote.getCurrentStatus().getStatus().equals(ClinicalNotesStatus.DRAFT)	&&
					domain.getHcpLiteUser() == null) 
			{
				fillIPStatusPreValidation();
			}				
		}
	}

	
	private void fillIPStatusPreValidation() 
	{
		form.cmbStatus().clear();
		form.cmbStatus().newRow(ClinicalNotesStatus.PREVALIDATION, ClinicalNotesStatus.PREVALIDATION.getText());
		form.cmbStatus().newRow(ClinicalNotesStatus.DRAFT, ClinicalNotesStatus.DRAFT.getText());
	}

	private void fillIPStatusNew() 
	{
		form.cmbStatus().clear();
		form.cmbStatus().newRow(ClinicalNotesStatus.ACTIVE, ClinicalNotesStatus.ACTIVE.getText());
		form.cmbStatus().newRow(ClinicalNotesStatus.DRAFT, ClinicalNotesStatus.DRAFT.getText());
	}

	private void fillIPStatusCorrect() 
	{
		form.cmbStatus().clear();
		form.cmbStatus().newRow(ClinicalNotesStatus.ACTIVE, ClinicalNotesStatus.ACTIVE.getText());
		form.cmbStatus().newRow(ClinicalNotesStatus.CORRECTED, ClinicalNotesStatus.CORRECTED.getText());
	}

//	private void fillIPStatusValidation() 
//	{
//		form.cmbStatus().clear();
//		form.cmbStatus().newRow(ClinicalNotesStatus.PREVALIDATION, ClinicalNotesStatus.PREVALIDATION.getText());
//		form.cmbStatus().newRow(ClinicalNotesStatus.ACTIVE, ClinicalNotesStatus.ACTIVE.getText());
//	}
	
	private ClinicalNotesVo populateDataFromScreen(ClinicalNotesVo clinicalNotesVo) 
	{
		if (clinicalNotesVo == null)
			clinicalNotesVo = new ClinicalNotesVo();
		
		if ( ! clinicalNotesVo.getCareContextIsNotNull())
			clinicalNotesVo.setCareContext(form.getGlobalContext().Core.getCurrentCareContext());
		
		MemberOfStaffShortVo mos = null;
		if (getDisciplineForLoggedInUser(clinicalNotesVo) != null)
			mos = getDisciplineForLoggedInUser(clinicalNotesVo);
		else
			return null;
		
		//Save old Status to check for active
		ClinicalNoteStatusVo voPreviousStat = clinicalNotesVo.getCurrentStatus();

		ClinicalNoteStatusVo voStat = new ClinicalNoteStatusVo();
		voStat.setStatus(form.cmbStatus().getValue());
		voStat.setDateTime(new DateTime());
		voStat.setMOS(mos != null ? mos : null);
		
		/*//In Correct mode, HCP ok and either Active or Correct then be sure status saved is Corrected
		if (correctModeIP(voPreviousStat)) 
		{
			voStat.setStatus(ClinicalNotesStatus.CORRECTED);
			clinicalNotesVo.setIsCorrected(new Boolean(true));
		}*/

		SOAPVo voSOAP = form.getLocalContext().getSOAPVo();
		if (voSOAP == null)
			voSOAP = new SOAPVo();
		
		if (!voSOAP.getCareContextIsNotNull())
			voSOAP.setCareContext(form.getGlobalContext().Core.getCurrentCareContext());
		
		voSOAP.setSubjectiveNote(form.txtSubjective().getValue() != null ? form.txtSubjective().getValue() : "");
		voSOAP.setObjectiveNote(form.txtObjective().getValue() != null ? form.txtObjective().getValue() : "");
		voSOAP.setAnalysisNote(form.txtAnalysis().getValue() != null ? form.txtAnalysis().getValue() : "");
		voSOAP.setPlanNote(form.txtPlan().getValue() != null ? form.txtPlan().getValue() : "");

		form.getLocalContext().setSOAPVo(voSOAP);
		//TODO
		if(form.getGlobalContext().Core.getClinicalNotingModeIsNotNull()
				&& form.getGlobalContext().Core.getClinicalNotingMode().equals(ClinicalNotingMode.VALIDATE))
		{
			voStat.setClinicalNote(clinicalNotesVo.getClinicalNote());
			voStat.setStatus(ClinicalNotesStatus.ACTIVE);
		}
		else
			voStat.setStatus(form.cmbStatus().getValue());
		
		boolean isReviewed = false;
		
		if (form.getGlobalContext().Core.getClinicalNotingModeIsNotNull())
			isReviewed = form.getGlobalContext().Core.getClinicalNotingMode().equals(ClinicalNotingMode.REVIEW);
		
		if (correctModeIP(voPreviousStat) 
			&& ! isReviewed 
			&& ! clinicalNotesVo.getClinicalNote().equals(voSOAP.getRichTextString())) //In Correct mode
		{
			voStat.setClinicalNote(clinicalNotesVo.getClinicalNote());
			clinicalNotesVo.setStatusHistory(addStatusToCollection(clinicalNotesVo.getStatusHistory(), voStat));
			
			voStat.setStatus(ClinicalNotesStatus.CORRECTED);
			clinicalNotesVo.setIsCorrected(new Boolean(true));
		}
		
		if (voStat.getStatusIsNotNull())
			clinicalNotesVo.setCurrentStatus(voStat);
		else
			clinicalNotesVo.setCurrentStatus(voPreviousStat);
		
		clinicalNotesVo.setClinicalNote(voSOAP.getRichTextString());
		clinicalNotesVo.setInHospitalReport(Boolean.FALSE);

		clinicalNotesVo.setDiscipline(form.customControlAuthoring().getValue().getAuthoringHcpIsNotNull()
				&& form.customControlAuthoring().getValue().getAuthoringHcp().getHcpTypeIsNotNull() ? form.customControlAuthoring().getValue().getAuthoringHcp().getHcpType() : null);

		setAuthoringInfo(clinicalNotesVo);
		
		if ( ! clinicalNotesVo.getNoteTypeIsNotNull())
			clinicalNotesVo.setNoteType(ClinicalNoteType.CLINICALNOTE);
		
		clinicalNotesVo.setIsDerivedNote(Boolean.TRUE);
		
		clinicalNotesVo.setSourceOfNote(SourceOfNote.TLT_NOTE);
		
		if (form.chkForReview().getValue())
		{
			clinicalNotesVo.setForReview(new Boolean(form.chkForReview().getValue()));
			clinicalNotesVo.setForReviewDiscipline(form.cmbDiscipline().getValue());
		}
		else
		{
			clinicalNotesVo.setForReview(null);
			clinicalNotesVo.setForReviewDiscipline(null);
		}
		
		if (form.iscustomControlReviewedVisible())
		{
			clinicalNotesVo.setReviewingDateTime(
				form.customControlReviewed().getValue() != null && 
					form.customControlReviewed().getValue().getAuthoringDateTimeIsNotNull() ? 
							form.customControlReviewed().getValue().getAuthoringDateTime() : null);
			clinicalNotesVo.setReviewingHCP(
				form.customControlReviewed().getValue() != null && 
					form.customControlReviewed().getValue().getAuthoringHcpIsNotNull() ?
							form.customControlReviewed().getValue().getAuthoringHcp() : null);
		}

		if (clinicalNotesVo.getRecordingUser() == null)
			clinicalNotesVo.setRecordingUser((MemberOfStaffShortVo)domain.getMosUser());
		if (clinicalNotesVo.getRecordingDateTime() == null)
			clinicalNotesVo.setRecordingDateTime(new DateTime());
		
		return clinicalNotesVo;
	}

	private void setAuthoringInfo(ClinicalNotesVo clinicalNotesVo)
	{
		AuthoringInformationVo voAuthor = new AuthoringInformationVo();
		voAuthor.setAuthoringDateTime(form.customControlAuthoring().getValue() != null && form.customControlAuthoring().getValue().getAuthoringDateTimeIsNotNull() ? form.customControlAuthoring().getValue().getAuthoringDateTime() : null);
		voAuthor.setAuthoringHcp(form.customControlAuthoring().getValue() != null && form.customControlAuthoring().getValue().getAuthoringHcpIsNotNull() ? form.customControlAuthoring().getValue().getAuthoringHcp() : null);
		clinicalNotesVo.setAuthoringInfo(voAuthor);
	}

	private MemberOfStaffShortVo getDisciplineForLoggedInUser(ClinicalNotesVo clinicalNotesVo)
	{
		MemberOfStaffVo fullVo = null;
		MemberOfStaffShortVo mos = (MemberOfStaffShortVo)domain.getMosUser();
		if (mos != null)
			fullVo = domain.getMemberOfStaff(mos);

		if (fullVo != null)
		{
			if (fullVo.getHcpIsNotNull() && fullVo.getHcp() instanceof MedicVo)
			{
				MedicVo voMedic = (MedicVo)fullVo.getHcp();
				if (voMedic.getHcpTypeIsNotNull())
					clinicalNotesVo.setDiscipline(voMedic.getHcpType());
				else
				{
					engine.showMessage("Please select a Discipline type for the logged in user.");
					return null;
				}
			}
			else
			{
				if (form.customControlAuthoring().getValue().getAuthoringHcpIsNotNull())
					clinicalNotesVo.setDiscipline(form.customControlAuthoring().getValue().getAuthoringHcp().getHcpType());
				else
				{
					engine.showMessage("No Discipline is available. Please choose an authoring user.");
					return null;
				}
			}
		}
		else
		{
			engine.showMessage("Member of Staff is Null.");
			return null;
		}
		return mos;
	}
	
	private ClinicalNoteStatusVoCollection addStatusToCollection(ClinicalNoteStatusVoCollection statusHistory, ClinicalNoteStatusVo voStat) 
	{
		ClinicalNoteStatusVoCollection voColl = statusHistory;
		if (voColl == null)
			voColl = new ClinicalNoteStatusVoCollection();
		voColl.add(voStat);
		
		return voColl;
	}
	
	private boolean correctModeIP(ClinicalNoteStatusVo currentStatus) 
	{
		if (currentStatus != null
			&&	currentStatus.getStatusIsNotNull() 
				&& (currentStatus.getStatus().equals(ClinicalNotesStatus.ACTIVE) 
						|| currentStatus.getStatus().equals(ClinicalNotesStatus.CORRECTED) )
							&& domain.getHcpLiteUser() != null 
								&& testDiscipline()) 
								//domain.getHcpLiteUser().equals(form.customControlAuthoring().getValue().getAuthoringHcp()))
									return true;
		else
			return false;
	}
	
	
	private void newInstance() 
	{
		form.setMode(FormMode.EDIT);
		
		clearDetails();
		form.customControlAuthoring().initializeComponent();
		form.getGlobalContext().Clinical.setCurrentClinicalNote(null);
		form.getLocalContext().setclinicalNotesVo(null);
		form.getLocalContext().setSOAPVo(null);
		
		showHideCustomComponent(form.customControlAuthoring(), Boolean.TRUE, true);
		AuthoringInformationVo voAuthoringInformation = new AuthoringInformationVo ();
		voAuthoringInformation.setAuthoringDateTime(new DateTime());
		if (domain.getHcpUser() != null)
		{
			HcpLiteVo authoringHcp = (HcpLiteVo) domain.getHcpLiteUser();
			if (authoringHcp != null)
				voAuthoringInformation.setAuthoringHcp(authoringHcp);
			form.customControlAuthoring().setValue(voAuthoringInformation);
			fillIPStatusNew();
		}
		else // No a HCP
		{
			if (form.getGlobalContext().Core.getCurrentCareContextIsNotNull()) 
			{
				CareContextVo voCareContext = domain.getCurrentCareContext(form.getGlobalContext().Core.getCurrentCareContext());
				voAuthoringInformation.setAuthoringHcp(voCareContext.getResponsibleHCPIsNotNull() ? (HcpLiteVo)voCareContext.getResponsibleHCP() : null);
			}
			form.customControlAuthoring().setValue(voAuthoringInformation);			
			fillIPStatusPreValidation();
		}
		
		
		form.setcustomControlReviewedVisible(false);
		form.chkMarkAsReviewed().setVisible(false);

		form.cmbStatus().setEnabled(true);
		form.chkForReview().setEnabled(true);
	}
	
	private void openTherapiesSOAP() throws PresentationLogicException
	{
		clearDetails();		
		form.setMode(FormMode.VIEW);
		
		showHideCustomComponent(form.customControlAuthoring(), Boolean.FALSE, false);
		
		//WDEV-13939
		ClinicalNotesVoCollection allSoapNotes = domain.getAllClinicalNotesForCareContext(form.getGlobalContext().Core.getCurrentCareContext());
		
		if (engine.isRIEMode())
		{
			populateScreenControls(allSoapNotes.get(0));
		}
		
		// for RIE
		if (form.getGlobalContext().Clinical.getCurrentClinicalNoteIsNotNull() && !engine.isRIEMode())//WDEV-13939
		{
			form.getGlobalContext().Clinical.setCurrentClinicalNote(domain.getClinicalNote(form.getGlobalContext().Clinical.getCurrentClinicalNote()));
			if(!form.getGlobalContext().Clinical.getCurrentClinicalNoteIsNotNull())
			{
				form.getLocalContext().setclinicalNotesVo(null);
			}
		}
		
		if (form.getGlobalContext().Clinical.getCurrentClinicalNoteIsNotNull() && !engine.isRIEMode())
		{
			//checkCurrentClinicalNote();
			populateScreenControls(form.getGlobalContext().Clinical.getCurrentClinicalNote());

			if (form.getGlobalContext().Clinical.getReturnToFormModeIsNotNull() && 
					form.getGlobalContext().Clinical.getReturnToFormMode().equals(FormMode.EDIT))
			{
				openAsDialog();
			}
			else
			{
				showBtnNew(true);
			}
		}
		else if (form.getGlobalContext().Clinical.getCurrentClinicalNote() == null &&
				form.getGlobalContext().Clinical.getReturnToFormModeIsNotNull()	&&
					form.getGlobalContext().Clinical.getReturnToFormMode().equals(FormMode.EDIT) )
		{
			newInstance();

			form.getGlobalContext().Clinical.setReturnToFormMode(null);
			form.getGlobalContext().Clinical.setCurrentClinicalNote(null);
		}
		else
		{
			if (form.getGlobalContext().Clinical.getCurrentClinicalNoteIsNotNull() && !engine.isRIEMode())
			{
				ClinicalNotesVo voNote = form.getGlobalContext().Clinical.getCurrentClinicalNote();
				checkForExistingClinicalNotes(voNote);
					
				if (voNote != null && 
					voNote.getNoteTypeIsNotNull() &&
					voNote.getNoteType().equals(ClinicalNoteType.THERAPYNOTE))
				{
					populateScreenControls(voNote);		
					showBtnNew(true);
				}
				else
				{
					showBtnNew(true);
				}
			}
			else
			{
				showBtnNew(true);
			}
		}
	}

	private void openAsDialog() throws PresentationLogicException
	{
		form.setMode(FormMode.EDIT);
		
		if(form.getGlobalContext().Core.getClinicalNotingModeIsNotNull() && 
			form.getGlobalContext().Core.getClinicalNotingMode().equals(ClinicalNotingMode.REVIEW))
		{
			form.chkForReview().setVisible(false);
			form.cmbDiscipline().setVisible(false);
			form.lblDiscipline().setVisible(false);
			form.setcustomControlReviewedVisible(true);
			form.customControlReviewed().setLabels(AuthoringLabelType.REVIEWING);
			form.chkMarkAsReviewed().setVisible(true);
			form.chkMarkAsReviewed().setValue(true);
			
			onChkMarkAsReviewedValueChanged();
			
			if (! form.getGlobalContext().Clinical.getCurrentClinicalNote().getReviewingHCPIsNotNull() && 
					! form.getGlobalContext().Clinical.getCurrentClinicalNote().getReviewingDateTimeIsNotNull())
			{
				enabledCustomReviewed(Boolean.TRUE);
			}
		}

		enableCustomReviewed(false);
		
		form.btnClose().setVisible(false);
	}

	private void checkForExistingClinicalNotes(ClinicalNotesVo voNote) throws FormOpenException
	{
		if ((voNote !=null &&
				voNote.getSourceOfNoteIsNotNull() && 
					! voNote.getSourceOfNote().equals(SourceOfNote.TLT_NOTE)) ||
						(voNote != null &&
							voNote.getNoteTypeIsNotNull() &&//wdev-4952
							!(voNote.getNoteType().equals(ClinicalNoteType.DISCHARGENOTE) ||
								voNote.getNoteType().equals(ClinicalNoteType.SUMMARYATADMISSION)) && 
									voNote.getIsDerivedNoteIsNotNull() &&
										!voNote.getIsDerivedNote().booleanValue()))			
											throw new FormOpenException("There is a clinical note of a different type already recorded on the system for this clincal contact");
	}

	private void enableCustomReviewed(boolean isEnabled)
	{
		if (form.getGlobalContext().Clinical.getCurrentClinicalNote().getReviewingHCPIsNotNull()
				&& form.getGlobalContext().Clinical.getCurrentClinicalNote().getReviewingDateTimeIsNotNull())
		{
			if (isEnabled == false)
				enabledCustomReviewed(Boolean.FALSE);
			else
				enabledCustomReviewed(Boolean.TRUE);
				
			form.chkMarkAsReviewed().setEnabled(isEnabled);
			setReviewedInfo();
		}
	}
	
	private void showBtnNew(boolean value)
	{
		form.btnNew().setVisible(value);
		form.btnNew().setEnabled(value);
	}
	

	private void enabledCustomReviewed(Boolean value)
	{
		form.customControlReviewed().setEnabledAuthoringHCP(value);
		form.customControlReviewed().setEnabledDateTime(value);
	}

	private void setReviewedInfo()
	{
		AuthoringInformationVo voAuthoringInformation = new AuthoringInformationVo();
		voAuthoringInformation.setAuthoringHcp(form.getGlobalContext().Clinical.getCurrentClinicalNote().getReviewingHCP());
		voAuthoringInformation.setAuthoringDateTime(form.getGlobalContext().Clinical.getCurrentClinicalNote().getReviewingDateTime());
		form.customControlReviewed().setValue(voAuthoringInformation);
	}
	
	private void populateScreenControls(ClinicalNotesVo voNote) 
	{
		initialiseScreenControls();
		
		if (voNote.getIsDerivedNoteIsNotNull()
				&& voNote.getIsDerivedNote().equals(Boolean.TRUE) )
			{	
				//Its a SOAP Clinical Note
				form.getLocalContext().setclinicalNotesVo(voNote);

				AuthoringInformationVo voAuthor = new AuthoringInformationVo();
				if (voNote.getAuthoringInfoIsNotNull())
				{
					voAuthor.setAuthoringDateTime(voNote.getAuthoringInfo().getAuthoringDateTime());
					voAuthor.setAuthoringHcp(voNote.getAuthoringInfo().getAuthoringHcp());
				}
				form.customControlAuthoring().setValue(voAuthor);
				
				ClinicalNotesRefVo voClinNotesRef = new ClinicalNotesRefVo();
				voClinNotesRef.setID_ClinicalNotes(voNote.getID_ClinicalNotes());
				
				SOAPVo voSOAP = domain.getSOAPsVo(voClinNotesRef);
				if (voSOAP != null)
				{
					form.getLocalContext().setSOAPVo(voSOAP);

					form.txtSubjective().setValue(voSOAP.getSubjectiveNoteIsNotNull() ? voSOAP.getSubjectiveNote() : "");  
					form.txtObjective().setValue(voSOAP.getObjectiveNoteIsNotNull() ? voSOAP.getObjectiveNote() : "");  
					form.txtAnalysis().setValue(voSOAP.getAnalysisNoteIsNotNull() ? voSOAP.getAnalysisNote() : "");  
					form.txtPlan().setValue(voSOAP.getPlanNoteIsNotNull() ? voSOAP.getPlanNote() : "");
				}

				fillIPStatusCombo(voNote);
				
				if (form.cmbStatus().getValues().size() == 0)
					form.cmbStatus().newRow(voNote.getCurrentStatus().getStatus(), voNote.getCurrentStatus().getStatus().getText());
				
				form.cmbStatus().setValue(voNote.getCurrentStatusIsNotNull() ? voNote.getCurrentStatus().getStatus() : null);

				if (voNote.getForReviewIsNotNull() && voNote.getForReview().booleanValue())
				{
					form.chkForReview().setValue(voNote.getForReview().booleanValue());
					form.cmbDiscipline().setValue(voNote.getForReviewDiscipline());

					form.chkForReview().setVisible(true);
					form.cmbDiscipline().setVisible(true);
					form.lblDiscipline().setVisible(true);
					form.setcustomControlReviewedVisible(false);
					form.chkMarkAsReviewed().setVisible(false);
					
					if (voNote.getReviewingHCPIsNotNull() || voNote.getReviewingDateTimeIsNotNull())
					{
						AuthoringInformationVo voReview = new AuthoringInformationVo();
						voReview.setAuthoringDateTime(voNote.getReviewingDateTime());
						voReview.setAuthoringHcp(voNote.getReviewingHCP());
						form.customControlReviewed().setValue(voReview);
						
						form.chkForReview().setVisible(false);
						form.cmbDiscipline().setVisible(false);
						form.lblDiscipline().setVisible(false);
						form.setcustomControlReviewedVisible(true);
						form.customControlReviewed().setLabels(AuthoringLabelType.REVIEWING);
						form.chkMarkAsReviewed().setVisible(true);
						form.chkMarkAsReviewed().setValue(true);
					}
				}
			}
	}

	private void clearDetails() 
	{
		form.customControlAuthoring().setValue(null);
		form.txtSubjective().setValue(null);
		form.txtObjective().setValue(null);
		form.txtAnalysis().setValue(null);
		form.txtPlan().setValue(null);
		form.cmbStatus().setValue(null);
		form.customControlReviewed().setValue(null);
		form.chkForReview().setValue(false);
		form.cmbDiscipline().setValue(null);
		
	}
	
	protected void showHideCustomComponent(IComponent customControl, Boolean isEnabled, boolean initialize)
	{	
		if (customControl != null)
		{
			customControl.setEnabledAuthoringHCP(isEnabled);
			customControl.setEnabledDateTime(isEnabled);
		}
		
		if (customControl != null &&
				initialize != false)
		{	
			customControl.initializeComponent();
		}
	}

	protected void onChkMarkAsReviewedValueChanged() throws PresentationLogicException
	{
		if (form.chkMarkAsReviewed().getValue() == true)
		{
			enabledCustomReviewed(Boolean.TRUE);
			form.customControlReviewed().initializeComponent();
		}
		else
		{
			form.customControlReviewed().setEnabledAuthoringHCP(Boolean.FALSE);
			form.customControlReviewed().setEnabledDateTime(Boolean.FALSE);
			form.customControlReviewed().setValue(null);
		}		
	}

	@Override
	protected void onChkReviewValueChanged() throws PresentationLogicException 
	{
		if (form.chkForReview().getValue() == true)
		{
			form.cmbDiscipline().setEnabled(true);
			form.cmbDiscipline().setRequired(true);//WDEV-14761
		}
		else
		{
			form.cmbDiscipline().setEnabled(false);
			form.cmbDiscipline().setValue(null);
		}
	}
	
	private void checkForDiscipline()
	{
		if (form.getGlobalContext().Clinical.getCurrentClinicalNoteIsNotNull())
		{
			MemberOfStaffShortVo mos = null;
			if (getDisciplineForLoggedInUser(form.getGlobalContext().Clinical.getCurrentClinicalNote()) != null)
				mos = getDisciplineForLoggedInUser(form.getGlobalContext().Clinical.getCurrentClinicalNote());
			else
			{
				engine.showMessage("No Discipline is available. Please choose an authoring user.");
				return;
			}
					
			if (form.getGlobalContext().Clinical.getCurrentClinicalNoteIsNotNull())
			{
				if (form.getGlobalContext().Clinical.getCurrentClinicalNote().getCurrentStatusIsNotNull() 
					&& form.getGlobalContext().Clinical.getCurrentClinicalNote().getDisciplineIsNotNull() 
					&& mos.getHcpIsNotNull()
					&& form.getGlobalContext().Clinical.getCurrentClinicalNote().getAuthoringInfoIsNotNull()
					&& form.getGlobalContext().Clinical.getCurrentClinicalNote().getAuthoringInfo().getAuthoringHcpIsNotNull()
					&& form.getGlobalContext().Clinical.getCurrentClinicalNote().getAuthoringInfo().getAuthoringHcp().getHcpTypeIsNotNull())
				{
					if ( ! form.getGlobalContext().Clinical.getCurrentClinicalNote().getAuthoringInfo().getAuthoringHcp().getHcpType().equals(mos.getHcp().getHcpType()) 
						&& (form.getGlobalContext().Clinical.getReturnToFormModeIsNotNull() 
							&& ! form.getGlobalContext().Clinical.getReturnToFormMode().equals(FormMode.EDIT) 
							|| form.getGlobalContext().Clinical.getReturnToFormMode() == null))
					{
						form.btnNew().setVisible(false);			
					}
				}
				//Non HCP
				else 
				{
					if (form.getMode().equals(FormMode.VIEW) &&
							domain.getHcpLiteUser() == null)
					{
						form.btnNew().setVisible(false);								
					}
				}
			}
		}
	}


	@Override
	protected void onBtnCloseClick() throws PresentationLogicException 
	{
		form.getGlobalContext().Core.setClinicalNotingMode(null);
		engine.close(DialogResult.OK);
	}

}
