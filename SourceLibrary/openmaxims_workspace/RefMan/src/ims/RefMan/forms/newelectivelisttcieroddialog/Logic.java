// This code was generated by Bogdan Tofei using IMS Development Environment (version 1.80 build 4972.23166)
// Copyright (C) 1995-2013 IMS MAXIMS. All rights reserved.

package ims.RefMan.forms.newelectivelisttcieroddialog;

import ims.admin.vo.ElectiveListConfigurationVo;
import ims.admin.vo.ElectiveListConfigurationVoCollection;
import ims.admin.vo.enums.ElectiveListDetails;
import ims.RefMan.forms.newelectivelisttcieroddialog.GenForm.grdNoteCommentsAddRow;
import ims.RefMan.forms.newelectivelisttcieroddialog.GenForm.grdNoteCommentsRow;
import ims.RefMan.vo.Booking_AppointmentElectiveListVo;
import ims.RefMan.vo.CatsReferralforElectiveListDetailsVo;
import ims.RefMan.vo.ElectiveListStatusVo;
import ims.RefMan.vo.ElectiveListStatusVoCollection;
import ims.RefMan.vo.PatientElectiveListDetailsToSaveVo;
import ims.RefMan.vo.PatientElectiveListNotesVo;
import ims.RefMan.vo.PatientElectiveListNotesVoCollection;
import ims.RefMan.vo.PatientElectiveListRefVo;
import ims.RefMan.vo.PatientElectiveListTCIVo;
import ims.RefMan.vo.PatientElectiveListTCIVoCollection;
import ims.RefMan.vo.ReferralERODVo;
import ims.RefMan.vo.ReviewPatientElectiveListVo;
import ims.RefMan.vo.ReviewPatientElectiveListVoCollection;
import ims.RefMan.vo.SuspensionDetailsForPatientElectiveListVo;
import ims.RefMan.vo.SuspensionDetailsForPatientElectiveListVoCollection;
import ims.RefMan.vo.TCIOutcomeForPatientElectiveListVo;
import ims.RefMan.vo.TCIOutcomeForPatientElectiveListVoCollection;
import ims.RefMan.vo.lookups.AdmissionOfferOutcome;
import ims.RefMan.vo.lookups.ERODType;
import ims.RefMan.vo.lookups.ElectiveAdmissionType;
import ims.chooseandbook.vo.lookups.ActionRequestType;
import ims.configuration.gen.ConfigFlag;
import ims.core.vo.HcpLiteVo;
import ims.core.vo.LocationLiteVoCollection;
import ims.core.vo.MemberOfStaffLiteVo;
import ims.core.vo.ProcedureLiteVo;
import ims.core.vo.ProcedureLiteVoCollection;
import ims.core.vo.ServiceLiteVo;
import ims.core.vo.enums.MosType;
import ims.core.vo.lookups.ManagementIntention;
import ims.core.vo.lookups.WaitingListStatus;
import ims.core.vo.lookups.YesNo;
import ims.domain.exceptions.DomainInterfaceException;
import ims.domain.exceptions.StaleObjectException;
import ims.emergency.vo.lookups.ElectiveListReason;
import ims.framework.Control;
import ims.framework.FormName;
import ims.framework.MessageButtons;
import ims.framework.MessageIcon;
import ims.framework.WindowParam;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.FormMode;
import ims.framework.enumerations.SortOrder;
import ims.framework.exceptions.PresentationLogicException;
import ims.framework.utils.Color;
import ims.framework.utils.Date;
import ims.framework.utils.DateTime;
import ims.scheduling.vo.Appointment_StatusVo;
import ims.scheduling.vo.Appointment_StatusVoCollection;
import ims.scheduling.vo.Booking_AppointmentVo;
import ims.scheduling.vo.lookups.Status_Reason;
import ims.vo.interfaces.IMos;

import java.util.ArrayList;
import java.util.List;

public class Logic extends BaseLogic
{
	private static final long serialVersionUID = 1L;
	private static final int REASONABLE_DAYS_LIMIT = 21;

	@Override
	protected void onFormOpen(Object[] args) throws ims.framework.exceptions.PresentationLogicException
	{
		
		if (args != null && args.length > 0 && args[0] != null && args[0] instanceof ElectiveListDetails)
		{
			form.getLocalContext().setActionPressed((ElectiveListDetails) args[0]);
		}
		else
			return;

		initialise();
		open();
		form.setMode((ElectiveListDetails.VIEWEDIT.equals(form.getLocalContext().getActionPressed()) || ElectiveListDetails.CANCELTCI.equals(form.getLocalContext().getActionPressed())) ? FormMode.VIEW : FormMode.EDIT);
		
		//if cancel TCI, open the CancelTciDialog
		if (ElectiveListDetails.CANCELTCI.equals(form.getLocalContext().getActionPressed()))
		{
			cancelTCI();
		}
		//wdev-18384
		if( ElectiveListDetails.REMOVE_ELECTIVE_LIST.equals(form.getLocalContext().getActionPressed()))
		{
			removeElectiveListEntry();
		}
		//-----------
		
	}
	//wdev-18384
	private void removeElectiveListEntry()
	{
		PatientElectiveListRefVo tempVo = form.getGlobalContext().RefMan.getPatientElectiveListRef();
		engine.open(form.getForms().RefMan.RemoveFromElectiveList, new Object[] {tempVo}); 
		
	}
	//------------
	private void initialise()
	{
		form.getLocalContext().setReferral(domain.getReferralDetails(form.getGlobalContext().RefMan.getCatsReferral()));
		
		CatsReferralforElectiveListDetailsVo referralDetais = form.getLocalContext().getReferral();

		form.ccRespHCP().initialize(MosType.HCP);
		
		if (referralDetais != null)
		{
			if (referralDetais.getReferralDetails() != null)
			{
				form.lblDate().setValue(referralDetais.getReferralDetails().getEnd18WW() != null ? referralDetais.getReferralDetails().getEnd18WW().toString() : "");
				form.ccRespHCP().setValue(referralDetais.getReferralDetails().getConsultant());
				
				if (referralDetais.getReferralDetails().getService() != null)
				{
					form.cmbService().newRow(referralDetais.getReferralDetails().getService(), referralDetais.getReferralDetails().getService().getServiceName());
					form.cmbService().setValue(referralDetais.getReferralDetails().getService());

					// if referral service has a maternity indicator, default to Maternity, else remove maternity
					if (Boolean.TRUE.equals(referralDetais.getReferralDetails().getService().getMaternityIndicator()))
					{
						form.cmbElectiveListReason().setValue(ElectiveListReason.MATERNITY);
					}
					else
					{
						form.cmbElectiveListReason().removeRow(ElectiveListReason.MATERNITY);
						form.cmbElectiveListReason().setValue(ElectiveListReason.TREATMENT);
					}
				}
			}
			
			form.cmbPriority().setValue(referralDetais.getUrgency());
		}

		// populate Elective Admission Type label
		if (ElectiveListDetails.ADDTOBOOKEDLIST.equals(form.getLocalContext().getActionPressed()))
		{
			form.getLocalContext().setAdmissionType(ElectiveAdmissionType.BOOKED_TYPE12);
			form.lblAdmissionType().setValue(ElectiveAdmissionType.BOOKED_TYPE12.getText());
		}
		else if (ElectiveListDetails.ADDTOPLANNEDLIST.equals(form.getLocalContext().getActionPressed()))
		{
			form.getLocalContext().setAdmissionType(ElectiveAdmissionType.PLANNED_TYPE13);
			form.lblAdmissionType().setValue(ElectiveAdmissionType.PLANNED_TYPE13.getText());
		}
		else if (ElectiveListDetails.ADDTOWAITINGLIST.equals(form.getLocalContext().getActionPressed()))
		{
			form.getLocalContext().setAdmissionType(ElectiveAdmissionType.ELECTIVE_TYPE11);
			form.lblAdmissionType().setValue(ElectiveAdmissionType.ELECTIVE_TYPE11.getText());
			
		}
		
		if (form.getGlobalContext().RefMan.getPatientElectiveListRef() == null)
		{
			form.lblStatus().setValue(WaitingListStatus.CREATED.getText());

			populateElectiveListCombo(ElectiveListReason.DIAGNOSTIC.equals(form.cmbElectiveListReason().getValue()) ? true : false);
			defaultIntendedProcedure();
			initialiseIntendedManagement();
			//WDEV-18603
			form.dteDateOnList().setValue(new Date());
			
			if (referralDetais != null && referralDetais.getReferralDetails() != null)
			{
				if (YesNo.YES.equals(referralDetais.getReferralDetails().getInterpreterRequired()))
				{
					form.chkInterpreterRequired().setValue(true);
					form.cmbInterpreterRequired().setValue(referralDetais.getReferralDetails().getLanguage());
				}

				if (YesNo.YES.equals(referralDetais.getReferralDetails().getTransportRequired()))
				{
					form.chkTransportRequired().setValue(true);
					form.cmbTransportRequired().setValue(referralDetais.getReferralDetails().getTransport());
				}

				if (referralDetais.getReferralDetails().getSpecialRequirements() != null)
				{
					form.chkSpecialRequirements().setValue(true);
					form.txtSpecialRequrements().setValue(referralDetais.getReferralDetails().getSpecialRequirements());
				}

			}
		}
		
		//WDEV-18388
		//initialiseWardCombo();
		form.lblLastReviewByValue().setValue(null);
		form.lblLastReviewDateValue().setValue(null);
		//WDEV-18464 
		form.lblTCIOutcomeValue().setValue(null);
		
	}

	private void initialiseWardCombo()
	{
		//WDEv-18388
		if (form.qmbHospital().getValue()==null)
			return;
		
		LocationLiteVoCollection wards = domain.listWards(form.qmbWard().getEditedText(),form.qmbHospital().getValue());
		
		if (wards == null)
			return;
		
		for (int i = 0; i < wards.size(); i++)
		{
			form.qmbWard().newRow(wards.get(i), wards.get(i).getName());//WDEV-18388
		}
	}

	private void initialiseIntendedManagement()
	{
		
		//WDEV-18388
		if (ElectiveAdmissionType.PLANNED_TYPE13.equals(form.getLocalContext().getAdmissionType()))
		{
			form.cmbIntendedManagement().removeRow(ManagementIntention.DAY_CASE);
			form.cmbIntendedManagement().removeRow(ManagementIntention.OVERNIGHT);
			form.cmbIntendedManagement().removeRow(ManagementIntention.TYPE1_STAYATLEASTONENIGHT);
			form.cmbIntendedManagement().removeRow(ManagementIntention.TYPE2_NOTOTSTAY);
		}
		else if (ElectiveAdmissionType.BOOKED_TYPE12.equals(form.getLocalContext().getAdmissionType()))
		{
			form.cmbIntendedManagement().removeRow(ManagementIntention.DAY_CASE);
			form.cmbIntendedManagement().removeRow(ManagementIntention.OVERNIGHT);
			form.cmbIntendedManagement().removeRow(ManagementIntention.TYPE3_SEQUENCEATLEASTONENIGHT);
			form.cmbIntendedManagement().removeRow(ManagementIntention.TYPE4_SEQUENCENOOVERNIGHSTAY);
			form.cmbIntendedManagement().removeRow(ManagementIntention.TYPE5_SEQUENCEOVERNIGHTANDHOME);
			
		}
		else if (ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType()))
		{
			form.cmbIntendedManagement().removeRow(ManagementIntention.DAY_CASE);
			form.cmbIntendedManagement().removeRow(ManagementIntention.OVERNIGHT);
			form.cmbIntendedManagement().removeRow(ManagementIntention.TYPE3_SEQUENCEATLEASTONENIGHT);
			form.cmbIntendedManagement().removeRow(ManagementIntention.TYPE4_SEQUENCENOOVERNIGHSTAY);
			form.cmbIntendedManagement().removeRow(ManagementIntention.TYPE5_SEQUENCEOVERNIGHTANDHOME);
		}

		defaultIntendedManagement();
		
	}

	private void defaultIntendedManagement()
	{
		if (form.intAnticipatedStay().getValue() != null  && (ElectiveAdmissionType.BOOKED_TYPE12.equals(form.getLocalContext().getAdmissionType()) || ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType())))
		{
			if (form.intAnticipatedStay().getValue() > 1)
			{
				form.cmbIntendedManagement().setValue(ManagementIntention.TYPE1_STAYATLEASTONENIGHT);
			}
			else if (form.intAnticipatedStay().getValue() == 1)
			{
				form.cmbIntendedManagement().setValue(ManagementIntention.TYPE2_NOTOTSTAY);
			}
		}
		else
			form.cmbIntendedManagement().setValue(null);
	}

	private void defaultIntendedProcedure()
	{
		ProcedureLiteVo sfsProcedure = domain.getProcedureFromSuitableForSurgery(form.getLocalContext().getReferral().getCareContext());

		if (sfsProcedure != null)
		{
			form.qmbIntendedProcedure().newRow(sfsProcedure, sfsProcedure.getProcedureName());
			form.qmbIntendedProcedure().setValue(sfsProcedure);
			form.txtDescription().setValue(sfsProcedure.getProcedureName());
			form.intAnticipatedStay().setValue(sfsProcedure != null ? sfsProcedure.getLOS() : null);
		}

	}

	private void populateElectiveListCombo(boolean isDiagnosticReason)
	{
		form.cmbElectiveList().clear();

		if (!isDiagnosticReason)
		{
    		ElectiveListConfigurationVoCollection electiveListConfigForService = new ElectiveListConfigurationVoCollection();
    		ElectiveListConfigurationVoCollection electiveListConfigForHCP = new ElectiveListConfigurationVoCollection();
    		ElectiveListConfigurationVoCollection electiveListConfigForAllServices = new ElectiveListConfigurationVoCollection();
    
    		electiveListConfigForService = domain.getElectiveListConfigForService(form.getLocalContext().getReferral().getReferralDetails().getService().getID_Service());
    
    		if (form.ccRespHCP().getValue() != null)
    		{
    			electiveListConfigForHCP = domain.getElectiveListConfigForHCP(form.ccRespHCP().getValue().getIMosId(), form.getLocalContext().getReferral().getReferralDetails().getService().getID_Service());
    		}
    
    		if (Boolean.TRUE.equals(form.chkExtendedSearch().getValue()) && form.getLocalContext().getReferral().getReferralDetails().getService().getSpecialty() != null)
    		{
    			electiveListConfigForAllServices = domain.getElectiveListsBySpecialty(form.getLocalContext().getReferral().getReferralDetails().getService().getSpecialty().getID());
    
    			addRowsToElectiveListCombo(electiveListConfigForAllServices, false);
    		}
    		else
    		// join the electiveListConfigForHCP and electiveListConfigForService
    		{
    			for (int i = 0; i < electiveListConfigForService.size(); i++)
    			{
    				electiveListConfigForHCP.add(electiveListConfigForService.get(i));
    			}
    
    			addRowsToElectiveListCombo(electiveListConfigForHCP, false);
    		}
		}
		else
		{
			ElectiveListConfigurationVoCollection electiveListConfig = domain.getElectiveList();
			addRowsToElectiveListCombo(electiveListConfig, true);
		}
	}

	private void addRowsToElectiveListCombo(ElectiveListConfigurationVoCollection electiveListConfig, boolean isDiagnosticReason)
	{
		ElectiveListConfigurationVoCollection tempListConfig = new ElectiveListConfigurationVoCollection();
		
		int nrOfListsHcpIsDefault = 0;
		ElectiveListConfigurationVo defaultHcpList = null;
		
		for (int i = 0; i < electiveListConfig.size(); i++)
		{

			// check if HCP if default for this ElectiveListConfiguration add instances
			if (!isDiagnosticReason && form.ccRespHCP().getValue() != null && isDefaultHcpOnListConfig(electiveListConfig.get(i)))
			{
				form.cmbElectiveList().newRow(electiveListConfig.get(i), electiveListConfig.get(i).getWaitingListName()+(electiveListConfig.get(i).getServiceIsNotNull() ? " ("+electiveListConfig.get(i).getService().getServiceName()+")":"" ), Color.Red);
				
				if (nrOfListsHcpIsDefault == 0) //set the defaultHcpList to the first default elective List found for the HCP
				{
					defaultHcpList = electiveListConfig.get(i);
				}
				
				nrOfListsHcpIsDefault++;
			}
			else
				// add to a temporary list
				tempListConfig.add(electiveListConfig.get(i));
		}

		ServiceLiteVo referralService = (form.getLocalContext().getReferral()!=null && form.getLocalContext().getReferral().getReferralDetails()!=null ? form.getLocalContext().getReferral().getReferralDetails().getService(): null); //WDEV-18388 
		// add the remaining ElectiveListConfiguration items to the combo
		for (int i = 0; i < tempListConfig.size(); i++)
		{
			form.cmbElectiveList().newRow(tempListConfig.get(i), tempListConfig.get(i).getWaitingListName()+ (tempListConfig.get(i).getServiceIsNotNull()  &&  referralService!=null && referralService.getID_Service().intValue() != tempListConfig.get(i).getService().getID_Service().intValue() ? " (Service: "+ tempListConfig.get(i).getService().getServiceName()+")" : ""));
		}

		if (electiveListConfig.size() == 1)
			form.cmbElectiveList().setValue(electiveListConfig.get(0));
		else if (nrOfListsHcpIsDefault == 1) // if the HCP has only one default Elective List, default it.
			form.cmbElectiveList().setValue(defaultHcpList);
	}

	private boolean isDefaultHcpOnListConfig(ElectiveListConfigurationVo electiveListConfig)
	{
		for (int j = 0; electiveListConfig.getHCPs() != null && j < electiveListConfig.getHCPs().size(); j++)
		{
			if (Boolean.TRUE.equals(electiveListConfig.getHCPs().get(j).getDefaultForHCP()) && electiveListConfig.getHCPs().get(j).getHCP().equals(form.ccRespHCP().getValue()))
			{
				return true;
			}
		}

		return false;
	}

	private void open()
	{	
		form.btnSuspend().setTooltip(null); //WDEV-18519
		populateScreenFromData();
	}

	private void populateScreenFromData()
	{
		if (form.getGlobalContext().RefMan.getPatientElectiveListRef() == null)
			return;
		
		PatientElectiveListDetailsToSaveVo patientElectiveList = domain.getPatientElectiveList(form.getGlobalContext().RefMan.getPatientElectiveListRef());
		
		form.getLocalContext().setPatientElectiveList(patientElectiveList);
		
		//WDEV-18519
		if (form.getLocalContext().getPatientElectiveListIsNotNull() && form.getLocalContext().getPatientElectiveList().getID_PatientElectiveListIsNotNull() && form.getLocalContext().getPatientElectiveList().getSuspensions() != null)
		{	
			SuspensionDetailsForPatientElectiveListVoCollection suspensions = domain.getSuspensionsForPatientElectiveList(form.getGlobalContext().RefMan.getPatientElectiveListRef());
			form.btnSuspend().setTooltip(populateSuspensionsTooltip(suspensions));
		}
		populateElectiveListDetails();
		populateTCIDetails();
		populateErodDetails();
		populateCommentsAndNotesGrid(ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType()));
		
		
	}

	private String populateSuspensionsTooltip(SuspensionDetailsForPatientElectiveListVoCollection suspensions)
	{
		if (suspensions == null || (suspensions != null && suspensions.size() == 0))
			return null;

		StringBuffer tooltip = new StringBuffer();

		tooltip.append("<table style=\"border :1px solid black; border-collapse:collapse;\">");
		tooltip.append("<tr><td style=\" border:1px solid black;\"><b>Start Date  &nbsp &nbsp</b></td><td style=\" border:1px solid black;\"><b>End Date  &nbsp &nbsp</b></td><td style=\" border:1px solid black;\"><b>Initiator  &nbsp &nbsp</b></td><td style=\" border:1px solid black;\"><b>Reason and Comments &nbsp &nbsp </b></td></tr>");
		for (int i = 0; i < suspensions.size(); i++)
		{
			tooltip.append("<tr>");
			SuspensionDetailsForPatientElectiveListVo suspension = suspensions.get(i);
			
			if (suspension==null)
				continue;
			
			tooltip.append("<td style=\" border:1px solid black;\"><b>" +(suspension.getStartDateIsNotNull() ?  suspension.getStartDate().toString():"") 
							+ "</b></td><td style=\" border:1px solid black;\"><b>" +(suspension.getEndDateIsNotNull() ? suspension.getEndDate().toString():"")
							+ "</b></td><td style=\" border:1px solid black;\"><b>" + (suspension.getInitatorIsNotNull() ? suspension.getInitator().getText() : "")
							+ "</b></td><td style=\" border:1px solid black;\">" + ((suspension.getSuspensionReasonIsNotNull() ? "<b>Suspension Reason:</b> " + suspension.getSuspensionReason().getText() : "" )+ (suspension.getCommentsIsNotNull() ? "<br/><b>Comments:</b> " + suspension.getComments() : "")
							+ "</b></td></tr>"));
		}
		tooltip.append("</table>");

		return tooltip.toString();
		
	}
	private void populateCommentsAndNotesGrid(boolean isWaitingListEntry)
	{
		form.grdNoteCommentsAdd().getRows().clear();//WDEV-18360
		form.grdNoteComments().getRows().clear();//WDEV-18360

		PatientElectiveListNotesVoCollection notesList = form.getLocalContext().getPatientElectiveList().getNotes();

		if (notesList == null || notesList.size() == 0)
			return;

		if (isWaitingListEntry)
		{	
			for (int i = 0; i < notesList.size(); i++)
			{
				PatientElectiveListNotesVo note = notesList.get(i);
				grdNoteCommentsAddRow row = form.grdNoteCommentsAdd().getRows().newRow();

				row.setcolNoteComment(note.getNotes());
				row.setcolRecordingDateTime(note.getAuthoringDateTime().toString());
				row.setcolRecordingUser(note.getAuthoringUser().toString());

				row.setValue(note);
			}
		}
		else
		{	
			for (int j = 0; j < notesList.size(); j++)
			{
				PatientElectiveListNotesVo elNote = notesList.get(j);
				grdNoteCommentsRow newRow = form.grdNoteComments().getRows().newRow();

				newRow.setcolNoteComment(elNote.getNotes());
				newRow.setcolRecordingDateTime(elNote.getAuthoringDateTime().toString());
				newRow.setcolRecordingUser(elNote.getAuthoringUser().toString());

				newRow.setValue(elNote);
			}
		}
	}

	private void populateElectiveListDetails()
	{
		PatientElectiveListDetailsToSaveVo patientElectiveList = form.getLocalContext().getPatientElectiveList();
		
		form.getLocalContext().setAdmissionType(patientElectiveList.getElectiveAdmissionType());
		
		initialiseIntendedManagement();
		
		//WDEV-18388
		
		form.lblStatus().setValue(patientElectiveList.getElectiveListStatus() != null ? patientElectiveList.getElectiveListStatus().getElectiveListStatus().getText() : "");
		form.lblAdmissionType().setValue(patientElectiveList.getElectiveAdmissionType() != null ? patientElectiveList.getElectiveAdmissionType().getText() : "");
		
		//WDEV-18603
		form.dteDateOnList().setValue(patientElectiveList.getDateOnList());
		form.ccRespHCP().setValue((IMos) patientElectiveList.getConsultant());
		ServiceLiteVo referralService = (form.getLocalContext().getReferral()!=null && form.getLocalContext().getReferral().getReferralDetails()!=null ? form.getLocalContext().getReferral().getReferralDetails().getService(): null); //WDEV-18388
		if (!form.cmbElectiveList().getValues().contains(patientElectiveList.getElectiveList()))
			form.cmbElectiveList().newRow(patientElectiveList.getElectiveList(), patientElectiveList.getElectiveList().getWaitingListName()+(patientElectiveList.getElectiveList().getServiceIsNotNull() && referralService!=null && referralService.getID_Service().intValue() != patientElectiveList.getElectiveList().getService().getID_Service().intValue()  ? " (Service: " + patientElectiveList.getElectiveList().getService().getServiceName() + ")": ""));//WDEV-18388
		
		form.cmbElectiveList().setValue(patientElectiveList.getElectiveList());
		form.cmbElectiveListReason().setValue(patientElectiveList.getElectiveListReason());
		
		if (patientElectiveList.getPrimaryProcedure() != null)
		{
			form.qmbIntendedProcedure().newRow(patientElectiveList.getPrimaryProcedure(), patientElectiveList.getPrimaryProcedure().getProcedureName());
			form.qmbIntendedProcedure().setValue(patientElectiveList.getPrimaryProcedure());
		}
		
		form.txtDescription().setValue(patientElectiveList.getProcedureDescription());
		form.cmbPriority().setValue(patientElectiveList.getPriority());
		form.cmbIntendedManagement().setValue(patientElectiveList.getIntendedManagement());
		form.intAnticipatedStay().setValue(patientElectiveList.getAnticipatedStay());
		form.chkAvailableAtShortNoticed().setValue(patientElectiveList.getAvailableAtShortNotice());
		form.intNoOfDaysNotice().setValue(patientElectiveList.getAvailableAtShortNoticePeriod());
		form.chkPreAdmissionRequired().setValue(patientElectiveList.getPreAdmissionRequired());
		form.chkInterpreterRequired().setValue(patientElectiveList.getInterpretatorRequired());
		form.cmbInterpreterRequired().setValue(patientElectiveList.getLanguage());
		form.chkTransportRequired().setValue(patientElectiveList.getTransportRequired());
		form.cmbTransportRequired().setValue(patientElectiveList.getTransport());
		form.chkSpecialRequirements().setValue(patientElectiveList.getSpecialRequirements()/*patientElectiveList.getAvailableAtShortNotice()*/);
		form.txtSpecialRequrements().setValue(patientElectiveList.getSpecialRequirementsDetails());
		
		//WDEV-18388
		ReviewPatientElectiveListVoCollection collPrevReviews = patientElectiveList.getReviews().sort(SortOrder.ASCENDING);
		form.imbElectiveListHistory().setTooltip(populateElectiveListHistoryTooltip(collPrevReviews));
		
		ReviewPatientElectiveListVo lastReview = collPrevReviews!=null && collPrevReviews.size()>0 && collPrevReviews.get(collPrevReviews.size()-1)!=null ?  collPrevReviews.get(collPrevReviews.size()-1) : null;
		form.lblLastReviewByValue().setValue(lastReview!=null && lastReview.getReviewedBy()!=null  ? lastReview.getReviewedBy().getIMosName(): null);
		form.lblLastReviewDateValue().setValue(lastReview!=null  && lastReview.getReviewedDate()!=null? lastReview.getReviewedDate().toString(): null);
		form.imbTCIHistory().setTooltip(populateTCiHistoryTooltip(patientElectiveList.getTCIHistory()));
	}

	//WDEV-18388
	private String populateElectiveListHistoryTooltip(ReviewPatientElectiveListVoCollection reviews)
	{
		if (reviews == null || (reviews != null && reviews.size() == 0))
			return null;

		StringBuffer tooltip = new StringBuffer();

		tooltip.append("<table style=\"border :1px solid black; border-collapse:collapse;\">");
		tooltip.append("<tr><td style=\" border:1px solid black;\"><b>Review Date  &nbsp &nbsp</b></td><td style=\" border:1px solid black;\"><b>Review By &nbsp &nbsp </b></td></tr>");
		for (int i = 0; i < reviews.size(); i++)
		{
			tooltip.append("<tr>");
			ReviewPatientElectiveListVo review = reviews.get(i);
			
			if (review==null)
				continue;
			
			tooltip.append("<td style=\" border:1px solid black;\"><b>" +( review.getReviewedDate()!=null ? review.getReviewedDate():"") 
							+ "</b></td><td style=\" border:1px solid black;\"><b>" +(review.getReviewedBy()!=null && review.getReviewedBy().getName()!=null ? review.getReviewedBy().getName():"" )
							+ "</b></td></tr>");
		}
		tooltip.append("</table>");

		return tooltip.toString();
		
	}

	//WDEV-18388
	private String populateTCiHistoryTooltip(PatientElectiveListTCIVoCollection tciHistory)
	{
		if (tciHistory == null || (tciHistory != null && tciHistory.size() == 0))
			return null;

		StringBuffer tooltip = new StringBuffer();

		tooltip.append("<table style=\"border :1px solid black; border-collapse:collapse;\">");
		tooltip.append("<tr><td style=\" border:1px solid black;\"><b>TCI Date  &nbsp &nbsp</b></td><td style=\" border:1px solid black;\"><b>TCI Time &nbsp &nbsp </b></td><td style=\" border:1px solid black;\"><b>Outcome &nbsp &nbsp </b></td></tr>");
		for (int i = 0; i < tciHistory.size(); i++)
		{
			tooltip.append("<tr>");
			PatientElectiveListTCIVo tci = tciHistory.get(i);
			
			if (tci==null)
				continue;
			
			tooltip.append("<td style=\" border:1px solid black;\"><b>" +( tci.getTCIDate()!=null ? tci.getTCIDate():"") 
							+ "</b></td><td style=\" border:1px solid black;\"><b>" +(tci.getTCITime()!=null ? tci.getTCITime():"" )
							+ "</b></td><td style=\" border:1px solid black;\"><b>" +(tci.getCurrentOutcome()!=null && tci.getCurrentOutcome().getOutcome()!=null? tci.getCurrentOutcome().getOutcome():"") + "</b></td></tr>");
		}
		tooltip.append("</table>");

		return tooltip.toString();
	}

	private void populateTCIDetails()
	{
		PatientElectiveListTCIVo tciDetails = form.getLocalContext().getPatientElectiveList().getTCIDetails();
		
		if (tciDetails == null)
		{
			clearTCIDetails();
			return;
		}
		
		form.dteTCIDate().setValue(tciDetails.getTCIDate());
		form.timTCITime().setValue(tciDetails.getTCITime());
		
		//WDEV-18388
		if (tciDetails.getTCIWard()!=null)
		{
			form.qmbWard().newRow(tciDetails.getTCIWard(), tciDetails.getTCIWard().getName());
			form.qmbWard().setValue(tciDetails.getTCIWard());
		}
		
		//WDEV-18388
		if (tciDetails.getTCIHospital()!=null)
		{
			form.qmbHospital().newRow(tciDetails.getTCIHospital(),tciDetails.getTCIHospital().getName());
			form.qmbHospital().setValue(tciDetails.getTCIHospital());
		}
		
		form.cmbBreachReason().setValue(tciDetails.getKPIExceededReason());
		form.dteDateOffered().setValue(tciDetails.getDateTCIOffered());
		form.cmbTCIOfferedMethod().setValue(tciDetails.getTCIOfferMethod());
		//WDEV-18464
		form.lblTCIOutcomeValue().setValue("");
		form.lblTCIOutcomeValue().setTooltip("");
		if (tciDetails.getCurrentOutcomeIsNotNull() 
			&& tciDetails.getCurrentOutcome().getOutcomeIsNotNull())
		{
			form.lblTCIOutcomeValue().setValue( tciDetails.getCurrentOutcome().getOutcome().getText().length() > 60 ? tciDetails.getCurrentOutcome().getOutcome().getText().substring(0 , 60) : tciDetails.getCurrentOutcome().getOutcome().getText());
			form.lblTCIOutcomeValue().setTooltip(tciDetails.getCurrentOutcome().getOutcome().getText().length() > 60 ? tciDetails.getCurrentOutcome().getOutcome().getText() : tciDetails.getCurrentOutcome().getOutcome().getText());
		}
			
	}

	private void clearTCIDetails()
	{
		form.dteTCIDate().setValue(null);
		form.timTCITime().setValue(null);
		form.qmbWard().setValue(null);//WDEV-18388
		form.qmbHospital().setValue(null);//WDEV-18388
		form.cmbBreachReason().setValue(null);
		form.dteDateOffered().setValue(null);
		form.cmbTCIOfferedMethod().setValue(null);
		form.lblTCIOutcomeValue().setValue(null);//WDEV-18464
		form.lblTCIOutcomeValue().setTooltip(null);//WDEV-18464
	}

	private void populateErodDetails()
	{
		 ReferralERODVo erodDetails = form.getLocalContext().getPatientElectiveList().getEROD();
		
		 if (erodDetails == null)
			 return;
		 
		 form.dteEarliestDateOffered().setValue(erodDetails.getERODDate1());
		 form.dteSecondDateOffered().setValue(erodDetails.getERODDate2());
		 form.chkReasonableOffer().setValue(erodDetails.getReasonableOffer());
		 form.dtePatientAvailableFromDate().setValue(erodDetails.getPatAvailFromDate());
	}

	@Override
	protected void onBtnCancelClick() throws ims.framework.exceptions.PresentationLogicException
	{
		if (ElectiveListDetails.VIEWEDIT.equals(form.getLocalContext().getActionPressed())
				|| ElectiveListDetails.NEWEDITEROD.equals(form.getLocalContext().getActionPressed())
				|| ElectiveListDetails.NEWEDITTCI.equals(form.getLocalContext().getActionPressed()))
		{
			open();
			form.setMode(FormMode.VIEW);
		}
		else
		{
			//wdev-18320
			if( ElectiveListDetails.REVIEW.equals(form.getLocalContext().getActionPressed()) )
			{
				
				PatientElectiveListDetailsToSaveVo patientElectiveList = form.getLocalContext().getPatientElectiveList();
				
				ReviewPatientElectiveListVo tempVo = new ReviewPatientElectiveListVo();
				tempVo.setReviewedDate(new DateTime());
				tempVo.setReviewedBy((MemberOfStaffLiteVo) domain.getMosUser());
				ReviewPatientElectiveListVoCollection tempColl = patientElectiveList.getReviews();
				if( tempColl == null )
					tempColl = new ReviewPatientElectiveListVoCollection();
				tempColl.add(tempVo);
				patientElectiveList.setReviews(tempColl);
				form.getLocalContext().setPatientElectiveList(patientElectiveList);
				
				save(false,false);
				
			}
			engine.close(DialogResult.CANCEL);
		}
	}

	@Override
	protected void onBtnSaveClick() throws ims.framework.exceptions.PresentationLogicException
	{
		if (save(true, true))
		{
			open();
			//WDEV-18388
			form.getLocalContext().setActionPressed(ElectiveListDetails.VIEWEDIT);
			form.setMode(FormMode.VIEW);
		}
	}

	private boolean save(boolean checkReasonableOffer, boolean populateFromScreen)
	{
		PatientElectiveListDetailsToSaveVo patElectiveListToSave = (populateFromScreen ? populateDataFromScreen(form.getLocalContext().getPatientElectiveList()) : form.getLocalContext().getPatientElectiveList());
		
		//WDEV-18449 -- start
		Booking_AppointmentElectiveListVo appointmentsDetails = null;
		Integer tciID = null;
		if (form.getLocalContext().getPatientElectiveListIsNotNull() && form.getLocalContext().getPatientElectiveList().getTCIDetailsIsNotNull() && form.getLocalContext().getPatientElectiveList().getTCIDetails().getAppointmentIsNotNull())
		{
			tciID = form.getLocalContext().getPatientElectiveList().getTCIDetails().getID_TCIForPatientElectiveList();
			appointmentsDetails = form.getLocalContext().getPatientElectiveList().getTCIDetails().getAppointment();
			form.getLocalContext().setapptStaus(setAppointmentStatus(form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList()));
		}
		//WDEV-18449 -- end
		
		if( populateFromScreen == true)   //wdev-18320
		{
    		if (!validateUIRules())
    			return false;
		}
		
		String[] errors = patElectiveListToSave.validate();
		
		if (errors != null && errors.length > 0)
		{
			engine.showErrors(errors);
			return false;
		}
		
		if (Boolean.TRUE.equals(form.chkReasonableOffer().getValue()) && form.chkReasonableOffer().isEnabled() && checkReasonableOffer)
		{
			if( checkReasonableOffer() == false )
				return false;
		}
		
		boolean isNewERODSaved = patElectiveListToSave.getEROD() != null && patElectiveListToSave.getEROD().getID_ReferralEROD() == null;;
		//WDEV-18345
		if (engine.getPreviosFormName().equals(form.getForms().Scheduling.AppointmentOutcomeDialog))
		{
			form.getGlobalContext().RefMan.setPatientElectiveList(patElectiveListToSave);
			engine.close(DialogResult.OK);
			return false;
		}
		
		try 
		{
			patElectiveListToSave = domain.save(patElectiveListToSave);
			form.getGlobalContext().RefMan.setPatientElectiveListRef(patElectiveListToSave);
		} 
		catch (StaleObjectException e) 
		{
			engine.showMessage(ims.configuration.gen.ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			engine.close(DialogResult.CANCEL);
			return false;
		}
		
				
		if(isNewERODSaved && patElectiveListToSave.getTCIDetails() == null)
		{
			form.getLocalContext().setSuspensionMessageBoxId(engine.showMessage("Do you want to create a suspension record?", "", MessageButtons.YESNO, MessageIcon.QUESTION));
		}
		
		// WDEV-18449 -- start
		if(form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList() != null && Boolean.TRUE.equals(form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList().getCancelTheatreAppointment()) &&
			patElectiveListToSave != null && (patElectiveListToSave.getTCIDetails() == null ||(patElectiveListToSave.getTCIDetailsIsNotNull() && !patElectiveListToSave.getTCIDetails().getID_TCIForPatientElectiveList().equals(tciID)))  && appointmentsDetails != null && appointmentsDetails.getTheatreBooking() != null)
		{
			cancelTCILinkedAppointments(appointmentsDetails);
		}
		// WDEV-18449 -- end
		
		return true;
	}

	private boolean checkReasonableOffer()
	{
		String warnings = "";
		int numberOfDates = 0;

		if (Boolean.TRUE.equals(form.chkReasonableOffer().getValue()))
		{

			if (form.dteEarliestDateOffered().getValue() != null && form.dteEarliestDateOffered().getValue().isLessThan(new Date().addDay(REASONABLE_DAYS_LIMIT)))
			{
				warnings += "'Earliest Date Offered' is less than " + REASONABLE_DAYS_LIMIT + " days";
				numberOfDates++;
			}

			if (form.dteSecondDateOffered().getValue() != null && form.dteSecondDateOffered().getValue().isLessThan(new Date().addDay(REASONABLE_DAYS_LIMIT)))
			{
				warnings += (warnings.length() > 0 ? "\n" : "") + "'Second Date Offered' is less than " + REASONABLE_DAYS_LIMIT + " days";
				numberOfDates++;
			}

			if (warnings.length() > 0)
			{
				warnings += "\nDid the patient confirm " + (numberOfDates == 2 ? "these dates" : "this date") + "?";
			}

			if (warnings.length() > 0)
			{
				engine.showMessage(warnings, "Warning", MessageButtons.YESNO, MessageIcon.WARNING);
				return false;
			}
			//else
			//	save(false, true);
		}
		return true;
	}

	private PatientElectiveListDetailsToSaveVo populateDataFromScreen(PatientElectiveListDetailsToSaveVo patientElectiveList)
	{
		//WDEV-18388
		if (patientElectiveList == null)
			patientElectiveList = new PatientElectiveListDetailsToSaveVo();
		else
			patientElectiveList=(PatientElectiveListDetailsToSaveVo) patientElectiveList.clone();
		
		CatsReferralforElectiveListDetailsVo currentReferral = form.getLocalContext().getReferral();
		
		patientElectiveList.setPatient(currentReferral.getPatient());
		patientElectiveList.setReferral(currentReferral);
		patientElectiveList.setEpisodeOfCare(currentReferral.getCareContext().getEpisodeOfCare());
		
		patientElectiveList.setElectiveList(form.cmbElectiveList().getValue());
		patientElectiveList.setElectiveListReason(form.cmbElectiveListReason().getValue());
		
		patientElectiveList.setPrimaryProcedure(form.qmbIntendedProcedure().getValue());
		patientElectiveList.setProcedureDescription(form.txtDescription().getValue());
		
		patientElectiveList.setPriority(form.cmbPriority().getValue());
		patientElectiveList.setIntendedManagement(form.cmbIntendedManagement().getValue());
		
		patientElectiveList.setAnticipatedStay(form.intAnticipatedStay().getValue());
		
		patientElectiveList.setAvailableAtShortNotice(form.chkAvailableAtShortNoticed().getValue());
		patientElectiveList.setAvailableAtShortNoticePeriod(form.intNoOfDaysNotice().getValue());
		
		patientElectiveList.setPreAdmissionRequired(form.chkPreAdmissionRequired().getValue());
		
		patientElectiveList.setOperativeProcedureStatus(form.qmbIntendedProcedure().getValue() != null);
		
		//WDEV-18388
		if (ElectiveListDetails.CANCELTCI.equals(form.getLocalContext().getActionPressed()) && patientElectiveList.getTCIDetails()!=null)
		{
			PatientElectiveListTCIVo tciToBeCancelled = (PatientElectiveListTCIVo) patientElectiveList.getTCIDetails().clone();
			 
			patientElectiveList.setTCIDetails(null);
			tciToBeCancelled.setCurrentOutcome(form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList());
			
			if(tciToBeCancelled.getOutcomeHistory() == null)
				tciToBeCancelled.setOutcomeHistory(new TCIOutcomeForPatientElectiveListVoCollection());
			
			tciToBeCancelled.getOutcomeHistory().add(form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList());
			
			if(patientElectiveList.getTCIHistory() == null)
				patientElectiveList.setTCIHistory(new PatientElectiveListTCIVoCollection());
			
			patientElectiveList.getTCIHistory().add(tciToBeCancelled);
		}
		
		if(atLeastOneTCIFieldCompleted())
		{
			PatientElectiveListTCIVo tciDetails = patientElectiveList.getTCIDetails();
			
			if (tciDetails == null) 
				tciDetails = new PatientElectiveListTCIVo();
			
			tciDetails.setTCIDate(form.dteTCIDate().getValue());
			tciDetails.setTCITime(form.timTCITime().getValue());
			tciDetails.setTCIWard(form.qmbWard().getValue());//WDEV-18388
			tciDetails.setTCIHospital(form.qmbHospital().getValue());//WDEV-18388
			tciDetails.setKPIExceededReason(form.cmbBreachReason().getValue());
			tciDetails.setDateTCIOffered(form.dteDateOffered().getValue());
			tciDetails.setTCIOfferMethod(form.cmbTCIOfferedMethod().getValue());
			tciDetails.setTCIConsultant((HcpLiteVo) form.ccRespHCP().getValue());
			tciDetails.setIsActive(Boolean.TRUE);
			patientElectiveList.setTCIDetails(tciDetails);
			patientElectiveList.setRequiresTCIBy(null);			//wdev-18419
		}
		else
			patientElectiveList.setTCIDetails(null);
		
		if (atLeastOneERODFieldCompleted())
		{
			ReferralERODVo erodDetails = patientElectiveList.getEROD();
			
			if(erodDetails == null)
			{
				erodDetails = new ReferralERODVo();
				// WDEV-18436  
				if (ElectiveListReason.DIAGNOSTIC.equals(form.cmbElectiveListReason().getValue()))
					erodDetails.setERODType(ERODType.DIAGNOSTIC);
				else
					erodDetails.setERODType(ERODType.ELECTIVE);
			}
			
			erodDetails.setERODDate1(form.dteEarliestDateOffered().getValue());
			erodDetails.setERODDate2(form.dteSecondDateOffered().getValue());
			erodDetails.setReasonableOffer(form.chkReasonableOffer().getValue());
			erodDetails.setPatAvailFromDate(form.dtePatientAvailableFromDate().getValue());
			erodDetails.setPathWayClock(currentReferral.getJourneyIsNotNull() ? currentReferral.getJourney().getCurrentClock():null);
			erodDetails.setIsActive(Boolean.TRUE);
			patientElectiveList.setEROD(erodDetails);
		}
		else
			patientElectiveList.setEROD(null);
		
		if (patientElectiveList.getElectiveListStatus() == null)
		{
			ElectiveListStatusVo electiveListStatus = new ElectiveListStatusVo();

			if (patientElectiveList.getTCIDetails() != null)
				electiveListStatus.setElectiveListStatus(WaitingListStatus.TCI_GIVEN);//wdev-18569
			else
				electiveListStatus.setElectiveListStatus(WaitingListStatus.CREATED);
			
			electiveListStatus.setAuthoringUser((MemberOfStaffLiteVo) domain.getMosUser());
			electiveListStatus.setStatusDateTime(new DateTime());

			patientElectiveList.setElectiveListStatus(electiveListStatus);

			if (patientElectiveList.getElectiveListStatusHistory() == null)
				patientElectiveList.setElectiveListStatusHistory(new ElectiveListStatusVoCollection());

			patientElectiveList.getElectiveListStatusHistory().add(electiveListStatus);
		}
		else if (patientElectiveList.getTCIDetails() != null 
				&& (WaitingListStatus.REQUIRES_TCI.equals(patientElectiveList.getElectiveListStatus().getElectiveListStatus()) 
					|| WaitingListStatus.CREATED.equals(patientElectiveList.getElectiveListStatus().getElectiveListStatus()) //WDEV-19107
						|| WaitingListStatus.SUSPENDED.equals(patientElectiveList.getElectiveListStatus().getElectiveListStatus())))
		{
			ElectiveListStatusVo electiveListStatus = new ElectiveListStatusVo();

			electiveListStatus.setElectiveListStatus(WaitingListStatus.TCI_GIVEN);
			electiveListStatus.setAuthoringUser((MemberOfStaffLiteVo) domain.getMosUser());
			electiveListStatus.setStatusDateTime(new DateTime());

			patientElectiveList.setElectiveListStatus(electiveListStatus);

			if (patientElectiveList.getElectiveListStatusHistory() == null)
				patientElectiveList.setElectiveListStatusHistory(new ElectiveListStatusVoCollection());

			patientElectiveList.getElectiveListStatusHistory().add(electiveListStatus);
		}
		//wdev-18320
		else if(ElectiveListDetails.REVIEW.equals(form.getLocalContext().getActionPressed()) 
				&& WaitingListStatus.CREATED.equals(patientElectiveList.getElectiveListStatus().getElectiveListStatus()))
		{
			ElectiveListStatusVo electiveListStatus = new ElectiveListStatusVo();

			if (patientElectiveList.getTCIDetails() == null)
				electiveListStatus.setElectiveListStatus(WaitingListStatus.REQUIRES_TCI);
			else
				electiveListStatus.setElectiveListStatus(WaitingListStatus.TCI_GIVEN);
			electiveListStatus.setAuthoringUser((MemberOfStaffLiteVo) domain.getMosUser());
			electiveListStatus.setStatusDateTime(new DateTime());

			patientElectiveList.setElectiveListStatus(electiveListStatus);

			if (patientElectiveList.getElectiveListStatusHistory() == null)
				patientElectiveList.setElectiveListStatusHistory(new ElectiveListStatusVoCollection());

			patientElectiveList.getElectiveListStatusHistory().add(electiveListStatus);
		}
		else if(ElectiveListDetails.CANCELTCI.equals(form.getLocalContext().getActionPressed()))
		{
			if (patientElectiveList.getTCIDetails() == null)
			{
				ElectiveListStatusVo status=populateElectiveListStatus(WaitingListStatus.REQUIRES_TCI);
				patientElectiveList.setElectiveListStatus(status);
				
				if(patientElectiveList.getElectiveListStatusHistory() == null)
					patientElectiveList.setElectiveListStatusHistory(new ElectiveListStatusVoCollection());
				
				patientElectiveList.getElectiveListStatusHistory().add(status);
				
			}
			else
			{
				ElectiveListStatusVo statusPrev=populateElectiveListStatus(WaitingListStatus.REQUIRES_TCI);
				ElectiveListStatusVo statusCurrent=populateElectiveListStatus(WaitingListStatus.TCI_GIVEN);
				
				patientElectiveList.setElectiveListStatus(statusCurrent);
				
				if(patientElectiveList.getElectiveListStatusHistory() == null)
					patientElectiveList.setElectiveListStatusHistory(new ElectiveListStatusVoCollection());
				
				patientElectiveList.getElectiveListStatusHistory().add(statusPrev);
				patientElectiveList.getElectiveListStatusHistory().add(statusCurrent);
			}
		}
		
		//wdev-18320
		if( ElectiveListDetails.REVIEW.equals(form.getLocalContext().getActionPressed()))
		{
			ReviewPatientElectiveListVo tempVo = new ReviewPatientElectiveListVo();
			tempVo.setReviewedDate(new DateTime());
			tempVo.setReviewedBy((MemberOfStaffLiteVo) domain.getMosUser());
			ReviewPatientElectiveListVoCollection tempColl = patientElectiveList.getReviews();
			if( tempColl == null )
				tempColl = new ReviewPatientElectiveListVoCollection();
			tempColl.add(tempVo);
			patientElectiveList.setReviews(tempColl);
			//form.getLocalContext().setReviewdByWasSaved(true);
			
		}
		
		patientElectiveList.setConsultant((HcpLiteVo) form.ccRespHCP().getValue());
		
		//WDEV-18603
		patientElectiveList.setDateOnList(form.dteDateOnList().getValue());
		
		patientElectiveList.setElectiveAdmissionType(form.getLocalContext().getAdmissionType());
		
		patientElectiveList.setInterpretatorRequired(form.chkInterpreterRequired().getValue());
		patientElectiveList.setLanguage(form.cmbInterpreterRequired().getValue());
		
		patientElectiveList.setTransportRequired(form.chkTransportRequired().getValue());
		patientElectiveList.setTransport(form.cmbTransportRequired().getValue());
		
		patientElectiveList.setSpecialRequirements(form.chkSpecialRequirements().getValue());
		patientElectiveList.setSpecialRequirementsDetails(form.txtSpecialRequrements().getValue());
		
		//WDEV-18344 to fix a NPE
		if(!ElectiveListReason.DIAGNOSTIC.equals(form.cmbElectiveListReason().getValue()))
			patientElectiveList.setPathwayClock(currentReferral.getJourneyIsNotNull() ? currentReferral.getJourney().getCurrentClock():null);
		
		patientElectiveList.setNotes(populateNotesFromScreen());//WDEV-18360 
		
		
		return patientElectiveList;
	}

	//WDEV-18388
	private ElectiveListStatusVo populateElectiveListStatus(WaitingListStatus requiresTci)
	{
		ElectiveListStatusVo status = new ElectiveListStatusVo();
		status.setElectiveListStatus(requiresTci);
		status.setAuthoringUser((MemberOfStaffLiteVo) domain.getMosUser());
		status.setStatusDateTime(new DateTime());
		
		return status;
	}

	//WDEV-18360
	private PatientElectiveListNotesVoCollection populateNotesFromScreen()
	{
		if (ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType()))
		{
			return form.grdNoteCommentsAdd().getValues();
		}
		else
		{
			return form.grdNoteComments().getValues();
		}
	}
	
	private boolean atLeastOneERODFieldCompleted()
	{
		if (form.dteEarliestDateOffered().getValue() != null || form.dteSecondDateOffered().getValue() != null 
			|| Boolean.TRUE.equals(form.chkReasonableOffer().getValue()) || form.dtePatientAvailableFromDate().getValue() != null)
			return true;
		
		return false;
	}

	private boolean atLeastOneTCIFieldCompleted()
	{
		if (form.dteTCIDate().getValue() != null || form.timTCITime().getValue() != null || form.qmbWard().getValue() != null || form.cmbBreachReason().getValue() != null || form.dteDateOffered().getValue() != null || form.cmbTCIOfferedMethod().getValue() != null) //WDEv-18388
			return true;
			
		return false;
	}

	private boolean validateUIRules()
	{
		ArrayList<String> errors = new ArrayList<String>();

		if (form.cmbElectiveList().getValue() == null)
		{
			errors.add("Elective List is mandatory.");
		}
		
		if (form.cmbElectiveListReason().getValue() == null)
		{
			errors.add("Elective List Reason is mandatory.");
		}
		
		if (form.cmbIntendedManagement().getValue() == null && form.cmbIntendedManagement().isEnabled() && form.cmbIntendedManagement().isRequired())
		{
			errors.add("Intended Management is mandatory.");
		}
		
		//WDEV-18388
		if (form.txtDescription().isEnabled() && form.txtDescription().getValue()==null) //WDEV-18489
		{
			errors.add("Details are mandatory.");
		}
		
		if (form.cmbInterpreterRequired().getValue() == null && form.cmbInterpreterRequired().isEnabled() && form.cmbInterpreterRequired().isRequired())
		{
			errors.add("Interpreter is mandatory.");
		}
		
		if (form.cmbTransportRequired().getValue() == null && form.cmbTransportRequired().isEnabled() && form.cmbTransportRequired().isRequired())
		{
			errors.add("Transport is mandatory.");
		}
		
		if (form.txtSpecialRequrements().getValue() == null && form.txtSpecialRequrements().isEnabled() && form.txtSpecialRequrements().isRequired())
		{
			errors.add("Special Requirements are mandatory.");
		}
		
		if (form.dteTCIDate().getValue() == null && form.dteTCIDate().isEnabled() && form.dteTCIDate().isRequired())
		{
			errors.add("TCI Date is mandatory.");
		}
		
		if (form.cmbBreachReason().getValue() == null && form.cmbBreachReason().isEnabled() && form.cmbBreachReason().isRequired())
		{
			errors.add("Breach Reason is mandatory.");
		}
		
		if (form.dteDateOffered().getValue() == null && form.dteDateOffered().isEnabled() && form.dteDateOffered().isRequired())
		{
			errors.add("Date Offered is mandatory.");
		}
		
		if (form.dteEarliestDateOffered().getValue() == null && form.dteEarliestDateOffered().isEnabled() && (form.dteSecondDateOffered().getValue() != null || Boolean.TRUE.equals(form.chkReasonableOffer().getValue()) || form.dtePatientAvailableFromDate().getValue() != null))
		{
			errors.add("Earliest Date Offered is mandatory.");
		}
		
		if (form.dteSecondDateOffered().getValue() == null && form.dteSecondDateOffered().isEnabled() && (form.dteEarliestDateOffered().getValue() != null || Boolean.TRUE.equals(form.chkReasonableOffer().getValue()) || form.dtePatientAvailableFromDate().getValue() != null))
		{
			errors.add("Second Date Offered is mandatory.");
		}
		
		if (form.dteEarliestDateOffered().getValue() != null && form.dteSecondDateOffered().getValue() != null && form.dteEarliestDateOffered().getValue().isGreaterOrEqualThan(form.dteSecondDateOffered().getValue()))
		{
			errors.add("'Second Date Offered' must be greater than 'Earliest Date Offered '");
		}
		
		if ((form.getLocalContext().getPatientElectiveList() == null || (form.getLocalContext().getPatientElectiveList() != null && form.getLocalContext().getPatientElectiveList().getEROD() == null)) && form.dteEarliestDateOffered().getValue() != null && new Date().isGreaterThan(form.dteEarliestDateOffered().getValue()))
		{
			errors.add("'Earliest Date Offered ' must be greater than or equal to Today");
		}
		
		int errorCount = errors.size();
		String[] result = new String[errorCount];

		for (int x = 0; x < errorCount; x++)
			result[x] = (String) errors.get(x);

		if (result != null && result.length > 0)
		{
			engine.showErrors(result);
			return false;
		}

		return true;
	}

	@Override
	protected void onBtnSuspendClick() throws ims.framework.exceptions.PresentationLogicException
	{
		//WDEV-18308
		engine.open(form.getForms().RefMan.SuspensionDetails, new Object[]{form.getLocalContext().getPatientElectiveList(),true});
	}

	@Override
	protected void onBtnViewERODHistoryClick() throws ims.framework.exceptions.PresentationLogicException
	{
		engine.open(form.getForms().RefMan.ERODHistoryDialog);
	}

	@Override
	protected void onBtnCancelTCIClick() throws ims.framework.exceptions.PresentationLogicException
	{
		cancelTCI();
	}

	private void cancelTCILinkedAppointments(Booking_AppointmentElectiveListVo appointmentsDetails)
	{
		Booking_AppointmentVo voApptFull = domain.getBookingAppointment(appointmentsDetails);
		
		if (voApptFull.getApptStatusIsNotNull()
				&& appointmentsDetails.getApptStatusIsNotNull()
				&&  !voApptFull.getApptStatus().equals(appointmentsDetails.getApptStatus()) )
			{
				engine.showMessage("The Status of the appointment has already been changed.");
				return;
			}
		
		if(form.getLocalContext().getapptStausIsNotNull())
		{
			// appt status and status history
			voApptFull.setApptStatus(Status_Reason.CANCELLED);
			
			Appointment_StatusVo voApptStatus = new Appointment_StatusVo();
			voApptFull.setCurrentStatusRecord(voApptStatus);

			voApptFull.setApptStatusHistory(getApptStatusHistory(voApptFull,Status_Reason.CANCELLED, voApptStatus));
			if(form.getLocalContext().getapptStausIsNotNull())
			{
				voApptFull.setApptStatusReas(form.getLocalContext().getapptStaus().getStatusReason());
			}
		}
		if (voApptFull.getSessionSlotIsNotNull())
			voApptFull.getSessionSlot().setStatus(Status_Reason.SLOTOPENED);
		
		String[] arrErrors = voApptFull.validate();
		if(arrErrors != null)
		{
			engine.showErrors(arrErrors);
			return;
		}

		try 
		{
			voApptFull = domain.cancelAppt(voApptFull, ActionRequestType.NOTIFY_APPT_CANCEL, "Cancel Appt requested By TCI cancellation");
		
			//domain.updateCatsReferralAdditionalInvStatus(form.getGlobalContext().RefMan.getCatsReferral());
			
			//domain.updateCatsReferralCancelStatus(form.getGlobalContext().RefMan.getCatsReferral());
		} 
		catch (StaleObjectException e) 
		{
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			return;
		}	
	}
	
	private Appointment_StatusVoCollection getApptStatusHistory(Booking_AppointmentVo voAppt, Status_Reason status, Appointment_StatusVo voApptStatus)
	{
		voApptStatus.setApptDate(voAppt.getAppointmentDate());
		if (voAppt.getSessionSlotIsNotNull())
		{
			voApptStatus.setApptTime(voAppt.getSessionSlot().getStartTm());
			voApptStatus.setStatusChangeDateTime(new DateTime());
			voApptStatus.setPriority(voAppt.getSessionSlot().getPriority());
		}
	
		else if(voAppt.getApptStartTimeIsNotNull())
		{
			voApptStatus.setApptTime(voAppt.getApptStartTime());
			voApptStatus.setStatusChangeDateTime(new DateTime());
		}
		
		// if reason is cancelled retrieve values set in cancel dialog
		if(status.equals(Status_Reason.CANCELLED))
		{
			if(form.getLocalContext().getapptStausIsNotNull())
			{
				voApptStatus.setStatus(form.getLocalContext().getapptStaus().getStatus());
				voApptStatus.setStatusReason(form.getLocalContext().getapptStaus().getStatusReason());
				voApptStatus.setCancellationReason(form.getLocalContext().getapptStaus().getCancellationReason());
				voApptStatus.setRebookSelected(form.getLocalContext().getapptStaus().getRebookSelected());
				voApptStatus.setComment(form.getLocalContext().getapptStaus().getComment());
			}
		}
		else
		{
			voApptStatus.setStatus(status);
			voApptStatus.setStatusReason(status);
		}

		Appointment_StatusVoCollection voCollApptStatusHistory = voAppt.getApptStatusHistory();
		if(voCollApptStatusHistory == null)
			voCollApptStatusHistory = new Appointment_StatusVoCollection();	
		
		voCollApptStatusHistory.add(voApptStatus);

		return voCollApptStatusHistory;
	}
	
	private void cancelTCI()
	{
		//WDEV-18541
		if (form.getLocalContext().getPatientElectiveList() != null && form.getLocalContext().getPatientElectiveList().getTCIDetails() != null)
		{
			TCIOutcomeForPatientElectiveListVo dummyTCIOutcome = new TCIOutcomeForPatientElectiveListVo();
			dummyTCIOutcome.setTciId(form.getLocalContext().getPatientElectiveList().getTCIDetails().getID_TCIForPatientElectiveList());
			
			form.getGlobalContext().RefMan.setTCIOutcomeForPatientElectiveList(dummyTCIOutcome);
		}
		
		engine.open(form.getForms().RefMan.CancelTCIForPatientElectiveListDialog);
	}

	@Override
	protected void onChkInterpreterRequiredValueChanged() throws ims.framework.exceptions.PresentationLogicException
	{
		if (!Boolean.TRUE.equals(form.chkInterpreterRequired().getValue()))
			form.cmbInterpreterRequired().setValue(null);

		updateControlsState();
	}

	@Override
	protected void onChkTransportRequiredValueChanged() throws ims.framework.exceptions.PresentationLogicException
	{
		if (!Boolean.TRUE.equals(form.chkTransportRequired().getValue()))
			form.cmbTransportRequired().setValue(null);

		updateControlsState();
	}

	@Override
	protected void onChkSpecialRequirementsValueChanged() throws ims.framework.exceptions.PresentationLogicException
	{
		if (!Boolean.TRUE.equals(form.chkSpecialRequirements().getValue()))
			form.txtSpecialRequrements().setValue(null);

		updateControlsState();
	}

	@Override
	protected void onChkExtendedSearchValueChanged() throws ims.framework.exceptions.PresentationLogicException
	{
		populateElectiveListCombo(false);
	}

	@Override
	protected void onBtnEditClick() throws ims.framework.exceptions.PresentationLogicException
	{
		form.setMode(FormMode.EDIT);
	}

	@Override
	protected void onFormModeChanged()
	{
		updateControlsState();
	}

	private void updateControlsState() //WDEV-18426
	{
		boolean addEditTciOrErod=ElectiveListDetails.NEWEDITTCI.equals(form.getLocalContext().getActionPressed()) || ElectiveListDetails.NEWEDITEROD.equals(form.getLocalContext().getActionPressed()); 
		form.ccRespHCP().setEnabled(FormMode.EDIT.equals(form.getMode()) && !ElectiveListDetails.REVIEW.equals(form.getLocalContext().getActionPressed()) && !addEditTciOrErod);  //wdev-18320 // 
		boolean admissionTypeBookedOrWaiting = ElectiveAdmissionType.BOOKED_TYPE12.equals(form.getLocalContext().getAdmissionType()) || ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType());
		
		//disable Elective List if PatientElectiveList has been recorded
		form.cmbElectiveList().setEnabled(FormMode.EDIT.equals(form.getMode()) && form.getLocalContext().getPatientElectiveList() == null && !ElectiveListDetails.REVIEW.equals(form.getLocalContext().getActionPressed()) && form.cmbElectiveListReason().getValue() != null && !addEditTciOrErod); //wdev-18320; WDEV-18412 
		form.chkExtendedSearch().setEnabled(FormMode.EDIT.equals(form.getMode()) && form.getLocalContext().getPatientElectiveList() == null && !ElectiveListReason.DIAGNOSTIC.equals(form.cmbElectiveListReason().getValue()) && form.cmbElectiveListReason().getValue() != null && !addEditTciOrErod);
		form.cmbIntendedManagement().setRequired(FormMode.EDIT.equals(form.getMode()) && (ElectiveAdmissionType.BOOKED_TYPE12.equals(form.getLocalContext().getAdmissionType()) || ElectiveListDetails.REVIEW.equals(form.getLocalContext().getActionPressed()))); //wdev-18320; WDEV-18412 
		form.cmbElectiveListReason().setEnabled(FormMode.EDIT.equals(form.getMode()) && form.getLocalContext().getPatientElectiveList() == null && !ElectiveListDetails.REVIEW.equals(form.getLocalContext().getActionPressed()) && !addEditTciOrErod); //WDEV-18412 
		
		form.chkAvailableAtShortNoticed().setVisible(admissionTypeBookedOrWaiting);
		form.chkAvailableAtShortNoticed().setEnabled(FormMode.EDIT.equals(form.getMode()) && !addEditTciOrErod);
		
		form.lblNoOfDayNotice().setVisible(admissionTypeBookedOrWaiting);
		form.intNoOfDaysNotice().setVisible(admissionTypeBookedOrWaiting);
		form.intNoOfDaysNotice().setEnabled(FormMode.EDIT.equals(form.getMode()) && Boolean.TRUE.equals(form.chkAvailableAtShortNoticed().getValue()) && !addEditTciOrErod);

		form.lblPreAdmissionRequired().setVisible(admissionTypeBookedOrWaiting);
		form.chkPreAdmissionRequired().setVisible(admissionTypeBookedOrWaiting);
		form.chkPreAdmissionRequired().setEnabled(FormMode.EDIT.equals(form.getMode()) && !Boolean.TRUE.equals(domain.isFitForSurgery(form.getLocalContext().getReferral().getCareContext())) && !addEditTciOrErod); //wdev-18341

		form.cmbInterpreterRequired().setEnabled(FormMode.EDIT.equals(form.getMode()) && Boolean.TRUE.equals(form.chkInterpreterRequired().getValue()) && !addEditTciOrErod);
		form.cmbInterpreterRequired().setRequired(FormMode.EDIT.equals(form.getMode()) && Boolean.TRUE.equals(form.chkInterpreterRequired().getValue()));

		form.cmbTransportRequired().setEnabled(FormMode.EDIT.equals(form.getMode()) && Boolean.TRUE.equals(form.chkTransportRequired().getValue()) && !addEditTciOrErod);
		form.cmbTransportRequired().setRequired(FormMode.EDIT.equals(form.getMode()) && Boolean.TRUE.equals(form.chkTransportRequired().getValue()));

		form.txtSpecialRequrements().setEnabled(FormMode.EDIT.equals(form.getMode()) && Boolean.TRUE.equals(form.chkSpecialRequirements().getValue()) && !addEditTciOrErod);
		form.txtSpecialRequrements().setRequired(FormMode.EDIT.equals(form.getMode()) && Boolean.TRUE.equals(form.chkSpecialRequirements().getValue()));
		
		//If TCI Details have been recorded disable TCI Date
		boolean disableTciDate = form.getLocalContext().getPatientElectiveList() !=  null && form.getLocalContext().getPatientElectiveList().getTCIDetails() != null ;
		
		//If EROD Details have been recorded disable Earliest Date Offered
		boolean disableEarliestOfferedDate = form.getLocalContext().getPatientElectiveList() !=  null && form.getLocalContext().getPatientElectiveList().getEROD() != null ;
		
	
		//---
		boolean enableTCIDetails = FormMode.EDIT.equals(form.getMode()) && ((!ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType()) && form.getLocalContext().getPatientElectiveList() == null) || ( form.getLocalContext().getPatientElectiveList() !=  null )) && !ElectiveListDetails.NEWEDITEROD.equals(form.getLocalContext().getActionPressed()) ;  //wdev-18085
		boolean statusRequiresTCI = form.getLocalContext().getPatientElectiveList() != null && form.getLocalContext().getPatientElectiveList().getElectiveListStatus() != null && WaitingListStatus.REQUIRES_TCI.equals(form.getLocalContext().getPatientElectiveList().getElectiveListStatus().getElectiveListStatus());
		
		form.dteTCIDate().setRequired(FormMode.EDIT.equals(form.getMode()) && 
				(!ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType()) && !statusRequiresTCI
						|| ElectiveListDetails.NEWEDITTCI.equals(form.getLocalContext().getActionPressed()) ) );//WDEV-18388
		form.dteTCIDate().setEnabled(!ElectiveListDetails.NEWEDITEROD.equals(form.getLocalContext().getActionPressed()) 
				&& FormMode.EDIT.equals(form.getMode()) 
				&& ((!ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType()) && !disableTciDate) 
						|| ( form.getLocalContext().getPatientElectiveList() !=  null 
								&& form.getLocalContext().getPatientElectiveList().getTCIDetails() == null) 
								|| (ElectiveListDetails.CANCELTCI.equals(form.getLocalContext().getActionPressed())))); //WDEV-18388
		form.timTCITime().setEnabled(enableTCIDetails);
		form.qmbWard().setEnabled(enableTCIDetails && form.qmbHospital().getValue() != null);//WDEV-18388
		form.qmbHospital().setEnabled(enableTCIDetails);//WDEV-18388
				
		boolean isBreachReasonMandatory =  form.dteTCIDate().getValue() != null && form.getLocalContext().getReferral().getReferralDetails() != null && form.getLocalContext().getReferral().getReferralDetails().getEnd18WW() != null && form.dteTCIDate().getValue().isGreaterThan(form.getLocalContext().getReferral().getReferralDetails().getEnd18WW());
		boolean enableBreachReason = isBreachReasonMandatory && FormMode.EDIT.equals(form.getMode()) && ((ElectiveAdmissionType.BOOKED_TYPE12.equals(form.getLocalContext().getAdmissionType()) && form.getLocalContext().getPatientElectiveList() == null) || ( form.getLocalContext().getPatientElectiveList() !=  null ));	//wdev-18085
		
		form.cmbBreachReason().setEnabled(enableBreachReason);
		form.cmbBreachReason().setRequired(enableBreachReason);
		
		form.dteDateOffered().setRequired(FormMode.EDIT.equals(form.getMode()) && 
				(form.dteTCIDate().getValue() != null || (!ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType()) && !statusRequiresTCI) || ElectiveListDetails.NEWEDITTCI.equals(form.getLocalContext().getActionPressed())));//WDEV_18388
		form.dteDateOffered().setEnabled(!ElectiveListDetails.NEWEDITEROD.equals(form.getLocalContext().getActionPressed()) && FormMode.EDIT.equals(form.getMode()) && ((!ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType()) && form.getLocalContext().getPatientElectiveList() == null) || (form.getLocalContext().getPatientElectiveList() !=  null ))); //wdev-18085
		form.cmbTCIOfferedMethod().setEnabled(enableTCIDetails);
		
		boolean enableERODDetails = FormMode.EDIT.equals(form.getMode()) && ((ElectiveAdmissionType.BOOKED_TYPE12.equals(form.getLocalContext().getAdmissionType()) && form.getLocalContext().getPatientElectiveList() == null) || ( form.getLocalContext().getPatientElectiveList() !=  null )) /*&& !ElectiveListDetails.NEWEDITTCI.equals(form.getLocalContext().getActionPressed())*/;		//wdev-18085 
		boolean addErod = ElectiveListDetails.NEWEDITEROD.equals(form.getLocalContext().getActionPressed()); //WDEV-18513 
		
		form.dteEarliestDateOffered().setRequired(FormMode.EDIT.equals(form.getMode()) && form.getLocalContext().getPatientElectiveList() != null && (form.getLocalContext().getPatientElectiveList().getEROD() != null || addErod)); //WDEV-18513 
		form.dteEarliestDateOffered().setEnabled(/*!ElectiveListDetails.NEWEDITTCI.equals(form.getLocalContext().getActionPressed()) && */FormMode.EDIT.equals(form.getMode()) && ((ElectiveAdmissionType.BOOKED_TYPE12.equals(form.getLocalContext().getAdmissionType()) && !disableEarliestOfferedDate) || (form.getLocalContext().getPatientElectiveList() !=  null && form.getLocalContext().getPatientElectiveList().getEROD() == null)));	//wdev-18085
		
		//---
		
		form.dteSecondDateOffered().setRequired(FormMode.EDIT.equals(form.getMode()) && form.getLocalContext().getPatientElectiveList() != null && (form.getLocalContext().getPatientElectiveList().getEROD() != null || form.dteDateOffered().getValue()!=null));
		form.dteSecondDateOffered().setEnabled(enableERODDetails);
		
		form.chkReasonableOffer().setEnabled(enableERODDetails);
		form.dtePatientAvailableFromDate().setEnabled(enableERODDetails);
		//WDEV-18464
		boolean hasCurrentTCIOutcome = form.getLocalContext().getPatientElectiveListIsNotNull() && form.getLocalContext().getPatientElectiveList().getTCIDetailsIsNotNull() && form.getLocalContext().getPatientElectiveList().getTCIDetails().getCurrentOutcomeIsNotNull() && form.getLocalContext().getPatientElectiveList().getTCIDetails().getCurrentOutcome().getOutcome() != null;
		form.btnCancelTCI().setVisible(!hasCurrentTCIOutcome);//WDEV-18388; WDEV-18464
		form.btnCancelTCI().setEnabled(!hasCurrentTCIOutcome && (!ElectiveListDetails.NEWEDITEROD.equals(form.getLocalContext().getActionPressed()) && form.getLocalContext().getPatientElectiveList() !=  null && form.getLocalContext().getPatientElectiveList().getTCIDetails() != null  && form.getLocalContext().getPatientElectiveList().getTCIDetails().getID_TCIForPatientElectiveListIsNotNull() && Boolean.TRUE.equals(form.getLocalContext().getPatientElectiveList().getTCIDetails().getIsActive()) && (FormMode.VIEW.equals(form.getMode())  || (FormMode.EDIT.equals(form.getMode()) && !ElectiveListDetails.CANCELTCI.equals(form.getLocalContext().getActionPressed())))));//WDEV-18388 //WDEV-18464 //WDEV-18527 
		
		form.btnViewERODHistory().setVisible(true);//WDEV-18388
		form.btnViewERODHistory().setEnabled(true);//WDEV-18388
		
		//WDEV-18308; WDEV-18344 //WDEV-18519 
		boolean isElectiveListRemoved = form.getLocalContext().getPatientElectiveList() != null && form.getLocalContext().getPatientElectiveList().getElectiveListStatusIsNotNull() && WaitingListStatus.REMOVED.equals(form.getLocalContext().getPatientElectiveList().getElectiveListStatus().getElectiveListStatus());
		form.btnSuspend().setVisible(form.getLocalContext().getPatientElectiveList() != null);
		form.btnSuspend().setEnabled(!isElectiveListRemoved);
				
		//WDEV-18344
		boolean isWaitingList = ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType()) && !ElectiveListDetails.REVIEW.equals(form.getLocalContext().getActionPressed())&& !ElectiveListDetails.NEWEDITTCI.equals(form.getLocalContext().getActionPressed()) && !ElectiveListDetails.NEWEDITEROD.equals(form.getLocalContext().getActionPressed()) && (form.getLocalContext().getPatientElectiveList()==null || (form.getLocalContext().getPatientElectiveList()!=null && form.getLocalContext().getPatientElectiveList().getTCIDetails()==null && form.getLocalContext().getPatientElectiveList().getEROD()==null ));//WDEV-18388
		hideTCIDetails(isWaitingList);
		hideERODDetails(isWaitingList);
		showNotesGridValidForContext(isWaitingList);
		
		//WDEV-18360
		form.getContextMenus().RefMan.hideAllNewElectiveListNotesMenu1MenuItems();
		form.getContextMenus().RefMan.hideAllNewElectiveListNotesMenu2MenuItems();
		
		boolean firstGridNotesRowSelected = form.grdNoteCommentsAdd().getValue()!=null;
		form.getContextMenus().RefMan.getNewElectiveListNotesMenu1ADDItem().setVisible(FormMode.EDIT.equals(form.getMode()) && isWaitingList);
		form.getContextMenus().RefMan.getNewElectiveListNotesMenu1VIEWItem().setVisible(firstGridNotesRowSelected && isWaitingList);
		form.getContextMenus().RefMan.getNewElectiveListNotesMenu1RIEItem().setVisible(FormMode.VIEW.equals(form.getMode()) && firstGridNotesRowSelected&& isWaitingList && engine.hasRight(ims.configuration.AppRight.ALLOW_DELETION_OF_ELECTIVE_LIST_NOTES));
		
		boolean secondGridNotesRowSelected = form.grdNoteComments().getValue()!=null;
		form.getContextMenus().RefMan.getNewElectiveListNotesMenu2ADDItem().setVisible(FormMode.EDIT.equals(form.getMode()) && !isWaitingList && !addEditTciOrErod);
		form.getContextMenus().RefMan.getNewElectiveListNotesMenu2VIEWItem().setVisible(secondGridNotesRowSelected && !isWaitingList && !addEditTciOrErod);
		form.getContextMenus().RefMan.getNewElectiveListNotesMenu2RIEItem().setVisible(FormMode.VIEW.equals(form.getMode()) && secondGridNotesRowSelected && !isWaitingList && engine.hasRight(ims.configuration.AppRight.ALLOW_DELETION_OF_ELECTIVE_LIST_NOTES) && !addEditTciOrErod); 
		
		//WDEV=18388
		form.btnAddTCI().setVisible(FormMode.VIEW.equals(form.getMode()) 
				&& form.getLocalContext().getPatientElectiveList() != null
					&& form.getLocalContext().getPatientElectiveList().getElectiveListStatus() != null 
						&& (WaitingListStatus.CREATED.equals(form.getLocalContext().getPatientElectiveList().getElectiveListStatus().getElectiveListStatus()) || WaitingListStatus.REQUIRES_TCI.equals(form.getLocalContext().getPatientElectiveList().getElectiveListStatus().getElectiveListStatus())) 
							&& form.getLocalContext().getPatientElectiveList().getTCIDetails() == null); //WDEV-19107
		form.btnAddEROD().setVisible(FormMode.VIEW.equals(form.getMode())
				&& form.getLocalContext().getPatientElectiveList() != null
					&& form.getLocalContext().getPatientElectiveList().getElectiveListStatus() != null
						&& WaitingListStatus.REQUIRES_TCI.equals(form.getLocalContext().getPatientElectiveList().getElectiveListStatus().getElectiveListStatus()) 
							&& form.getLocalContext().getPatientElectiveList().getEROD()== null
								&& form.getLocalContext().getPatientElectiveList().getTCIDetails() == null); //WDEV-19107
		form.grdDateEvent().setVisible(false);
		form.imbElectiveListHistory().setEnabled(false);
		form.imbTCIHistory().setEnabled(false);
		form.txtDescription().setRequired(true);
		
		form.imbElectiveListHistory().setVisible(form.getLocalContext().getPatientElectiveList()!=null && form.getLocalContext().getPatientElectiveList().getReviews()!=null &&  form.getLocalContext().getPatientElectiveList().getReviews().size()>0 );
		form.lblLastReviewBy().setVisible(form.getLocalContext().getPatientElectiveList()!=null && form.getLocalContext().getPatientElectiveList().getReviews()!=null &&  form.getLocalContext().getPatientElectiveList().getReviews().size()>0);
		form.lblLastReviewByValue().setVisible(form.getLocalContext().getPatientElectiveList()!=null && form.getLocalContext().getPatientElectiveList().getReviews()!=null &&  form.getLocalContext().getPatientElectiveList().getReviews().size()>0);
		form.lblLastReviewDate().setVisible(form.getLocalContext().getPatientElectiveList()!=null && form.getLocalContext().getPatientElectiveList().getReviews()!=null &&  form.getLocalContext().getPatientElectiveList().getReviews().size()>0);
		form.lblLastReviewDateValue().setVisible(form.getLocalContext().getPatientElectiveList()!=null && form.getLocalContext().getPatientElectiveList().getReviews()!=null &&  form.getLocalContext().getPatientElectiveList().getReviews().size()>0);
		form.imbTCIHistory().setVisible(!isWaitingList && form.getLocalContext().getPatientElectiveList()!=null && form.getLocalContext().getPatientElectiveList().getTCIHistoryIsNotNull() && form.getLocalContext().getPatientElectiveList().getTCIHistory().size()>0);
		
		//WDEV-18426
		form.qmbIntendedProcedure().setEnabled(FormMode.EDIT.equals(form.getMode())&& !addEditTciOrErod);
		form.txtDescription().setEnabled(FormMode.EDIT.equals(form.getMode())&& !addEditTciOrErod);
		form.cmbPriority().setEnabled(FormMode.EDIT.equals(form.getMode())&& !addEditTciOrErod);
		form.chkInterpreterRequired().setEnabled(FormMode.EDIT.equals(form.getMode())&& !addEditTciOrErod);
		form.cmbIntendedManagement().setEnabled(FormMode.EDIT.equals(form.getMode())&& !addEditTciOrErod);
		form.intAnticipatedStay().setEnabled(FormMode.EDIT.equals(form.getMode())&& !addEditTciOrErod);
		form.chkSpecialRequirements().setEnabled(FormMode.EDIT.equals(form.getMode())&& !addEditTciOrErod);
		form.chkTransportRequired().setEnabled(FormMode.EDIT.equals(form.getMode())&& !addEditTciOrErod);
	}

	private void hideTCIDetails(boolean isWaitingListEntry)
	{
		form.pnlTCIDetails().setVisible(!isWaitingListEntry);
		form.dteTCIDate().setVisible(!isWaitingListEntry);
		form.lblTCIDate().setVisible(!isWaitingListEntry);
		form.lblTCITime().setVisible(!isWaitingListEntry);
		form.timTCITime().setVisible(!isWaitingListEntry);
		form.lblWard().setVisible(!isWaitingListEntry);
		form.qmbWard().setVisible(!isWaitingListEntry);//WDEV-18388
		form.qmbHospital().setVisible(!isWaitingListEntry);//WDEV-18388
		form.lblBreachReason().setVisible(!isWaitingListEntry);
		form.cmbBreachReason().setVisible(!isWaitingListEntry);
		form.lblDateOffered().setVisible(!isWaitingListEntry);
		form.dteDateOffered().setVisible(!isWaitingListEntry);
		form.lblTCIOfferedMethod().setVisible(!isWaitingListEntry);
		form.cmbTCIOfferedMethod().setVisible(!isWaitingListEntry);
		form.grdDateEvent().setVisible(!isWaitingListEntry);
		form.btnCancelTCI().setVisible(!isWaitingListEntry);//WDEV-18388
		form.imbTCIHistory().setVisible(!isWaitingListEntry);//WDEV-18388
		form.lblTCIOutcome().setVisible(!isWaitingListEntry); //WDEV-18464
		form.lblTCIOutcomeValue().setVisible(!isWaitingListEntry); //WDEV-18464
	}
	
	private void hideERODDetails(boolean isWaitingListEntry)
	{
		form.pnlERODDetails().setVisible(!isWaitingListEntry);
		form.lblEarliestDateOffered().setVisible(!isWaitingListEntry);
		form.dteEarliestDateOffered().setVisible(!isWaitingListEntry);
		form.lblSecondDateOffered().setVisible(!isWaitingListEntry);
		form.dteSecondDateOffered().setVisible(!isWaitingListEntry);
		form.lblPatientAvailableFromDate().setVisible(!isWaitingListEntry);
		form.dtePatientAvailableFromDate().setVisible(!isWaitingListEntry);
		form.chkReasonableOffer().setVisible(!isWaitingListEntry);
		form.btnViewERODHistory().setVisible(!isWaitingListEntry);//WDEV-18388
	}
	
	private void showNotesGridValidForContext(boolean isWaitingListEntry)
	{
		form.grdNoteComments().setVisible(!isWaitingListEntry);
		form.grdNoteCommentsAdd().setVisible(isWaitingListEntry);
	}
	
	@Override
	protected void onBtnCloseClick() throws PresentationLogicException
	{
				
		engine.close(DialogResult.ABORT);//WDEV-18439
	}

	@Override
	protected void onChkAvailableAtShortNoticedValueChanged() throws PresentationLogicException
	{
		if (!Boolean.TRUE.equals(form.chkAvailableAtShortNoticed().getValue()))
			form.intNoOfDaysNotice().setValue(null);

		updateControlsState();

	}

	@Override
	protected void onQmbIntendedProcedureValueChanged() throws PresentationLogicException
	{
		resetProcedureDescription();
		
		form.intAnticipatedStay().setValue(form.qmbIntendedProcedure().getValue() != null ? form.qmbIntendedProcedure().getValue().getLOS() : null);
		defaultIntendedManagement();
		
		updateControlsState();
	}

	private void resetProcedureDescription()
	{
		if (form.qmbIntendedProcedure().getValue() != null)
		{
			form.txtDescription().setValue(form.qmbIntendedProcedure().getValue().getProcedureName());
		}
		else
			form.txtDescription().setValue(null);
		
	}

	@Override
	protected void onQmbIntendedProcedureTextSubmited(String value) throws PresentationLogicException
	{
		form.qmbIntendedProcedure().clear();
		form.txtDescription().setValue(null);
		
		ProcedureLiteVoCollection procedureCollection = new ProcedureLiteVoCollection();
		
		try
		{
			procedureCollection = domain.listProcedures(value);
		}
		catch (DomainInterfaceException e) 
		{
			engine.showMessage(e.getMessage());
			return;
		}	
		
		for (int i=0; i < procedureCollection.size(); i++)
		{
			addRow(procedureCollection.get(i));
		}
		
		if (procedureCollection.size() == 1)
		{
			form.qmbIntendedProcedure().setValue(procedureCollection.get(0));
			resetProcedureDescription();
			updateControlsState();
		}
		else if (procedureCollection.size() > 1)
			form.qmbIntendedProcedure().showOpened();
		
		
	}

	private void addRow(ProcedureLiteVo procedureLiteVo)
	{
		form.qmbIntendedProcedure().newRow(procedureLiteVo, procedureLiteVo.getProcedureName());
	}

	@Override
	protected void onIntAnticipatedStayValueChanged() throws PresentationLogicException
	{
		defaultIntendedManagement();
	}

	@Override
	protected void onCcRespHCPValueChanged() throws PresentationLogicException
	{
		if (form.getLocalContext().getPatientElectiveList() == null && form.cmbElectiveListReason().getValue() != null && !ElectiveListReason.DIAGNOSTIC.equals(form.cmbElectiveListReason().getValue()))
		{
			populateElectiveListCombo(false);
		}
	}

	@Override
	protected void onMessageBoxClosed(int messageBoxId, DialogResult result) throws PresentationLogicException
	{
		if(form.getLocalContext().getSuspensionMessageBoxId() != null && form.getLocalContext().getSuspensionMessageBoxId() == messageBoxId)
		{
			if(DialogResult.YES.equals(result))
			{
				engine.open(form.getForms().RefMan.SuspensionDetails);
			}
			
			form.getLocalContext().setSuspensionMessageBoxId(null);
			
			return;
		}
		
		if (DialogResult.YES.equals(result))
		{
			save(false, true);
			open();
			form.setMode(FormMode.VIEW);
			form.getLocalContext().setActionPressed(ElectiveListDetails.VIEWEDIT);
		}
		else
			form.chkReasonableOffer().setValue(false);
		
	}

	@Override
	protected void onDteTCIDateValueChanged() throws PresentationLogicException
	{
		form.cmbBreachReason().setValue(null);
		updateControlsState();
	}

	@Override
	protected void onFormDialogClosed(FormName formName, DialogResult result) throws PresentationLogicException
	{
		if (formName.equals(form.getForms().RefMan.CancelTCIForPatientElectiveListDialog) && DialogResult.OK.equals(result) && FormMode.VIEW.equals(form.getMode()))//WDEV-18388
		{
			PatientElectiveListDetailsToSaveVo patientElectiveList = form.getLocalContext().getPatientElectiveList();	
			
			//WDEV-18449 -- start
			Booking_AppointmentElectiveListVo appointmentsDetails = null;
			if (form.getLocalContext().getPatientElectiveListIsNotNull() && form.getLocalContext().getPatientElectiveList().getTCIDetailsIsNotNull() && form.getLocalContext().getPatientElectiveList().getTCIDetails().getAppointmentIsNotNull())
			{
				appointmentsDetails = form.getLocalContext().getPatientElectiveList().getTCIDetails().getAppointment();
				form.getLocalContext().setapptStaus(setAppointmentStatus(form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList()));
			}
			//WDEV-18449 -- end
			
			ElectiveListStatusVo status = new ElectiveListStatusVo();
			status.setElectiveListStatus(WaitingListStatus.REQUIRES_TCI);
			status.setAuthoringUser((MemberOfStaffLiteVo) domain.getMosUser());
			status.setStatusDateTime(new DateTime());
						
			//wdev-18384
			if( !patientElectiveList.getElectiveListStatusIsNotNull() || !patientElectiveList.getElectiveListStatus().getElectiveListStatusIsNotNull() || !patientElectiveList.getElectiveListStatus().getElectiveListStatus().equals(WaitingListStatus.REMOVED))
			{
				patientElectiveList.setElectiveListStatus(status);
				//wdev-18419
				if( form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveListIsNotNull() && Boolean.TRUE.equals(form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList().getCancelledForNonMedicalReason()) && form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList().getStatusDateTimeIsNotNull() && form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList().getStatusDateTime().getDate().equals(new Date()))
				{
										
					Date dtnow = new Date();
					dtnow.addDay(28);
					patientElectiveList.setRequiresTCIBy(dtnow);
					patientElectiveList.setTCICancelledByProvider(true);
					if( form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList().getOutcomeIsNotNull())
					{
						form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList().setOutcome(AdmissionOfferOutcome.ADMISSION_CANCELLED_BY_HOSPITAL_ON_DAY_7);
						
					}
				}
				//---------
			
				if(patientElectiveList.getElectiveListStatusHistory() == null)
					patientElectiveList.setElectiveListStatusHistory(new ElectiveListStatusVoCollection());
			
				patientElectiveList.getElectiveListStatusHistory().add(status);
			}
			PatientElectiveListTCIVo tciDetails = (PatientElectiveListTCIVo) patientElectiveList.getTCIDetails().clone();
			 
			patientElectiveList.setTCIDetails(null);
			tciDetails.setCurrentOutcome(form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList());
			
			if(tciDetails.getOutcomeHistory() == null)
				tciDetails.setOutcomeHistory(new TCIOutcomeForPatientElectiveListVoCollection());
			
			tciDetails.getOutcomeHistory().add(form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList());
			
			if(patientElectiveList.getTCIHistory() == null)
				patientElectiveList.setTCIHistory(new PatientElectiveListTCIVoCollection());
			
			patientElectiveList.getTCIHistory().add(tciDetails);
			
			save(false, false);
			open();
			form.setMode(FormMode.VIEW);
			form.getLocalContext().setActionPressed(ElectiveListDetails.VIEWEDIT);
			
			// WDEV-18449 -- start
			if(form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList() != null && Boolean.TRUE.equals(form.getGlobalContext().RefMan.getTCIOutcomeForPatientElectiveList().getCancelTheatreAppointment()) &&
				form.getLocalContext().getPatientElectiveList() != null && form.getLocalContext().getPatientElectiveList().getTCIDetails() == null && appointmentsDetails != null && appointmentsDetails.getTheatreBooking() != null)
			{
				cancelTCILinkedAppointments(appointmentsDetails);
			}
			// WDEV-18449 -- end
		}
		else if (formName.equals(form.getForms().RefMan.CancelTCIForPatientElectiveListDialog) && DialogResult.OK.equals(result) && FormMode.EDIT.equals(form.getMode()))//WDEV-18388
		{
			clearTCIDetails();
			form.getLocalContext().setActionPressed(ElectiveListDetails.CANCELTCI);
			form.getLocalContext().getActionPressed();
			updateControlsState();	
		}
		else if(formName.equals(form.getForms().RefMan.SuspensionDetails))
		{
			open();
			form.setMode(FormMode.VIEW);
		}
		else if( formName.equals(form.getForms().RefMan.RemoveFromElectiveList))     //wdev-18384
		{
			open();
			form.setMode(FormMode.VIEW);
			form.getLocalContext().setActionPressed(ElectiveListDetails.VIEWEDIT);
		}
		else if(DialogResult.OK.equals(result) && formName.equals(form.getForms().RefMan.PatientElectiveListNotes)) //WDEV-18360
		{
			if (ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType()))
			{
				addRowToGrdNoteCommentsAdd(form.getGlobalContext().RefMan.getPatientElectiveListNotes());
			}
			else
			{
				addRowToGrdNoteComments(form.getGlobalContext().RefMan.getPatientElectiveListNotes());
			}
			
		}
		else if (formName.equals(form.getForms().Core.RieConfirmationDialog) && DialogResult.OK.equals(result))
		{
			doRIE();
			open();
			updateControlsState();
		}
		
		
	}

	//WDEV-18449 
	private Appointment_StatusVo setAppointmentStatus(TCIOutcomeForPatientElectiveListVo tciOutcomeForPatientElectiveList)
	{
		if (tciOutcomeForPatientElectiveList != null)
		{
			Appointment_StatusVo voApptStatus = new Appointment_StatusVo();
			voApptStatus.setStatus(Status_Reason.CANCELLED);
			voApptStatus.setStatusReason(AdmissionOfferOutcome.ADMISSION_CANCELLED_BY_PATIENT_2.equals(tciOutcomeForPatientElectiveList.getOutcome()) ? Status_Reason.PATIENTCANCELLED : Status_Reason.HOSPITALCANCELLED);
			voApptStatus.setRebookSelected(false);	
			return voApptStatus;
		}
		return null;
	}
	
	//WDEV-18360	
	private void doRIE()
	{
		boolean isStale = false;
		
		if(domain.isStaleNote(form.getLocalContext().getRIENoteRecord()))
		{
			isStale = true;
		}
		
		if(isStale)
		{
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			return;
		}
		
		try
		{
			domain.markAsRie(form.getLocalContext().getRIENoteRecord(), form.getForms().RefMan.NewElectiveListTCIErodDialog, form.getGlobalContext().Core.getPatientShort() != null ? form.getGlobalContext().Core.getPatientShort().getID_Patient() : null, null,
							form.getGlobalContext().Core.getCurrentCareContextIsNotNull()?form.getGlobalContext().Core.getCurrentCareContext().getID_CareContext():null,
							form.getGlobalContext().Core.getRieMessage());
		}
		catch (StaleObjectException e)
		{
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			return;
		}
	}
	
	//WDEV-18360	
	private void addRowToGrdNoteComments(PatientElectiveListNotesVo note)
	{
		if (note==null)
			return;
		
		grdNoteCommentsRow row = form.grdNoteComments().getRows().newRow();

		row.setcolNoteComment(note.getNotes());
		row.setcolRecordingDateTime(note.getAuthoringDateTime().toString());
		row.setcolRecordingUser(note.getAuthoringUser().toString());

		row.setValue(note);
		form.grdNoteComments().setValue(note);
	}
	
	//WDEV-18360
	private void addRowToGrdNoteCommentsAdd(PatientElectiveListNotesVo note)
	{
		if (note==null)
			return;
		
		grdNoteCommentsAddRow row = form.grdNoteCommentsAdd().getRows().newRow();

		row.setcolNoteComment(note.getNotes());
		row.setcolRecordingDateTime(note.getAuthoringDateTime().toString());
		row.setcolRecordingUser(note.getAuthoringUser().toString());

		row.setValue(note);
		form.grdNoteCommentsAdd().setValue(note);
	}

	//WDEV-18360
	@Override
	protected void onContextMenuItemClick(int menuItemID, Control sender) throws PresentationLogicException
	{
		switch (menuItemID)
		{
			case GenForm.ContextMenus.RefManNamespace.NewElectiveListNotesMenu1.ADD:
				addNote();		
				break;
			
			case GenForm.ContextMenus.RefManNamespace.NewElectiveListNotesMenu1.VIEW:
				viewNote();	
			break;	
			
			case GenForm.ContextMenus.RefManNamespace.NewElectiveListNotesMenu1.RIE:
				markRecordAsRie();
			break;
			
			case GenForm.ContextMenus.RefManNamespace.NewElectiveListNotesMenu2.ADD:
				addNote();	
				break;
			
			case GenForm.ContextMenus.RefManNamespace.NewElectiveListNotesMenu2.VIEW:
				viewNote();		
			break;
			
			case GenForm.ContextMenus.RefManNamespace.NewElectiveListNotesMenu2.RIE:
				markRecordAsRie();	
			break;
		}
		
		updateControlsState();
	}
	
	//WDEV-18360
	private void markRecordAsRie()
	{
		form.getLocalContext().setRIENoteRecord(ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType()) ? form.grdNoteCommentsAdd().getValue() : form.grdNoteComments().getValue());
		if(form.getLocalContext().getRIENoteRecord() != null)
		{
			engine.open(form.getForms().Core.RieConfirmationDialog);
		}
	}
	
	//WDEV-18360
	private void viewNote()
	{
		form.getGlobalContext().RefMan.setPatientElectiveListNotes(ElectiveAdmissionType.ELECTIVE_TYPE11.equals(form.getLocalContext().getAdmissionType()) ? form.grdNoteCommentsAdd().getValue() : form.grdNoteComments().getValue());
		engine.open(form.getForms().RefMan.PatientElectiveListNotes,new Object[]{FormMode.VIEW});
	}

	//WDEV-18360
	private void addNote()
	{
		form.getGlobalContext().RefMan.setPatientElectiveListNotes(null);
		form.grdNoteComments().setValue(null);
		form.grdNoteCommentsAdd().setValue(null);
		engine.open(form.getForms().RefMan.PatientElectiveListNotes, new Object[]{FormMode.EDIT});
	}

	//WDEV-18360
	@Override
	protected void onGrdNoteCommentsSelectionChanged() throws PresentationLogicException
	{
		updateControlsState();
	}

	//WDEV-18360
	@Override
	protected void onGrdNoteCommentsAddSelectionChanged() throws PresentationLogicException
	{
		updateControlsState();
	}

	//WDEV-18388
	@Override
	protected void onCmbIntendedManagementValueChanged() throws PresentationLogicException
	{
		if (ManagementIntention.TYPE1_STAYATLEASTONENIGHT.equals(form.cmbIntendedManagement().getValue()))
		{
			form.intAnticipatedStay().setValue(1);
		}
	}

	//WDEV-18388
	@Override
	protected void onBtnAddTCIClick() throws PresentationLogicException
	{
		form.getLocalContext().setActionPressed(ElectiveListDetails.NEWEDITTCI);
		if (form.getMode().equals(FormMode.VIEW))
		{
			form.setMode(FormMode.EDIT);
			return;
		}
		updateControlsState();
	}

	//WDEV-18388
	@Override
	protected void onBtnAddERODClick() throws PresentationLogicException
	{
		form.getLocalContext().setActionPressed(ElectiveListDetails.NEWEDITEROD);
		if (form.getMode().equals(FormMode.VIEW))
		{
			form.setMode(FormMode.EDIT);
			return;
		}
		updateControlsState();
	}

	//WDEV-18388
	@Override
	protected void onQmbWardTextSubmited(String value) throws PresentationLogicException
	{
		if (form.qmbHospital().getValue()==null)
			return;
		
		LocationLiteVoCollection wards = domain.listWards(value,form.qmbHospital().getValue());
		
		if (wards == null || wards.size()==0)
			return;
		
		for (int i = 0; i < wards.size(); i++)
		{
			form.qmbWard().newRow(wards.get(i), wards.get(i).getName());
		}
		
		if (wards.size()==1)
		{
			form.qmbWard().setValue(wards.get(0));
		}
		else
		{
			form.qmbWard().showOpened();
		}
	}

	//WDEV-18388
	@Override
	protected void onQmbHospitalValueChanged() throws PresentationLogicException
	{
		form.qmbWard().clear();
		updateControlsState();
	}

	//WDEV-18388
	@Override
	protected void onQmbHospitalTextSubmited(String value) throws PresentationLogicException
	{
		form.qmbWard().clear();
		LocationLiteVoCollection hospitals = domain.listHospitals(value);
		
		if (hospitals == null || hospitals.size()==0)
			return;
			
		for (int i = 0; i < hospitals.size(); i++)
		{
			form.qmbHospital().newRow(hospitals.get(i), hospitals.get(i).getName());
		}
		
		if (hospitals.size()==1)
		{
			form.qmbHospital().setValue(hospitals.get(0));
		}
		else
		{
			form.qmbHospital().showOpened();
		}
		
		updateControlsState(); //WDEV-18656
	}

	@Override
	protected void onDteEarliestDateOfferedValueChanged() throws PresentationLogicException
	{
		updateControlsState();
	}
	@Override
	protected void onCmbElectiveListReasonValueChanged() throws PresentationLogicException
	{
		form.chkExtendedSearch().setValue(false);
		
		if (form.cmbElectiveListReason().getValue() != null)
			populateElectiveListCombo(ElectiveListReason.DIAGNOSTIC.equals(form.cmbElectiveListReason().getValue()) ? true : false);
		else
			form.cmbElectiveList().clear();
		
		updateControlsState();		
	}
	@Override
	protected void onBtnDashboardClick() throws PresentationLogicException
	{
		if(form.getGlobalContext().Core.getPatientShortIsNotNull())
		{
			if(ConfigFlag.GEN.PATIENT_DASHBOARD_URL.getValue() == null || ConfigFlag.GEN.PATIENT_DASHBOARD_URL.getValue().length() == 0)
			{
				engine.showMessage("PATIENT_DASHBOARD_URL config flag was not set.");
				return;
			}
			
			String url = ConfigFlag.GEN.PATIENT_DASHBOARD_URL.getValue() + "&PID=" + form.getGlobalContext().Core.getPatientShort().getID_Patient();
			List<WindowParam> params = new ArrayList<WindowParam>(); 
			params.add(new WindowParam("FullScreen","false")); 
			params.add(new WindowParam("ToolBar","false")); 
			params.add(new WindowParam("StatusBar","false")); 
			params.add(new WindowParam("StatusBar","false")); 
			params.add(new WindowParam("MenuBar","false")); 
			params.add(new WindowParam("AddressBar","false")); 
			params.add(new WindowParam("Resizable","true")); 
			params.add(new WindowParam("Visible","true"));
			params.add(new WindowParam("Width","1440")); 
			params.add(new WindowParam("Height","1000")); 

			engine.openCustomUrlCloseableOnContextChange(url, params, true);
		}
		
	}
}
