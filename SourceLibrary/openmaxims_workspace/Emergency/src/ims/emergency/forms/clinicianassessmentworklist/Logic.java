//#############################################################################
//#                                                                           #
//#  Copyright (C) <2014>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by Cristian Belciug using IMS Development Environment (version 1.80 build 4342.23748)
// Copyright (C) 1995-2012 IMS MAXIMS. All rights reserved.

package ims.emergency.forms.clinicianassessmentworklist;

import ims.admin.vo.AppImageVo;
import ims.clinical.configuration.vo.ClinicalProblemRefVo;
import ims.configuration.EnvironmentConfig;
import ims.configuration.gen.ConfigFlag;
import ims.core.admin.vo.CareContextRefVo;
import ims.core.admin.vo.EmergencyAttendanceRefVo;
import ims.core.admin.vo.EpisodeOfCareRefVo;
import ims.core.resource.people.vo.HcpRefVo;
import ims.core.resource.people.vo.MedicRefVo;
import ims.core.vo.AppDBImageVo;
import ims.core.vo.HcpLiteVo;
import ims.core.vo.MedicVo;
import ims.core.vo.lookups.HcpDisType;
import ims.core.vo.lookups.Sex;
import ims.domain.exceptions.StaleObjectException;
import ims.emergency.forms.clinicianassessmentworklist.GenForm.GroupClinicianReviewEnumeration;
import ims.emergency.forms.clinicianassessmentworklist.GenForm.grdAttendanceHistoryRow;
import ims.emergency.helper.EmergencyDisplayHelper;
import ims.emergency.vo.EmergencyAttendanceForTriageLiteVo;
import ims.emergency.vo.EmergencyAttendanceForTriageVo;
import ims.emergency.vo.EmergencyEpisodeForTriageLiteVo;
import ims.emergency.vo.EmergencyEpisodeForTriageVo;
import ims.emergency.vo.EmergencyEpisodeForTriageVoCollection;
import ims.emergency.vo.EpisodeOfcareLiteVo;
import ims.emergency.vo.PatientForTriageVo;
import ims.emergency.vo.SeenByHCPVo;
import ims.emergency.vo.TrackingForClinicianWorklistAndTriageVo;
import ims.emergency.vo.TrackingForClinicianWorklistVo;
import ims.emergency.vo.TrackingListForClinicianWorklistVo;
import ims.emergency.vo.TrackingListForClinicianWorklistVoCollection;
import ims.emergency.vo.TrackingRefVo;
import ims.emergency.vo.TriagePriorityKpConfigVo;
import ims.emergency.vo.TriageProtocolAssessmentForTriageVo;
import ims.emergency.vo.TriageProtocolAssessmentForTriageVoCollection;
import ims.emergency.vo.enums.DischargeDetails_CustomEvents;
import ims.emergency.vo.lookups.TrackingStatus;
import ims.emergency.vo.lookups.TriagePriority;
import ims.framework.Control;
import ims.framework.FormName;
import ims.framework.LayerBridge;
import ims.framework.MessageButtons;
import ims.framework.MessageIcon;
import ims.framework.controls.DynamicGridCell;
import ims.framework.controls.DynamicGridCellTable;
import ims.framework.controls.DynamicGridCellTable.TableCell;
import ims.framework.controls.DynamicGridCellTable.TableCellOptions;
import ims.framework.controls.DynamicGridCellTable.TableCellType;
import ims.framework.controls.DynamicGridCellTable.TableRow;
import ims.framework.controls.DynamicGridColumn;
import ims.framework.controls.DynamicGridRow;
import ims.framework.controls.Timer;
import ims.framework.delegates.CancelArgs;
import ims.framework.enumerations.Align;
import ims.framework.enumerations.DialogResult;
import ims.framework.enumerations.DynamicCellType;
import ims.framework.enumerations.FontFamily;
import ims.framework.enumerations.FontStyle;
import ims.framework.enumerations.FontWeight;
import ims.framework.enumerations.FormMode;
import ims.framework.exceptions.PresentationLogicException;
import ims.framework.utils.Base64;
import ims.framework.utils.Color;
import ims.framework.utils.DateTime;
import ims.framework.utils.Image;
import ims.icps.instantiation.vo.PatientICPRefVo;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.security.SecureRandom;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.Iterator;
import java.util.List;

public class Logic extends BaseLogic
{
	private static final long serialVersionUID = 1L;

	private static final String	COLUMN_NAME			= "0";
	private static final int EMERGENCY_PATIENT_SUMMARY = 320; 
	private static final String CARE_CONTEXT_SEED = "CareContext_id";
	
	private enum TriagePriorityEnum //WDEV-17208
	{ 
		Priority1(TriagePriority.PRIORITY1, 1),
		Priority2(TriagePriority.PRIORITY2, 2),
		Priority3(TriagePriority.PRIORITY3, 3),
		Priority4(TriagePriority.PRIORITY4, 4),
		Priority5(TriagePriority.PRIORITY5, 5),
		SkippedTriage(TriagePriority.SKIPPED_TRIAGE, 7);
		
		private TriagePriority index;
		private Integer order;
		
		TriagePriorityEnum(TriagePriority index,Integer order)
		{
			this.index = index;
			this.order = order;
		}
		
		public TriagePriority getIndex()
		{
			return index;
		}
		
		public Integer getOrder()
		{
			return order;
		}
	}

	@Override
	protected void onFormOpen(Object[] args) throws ims.framework.exceptions.PresentationLogicException
	{
		//WDEV-16174
		form.getLocalContext().getisFormOpenedFromOtherForm();
		if (args != null && args.length == 1 && args[0] != null)
		{
			form.getLocalContext().setisFormOpenedFromOtherForm((Boolean)args[0]);
		}
		
		initialize();
		open();
	}

	private void initialize() 
	{
		if(engine.getCurrentLocation() != null)
		{
			form.getLocalContext().setAttendanceKPIConfig(domain.getAttendanceKPIConfigForClinicianWorklist(engine.getCurrentLocation()));
		}
		
		Object user = domain.getHcpLiteUser();
		if(user instanceof HcpRefVo)
		{
			form.getLocalContext().setLoggedHcp((HcpRefVo) user);
		}
		
		form.GroupClinicianReview().setValue(GroupClinicianReviewEnumeration.rdoAll);
		createPatientGridColumns();
		
		form.lyrPatientTriage().tabPathway().ccICP().initialize();
		
		if(ConfigFlag.UI.ED_CLINICIAN_WORKLIST_AUTO_REFRESH_TIME_MINUTES.getValue() > 0)
		{
			form.getTimers().gettimerClinicianWorklist().setInterval(ConfigFlag.UI.ED_CLINICIAN_WORKLIST_AUTO_REFRESH_TIME_MINUTES.getValue() * 60);
			form.getTimers().gettimerClinicianWorklist().setEnabled(true);
		}
		
		if(form.getGlobalContext().Core.getCurrentCareContext() != null)
		{
			form.getLocalContext().setSelectedWaitingPatient(domain.getTrackingForClinicianWorklistByCareContext(form.getGlobalContext().Core.getCurrentCareContext()));
		}
	}

	@Override
	protected void onBtnStartAssessmentClick() throws PresentationLogicException
	{
		startClinicianAssessment(form.getLocalContext().getSelectedWaitingPatient());
	}

	private void startClinicianAssessment(TrackingForClinicianWorklistVo tracking)
	{
		if (tracking == null)
			return;
		
		HcpLiteVo hcpUser = (HcpLiteVo) domain.getHcpLiteUser();
		
		if (hcpUser == null || !HcpDisType.MEDICAL.equals(hcpUser.getHcpType()))
		{
			engine.open(form.getForms().Emergency.EDSeenByAndCompleteDialog);//WDEV-16816
			return;
		}
		else
		{
			//WDEV-16816
			// Attempt to save created SeenByHcp to tracking
			if (saveSeenByHcp(tracking, new MedicRefVo(hcpUser.getID_Hcp(), hcpUser.getVersion_Hcp())))
			{
				// Refresh screen
				open();
			}
		}
	}

	//WDEV-16816
	private boolean saveSeenByHcp(TrackingForClinicianWorklistVo tracking, MedicRefVo medic)
	{
		try
		{
			// Create the SeenByHcp record to be associated with tracking
			SeenByHCPVo seenByHcp = new SeenByHCPVo();
			seenByHcp.setPatient(tracking.getPatient());
			seenByHcp.setEpisode(tracking.getEpisode().getEpisodeOfCare());
			seenByHcp.setAttendance(tracking.getAttendance().getCareContext());
			seenByHcp.setTrackingArea(tracking.getCurrentArea());

			seenByHcp.setAllocatedDateTime(new DateTime());			
			seenByHcp.setAllocatedMedic((MedicVo)domain.getHcpUser());		
			seenByHcp.setSeenDateTime(new DateTime());
			
			// Validate SeenByHcp record
			String[] errors = seenByHcp.validate();

			if (errors != null && errors.length > 0)
			{
				engine.showErrors(errors);
				return false;
			}

			form.getLocalContext().setSelectedWaitingPatient(domain.saveTrackingSeenByHcp(tracking, seenByHcp));

			return true;
		}
		catch (StaleObjectException e)
		{
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			open();
			return false;
		}
	}

	private void createPatientGridColumns() 
	{
		DynamicGridColumn columnName = form.dyngrdPatients().getColumns().newColumn("Name", COLUMN_NAME);
		columnName.setWidth(298);
	}

	private void open() 
	{
		searchWaitingForClinicianReview();
		selectedInstance();
		updateControlsState();
	}
	
	private void searchWaitingForClinicianReview() 
	{
		clearScreen();
		
		HcpRefVo hcp = null;
		if(form.getLocalContext().getLoggedHcpIsNotNull() && GroupClinicianReviewEnumeration.rdoMyAllocated.equals(form.GroupClinicianReview().getValue()))
		{
			hcp = form.getLocalContext().getLoggedHcp();
		}
		
		TrackingListForClinicianWorklistVoCollection patients = domain.listPatientsWaiting(engine.getCurrentLocation(), TrackingStatus.WAITING_TO_BE_SEEN_BY_A_MEDIC, hcp);
		
		if(patients == null)
			return;
		
		populatePatientsWaitingForTriage(patients.sort(new TrackingComparator()));
	}

	private void clearScreen() 
	{
		form.dyngrdPatients().getRows().clear();
		form.lblPresentingComplaint().setValue(null);
		form.lblPresentingProblem().setValue(null);
		form.imgTriagePriority().setValue(null);
		form.lblDiscriminator().setValue(null);
		form.lyrPatientTriage().tabNotes().ccMedicNotes().clear();
		form.grdProblem().getRows().clear();
		form.ccAlert().clear();
		form.ccAllergy().clear();
		form.grdAttendanceHistory().getRows().clear();
		form.dtimIncidentTime().setValue(null);
		form.dtimArrivalTime().setValue(null);
		form.dtimRegistrationTime().setValue(null);
		form.txtLOS().setValue(null);//WDEV-15818
		form.dtimTriageStartTime().setValue(null);
		form.dtimTriageEndTime().setValue(null);
		form.dtimMedicStartTime().setValue(null);
		form.dtimDischargeBreachTime().setValue(null);
	}

	private void populatePatientsWaitingForTriage(TrackingListForClinicianWorklistVoCollection patients) 
	{
		form.dyngrdPatients().getRows().clear();
		deletePatientImages();
		
		if(patients == null)
			return;
		
		Integer totalLOS = 0;
		
		for(int i=0; i<patients.size(); i++)
		{
			Integer los = addPatientRow(patients.get(i), i);
			
			if(los != null)
			{
				totalLOS += los;
			}
		}
		
		Integer averageTime = totalLOS/patients.size();	
		form.lblAverageTime().setValue("Average Time to be Seen : " + EmergencyDisplayHelper.minutesToHoursAndMinutes(averageTime));//WDEV-15818
		
		form.dyngrdPatients().setValue(form.getLocalContext().getSelectedWaitingPatient());
	}

	private Integer addPatientRow(TrackingListForClinicianWorklistVo tracking, int position) 
	{
		if(tracking == null)
			return null;
		
		AppImageVo patientImage = null;
		
		try 
		{
			patientImage = getPatientImage(tracking);
			
			if(tracking != null && tracking.getPatient() != null && tracking.getPatient().getPhoto() != null)
			{
				addPatientToLocalCollection(patientImage);
			}
		}
		catch (IOException e) 
		{
			
		}
		
		Integer LOS = null;
		
		if(tracking.getAttendance() != null && tracking.getAttendance().getRegistrationDateTime() != null)
		{
			LOS = calculateDateDiffInMinutes(new DateTime(), tracking.getAttendance().getRegistrationDateTime());
		}
		
		DynamicGridRow row = form.dyngrdPatients().getRows().newRow();
					
		DynamicGridCell cellLabel = row.getCells().newCell(form.dyngrdPatients().getColumns().getByIdentifier(COLUMN_NAME), DynamicCellType.TABLE);
		DynamicGridCellTable helper = new DynamicGridCellTable(cellLabel);		
		helper.setBorder(4);		
		
		TableRow  tableRow = helper.getRows().newRow();
		
		
		
		//Patient			
		TableCell tableCell = tableRow.getCells().newCell();
		tableCell.setType(TableCellType.STRING);		
		TableCellOptions cellOptions = new TableCellOptions();		
						 cellOptions.setTextColor(Color.Black);
						 cellOptions.setFontFamily(FontFamily.ARIAL);
						 cellOptions.setFontSize(16);
						 cellOptions.setFontWeight(FontWeight.BOLDER);
						 cellOptions.setAlign(Align.LEFT);
						// cellOptions.setBlink(true);
		tableCell.setOptions(cellOptions);
		tableCell.setWidth(120);		
		tableCell.setColSpan(4);			
		if (tracking.getPatientIsNotNull() && tracking.getPatient().getNameIsNotNull())
		{
			tableCell.setValue(tracking.getPatient().getName().getSurname().toUpperCase() + ", " + tracking.getPatient().getName().getForename());
			tableCell.setTooltip(tracking.getPatient().getName().getSurname().toUpperCase() + ", " + tracking.getPatient().getName().getForename());
		}		
		
		//Hospital
		tableCell = tableRow.getCells().newCell();
		tableCell.setType(TableCellType.STRING);
		cellOptions = new TableCellOptions();		
						 cellOptions.setTextColor(Color.Black);
						 cellOptions.setFontFamily(FontFamily.CALIBRI);
						 cellOptions.setFontSize(13);
						 cellOptions.setAlign(Align.RIGHT);
		tableCell.setOptions(cellOptions);
		tableCell.setColSpan(2);
		if (tracking.getPatientIsNotNull() && tracking.getPatient().getHospnum() != null)
		{
			tableCell.setValue(tracking.getPatient().getHospnum().getIdValue());
			tableCell.setTooltip(tracking.getPatient().getHospnum().getIdValue());
		}		
				
		//Triage priority
		tableCell = tableRow.getCells().newCell();
		tableCell.setType(TableCellType.IMAGE);
		tableCell.setValue(getPriorityImage(tracking));//engine.getRegisteredImage(129110));
	
		tableCell.setColSpan(2);
		
		
		tableRow = helper.getRows().newRow();
		
		//Patient image
				 tableCell = tableRow.getCells().newCell();
							tableCell.setType(TableCellType.IMAGE);		
							tableCell.setRowSpan(3);
							tableCell.setValue(patientImage);
							tableCell.setWidth(50);
		
		//Gender
				tableCell = tableRow.getCells().newCell();
				tableCell.setType(TableCellType.IMAGE);
				tableCell.setWidth(24);
				if (tracking.getPatientIsNotNull() && tracking.getPatient().getSex() != null)
				{
					if(tracking.getPatient().getSex().equals(Sex.MALE))
					{
						tableCell.setValue(form.getImages().Emergency.Male);
					}
					else if(tracking.getPatient().getSex().equals(Sex.FEMALE))
					{
						tableCell.setValue(form.getImages().Emergency.Female);
					}			
				}		
		
		//Presenting problem
		tableCell = tableRow.getCells().newCell();
		cellOptions = new TableCellOptions();		
						 //cellOptions.setTextColor(Color.Black);
						 cellOptions.setFontFamily(FontFamily.CALIBRI);
						 cellOptions.setFontSize(13);
						 cellOptions.setFontStyle(FontStyle.ITALIC);
						 cellOptions.setFontWeight(FontWeight.BOLD);
						 setProblemCellOptionColor(cellOptions, tracking, LOS);
						 cellOptions.setAlign(Align.CENTER);
						 //cellOptions.setTextColor(Color.White);						 
		tableCell.setType(TableCellType.STRING);
		tableCell.setOptions(cellOptions);
		
		if(tracking.getTriageDetails() != null && tracking.getTriageDetails().getMainPresentingProblem() != null)
		{
			tableCell.setValue(tracking.getTriageDetails().getMainPresentingProblem().getPatientProblem());
		}
		tableCell.setWidth(140);
		tableCell.setColSpan(3);
		

		//Path Image
		tableCell = tableRow.getCells().newCell();
		tableCell.setType(TableCellType.IMAGE);
		
		if(position == 0 || position == 2)
		{
			tableCell.setValue(form.getImages().OCRR.Pathology48);//engine.getRegisteredImage(129132));
		}
		tableCell.setWidth(24);
		
		//Rad Image
		tableCell = tableRow.getCells().newCell();
		tableCell.setType(TableCellType.IMAGE);
		if(position == 0 || position == 2)
		{
			tableCell.setValue(form.getImages().Core.Radiology48);//engine.getRegisteredImage(129121));	
		}
		tableCell.setWidth(24);
		
		//DOB
		tableRow = helper.getRows().newRow();
		tableCell = tableRow.getCells().newCell();
		tableCell.setType(TableCellType.STRING);
		cellOptions = new TableCellOptions();		
						 cellOptions.setTextColor(Color.Black);
						 cellOptions.setFontFamily(FontFamily.CALIBRI);
						 cellOptions.setFontSize(11);
						 cellOptions.setFontWeight(FontWeight.BOLD);
						 cellOptions.setAlign(Align.LEFT);
		tableCell.setOptions(cellOptions);
		tableCell.setValue("DOB:");
		tableCell.setWidth(30);
		
		//dd/mm/yyy
		tableCell = tableRow.getCells().newCell();
		tableCell.setType(TableCellType.STRING);
		cellOptions = new TableCellOptions();		
						 cellOptions.setTextColor(Color.Black);
						 cellOptions.setFontFamily(FontFamily.CALIBRI);
						 cellOptions.setFontSize(11);					
						 cellOptions.setAlign(Align.LEFT);
		tableCell.setOptions(cellOptions);
		tableCell.setWidth(105);
		if (tracking.getPatientIsNotNull() && tracking.getPatient().getDobIsNotNull())
		{
			tableCell.setValue(tracking.getPatient().getDob().toString() + (tracking.getAttendance() != null && tracking.getAttendance().getAgeAtAttendance() != null ? " (" + tracking.getAttendance().getAgeAtAttendance() + ")" : ""));
			tableCell.setTooltip(tracking.getPatient().getDob().toString() + (tracking.getAttendance() != null && tracking.getAttendance().getAgeAtAttendance() != null ? " (" + tracking.getAttendance().getAgeAtAttendance() + ")" : ""));
		}
		
		
		//Time since
				tableCell = tableRow.getCells().newCell();
				cellOptions = new TableCellOptions();		
								 cellOptions.setTextColor(Color.Black);
								 cellOptions.setFontFamily(FontFamily.CALIBRI);
								 cellOptions.setFontSize(12);
								 cellOptions.setFontWeight(FontWeight.BOLD);										 
								 //cellOptions.setBackgroundColor(Color.Yellow);
								 cellOptions.setAlign(Align.CENTER);
				tableCell.setType(TableCellType.STRING);
				tableCell.setOptions(cellOptions);
				
				if(tracking.getTriageDetails() != null && tracking.getTriageDetails().getTriageStartDateTime() != null)
				{
					Integer timeSince = calculateDateDiffInMinutes(new DateTime(), tracking.getTriageDetails().getTriageStartDateTime());
					tableCell.setValue(EmergencyDisplayHelper.minutesToHoursAndMinutes(timeSince));//WDEV-15818
					tableCell.setTooltip(EmergencyDisplayHelper.minutesToHoursAndMinutes(timeSince));//WDEV-15818
				}
				tableCell.setWidth(50);
		
		
		
		//LOS
		tableCell = tableRow.getCells().newCell();
		tableCell.setType(TableCellType.STRING);
		cellOptions = new TableCellOptions();		
						 //cellOptions.setTextColor(Color.White);
						 cellOptions.setFontFamily(FontFamily.CALIBRI);
						 cellOptions.setFontSize(11);
						 cellOptions.setFontWeight(FontWeight.BOLD);
						 //cellOptions.setBackgroundColor(Color.Green);
						 setLOSCellOptionColor(cellOptions, LOS);
						 cellOptions.setAlign(Align.CENTER);
						// cellOptions.setTextColor(Color.White);
		tableCell.setOptions(cellOptions);
		
		if(LOS != null)
		{
			tableCell.setValue(EmergencyDisplayHelper.minutesToHoursAndMinutes(LOS));//WDEV-15818
			tableCell.setTooltip(EmergencyDisplayHelper.minutesToHoursAndMinutes(LOS));//WDEV-15818
		}
		tableCell.setWidth(50);
		
		//Alert
		tableCell = tableRow.getCells().newCell();
		tableCell.setType(TableCellType.IMAGE);
		tableCell.setWidth(24);
		tableCell.setValue(tracking.getPatient() != null && Boolean.TRUE.equals(tracking.getPatient().getHasAlerts()) ? form.getImages().Core.Alert48 : "Images/Admin/spacer.gif");
		
		//Allergy
		tableCell = tableRow.getCells().newCell();
		tableCell.setType(TableCellType.IMAGE);
		tableCell.setWidth(24);
		tableCell.setValue(tracking.getPatient() != null && Boolean.TRUE.equals(tracking.getPatient().getHasAllergies()) ? form.getImages().Core.Allergies48 : null);
		
		
		cellLabel.setValue(helper);
		cellLabel.setReadOnly(true);
		
		row.setValue(tracking);
		
		return LOS;
	}
	
	private void addPatientToLocalCollection(AppImageVo patientImage) 
	{
		if(patientImage == null)
			return;
		
		List<String> imagesColl = form.getLocalContext().getPatientImagesList();
		
		if (imagesColl == null)
			imagesColl = new ArrayList<String>();
		
		if (EnvironmentConfig.getFileUploadMountpoint() != null && EnvironmentConfig.getFileUploadMountpoint() != "")
		{
			imagesColl.add(EnvironmentConfig.getFileUploadMountpoint() + patientImage.getImagePath());
		}
		else
		{
			imagesColl.add(EnvironmentConfig.getBaseUri() + patientImage.getImagePath());
		}
		
		form.getLocalContext().setPatientImagesList(imagesColl);
	}
	
	private void deletePatientImages() 
	{
		List<String> importedFiles = form.getLocalContext().getPatientImagesList();
		
		if (importedFiles != null && importedFiles.size() > 0)
		{
			for (Iterator<String> iterator = importedFiles.iterator(); iterator.hasNext();) 
			{
				String file = ((String) iterator.next()).replace("/", "\\");
				File f = new File(file);
				f.delete();											
			}
		}
	}
	
	private void setLOSCellOptionColor(TableCellOptions cellOptions, Integer LOS) 
	{
		if(cellOptions == null)
			return;
		
		if(LOS == null )
		{
			cellOptions.setTextColor(Color.Black);
			return;
		}
		
		if(form.getLocalContext().getAttendanceKPIConfig() == null)
		{
			cellOptions.setTextColor(Color.Black);
			return;
		}
		
		Integer losBreachWarningKPI = form.getLocalContext().getAttendanceKPIConfig().getLosBreachWarningKPI();
		
		if(losBreachWarningKPI == null)
		{
			cellOptions.setTextColor(Color.Black);
			return;
		}
		
		Integer losBreachedKPI = form.getLocalContext().getAttendanceKPIConfig().getLosBreachedKPI();
		
		if(losBreachedKPI == null)
		{
			cellOptions.setTextColor(Color.Black);
			return;
		}
		
		if(LOS >= losBreachWarningKPI && LOS < losBreachedKPI)
		{
			cellOptions.setTextAndBackgroundBlink(form.getLocalContext().getAttendanceKPIConfig().getLosBreachWarningKPITextColour(),form.getLocalContext().getAttendanceKPIConfig().getLosBreachWarningKPIFlashingTextColour(),form.getLocalContext().getAttendanceKPIConfig().getLosBreachWarningKPIBackgroundColour(),form.getLocalContext().getAttendanceKPIConfig().getLosBreachWarningKPIBackgroundColour());	//wdev-16138
			cellOptions.setTextColor(form.getLocalContext().getAttendanceKPIConfig().getLosBreachWarningKPITextColour());   			//wdev-16138
			cellOptions.setBackgroundColor(form.getLocalContext().getAttendanceKPIConfig().getLosBreachWarningKPIBackgroundColour());	//wdev-16138
		}
		else if(LOS >= losBreachedKPI)
		{
			
			cellOptions.setTextAndBackgroundBlink(form.getLocalContext().getAttendanceKPIConfig().getLosBreachKPITextColour(),form.getLocalContext().getAttendanceKPIConfig().getLosBreachedKPIFlashingTextColour(),form.getLocalContext().getAttendanceKPIConfig().getLosBreachedKPIBackgroundColour(), form.getLocalContext().getAttendanceKPIConfig().getLosBreachedKPIBackgroundColour());	//wdev-16138
			cellOptions.setTextColor(form.getLocalContext().getAttendanceKPIConfig().getLosBreachKPITextColour());					//wdev-16138
			cellOptions.setBackgroundColor(form.getLocalContext().getAttendanceKPIConfig().getLosBreachedKPIBackgroundColour());	//wdev-16138
			//cellOptions.setBlink(true);
		}
	}

	private void setProblemCellOptionColor(TableCellOptions cellOptions, TrackingListForClinicianWorklistVo tracking, Integer LOS) 
	{
		if(cellOptions == null)
			return;
		
		if(tracking == null || tracking.getTriageDetails() == null)
		{
			cellOptions.setTextColor(Color.Black);
			return;
		}
		
		if(tracking.getTriageDetails().getCurrentTriagePriority() == null)
		{
			cellOptions.setTextColor(Color.Black);
		}
		else
		{
			if(tracking.getTriageDetails().getMedicInterventionStartDateTime() != null)
			{
				cellOptions.setTextColor(tracking.getTriageDetails().getCurrentTriagePriority().getColor());
			}
			else
			{
				if(LOS == null)
				{
					cellOptions.setTextColor(Color.Black);
					return;
				}
				
				if(form.getLocalContext().getAttendanceKPIConfig() == null)
				{
					cellOptions.setTextColor(Color.Black);
					return;
				}
				
				TriagePriorityKpConfigVo triagePriorityKpConfig = getTriagePriorityKpConfig(tracking.getTriageDetails().getCurrentTriagePriority());
				
				if(triagePriorityKpConfig == null)
				{
					cellOptions.setTextColor(Color.Black);
					return;
				}
				
				Integer breachWarningInMins = triagePriorityKpConfig.getPriorityBreachWarningKPI();
				
				if(breachWarningInMins == null)
				{
					cellOptions.setTextColor(Color.Black);
					return;
				}
				
				Integer breachedKPIInMIns = triagePriorityKpConfig.getPriorityBreachedKPI();
				
				if(breachedKPIInMIns == null)
				{
					cellOptions.setTextColor(Color.Black);
					return;
				}
				
				if(LOS >= breachWarningInMins && LOS < breachedKPIInMIns)
				{
					cellOptions.setTextAndBackgroundBlink(triagePriorityKpConfig.getPriorityBreachWarningKPITextColour(),triagePriorityKpConfig.getPriorityBreachWarningKPIFlashingTextColour() ,triagePriorityKpConfig.getPriorityBreachWarningKPIBackgroundColour(),triagePriorityKpConfig.getPriorityBreachWarningKPIBackgroundColour()); //wdev-16138
					cellOptions.setTextColor(triagePriorityKpConfig.getPriorityBreachWarningKPITextColour());						//wdev-16138
					cellOptions.setBackgroundColor(triagePriorityKpConfig.getPriorityBreachWarningKPIBackgroundColour());			//wdev-16138
				}
				else if(LOS >= breachedKPIInMIns)
				{
					cellOptions.setTextAndBackgroundBlink(triagePriorityKpConfig.getPriorityBreachKPITextColour(), triagePriorityKpConfig.getPriorityBreachedKPIFlashingTextColour() ,triagePriorityKpConfig.getPriorityBreachedKPIBackgroundColour(),triagePriorityKpConfig.getPriorityBreachedKPIBackgroundColour());	//wdev-16138
					cellOptions.setTextColor(triagePriorityKpConfig.getPriorityBreachKPITextColour());
					cellOptions.setBackgroundColor(triagePriorityKpConfig.getPriorityBreachedKPIBackgroundColour());				//wdev-16138
					//cellOptions.setBlink(true);
				}
			}
		}
	}
	
	private TriagePriorityKpConfigVo getTriagePriorityKpConfig(TriagePriority currentTriagePriority) 
	{
		if(form.getLocalContext().getAttendanceKPIConfig() == null || form.getLocalContext().getAttendanceKPIConfig().getTriagePriorityKPIs() == null || currentTriagePriority == null)
			return null;
		
		for(TriagePriorityKpConfigVo triagePriorityConfig : form.getLocalContext().getAttendanceKPIConfig().getTriagePriorityKPIs())
		{
			if(triagePriorityConfig == null)
				continue;
			
			if(currentTriagePriority.equals(triagePriorityConfig.getTriagePriority()))
				return triagePriorityConfig;
		}
		
		return null;
	}

	private Image getPriorityImage(TrackingListForClinicianWorklistVo tracking) 
	{
		if(tracking == null || tracking.getTriageDetails() == null)
			return null;
		
		if(TriagePriority.PRIORITY1.equals(tracking.getTriageDetails().getCurrentTriagePriority()))
			return form.getImages().Emergency.Triage_Priority_P1;
		else if(TriagePriority.PRIORITY2.equals(tracking.getTriageDetails().getCurrentTriagePriority()))
			return form.getImages().Emergency.Triage_Priority_P2;
		else if(TriagePriority.PRIORITY3.equals(tracking.getTriageDetails().getCurrentTriagePriority()))
			return form.getImages().Emergency.Triage_Priority_P3;
		else if(TriagePriority.PRIORITY4.equals(tracking.getTriageDetails().getCurrentTriagePriority()))
			return form.getImages().Emergency.Triage_Priority_P4;
		else if(TriagePriority.PRIORITY5.equals(tracking.getTriageDetails().getCurrentTriagePriority()))
			return form.getImages().Emergency.Triage_Priority_P5;
		
		return null;
	}

	private AppImageVo getPatientImage(TrackingListForClinicianWorklistVo tracking) throws IOException
	{
		if (tracking == null || tracking.getPatient() == null)
			return null;
		
		String sessionID = engine.getSessionId();
		
		AppDBImageVo dbImageVo = tracking.getPatient().getPhoto();
		
		//Existing Patient with no image
		if (dbImageVo == null)
		{
			// NoPatientImage	
			AppImageVo imageVo = new AppImageVo();
			imageVo.setImagePath(engine.getRegisteredImage(102554).getImagePath());
			
			return imageVo;
		}
		
		String encodedImage = dbImageVo.getImageData();
		String type = dbImageVo.getImageType().getText();	  		  		  	
  	
		return decodeFromBase64(encodedImage, sessionID, type);
	}
	
	private AppImageVo decodeFromBase64(String content, String sessionID, String imageType) throws IOException
	{
		byte[] decBytes = Base64.decode(content);

		if (decBytes == null || (decBytes != null && decBytes.length == 0)) 
		{
			engine.showMessage("Base64 image size is zero");
			return null;
		}
		//Get CurrentTimeMillis() segment
		String str = generateName();
		String image = EnvironmentConfig.getBaseUri() + ConfigFlag.GEN.FILE_UPLOAD_DIR.getValue() + str + "." + imageType.toLowerCase();		
		
		try
		{		
			FileOutputStream fos = new FileOutputStream(image);				
			fos.write(decBytes);
			fos.close();	
			
			AppImageVo imageVo = new AppImageVo();
			imageVo.setImagePath((EnvironmentConfig.getAplicationURL() + (ConfigFlag.GEN.FILE_UPLOAD_DIR.getValue() + str + "." + imageType.toLowerCase()).replace("\\", "/")));
			return imageVo;
		}		
		catch(FileNotFoundException exception) {			
			System.out.println("FileNotFoundException : " + exception);
		}		
		catch(IOException ioexception) {						
			System.out.println("IOException : " + ioexception);
		}
						
		return null;			
	}
	
	private String generateName() 
	{
		String str = "";

		try
		{
			//Get Random Segment
			SecureRandom prng = SecureRandom.getInstance("SHA1PRNG");
			str += Integer.toHexString(prng.nextInt());
			while (str.length() < 8)
			{
				str = '0' + str;
			}

			//Get CurrentTimeMillis() segment
			str += Long.toHexString(System.currentTimeMillis());
			while (str.length() < 12)
			{
				str = '0' + str;
			}

			//Get Random Segment
			SecureRandom secondPrng = SecureRandom.getInstance("SHA1PRNG");
			str += Integer.toHexString(secondPrng.nextInt());
			while (str.length() < 8)
			{
				str = '0' + str;
			}

			//Get IdentityHash() segment
			str += Long.toHexString(System.identityHashCode((Object) this));
			while (str.length() < 8)
			{
				str = '0' + str;
			}
			//Get Third Random Segment
			byte bytes[] = new byte[16];
			SecureRandom thirdPrng = SecureRandom.getInstance("SHA1PRNG");
			thirdPrng.nextBytes(bytes);
			str += Integer.toHexString(thirdPrng.nextInt());
			while (str.length() < 8)
			{
				str = '0' + str;
			}
		}
		catch (java.security.NoSuchAlgorithmException ex)
		{
			ex.getMessage();
		}

		return str;
	}
	
	@Override
	protected void onDyngrdPatientsRowSelectionChanged(DynamicGridRow row) throws PresentationLogicException 
	{
		form.lyrPatientTriage().showtabNotes();
		
		selectedInstance();
		updateControlsState();
	}

	private void setTooltips()
	{
		if (form.dtimIncidentTime().getValue() != null)
		{
			String incidentTime = EmergencyDisplayHelper.minutesToHoursAndMinutes(calculateDateDiffInMinutes(new DateTime(), form.dtimIncidentTime().getValue()));	//wdev-17349
			if( incidentTime == null )
				incidentTime = "0 m";
			form.dtimIncidentTime().setTooltip("Time since Incident: " + incidentTime);
		}
		
		if (form.dtimArrivalTime().getValue() != null)
		{
			String arrivalTime = EmergencyDisplayHelper.minutesToHoursAndMinutes(calculateDateDiffInMinutes(new DateTime(), form.dtimArrivalTime().getValue())); //wdev-17349
			if( arrivalTime == null )
				arrivalTime = "0 m";
			form.dtimArrivalTime().setTooltip("Time since Arrival: " + arrivalTime);
		}
		
		if (form.dtimRegistrationTime().getValue() != null)
		{
			String registrationTime = EmergencyDisplayHelper.minutesToHoursAndMinutes(calculateDateDiffInMinutes(new DateTime(), form.dtimRegistrationTime().getValue())); //wdev-17349
			if( registrationTime == null )
				registrationTime = "0 m"; 
			form.dtimRegistrationTime().setTooltip("Time since Registration: " + registrationTime);
		}
		
		if (form.dtimTriageStartTime().getValue() != null)
		{
			String triageStartTime = EmergencyDisplayHelper.minutesToHoursAndMinutes(calculateDateDiffInMinutes(new DateTime(), form.dtimTriageStartTime().getValue())); //wdev-17349
			if( triageStartTime == null )
				triageStartTime = "0 m";
			form.dtimTriageStartTime().setTooltip("Time since Triage Start: " + triageStartTime);
			
		}
		
		if (form.dtimTriageEndTime().getValue() != null)
		{
			String triageEndTime = EmergencyDisplayHelper.minutesToHoursAndMinutes(calculateDateDiffInMinutes(new DateTime(), form.dtimTriageEndTime().getValue()));	//wdev-17349
			if( triageEndTime == null )
				triageEndTime = "0 m";
			form.dtimTriageEndTime().setTooltip("Time since Triage End: " + triageEndTime);
		}
		
		if (form.dtimMedicStartTime().getValue() != null)
		{
			String medicStartTime = EmergencyDisplayHelper.minutesToHoursAndMinutes(calculateDateDiffInMinutes(new DateTime(), form.dtimMedicStartTime().getValue())); 	//wdev-17349
			if( medicStartTime == null )
				medicStartTime = "0 m";
			form.dtimMedicStartTime().setTooltip("Time since Medic Start: " + medicStartTime);
		}
		
		if (form.dtimDischargeBreachTime().getValue() != null)
		{
			String dischargeBreachTime = EmergencyDisplayHelper.minutesToHoursAndMinutes(calculateDateDiffInMinutes(new DateTime(), form.dtimDischargeBreachTime().getValue()));	//wdev-17349
			if( dischargeBreachTime == null )
				dischargeBreachTime = "0 m";
			
			form.dtimDischargeBreachTime().setTooltip("Time since Discharge Breached: " + dischargeBreachTime);
		}
	}
	//wdev-17349
	private void clearToolTips()
	{
		form.dtimIncidentTime().setTooltip(" ");
		form.dtimArrivalTime().setTooltip(" ");
		form.dtimRegistrationTime().setTooltip(" ");
		form.dtimTriageStartTime().setTooltip(" ");
		form.dtimTriageEndTime().setTooltip(" ");
		form.dtimMedicStartTime().setTooltip(" ");
		form.dtimDischargeBreachTime().setTooltip(" ");

	}

	private void selectedInstance() 
	{
		form.getLocalContext().setHistoryMode(false);
		form.getLocalContext().setSelectedWaitingPatient(null);
		
		if(form.dyngrdPatients().getValue() instanceof TrackingRefVo)
		{
			form.getGlobalContext().Emergency.setTracking((TrackingRefVo) form.dyngrdPatients().getValue());
			form.getLocalContext().setSelectedWaitingPatient(domain.getTrackingForTriage((TrackingRefVo) form.dyngrdPatients().getValue()));
		}
		else if(form.getGlobalContext().Core.getCurrentCareContext() != null)
		{
			 TrackingForClinicianWorklistVo TrackingForClinician = domain.getTrackingForClinicianWorklistByCareContext(form.getGlobalContext().Core.getCurrentCareContext());
			
			//WDEV-15951
			if (TrackingForClinician != null && TrackingForClinician.getAttendanceIsNotNull() && TrackingForClinician.getAttendance().getDischargeDateTimeIsNotNull())
			{
				form.getLocalContext().setHistoryMode(true); //wdev-16064
			}
			
			form.getLocalContext().setSelectedWaitingPatient(TrackingForClinician);
			form.getGlobalContext().Emergency.setTracking(form.getLocalContext().getSelectedWaitingPatient());
			form.dyngrdPatients().setValue(form.getLocalContext().getSelectedWaitingPatient());
			
		}
		
		if(form.getLocalContext().getSelectedWaitingPatient() != null)
		{
			form.getGlobalContext().Emergency.setTriage(form.getLocalContext().getSelectedWaitingPatient().getTriageDetails());
			
			if(form.getLocalContext().getSelectedWaitingPatient().getEpisode() != null)
			{
				form.getLocalContext().setCurrentEpisode((EmergencyEpisodeForTriageLiteVo) form.getLocalContext().getSelectedWaitingPatient().getEpisode().clone());
			}
			if(form.getLocalContext().getSelectedWaitingPatient().getAttendance() != null && form.getLocalContext().getSelectedWaitingPatient().getAttendance().getDischargeDateTime() == null)
			{
				form.getLocalContext().setCurrentAttendance((EmergencyAttendanceForTriageLiteVo) form.getLocalContext().getSelectedWaitingPatient().getAttendance().clone());
			}
		}
		
		populateScreenFromData();
	}

	private void populateScreenFromData() 
	{
		if(form.getLocalContext().getSelectedWaitingPatient() == null)
			return;
		
		PatientForTriageVo patient = form.getLocalContext().getSelectedWaitingPatient().getPatient();
		EpisodeOfCareRefVo episode = form.getLocalContext().getSelectedWaitingPatient().getEpisode().getEpisodeOfCare();
		CareContextRefVo careContext = form.getLocalContext().getSelectedWaitingPatient().getAttendance().getCareContext();
		
		ClinicalProblemRefVo problem = null;
		if(form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getMainPresentingProblem() != null)
		{
			problem = form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getMainPresentingProblem().getProblem();
		}
		
		PatientICPRefVo icp = form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() != null ? form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getCurrentTriagePathway() : null;
		
		form.getGlobalContext().Core.setPatientShort(domain.getPatientShort(patient));//WDEV-15815
		form.getGlobalContext().Core.setEpisodeofCareShort(domain.getEpisodeOfCare(episode));
		form.getGlobalContext().Core.setCurrentCareContext(domain.getCareContext(careContext));
		
		initializePatientTriageLayer(patient, episode, careContext, problem, icp);
		
		populateOtherDetails(patient);
	}

	private void populateOtherDetails(PatientForTriageVo patient) 
	{
		populateOtherProblems();
		
		form.ccAllergy().refresh();
		form.ccAlert().refresh();
		
		populateAttendanceHisyory(patient);
		
		form.imgTriagePriority().setValue(getPriorityImageByTriagePriority());
		form.lblPresentingComplaint().setValue((form.getLocalContext().getSelectedWaitingPatient() != null && form.getLocalContext().getSelectedWaitingPatient().getEpisode().getPresentingComplaint() != null) ? form.getLocalContext().getSelectedWaitingPatient().getEpisode().getPresentingComplaint().getText() : "");
		form.lblPresentingProblem().setValue((form.getLocalContext().getSelectedWaitingPatient() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getMainPresentingProblem() != null) ? form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getMainPresentingProblem().getPatientProblem() : null);
		form.lblDiscriminator().setValue((form.getLocalContext().getSelectedWaitingPatient() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getCurrentTriageAssessment() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getCurrentTriageAssessment().getDiscriminator() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getCurrentTriageAssessment().getDiscriminator().getDiscriminator() != null) ? form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getCurrentTriageAssessment().getDiscriminator().getDiscriminator().getDiscriminatorName() : "");
		
		populateAttendanceTimes();
	}

	private void populateOtherProblems() 
	{
		form.grdProblem().getRows().clear();
		
		if(form.getGlobalContext().Core.getCurrentCareContext() == null)
			return;
		
		TriageProtocolAssessmentForTriageVoCollection otherProblems = domain.listOtherProblems(form.getGlobalContext().Core.getCurrentCareContext());
		
		for(TriageProtocolAssessmentForTriageVo otherProblem : otherProblems)
		{
			addOtherProblemRow(otherProblem);
		}
	}

	private void addOtherProblemRow(TriageProtocolAssessmentForTriageVo otherProblem) 
	{
		if(otherProblem == null)
			return;
		
		ims.emergency.forms.clinicianassessmentworklist.GenForm.grdProblemRow row = form.grdProblem().getRows().newRow();
		
		row.setColOtherProblems(otherProblem.getPatientProblem() != null ? otherProblem.getPatientProblem().getPatientProblem() : null);
		row.setColDiscriminator((otherProblem.getDiscriminator() != null && otherProblem.getDiscriminator().getDiscriminator() != null) ? otherProblem.getDiscriminator().getDiscriminator().getDiscriminatorName() : null);
		
		row.setValue(otherProblem);
	}

	private Image getPriorityImageByTriagePriority() 
	{
		if(form.getLocalContext().getSelectedWaitingPatient() == null || form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() == null)
			return null;
		
		if(TriagePriority.PRIORITY1.equals(form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getCurrentTriagePriority()))
			return form.getImages().Emergency.Triage_Priority_P1;
		else if(TriagePriority.PRIORITY2.equals(form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getCurrentTriagePriority()))
			return form.getImages().Emergency.Triage_Priority_P2;
		else if(TriagePriority.PRIORITY3.equals(form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getCurrentTriagePriority()))
			return form.getImages().Emergency.Triage_Priority_P3;
		else if(TriagePriority.PRIORITY4.equals(form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getCurrentTriagePriority()))
			return form.getImages().Emergency.Triage_Priority_P4;
		else if(TriagePriority.PRIORITY5.equals(form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getCurrentTriagePriority()))
			return form.getImages().Emergency.Triage_Priority_P5;
		
		return null;
	}

	private void populateAttendanceTimes() 
	{
		if(form.getLocalContext().getSelectedWaitingPatient() == null)
			return;
		
		form.dtimIncidentTime().setValue(form.getLocalContext().getSelectedWaitingPatient().getEpisode() != null ? form.getLocalContext().getSelectedWaitingPatient().getEpisode().getInjuryDateTime() : null);
		form.dtimArrivalTime().setValue(form.getLocalContext().getSelectedWaitingPatient().getAttendance() != null ? form.getLocalContext().getSelectedWaitingPatient().getAttendance().getArrivalDateTime() : null);
		form.dtimRegistrationTime().setValue(form.getLocalContext().getSelectedWaitingPatient().getAttendance() != null ? form.getLocalContext().getSelectedWaitingPatient().getAttendance().getRegistrationDateTime() : null);
		form.dtimTriageStartTime().setValue(form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() != null ? form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getTriageStartDateTime() : null);
		form.dtimTriageEndTime().setValue(form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() != null ? form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getTriageCompletionTime() : null);
		
		form.txtLOS().setValue(EmergencyDisplayHelper.minutesToHoursAndMinutes(calculateDateDiffInMinutes(new DateTime(), form.dtimRegistrationTime().getValue())));//WDEV-15818
		
		form.dtimMedicStartTime().setValue(form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() != null ? form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getMedicInterventionStartDateTime() : null);
		form.dtimDischargeBreachTime().setValue(calculateDischargeBreachTime(form.dtimRegistrationTime().getValue()));
	}
	
	private DateTime calculateDischargeBreachTime(DateTime registrationDateTime) 
	{
		if(registrationDateTime == null)
			return null;
		
		if(form.getLocalContext().getAttendanceKPIConfig() == null || form.getLocalContext().getAttendanceKPIConfig().getLosBreachedKPI() == null)
			return null;
		
		return ((DateTime) registrationDateTime.clone()).addMinutes(form.getLocalContext().getAttendanceKPIConfig().getLosBreachedKPI());
	}

	private Integer calculateDateDiffInMinutes(DateTime currentTime, DateTime registrationDateTime) 
	{
		if(currentTime == null || registrationDateTime == null)
			return null;
		
		long currentTimeInMillis = currentTime.getJavaDate().getTime();
		long registrationDateTimeInMillis = registrationDateTime.getJavaDate().getTime();
		
		return (int)(((currentTimeInMillis < registrationDateTimeInMillis ? registrationDateTimeInMillis - currentTimeInMillis : currentTimeInMillis - registrationDateTimeInMillis)/1000)/60);
	}

	private void populateAttendanceHisyory(PatientForTriageVo patient) 
	{
		form.grdAttendanceHistory().getRows().clear();
		form.getLocalContext().setCountOfPreviousAttendances(new Integer(0));	//wdev-16072
		if(patient == null)
			return;
		
		EmergencyEpisodeForTriageVoCollection attendanceHistory = domain.listAttendanceHistory(patient);
		
		if(attendanceHistory == null)
		{
			form.getLocalContext().setCountOfPreviousAttendances(0);		//wdev-16072
			form.lbl18().setValue("Attendance History");					//wdev-16072
			return;
		}
		
		for(EmergencyEpisodeForTriageVo emergencyEpisode : attendanceHistory)
		{
			addEmergencyEpisodeRow(emergencyEpisode);
			//wdev-16072
			int nrPreviousAttendances = form.getLocalContext().getCountOfPreviousAttendances();	
			nrPreviousAttendances += 1;
			form.getLocalContext().setCountOfPreviousAttendances(nrPreviousAttendances);
			//wdev-16072
			
			
		}
		
		form.grdAttendanceHistory().setValue(null);
		if(form.getLocalContext().getSelectedWaitingPatient() != null)
		{
			form.grdAttendanceHistory().setValue(form.getLocalContext().getSelectedWaitingPatient().getAttendance());
		}
		
		form.grdAttendanceHistory().resetScrollPosition();
		//wdev-16072
		if( form.getLocalContext().getCountOfPreviousAttendances() > 1)
		{
			Integer nrcount = new Integer(form.getLocalContext().getCountOfPreviousAttendances() -1 );
			form.lbl18().setValue("Attendance History - "+nrcount.toString() + " previous" );				
		}
		else
		{
			form.lbl18().setValue("Attendance History");
		}
		//-----------------end wdev-16072
		
	}

	private void addEmergencyEpisodeRow(EmergencyEpisodeForTriageVo emergencyEpisode) 
	{
		if(emergencyEpisode == null)
			return;
		
		grdAttendanceHistoryRow row = form.grdAttendanceHistory().getRows().newRow();
		EpisodeOfcareLiteVo tempVo = domain.getEpisodeOfCareLite(emergencyEpisode.getEpisodeOfCare());	//wdev-16070
		row.setColID(emergencyEpisode.getID_EmergencyEpisode().toString() + (tempVo != null ? " - " + tempVo.getStartDate().toString() : ""));	//wdev-16070
		row.setBold(true);
		
		row.setValue((EmergencyEpisodeForTriageLiteVo) emergencyEpisode);
		
		if(emergencyEpisode.getEmergencyAttendances() == null)
			return;
		
		row.setExpanded(true);
		
		for(EmergencyAttendanceForTriageVo emergencyAttendance : emergencyEpisode.getEmergencyAttendances())
		{
			addEmergencyAttendanceRow(row, emergencyAttendance);
		}
	}

	private void addEmergencyAttendanceRow(grdAttendanceHistoryRow row,	EmergencyAttendanceForTriageVo emergencyAttendance) 
	{
		if(row == null || emergencyAttendance == null)
			return;
		
		grdAttendanceHistoryRow childRow = row.getRows().newRow();
		childRow.setColID(emergencyAttendance.getID_EmergencyAttendance().toString() + (emergencyAttendance.getRegistrationDateTimeIsNotNull() ? " - " + emergencyAttendance.getRegistrationDateTime().toString() : ""));
		
		childRow.setValue((EmergencyAttendanceForTriageLiteVo) emergencyAttendance);
	}

	private void initializePatientTriageLayer(PatientForTriageVo patient, EpisodeOfCareRefVo episode, CareContextRefVo careContext, ClinicalProblemRefVo problem, PatientICPRefVo icp) 
	{
		form.lyrPatientTriage().tabNotes().ccMedicNotes().initialize(patient, episode, careContext, problem);
		
		//WDEV-15996
		if (ConfigFlag.UI.DISPLAY_EXTENDED_OBS_DATA_SET.getValue()==false)
		{
			form.lyrPatientTriage().tabObs().ccVitalSigns().initialize();
		}
		else
		{
			initializeObsLayerTabs();
		}
		
		TrackingForClinicianWorklistAndTriageVo trackVo = domain.getTrackingForClinicianWorklistAndTriageVo(form.getLocalContext().getSelectedWaitingPatient());  //wdev-17819
		form.lyrPatientTriage().tabPatientMeds().ccPatientMeds().initialize(patient, careContext, episode,trackVo);	//wdev-17819
		form.lyrPatientTriage().tabRelevantPMH().ccRelevantPMH().initialize(careContext, patient, episode);
		form.lyrPatientTriage().tabSysReview().ccSystemReview().initialize(careContext, episode, patient, problem);
		form.lyrPatientTriage().tabPathway().ccICP().setValue(icp);
		form.lyrPatientTriage().tabSupport().ccSupportService().initialize(careContext, episode, patient);
		form.lyrPatientTriage().tabDischargeDetails().ccDischarge().setValue(careContext, problem);
	}

	//WDEV-15996
	private void initializeObsLayerTabs()
	{
		if (form.lyrPatientTriage().tabObs2().lyrObs2().tabVitalSigns().isVisible())
		{
			form.lyrPatientTriage().tabObs2().lyrObs2().tabVitalSigns().ccVitalSignsObs().initialize();
		}
		else if (form.lyrPatientTriage().tabObs2().lyrObs2().tabUrinalysis().isVisible())
		{
			form.lyrPatientTriage().tabObs2().lyrObs2().tabUrinalysis().ccUrinalysis().initialize();
		}
		else if (form.lyrPatientTriage().tabObs2().lyrObs2().tabUrineTox().isVisible())
		{
			form.lyrPatientTriage().tabObs2().lyrObs2().tabUrineTox().ccUrineTox().initialize();
		}
		else if (form.lyrPatientTriage().tabObs2().lyrObs2().tabHCG().isVisible())
		{
			form.lyrPatientTriage().tabObs2().lyrObs2().tabHCG().ccHCG().initialize();
		}
		else if (form.lyrPatientTriage().tabObs2().lyrObs2().tabOther().isVisible())
		{
			form.lyrPatientTriage().tabObs2().lyrObs2().tabOther().ccPatientAssessment().initialize();	
		}
	}
	
	private void updateControlsState() 
	{
		clearToolTips();	//wdev-17349
		setTooltips(); //WDEV-15820
		
		boolean isPatientSelected = form.getLocalContext().getSelectedWaitingPatient() != null;
		boolean hasSeenByHcp = isPatientSelected && form.getLocalContext().getSelectedWaitingPatient().getSeenBy() != null;//WDEV-16816
		boolean isHistoryMode = Boolean.TRUE.equals(form.getLocalContext().getHistoryMode());
		boolean hasMainPresentingProblem = ((form.getLocalContext().getSelectedWaitingPatient() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getMainPresentingProblem() != null) ? true : false);
		
		form.imgTriagePriority().setVisible(isPatientSelected && form.getLocalContext().getSelectedWaitingPatient() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getCurrentTriagePriority() != null);
		form.btnEditMainProblem().setVisible(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && !isHistoryMode && hasMainPresentingProblem);
		
		form.lyrPatientTriage().tabNotes().setHeaderEnabled(isPatientSelected&& FormMode.VIEW.equals(form.getMode()));
		
		//WDEV-15996
		form.lyrPatientTriage().tabObs().setHeaderVisible(!ConfigFlag.UI.DISPLAY_EXTENDED_OBS_DATA_SET.getValue());
		form.lyrPatientTriage().tabObs().setHeaderEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && !ConfigFlag.UI.DISPLAY_EXTENDED_OBS_DATA_SET.getValue());
		
		form.lyrPatientTriage().tabObs2().setHeaderVisible(ConfigFlag.UI.DISPLAY_EXTENDED_OBS_DATA_SET.getValue());
		form.lyrPatientTriage().tabObs2().setHeaderEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && ConfigFlag.UI.DISPLAY_EXTENDED_OBS_DATA_SET.getValue());
		form.lyrPatientTriage().tabObs2().lyrObs2().tabVitalSigns().setHeaderEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && ConfigFlag.UI.DISPLAY_EXTENDED_OBS_DATA_SET.getValue());
		form.lyrPatientTriage().tabObs2().lyrObs2().tabUrinalysis().setHeaderEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && ConfigFlag.UI.DISPLAY_EXTENDED_OBS_DATA_SET.getValue());
		form.lyrPatientTriage().tabObs2().lyrObs2().tabUrineTox().setHeaderEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && ConfigFlag.UI.DISPLAY_EXTENDED_OBS_DATA_SET.getValue());
		form.lyrPatientTriage().tabObs2().lyrObs2().tabHCG().setHeaderEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && ConfigFlag.UI.DISPLAY_EXTENDED_OBS_DATA_SET.getValue());
		form.lyrPatientTriage().tabObs2().lyrObs2().tabOther().setHeaderEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && ConfigFlag.UI.DISPLAY_EXTENDED_OBS_DATA_SET.getValue());
		
		form.lyrPatientTriage().tabObs2().lyrObs2().tabVitalSigns().ccVitalSignsObs().setEnabled(isPatientSelected && !isHistoryMode);
		form.lyrPatientTriage().tabObs2().lyrObs2().tabUrinalysis().ccUrinalysis().setEnabled(isPatientSelected && !isHistoryMode);
		form.lyrPatientTriage().tabObs2().lyrObs2().tabUrineTox().ccUrineTox().setEnabled(isPatientSelected && !isHistoryMode);
		form.lyrPatientTriage().tabObs2().lyrObs2().tabHCG().ccHCG().setEnabled(isPatientSelected && !isHistoryMode);
		form.lyrPatientTriage().tabObs2().lyrObs2().tabOther().ccPatientAssessment().setEnabled(isPatientSelected && !isHistoryMode);
		//end WDEV-15996
		
		form.lyrPatientTriage().tabPatientMeds().setHeaderEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()));
		form.lyrPatientTriage().tabSysReview().setHeaderEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()));
		form.lyrPatientTriage().tabRelevantPMH().setHeaderEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()));
		form.lyrPatientTriage().tabPathway().setHeaderEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()));
		form.lyrPatientTriage().tabSupport().setHeaderEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()));
		form.lyrPatientTriage().tabDischargeDetails().setHeaderEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()));
		form.lyrPatientTriage().tabNotes().ccMedicNotes().setEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && !isHistoryMode);
		form.lyrPatientTriage().tabObs().ccVitalSigns().setEnabled(isPatientSelected && !isHistoryMode);
		form.lyrPatientTriage().tabPathway().ccICP().setReadOnly(!(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && !isHistoryMode));
		form.lyrPatientTriage().tabSysReview().ccSystemReview().setEnabled(isPatientSelected && !isHistoryMode);
		form.lyrPatientTriage().tabPatientMeds().ccPatientMeds().setEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && !isHistoryMode);
		form.lyrPatientTriage().tabRelevantPMH().ccRelevantPMH().setEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && !isHistoryMode);
		form.lyrPatientTriage().tabSupport().ccSupportService().setEnabled(isPatientSelected && !isHistoryMode);
		form.lyrPatientTriage().tabDischargeDetails().ccDischarge().setReadOnly(!(isPatientSelected && !isHistoryMode));
		
		form.ccAllergy().setEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && !isHistoryMode);
		form.ccAlert().setEnabled(isPatientSelected && FormMode.VIEW.equals(form.getMode()) && !isHistoryMode);
		
		if(FormMode.VIEW.equals(form.getMode()))
		{
			form.btnStartAssessment().setVisible(isPatientSelected && !hasSeenByHcp && !isHistoryMode);//WDEV-16816
			form.btnPatientSummary().setVisible(isPatientSelected);
			form.btnTriageNotes().setVisible(isPatientSelected);
			form.btnViewHistory().setVisible(isPatientSelected);
			form.btnReferToSpecialty().setVisible(isPatientSelected && !isHistoryMode);
			form.btnSeenCompleteHCP().setVisible(isPatientSelected && !isHistoryMode);//WDEV-16816
			form.btnMovePatient().setVisible(isPatientSelected && !isHistoryMode && (form.getLocalContext().getSelectedWaitingPatient().getIsDischarged() == null || Boolean.FALSE.equals(form.getLocalContext().getSelectedWaitingPatient().getIsDischarged())));
		}
		
		form.dtimMedicStartTime().setEnabled(form.getLocalContext().getSelectedWaitingPatient() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getMedicInterventionStartDateTime() == null && FormMode.VIEW.equals(form.getMode()) && !isHistoryMode);
		
		form.getContextMenus().Emergency.getOtherProblemsTriageMenuADDItem().setVisible(isPatientSelected && !isHistoryMode && FormMode.VIEW.equals(form.getMode()));
		form.getContextMenus().Emergency.getOtherProblemsTriageMenuEDITItem().setVisible(isPatientSelected && !isHistoryMode && FormMode.VIEW.equals(form.getMode()) && form.grdProblem().getValue() != null);
		
		//WDEV-16174
		form.lnkReturn().setVisible(FormMode.VIEW.equals(form.getMode()) && engine.getPreviousNonDialogFormName().equals(form.getForms().Emergency.TrackingAndAttendanceWorklists) && form.getLocalContext().getisFormOpenedFromOtherFormIsNotNull() && form.getLocalContext().getisFormOpenedFromOtherForm());
	}

	@Override
	protected void onCcVitalSignsValueChanged()	throws PresentationLogicException 
	{
		FormMode vitalSignMode = form.lyrPatientTriage().tabObs().ccVitalSigns().getMode();
		form.setMode(vitalSignMode);
		
		form.getTimers().gettimerClinicianWorklist().setEnabled(FormMode.VIEW.equals(vitalSignMode));
	}

	@Override
	protected void onFormModeChanged() 
	{
		updateControlsState();
	}

	@Override
	protected void onGrdProblemSelectionChanged() throws PresentationLogicException 
	{
		updateControlsState();
	}

	@Override
	protected void onRadioButtonGroupClinicianReviewValueChanged()	throws PresentationLogicException 
	{
		clearContexts();
		form.lyrPatientTriage().showtabNotes();
		
		searchWaitingForClinicianReview();
		updateControlsState();
	}

	private void clearContexts() 
	{
		clearGlobalContexts();
		form.getLocalContext().setSelectedWaitingPatient(null);
		form.getLocalContext().setCurrentAttendance(null);
		form.getLocalContext().setCurrentEpisode(null);
	}

	@Override
	protected void onBtnTriageNotesClick() throws PresentationLogicException 
	{
		ClinicalProblemRefVo problem = null;
		
		if(form.getLocalContext().getSelectedWaitingPatient() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() != null && form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getMainPresentingProblem() != null)
		{
			problem = form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getMainPresentingProblem().getProblem(); 
		}
		
		engine.open(form.getForms().Emergency.TriageNotesDialog, problem != null ? new Object[] {problem} : null);
	}

	@Override
	protected void onBtnReferToSpecialtyClick()	throws PresentationLogicException 
	{
		engine.open(form.getForms().Emergency.EDReferralToSpecialtyDialog);//WDEV-16777
	}

	@Override
	protected void onBtnMovePatientClick() throws PresentationLogicException 
	{
		if(saveMedicStartTime())
			open();
		
		engine.open(form.getForms().Emergency.SendToAreaDialog, new Object[] {Boolean.TRUE});
	}

	private boolean saveMedicStartTime() 
	{
		if(form.getLocalContext().getSelectedWaitingPatient() == null || form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() == null)
			return false;
		
		if(form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getMedicInterventionStartDateTime() != null || form.dtimMedicStartTime().getValue() == null)
			return false;
		
		form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().setMedicInterventionStartDateTime(form.dtimMedicStartTime().getValue());
		String[] errors = form.getLocalContext().getSelectedWaitingPatient().validate();
		
		if(errors != null && errors.length > 0)
		{
			engine.showErrors(errors);
			return false;
		}
		
		try 
		{
			domain.saveMedicStartTime(form.getLocalContext().getSelectedWaitingPatient());
		} 
		catch (StaleObjectException e) 
		{
			e.printStackTrace();
			engine.showMessage(ConfigFlag.UI.STALE_OBJECT_MESSAGE.getValue());
			open();
			return false;
		}
		
		return true;
	}
	
	private Integer getOrderByIndex(TriagePriority priority)
	{
		for(TriagePriorityEnum item : TriagePriorityEnum.values())
		{
			if(item.getIndex().equals(priority))
				return item.getOrder();
		}
		
		return null;
	}
	
	class TrackingComparator implements Comparator<TrackingListForClinicianWorklistVo>
	{
		public int compare(TrackingListForClinicianWorklistVo o1, TrackingListForClinicianWorklistVo o2)
		{
			if (o1 != null && o1.getTriageDetails() != null && o1.getTriageDetails().getCurrentTriagePriority() != null && o2!=null && o2.getTriageDetails() != null && o2.getTriageDetails().getCurrentTriagePriority() != null)
			{
				Integer priorityOrder1 = getOrderByIndex(o1.getTriageDetails().getCurrentTriagePriority());
				Integer priorityOrder2 = getOrderByIndex(o2.getTriageDetails().getCurrentTriagePriority());
				
				int orderByPriority = priorityOrder1.compareTo(priorityOrder2);
				
				if(orderByPriority == 0)
				{
					return compareByLOS(o1, o2);
				}
				
				return orderByPriority;
			}
			
			if((o1 == null || o1.getTriageDetails() == null || o1.getTriageDetails().getCurrentTriagePriority() == null) && (o2 == null || o2.getTriageDetails() == null || o2.getTriageDetails().getCurrentTriagePriority() == null))
				return compareByLOS(o1, o2);
			
			if (o1 == null || o1.getTriageDetails() == null || o1.getTriageDetails().getCurrentTriagePriority() == null)
				return 1;
			
			if (o2 == null || o2.getTriageDetails() == null || o2.getTriageDetails().getCurrentTriagePriority() == null)
				return -1;
			
			return 0;
		}

		private int compareByLOS(TrackingListForClinicianWorklistVo o1, TrackingListForClinicianWorklistVo o2) 
		{
			if(o1 != null && o1.getAttendance() != null && o1.getAttendance().getRegistrationDateTime() != null && o2 != null && o2.getAttendance() != null && o2.getAttendance().getRegistrationDateTime() != null)
			{
				Integer LOS1 = calculateDateDiffInMinutes(new DateTime(), o1.getAttendance().getRegistrationDateTime());
				Integer LOS2 = calculateDateDiffInMinutes(new DateTime(), o2.getAttendance().getRegistrationDateTime());
				
				int orderByLOS = -1 * LOS1.compareTo(LOS2);
				
				if(orderByLOS == 0)
				{
					return compareByName(o1, o2);
				}
				
				return orderByLOS;
			}
			
			if (o1 == null || o1.getAttendance() == null || o1.getAttendance().getRegistrationDateTime() == null)
				return -1;
			
			if (o2 == null || o2.getAttendance() == null || o2.getAttendance().getRegistrationDateTime() == null)
				return 1;
			
			return 0;
		}

		private int compareByName(TrackingListForClinicianWorklistVo o1, TrackingListForClinicianWorklistVo o2) 
		{
			if(o1 != null && o1.getPatient() != null && o1.getPatient().getName() != null && o2 != null && o2.getPatient() != null && o2.getPatient().getName() != null)
			{
				return o1.getPatient().getName().compareTo(o2.getPatient().getName(), true);
			}
			
			if (o1 == null || o1.getPatient() == null || o1.getPatient().getName() == null)
				return -1;
			
			if (o2 == null || o2.getPatient() == null || o2.getPatient().getName() == null)
				return 1;
			
			return 0;
		}
	}

	@Override
	protected void onTimer(Timer timer) throws PresentationLogicException 
	{
		System.out.println("Clinician Worklist timer = " + ConfigFlag.UI.ED_CLINICIAN_WORKLIST_AUTO_REFRESH_TIME_MINUTES.getValue());
		open();
	}

	@Override
	protected void onBtnViewHistoryClick() throws PresentationLogicException 
	{
		engine.open(form.getForms().Emergency.AttendanceHistory);
	}

	@Override
	protected void onBtnPatientSummaryClick() throws PresentationLogicException 
	{
		if(form.getLocalContext().getSelectedWaitingPatient() == null)
			return;
		
		form.getGlobalContext().Core.setImsReportId(EMERGENCY_PATIENT_SUMMARY);
		engine.open(form.getForms().Core.PrintReportByIMSId, new Object[] {CARE_CONTEXT_SEED, form.getLocalContext().getSelectedWaitingPatient().getAttendance().getCareContext().getID_CareContext()});
	}

	@Override
	protected void onCcDischargeValueChanged() throws PresentationLogicException 
	{
		if(DischargeDetails_CustomEvents.FORMMODECHANGED.equals(form.lyrPatientTriage().tabDischargeDetails().ccDischarge().getCustomEvent()))
		{
			FormMode dischargeMode = form.lyrPatientTriage().tabDischargeDetails().ccDischarge().getMode();
			form.setMode(dischargeMode);
			
			form.getTimers().gettimerClinicianWorklist().setEnabled(FormMode.VIEW.equals(dischargeMode));
			
			Boolean isDischarged = form.lyrPatientTriage().tabDischargeDetails().ccDischarge().getRecordedDischarge();
			
			if(isDischarged)
			{
				clearGlobalContexts();
			}
			
			if(FormMode.VIEW.equals(form.getMode()))
			{
				open();
				
				if(form.getLocalContext().getSelectedWaitingPatient() == null)
				{
					form.lyrPatientTriage().showtabNotes();
				}
			}
			
			form.lyrPatientTriage().tabDischargeDetails().ccDischarge().clearCustomEvent();
		}
	}

	private void clearGlobalContexts() 
	{
		form.getGlobalContext().Core.setCurrentCareContext(null);
		form.getGlobalContext().Core.setEpisodeofCareShort(null);
		form.getGlobalContext().Core.setPatientShort(null);
		form.getGlobalContext().Emergency.setTracking(null);
		form.getGlobalContext().Emergency.setTriage(null);
	}

	@Override
	protected void onCcSupportServiceValueChanged()	throws PresentationLogicException 
	{
		FormMode supportServiceMode = form.lyrPatientTriage().tabSupport().ccSupportService().getMode();
		form.setMode(supportServiceMode);
		
		form.getTimers().gettimerClinicianWorklist().setEnabled(FormMode.VIEW.equals(supportServiceMode));
	}

	@Override
	protected void onCcPatientMedsValueChanged() throws PresentationLogicException 
	{
		FormMode patMedsMode = form.lyrPatientTriage().tabPatientMeds().ccPatientMeds().getMode();
		form.setMode(patMedsMode);
		
		form.getTimers().gettimerClinicianWorklist().setEnabled(FormMode.VIEW.equals(patMedsMode));
	}

	@Override
	protected void onCcRelevantPMHValueChanged() throws PresentationLogicException 
	{
		FormMode relevPMHMode = form.lyrPatientTriage().tabRelevantPMH().ccRelevantPMH().getMode();
		form.setMode(relevPMHMode);
		
		form.getTimers().gettimerClinicianWorklist().setEnabled(FormMode.VIEW.equals(relevPMHMode));
	}

	@Override
	protected void onBtnEditMainProblemClick() throws PresentationLogicException 
	{
		if(form.getLocalContext().getSelectedWaitingPatient() == null || form.getLocalContext().getSelectedWaitingPatient().getTriageDetails() == null || form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getCurrentTriageAssessment() == null)
			return;
		
		form.getGlobalContext().Emergency.setTriageProtocolAssessment(form.getLocalContext().getSelectedWaitingPatient().getTriageDetails().getCurrentTriageAssessment());
		engine.open(form.getForms().Emergency.TriageProtocolAssessment);
	}

	@Override
	protected void onContextMenuItemClick(int menuItemID, Control sender) throws PresentationLogicException 
	{
		switch(menuItemID)
		{
			case GenForm.ContextMenus.EmergencyNamespace.OtherProblemsTriageMenu.ADD:
				form.getGlobalContext().Emergency.setTriageProtocolAssessment(null);
				engine.open(form.getForms().Emergency.TriageProtocolAssessment);
			break;
			
			case GenForm.ContextMenus.EmergencyNamespace.OtherProblemsTriageMenu.EDIT:
				form.getGlobalContext().Emergency.setTriageProtocolAssessment(form.grdProblem().getValue());
				engine.open(form.getForms().Emergency.TriageProtocolAssessment);
			break;
		}
	}

	@Override
	protected void onBtnTrackingSummaryClick() throws PresentationLogicException 
	{
		engine.open(form.getForms().Emergency.TrackingSummary);
	}

	@Override
	protected void onBtnTrackingClick() throws PresentationLogicException 
	{
		engine.open(form.getForms().Emergency.Tracking);
	}

	@Override
	protected void onGrdAttendanceHistorySelectionChanged() throws PresentationLogicException 
	{
		selectedAttendanceHistory();
	}
	
	private void selectedAttendanceHistory() 
	{
		form.getLocalContext().setHistoryMode(false);
		
		
		
		if(form.grdAttendanceHistory().getValue() instanceof EmergencyAttendanceForTriageLiteVo)
		{
			if (form.getLocalContext().getCurrentAttendance() == null) //WDEV-15951, wdev-16751
			{
				EmergencyAttendanceForTriageLiteVo attendance = domain.getEmergencyAttendance((EmergencyAttendanceRefVo) form.grdAttendanceHistory().getValue());
				
				if (attendance.getDischargeDateTime() == null)
				{
					form.getLocalContext().setCurrentAttendance(attendance);
				}
			}
			
			if(!form.grdAttendanceHistory().getValue().equals(form.getLocalContext().getCurrentAttendance()))
			{
				form.getLocalContext().setHistoryMode(true);
				form.getLocalContext().setMessageBoxIdForOldEmergencyAttendance(engine.showMessage("Do you wish to view the clinician details for the attendance on " + ((EmergencyAttendanceForTriageLiteVo) form.grdAttendanceHistory().getValue()).getRegistrationDateTime(), "" , MessageButtons.YESNO, MessageIcon.QUESTION));
			}
			else
			{
				form.getLocalContext().setSelectedWaitingPatient(domain.geTrackingForTriageByAttendanceId((EmergencyAttendanceForTriageLiteVo) form.grdAttendanceHistory().getValue()));
				form.dyngrdPatients().setValue(form.getLocalContext().getSelectedWaitingPatient());
				
				populateScreenFromData();
				updateControlsState();
			}
		}
	}

	@Override
	protected void onMessageBoxClosed(int messageBoxId, DialogResult result) throws PresentationLogicException 
	{
		if(form.getLocalContext().getMessageBoxIdForOldEmergencyAttendanceIsNotNull() && form.getLocalContext().getMessageBoxIdForOldEmergencyAttendance().equals(messageBoxId))
		{
			if(DialogResult.YES.equals(result) && form.grdAttendanceHistory().getValue() instanceof EmergencyAttendanceForTriageLiteVo)
			{
				form.getLocalContext().setSelectedWaitingPatient(domain.geTrackingForTriageByAttendanceId((EmergencyAttendanceForTriageLiteVo) form.grdAttendanceHistory().getValue()));
				form.dyngrdPatients().setValue(form.getLocalContext().getSelectedWaitingPatient());
				form.getLocalContext().setCurrentAttendance(null);
				
				populateScreenFromData();
				updateControlsState();
			}
			//WDEV-15951
			else if (DialogResult.NO.equals(result) && form.grdAttendanceHistory().getValue() instanceof EmergencyAttendanceForTriageLiteVo)//WDEV-15868
			{
				form.getLocalContext().setHistoryMode(false);
				form.grdAttendanceHistory().setValue(form.getLocalContext().getSelectedWaitingPatient().getAttendance());
			}
		}
	}

	@Override
	protected void onFormDialogClosed(FormName formName, DialogResult result) throws PresentationLogicException 
	{
		//WDEV-15951
		if (form.getLocalContext().getHistoryMode() == null)
		{
			form.getLocalContext().setHistoryMode(false);
		}
		
		open();
	}

	//WDEV-15996
	@Override
	protected void onFormClosing(CancelArgs args) throws PresentationLogicException 
	{
		deletePatientImages();
	}

	//WDEV-15996
	@Override
	protected void onCcVitalSignsObsValueChanged() throws PresentationLogicException
	{
		FormMode vitalSignsObsMode = form.lyrPatientTriage().tabObs2().lyrObs2().tabVitalSigns().ccVitalSignsObs().getMode();
		form.setMode(vitalSignsObsMode);
		
		form.getTimers().gettimerClinicianWorklist().setEnabled(FormMode.VIEW.equals(vitalSignsObsMode));
	}

	//WDEV-15996
	@Override
	protected void onCcUrinalysisValueChanged() throws PresentationLogicException
	{
		FormMode urinalysisMode = form.lyrPatientTriage().tabObs2().lyrObs2().tabUrinalysis().ccUrinalysis().getMode();
		form.setMode(urinalysisMode);
		
		form.getTimers().gettimerClinicianWorklist().setEnabled(FormMode.VIEW.equals(urinalysisMode));
	}

	//WDEV-15996
	@Override
	protected void onCcUrineToxValueChanged() throws PresentationLogicException
	{
		FormMode urineToxMode = form.lyrPatientTriage().tabObs2().lyrObs2().tabUrineTox().ccUrineTox().getMode();
		form.setMode(urineToxMode);
		
		form.getTimers().gettimerClinicianWorklist().setEnabled(FormMode.VIEW.equals(urineToxMode));
	}

	//WDEV-15996
	@Override
	protected void onCcHCGValueChanged() throws PresentationLogicException
	{
		FormMode hcgMode = form.lyrPatientTriage().tabObs2().lyrObs2().tabHCG().ccHCG().getMode();
		form.setMode(hcgMode);
		
		form.getTimers().gettimerClinicianWorklist().setEnabled(FormMode.VIEW.equals(hcgMode));
	}

	//WDEV-15996
	@Override
	protected void onCcPatientAssessmentValueChanged() throws PresentationLogicException
	{
		FormMode patAssessmentMode = form.lyrPatientTriage().tabObs2().lyrObs2().tabOther().ccPatientAssessment().getMode();
		form.setMode(patAssessmentMode);
		
		form.getTimers().gettimerClinicianWorklist().setEnabled(FormMode.VIEW.equals(patAssessmentMode));
	}

	//WDEV-15996
	@Override
	protected void onlyrPatientTriageTabChanged(LayerBridge tab)
	{
		if (FormMode.VIEW.equals(form.getMode()))
		{
    		if (tab.equals(form.lyrPatientTriage().tabObs2()))
    		{
    			//form.lyrPatientTriage().tabObs2().lyrObs2().tabVitalSigns().ccVitalSignsObs().initialize();
    			initializeObsLayerTabs();
    		}
    		updateControlsState();
		}
	}

	//WDEV-15996
	@Override
	protected void onlyrObs2TabChanged(LayerBridge tab)
	{
		if (FormMode.VIEW.equals(form.getMode()))
		{
    		if (tab.equals(form.lyrPatientTriage().tabObs2().lyrObs2().tabVitalSigns()))
    		{
    			form.lyrPatientTriage().tabObs2().lyrObs2().tabVitalSigns().ccVitalSignsObs().initialize();
    		}
    		else if (tab.equals(form.lyrPatientTriage().tabObs2().lyrObs2().tabUrinalysis()))
    		{
    			form.lyrPatientTriage().tabObs2().lyrObs2().tabUrinalysis().ccUrinalysis().initialize();
    		}
    		else if (tab.equals(form.lyrPatientTriage().tabObs2().lyrObs2().tabUrineTox()))
    		{
    			form.lyrPatientTriage().tabObs2().lyrObs2().tabUrineTox().ccUrineTox().initialize();
    		}
    		else if (tab.equals(form.lyrPatientTriage().tabObs2().lyrObs2().tabHCG()))
    		{
    			form.lyrPatientTriage().tabObs2().lyrObs2().tabHCG().ccHCG().initialize();
    		}
    		else if (tab.equals(form.lyrPatientTriage().tabObs2().lyrObs2().tabOther()))
    		{
    			form.lyrPatientTriage().tabObs2().lyrObs2().tabOther().ccPatientAssessment().initialize();
    		}
    		updateControlsState();
		}
	}

	//WDEV-16174
	protected void onLnkReturnClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Emergency.TrackingAndAttendanceWorklists);
	}

	//WDEV-16816
	protected void onBtnSeenCompleteHCPClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Emergency.EDSeenByAndCompleteDialog);
	}

	protected void onBtnResultsClick() throws PresentationLogicException
	{
		engine.open(form.getForms().Emergency.AttendanceResultListDialog);
	}
}
