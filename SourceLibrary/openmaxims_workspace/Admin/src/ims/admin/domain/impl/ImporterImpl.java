//#############################################################################
//#                                                                           #
//#  Copyright (C) <2014>  <IMS MAXIMS>                                       #
//#                                                                           #
//#  This program is free software: you can redistribute it and/or modify     #
//#  it under the terms of the GNU Affero General Public License as           #
//#  published by the Free Software Foundation, either version 3 of the       #
//#  License, or (at your option) any later version.                          # 
//#                                                                           #
//#  This program is distributed in the hope that it will be useful,          #
//#  but WITHOUT ANY WARRANTY; without even the implied warranty of           #
//#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the            #
//#  GNU Affero General Public License for more details.                      #
//#                                                                           #
//#  You should have received a copy of the GNU Affero General Public License #
//#  along with this program.  If not, see <http://www.gnu.org/licenses/>.    #
//#                                                                           #
//#############################################################################
//#EOH
// This code was generated by John MacEnri using IMS Development Environment (version 1.53 build 2543.28531)
// Copyright (C) 1995-2006 IMS MAXIMS plc. All rights reserved.

package ims.admin.domain.impl;

import java.lang.reflect.Method;
import java.util.HashMap;
import java.util.Iterator;

import org.dom4j.Element;

import ims.admin.domain.base.impl.BaseImporterImpl;
import ims.configuration.ImportedObject;
import ims.domain.DomainFactory;
import ims.domain.DomainObject;
import ims.domain.exceptions.DomainInterfaceException;

public class ImporterImpl extends BaseImporterImpl
{
	private static final long serialVersionUID = 1L;

	public void importItem(Element el) throws DomainInterfaceException
	{
		DomainFactory factory = getDomainFactory();
		
		String className = el.attributeValue("type");
		try
		{
			Class c = Class.forName(className);
			String shortClassName = className.substring(className.lastIndexOf(".")+1);
			String methodName = "get" + shortClassName + "fromXML";
			HashMap domMap = new HashMap();
			Method m = c.getMethod(methodName, new Class[]{Element.class, DomainFactory.class, java.util.HashMap.class});
			DomainObject domObj = (DomainObject)m.invoke(null, new Object[]{el, factory, domMap});
			factory.save(domObj);
			Iterator iter = domMap.values().iterator();
			while (iter.hasNext())
			{
				ImportedObject impObj = (ImportedObject)iter.next();
				factory.saveImport(impObj.getDomainObject(), impObj.getExternalSource(), impObj.getExternalId());
			}			
		}
		catch(Exception e)
		{
			throw new DomainInterfaceException(e);
		}
	}
}
